# Budget System - Workflow Summary (สรุปการทำงาน)

**Date:** December 19, 2025
**Purpose:** อธิบาย workflow ของระบบงบประมาณแบบเข้าใจง่าย

---

## 🎯 ภาพรวม: ระบบงบประมาณทำงานยังไง?

```
┌────────────────────────────────────────────────────────────┐
│                   ระบบงบประมาณโรงพยาบาล                    │
│                                                            │
│  ปีละ 1 ครั้ง → วางแผนงบประมาณทั้งปี → ซื้อของตลอดปี     │
└────────────────────────────────────────────────────────────┘
```

---

## 📅 Timeline: ปีงบประมาณ 2568

```
ต.ค. 67          ม.ค. 68          เม.ย. 68         ก.ค. 68          ก.ย. 68
  │                 │                 │                │                │
  Q1                Q2                Q3               Q4               │
  (ต.ค.-ธ.ค.)      (ม.ค.-มี.ค.)     (เม.ย.-มิ.ย.)    (ก.ค.-ก.ย.)      End

  ▼ เริ่มปีงบ

  ก.ย. 67: ทำ Budget Request ให้เสร็จ
  ต.ค. 67: เริ่มใช้งบ Q1
```

**Thai Fiscal Year:**

- เริ่ม: 1 ตุลาคม 2567
- สิ้นสุด: 30 กันยายน 2568
- แบ่ง 4 ไตรมาส (Q1-Q4)

---

## 🔄 Workflow แบบละเอียด

### 📝 STEP 1: สร้าง Budget Request (ก.ย. 67)

**ใครทำ:** Finance Officer

**ทำอะไร:**

1. สร้าง Budget Request ปีงบ 2568
2. ไม่ระบุแผนก (department_id = null) → งบกลาง
3. Status: **DRAFT** (ร่าง)

**ในระบบ:**

```sql
INSERT INTO budget_requests (
  fiscal_year,
  department_id,    -- NULL = งบกลาง
  status
) VALUES (2568, NULL, 'DRAFT');
```

**ผลลัพธ์:**

```
Budget Request #1
├─ Fiscal Year: 2568
├─ Department: NULL (งบกลาง)
├─ Status: DRAFT
└─ Items: 0 (ยังไม่มีรายการ)
```

---

### 📦 STEP 2: เพิ่มรายการยา/เวชภัณฑ์

**ใครทำ:** Pharmacy, แผนกต่างๆ (ทำร่วมกัน)

**ทำอะไร:**

1. เพิ่มยาที่ต้องการซื้อ เช่น:
   - Paracetamol 500mg
   - Ibuprofen 400mg
   - Aspirin 100mg
   - ... (รวม ~5,000 รายการ)

2. กำหนดปริมาณรายไตรมาส:
   - Q1: เท่าไร
   - Q2: เท่าไร
   - Q3: เท่าไร
   - Q4: เท่าไร

3. **ใหม่!** ตั้งค่าการควบคุมงบราย item (ถ้ามี):
   - ควบคุมปริมาณ: NONE/SOFT/HARD
   - ควบคุมราคา: NONE/SOFT/HARD
   - ยอมให้เกิน: ±10%

**ตัวอย่าง: เพิ่ม Paracetamol**

```
Paracetamol 500mg
├─ ปริมาณรวม: 10,000 เม็ด
├─ Q1: 2,500 เม็ด (ต.ค.-ธ.ค.)
├─ Q2: 3,000 เม็ด (ม.ค.-มี.ค.)
├─ Q3: 2,500 เม็ด (เม.ย.-มิ.ย.)
├─ Q4: 2,000 เม็ด (ก.ค.-ก.ย.)
├─ ราคาต่อหน่วย: 5 บาท
├─ รวมเงิน: 50,000 บาท
│
└─ การควบคุมงบ (ใหม่):
   ├─ ควบคุมปริมาณ: HARD (ไม่ให้เกิน)
   ├─ ควบคุมราคา: SOFT (เกินได้แต่ต้องมีเหตุผล)
   └─ ยอมให้เกิน: ±10%
```

**ในระบบ:**

```sql
INSERT INTO budget_request_items (
  budget_request_id,
  generic_id,                -- ยา
  requested_qty,             -- 10,000
  q1_qty, q2_qty, q3_qty, q4_qty,  -- แบ่งตามไตรมาส
  unit_price,                -- 5 บาท

  -- ใหม่: การควบคุมงบ
  quantity_control_type,     -- HARD
  price_control_type,        -- SOFT
  quantity_variance_percent, -- 10
  price_variance_percent     -- 10
) VALUES (...);
```

**ผลลัพธ์:**

```
Budget Request #1
├─ Status: DRAFT
├─ Items: 5,000 รายการ
│   ├─ Paracetamol: 10,000 เม็ด @ 5฿ = 50,000฿
│   ├─ Ibuprofen: 5,000 เม็ด @ 10฿ = 50,000฿
│   └─ ...
└─ Total: 50,000,000 บาท
```

---

### ✅ STEP 3: Submit เพื่อขออนุมัติ

**ใครทำ:** Finance Officer

**ทำอะไร:**

1. ตรวจสอบรายการทั้งหมด
2. กดปุ่ม "ส่งขออนุมัติ"
3. Status: **SUBMITTED**

**ในระบบ:**

```sql
UPDATE budget_requests
SET status = 'SUBMITTED'
WHERE id = 1;
```

**ผลลัพธ์:**

```
Budget Request #1
├─ Status: SUBMITTED ← เปลี่ยน
├─ Submitted At: 2024-09-15
└─ รอผู้อนุมัติระดับแผนก
```

---

### 👨‍⚕️ STEP 4: ผู้อนุมัติแผนก

**ใครทำ:** Department Director

**ทำอะไร:**

1. Review รายการยาที่ขอ
2. ตรวจสอบปริมาณสมเหตุสมผลไหม
3. อนุมัติ → Status: **DEPT_APPROVED**

**ในระบบ:**

```sql
UPDATE budget_requests
SET status = 'DEPT_APPROVED',
    dept_reviewed_by = 'user-123',
    dept_reviewed_at = NOW()
WHERE id = 1;
```

**ผลลัพธ์:**

```
Budget Request #1
├─ Status: DEPT_APPROVED ← เปลี่ยน
├─ Dept Approved By: นพ.สมชาย
└─ Dept Approved At: 2024-09-18
```

---

### 💰 STEP 5: ผู้อนุมัติการเงิน (สำคัญ!)

**ใครทำ:** Finance Manager

**ทำอะไร:**

1. Review งบประมาณรวม (50 ล้าน)
2. ตรวจสอบงบพอไหม
3. อนุมัติ → Status: **FINANCE_APPROVED**
4. **ระบบสร้าง budget_allocations อัตโนมัติ** ⭐

**ในระบบ:**

```sql
-- 1. Update status
UPDATE budget_requests
SET status = 'FINANCE_APPROVED',
    finance_reviewed_by = 'user-456',
    finance_reviewed_at = NOW()
WHERE id = 1;

-- 2. ระบบสร้าง budget_allocations (AUTO)
INSERT INTO budget_allocations (
  fiscal_year,
  budget_id,
  department_id,    -- 1 = คลังกลาง/งบรวม
  total_budget,     -- 50,000,000
  q1_budget,        -- 12,500,000
  q2_budget,        -- 15,000,000
  q3_budget,        -- 12,500,000
  q4_budget,        -- 10,000,000
  remaining_budget, -- 50,000,000 (ยังไม่ได้ใช้)
  total_spent       -- 0
) VALUES (...);
```

**ผลลัพธ์:**

```
Budget Request #1
├─ Status: FINANCE_APPROVED ← เปลี่ยน
└─ Finance Approved At: 2024-09-20

budget_allocations (ถูกสร้างขึ้นมา)
├─ Fiscal Year: 2568
├─ Budget ID: 1 (งบกลาง)
├─ Department ID: 1 (คลังกลาง)
├─ Total Budget: 50,000,000฿
├─ Q1 Budget: 12,500,000฿
├─ Q2 Budget: 15,000,000฿
├─ Q3 Budget: 12,500,000฿
├─ Q4 Budget: 10,000,000฿
├─ Total Spent: 0฿ ← ยังไม่ได้ใช้
└─ Remaining: 50,000,000฿ ← เหลือเต็มจำนวน
```

---

## 🎉 สรุป Phase 1: Budget Planning Complete!

**จุดนี้เสร็จแล้ว:**

- ✅ มี Budget Request (อนุมัติแล้ว)
- ✅ มีรายการยา 5,000 รายการ
- ✅ แบ่งเป็น Q1-Q4 แล้ว
- ✅ มีการควบคุมงบราย item แล้ว (NONE/SOFT/HARD)
- ✅ มี budget_allocations (งบจัดสรร 50 ล้าน)

**พร้อมใช้งานได้ตั้งแต่:** 1 ตุลาคม 2567

---

## 🛒 Phase 2: การใช้งบ (ตลอดปี 2568)

### การซื้อของจริง (PR/PO Flow)

```
เดือนตุลาคม (Q1):
  ห้องยาต้องการซื้อ Paracetamol

      ↓

  สร้าง PR (Purchase Request)
  - จำนวน: 2,500 เม็ด (ตาม Q1 plan)
  - ราคา: 5 บาท/เม็ด
  - รวม: 12,500 บาท

      ↓

  ระบบตรวจสอบงบ (2 ระดับ):

  ✅ Level 1: เช็คงบรวม (budget_allocations)
     - งบ Q1: 12,500,000฿
     - ใช้ไป: 0฿
     - เหลือ: 12,500,000฿
     - ขอ: 12,500฿
     → ✅ พอ
     → จองงบ (reserve_budget)

  ✅ Level 2: เช็คงบราย item (budget_request_items)
     - วางแผน Q1: 2,500 เม็ด
     - ซื้อแล้ว: 0 เม็ด
     - เหลือ: 2,500 เม็ด
     - ขอ: 2,500 เม็ด
     - ควบคุม: HARD ±10% (2,250-2,750 OK)
     → ✅ พอดี ไม่เกิน

      ↓

  PR ผ่าน → สร้าง PO

      ↓

  PO Approved

      ↓

  ระบบ Update (AUTO):

  1. budget_request_items
     - q1_purchased_qty: 0 → 2,500 ← อัพเดท
     - total_purchased_qty: 0 → 2,500
     - total_purchased_value: 0 → 12,500฿

  2. budget_allocations
     - q1_spent: 0 → 12,500฿ ← อัพเดท
     - total_spent: 0 → 12,500฿
     - remaining_budget: 50,000,000 → 49,987,500฿

  3. budget_reservations
     - จองไว้ 12,500฿ → ปลดล็อค (committed)
```

---

## 📊 ระหว่างปี: ติดตาม Budget

### Dashboard แสดง:

```
┌─────────────────────────────────────────────────┐
│           Budget Status - Q1 (ต.ค.-ธ.ค.)       │
├─────────────────────────────────────────────────┤
│ งบ Q1:          12,500,000฿                     │
│ ใช้ไป:          5,000,000฿ (40%)               │
│ จองไว้:         2,000,000฿ (16%)               │
│ เหลือ:          5,500,000฿ (44%)               │
│                                                 │
│ [████████████░░░░░░░░░░░░] 40% used            │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│           รายการยา (Items)                      │
├─────────────────────────────────────────────────┤
│ Paracetamol 500mg                               │
│ ├─ วางแผน Q1: 2,500 เม็ด                       │
│ ├─ ซื้อแล้ว:   2,500 เม็ด (100%) ✅            │
│ ├─ เหลือ:      0 เม็ด                          │
│ └─ ควบคุม:     🔴 HARD ±10%                    │
│                                                 │
│ Ibuprofen 400mg                                 │
│ ├─ วางแผน Q1: 1,250 เม็ด                       │
│ ├─ ซื้อแล้ว:   1,000 เม็ด (80%)                │
│ ├─ เหลือ:      250 เม็ด                        │
│ └─ ควบคุม:     🟡 SOFT ±15%                    │
└─────────────────────────────────────────────────┘
```

---

## 🚨 การควบคุมงบราย Item (Item-Level Control)

### ตัวอย่าง: Paracetamol (HARD Control ±10%)

**สถานการณ์:**

```
Q1:
├─ วางแผน: 2,500 เม็ด
├─ ซื้อแล้ว: 2,400 เม็ด
└─ เหลือ: 100 เม็ด

HARD ±10% หมายความว่า:
├─ เหลือ 100 เม็ด
├─ ยอมให้เกิน: 100 × 10% = 10 เม็ด
└─ ซื้อได้สูงสุด: 100 + 10 = 110 เม็ด
```

**กรณีที่ 1: ขอซื้อ 100 เม็ด**

```
✅ ผ่าน
- เหลือ: 100 เม็ด
- ขอ: 100 เม็ด
- ไม่เกิน → อนุญาต
```

**กรณีที่ 2: ขอซื้อ 110 เม็ด**

```
✅ ผ่าน (พอดี)
- เหลือ: 100 เม็ด
- ขอ: 110 เม็ด (เกิน 10%)
- ยอมให้เกิน ±10% → อนุญาต
```

**กรณีที่ 3: ขอซื้อ 150 เม็ด**

```
❌ ไม่ผ่าน (BLOCKED)
- เหลือ: 100 เม็ด
- ขอ: 150 เม็ด (เกิน 50%)
- เกินกว่า ±10% → บล็อค ไม่ให้สร้าง PR

UI แสดง:
┌────────────────────────────────────┐
│ ❌ Error: Budget Exceeded          │
├────────────────────────────────────┤
│ Paracetamol 500mg                  │
│ - วางแผน: 2,500 เม็ด              │
│ - ซื้อแล้ว: 2,400 เม็ด            │
│ - เหลือ: 100 เม็ด                 │
│ - คุณขอ: 150 เม็ด                 │
│ - เกิน: 50 เม็ด (50%)             │
│ - ยอมให้เกิน: ±10% เท่านั้น       │
│                                    │
│ ⚠️ ไม่สามารถสร้าง PR ได้          │
│ กรุณาแก้ไขปริมาณหรือขออนุมัติ      │
│ เพิ่มงบประมาณ                      │
└────────────────────────────────────┘
```

---

### ตัวอย่าง: Ibuprofen (SOFT Control ±15%)

**กรณีที่ 1: ขอซื้อ 100 เม็ด (ไม่เกิน)**

```
✅ ผ่าน (ไม่มี warning)
```

**กรณีที่ 2: ขอซื้อ 150 เม็ด (เกิน 20%)**

```
⚠️ Warning แต่อนุญาต

UI แสดง:
┌────────────────────────────────────┐
│ ⚠️ Warning: Budget Exceeded        │
├────────────────────────────────────┤
│ Ibuprofen 400mg                    │
│ - วางแผน: 1,250 เม็ด              │
│ - ซื้อแล้ว: 1,000 เม็ด            │
│ - เหลือ: 250 เม็ด                 │
│ - คุณขอ: 300 เม็ด                 │
│ - เกิน: 50 เม็ด (20%)             │
│ - ยอมให้เกิน: ±15%                │
│                                    │
│ ⚠️ คุณกำลังซื้อเกินงบประมาณ       │
│ กรุณาระบุเหตุผล:                  │
│ [_____________________________]    │
│                                    │
│ [ยกเลิก] [ดำเนินการต่อ]           │
└────────────────────────────────────┘

กรอกเหตุผล: "ผู้ป่วยเพิ่มขึ้นกะทันหัน จำเป็นต้องซื้อเพิ่ม"
→ ✅ อนุญาตสร้าง PR (บันทึกเหตุผลไว้)
```

---

### ตัวอย่าง: Vitamin C (NONE Control)

```
✅ ซื้อได้ทุกจำนวน ไม่มีการตรวจสอบ
- วางแผน: 1,000 เม็ด
- ซื้อแล้ว: 900 เม็ด
- คุณขอ: 500 เม็ด (เกิน 400 เม็ด)
→ ✅ ผ่าน ไม่มี warning ไม่มี error
```

---

## 🔄 สรุป Flow ทั้งหมด

```
1️⃣ Finance สร้าง Budget Request
   └─ Status: DRAFT

2️⃣ Pharmacy/แผนกต่างๆ เพิ่มรายการยา + ตั้งค่า control
   └─ เพิ่ม 5,000 รายการ พร้อม NONE/SOFT/HARD

3️⃣ Submit
   └─ Status: SUBMITTED

4️⃣ Department Approve
   └─ Status: DEPT_APPROVED

5️⃣ Finance Approve
   ├─ Status: FINANCE_APPROVED
   └─ ระบบสร้าง budget_allocations (AUTO)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   Budget Planning เสร็จ พร้อมใช้งาน
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

6️⃣ ตลอดปี: สร้าง PR ซื้อของ
   ├─ ระบบเช็คงบรวม (allocations)
   ├─ ระบบเช็คงบราย item (request_items)
   │  ├─ HARD: บล็อคถ้าเกิน
   │  ├─ SOFT: เตือนแต่อนุญาต (ต้องมีเหตุผล)
   │  └─ NONE: ไม่เช็ค
   └─ จองงบ (reserve_budget)

7️⃣ PR → PO → Approve
   ├─ Update purchased_qty (items)
   ├─ Update spent (allocations)
   └─ ปลดล็อคงบที่จอง

8️⃣ Dashboard ติดตามการใช้งบ
   ├─ แสดงงบใช้ไป/เหลือ
   ├─ แสดง items ที่ใกล้หมด/เกิน
   └─ สถิติการใช้งบ
```

---

## 🎯 สรุปสั้นๆ

### Budget System ทำ 3 เรื่องหลัก:

1. **📝 Planning** (ก่อนปีงบ)
   - สร้าง budget request
   - เพิ่มรายการยา + แบ่ง Q1-Q4
   - ตั้งค่า control (NONE/SOFT/HARD)
   - อนุมัติ → ได้ budget_allocations

2. **🛡️ Control** (ตลอดปี)
   - เช็คงบก่อนซื้อทุกครั้ง
   - Level 1: งบรวม (allocations)
   - Level 2: งบราย item (request_items + control)
   - HARD/SOFT/NONE แตกต่างกัน

3. **📊 Tracking** (ตลอดปี + สรุปท้ายปี)
   - อัพเดท purchased_qty เมื่อ PO approved
   - อัพเดท spent เมื่อ PO approved
   - Dashboard แสดงสถานะแบบ real-time
   - สรุปงบใช้ไป/เหลือ

---

**ครบวงจร:** วางแผน → ควบคุม → ติดตาม 🔄
