{
  "id": "snapshot_1766156118396_4lxwglwmi",
  "approvalId": "approval_1766156118321_dhh2k8gss",
  "approvalTitle": "Design: AegisX MCP Sync Automation",
  "version": 1,
  "timestamp": "2025-12-19T14:55:18.396Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design implements an automated synchronization system for aegisx-mcp that extracts metadata from aegisx-ui Angular components and aegisx-cli commands, then generates TypeScript data files. The system uses TypeScript compiler API for AST parsing, Node.js filesystem operations, and follows a modular extractor-generator pattern to ensure maintainability and extensibility.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **TypeScript-first**: All sync code written in TypeScript with strict typing\n- **Node.js ecosystem**: Uses TypeScript compiler API and built-in fs/path modules\n- **Zero runtime dependencies**: Leverages existing devDependencies only\n- **Build integration**: Integrates with existing TypeScript build pipeline\n\n### Project Structure (structure.md)\n\n- Sync tool lives in `libs/aegisx-mcp/scripts/sync/`\n- Generated files output to `libs/aegisx-mcp/src/data/`\n- Follows monorepo workspace structure with pnpm\n- Respects existing aegisx-mcp directory organization\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **TypeScript Compiler API** (`typescript` package): Already a devDependency in aegisx-mcp, will be used for AST parsing\n- **Node.js fs/path modules**: Built-in modules for file system operations\n- **aegisx-mcp existing interfaces**: Reuse ComponentInfo, CommandInfo, PackageInfo, CodePattern interfaces from current data files\n\n### Integration Points\n\n- **aegisx-mcp package.json**: Add `presync` and `sync` scripts\n- **aegisx-mcp build process**: Add sync step before `tsc` compilation\n- **aegisx-ui components**: Source of truth for component metadata\n- **aegisx-cli lib/**: Source of truth for command metadata\n\n## Architecture\n\nThe system follows a **Pipeline Architecture** with three distinct phases:\n\n1. **Extraction Phase**: Parse source files and extract metadata\n2. **Transformation Phase**: Convert extracted data to target interfaces\n3. **Generation Phase**: Write formatted TypeScript files\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each extractor handles one source type (components, commands, patterns)\n- **Component Isolation**: Extractors, generators, and utilities are independent modules\n- **Service Layer Separation**: Clear separation between file I/O, parsing, and generation\n- **Utility Modularity**: Shared utilities for AST parsing, file operations, and formatting\n\n```mermaid\ngraph TD\n    A[Sync Script Entry Point] --> B[Component Extractor]\n    A --> C[Command Extractor]\n    A --> D[Pattern Extractor]\n\n    B --> E[Component Metadata]\n    C --> F[Command Metadata]\n    D --> G[Pattern Metadata]\n\n    E --> H[Components Generator]\n    F --> I[Commands Generator]\n    G --> J[Patterns Generator]\n\n    H --> K[components.ts]\n    I --> L[crud-commands.ts]\n    J --> M[patterns.ts]\n\n    B -.-> N[TypeScript Parser Utility]\n    C -.-> N\n    D -.-> N\n\n    B -.-> O[JSDoc Parser Utility]\n    C -.-> O\n    D -.-> O\n\n    H -.-> P[Code Formatter Utility]\n    I -.-> P\n    J -.-> P\n```\n\n## Components and Interfaces\n\n### 1. Sync Script (sync.ts)\n\n- **Purpose:** Main entry point that orchestrates the sync process\n- **Location:** `libs/aegisx-mcp/scripts/sync/sync.ts`\n- **Responsibilities:**\n  - Parse command-line arguments (--dry-run, --verbose)\n  - Execute extractors in sequence\n  - Call generators with extracted data\n  - Report statistics and errors\n  - Exit with appropriate status code\n- **Interfaces:**\n  ```typescript\n  interface SyncOptions {\n    dryRun: boolean;\n    verbose: boolean;\n    projectRoot: string;\n  }\n\n  interface SyncResult {\n    componentsFound: number;\n    commandsFound: number;\n    patternsFound: number;\n    filesGenerated: string[];\n    errors: Error[];\n  }\n  ```\n- **Dependencies:** All extractors, all generators, utilities\n- **Reuses:** Node.js `process.argv`, path resolution\n\n### 2. Component Extractor (component-extractor.ts)\n\n- **Purpose:** Extract metadata from aegisx-ui Angular component files\n- **Location:** `libs/aegisx-mcp/scripts/sync/extractors/component-extractor.ts`\n- **Responsibilities:**\n  - Scan `libs/aegisx-ui/src/lib/components/` directory\n  - Parse TypeScript files using TS compiler API\n  - Extract @Component decorator metadata (selector, standalone, etc.)\n  - Extract @Input decorators (name, type, default, description from JSDoc)\n  - Extract @Output decorators (name, type, description from JSDoc)\n  - Parse JSDoc comments for usage examples and best practices\n  - Determine component category from directory structure\n- **Interfaces:**\n  ```typescript\n  interface ExtractedComponent {\n    name: string;\n    selector: string;\n    category: string;\n    description: string;\n    inputs: ExtractedInput[];\n    outputs: ExtractedOutput[];\n    usage: string;\n    bestPractices: string[];\n    relatedComponents: string[];\n    filePath: string; // For debugging\n  }\n\n  interface ExtractedInput {\n    name: string;\n    type: string;\n    default?: string;\n    description: string;\n    required: boolean;\n  }\n\n  interface ExtractedOutput {\n    name: string;\n    type: string;\n    description: string;\n  }\n  ```\n- **Dependencies:** TypeScript Parser Utility, JSDoc Parser Utility, File Scanner Utility\n- **Reuses:** Existing ComponentInfo interface structure\n\n### 3. Command Extractor (command-extractor.ts)\n\n- **Purpose:** Extract metadata from aegisx-cli command files and documentation\n- **Location:** `libs/aegisx-mcp/scripts/sync/extractors/command-extractor.ts`\n- **Responsibilities:**\n  - Scan `libs/aegisx-cli/lib/` for generator files\n  - Parse JavaScript files to extract command definitions\n  - Extract command names, descriptions, options from commander.js definitions\n  - Read `libs/aegisx-cli/docs/QUICK_REFERENCE.md` for additional context\n  - Extract package information (standard, enterprise, full)\n  - Parse usage examples from documentation\n- **Interfaces:**\n  ```typescript\n  interface ExtractedCommand {\n    name: string;\n    description: string;\n    usage: string;\n    options: ExtractedOption[];\n    examples: string[];\n    notes: string[];\n    filePath: string;\n  }\n\n  interface ExtractedOption {\n    name: string;\n    alias?: string;\n    type: 'boolean' | 'string' | 'number';\n    default?: string | boolean | number;\n    description: string;\n    choices?: string[];\n  }\n\n  interface ExtractedPackage {\n    name: string;\n    description: string;\n    features: string[];\n    useCases: string[];\n    command: string;\n  }\n  ```\n- **Dependencies:** TypeScript Parser Utility, Markdown Parser Utility, File Scanner Utility\n- **Reuses:** Existing CommandInfo and PackageInfo interface structures\n\n### 4. Pattern Extractor (pattern-extractor.ts)\n\n- **Purpose:** Extract development patterns from existing pattern definitions\n- **Location:** `libs/aegisx-mcp/scripts/sync/extractors/pattern-extractor.ts`\n- **Responsibilities:**\n  - Read current `libs/aegisx-mcp/src/data/patterns.ts` as baseline\n  - Validate pattern structure\n  - Allow for manual pattern additions\n  - Future: Extract patterns from codebase templates\n- **Interfaces:**\n  ```typescript\n  interface ExtractedPattern {\n    name: string;\n    category: 'backend' | 'frontend' | 'database' | 'testing';\n    description: string;\n    code: string;\n    language: string;\n    notes: string[];\n    relatedPatterns: string[];\n    filePath?: string;\n  }\n  ```\n- **Dependencies:** TypeScript Parser Utility, File Scanner Utility\n- **Reuses:** Existing CodePattern interface structure\n\n### 5. Components Generator (components-generator.ts)\n\n- **Purpose:** Generate `libs/aegisx-mcp/src/data/components.ts` from extracted data\n- **Location:** `libs/aegisx-mcp/scripts/sync/generators/components-generator.ts`\n- **Responsibilities:**\n  - Transform ExtractedComponent[] to ComponentInfo[] format\n  - Generate valid TypeScript code with proper imports\n  - Format code with consistent indentation and line breaks\n  - Add header comments with generation timestamp\n  - Preserve existing interface definitions\n- **Interfaces:**\n  ```typescript\n  interface GeneratorOptions {\n    outputPath: string;\n    dryRun: boolean;\n  }\n\n  interface GenerationResult {\n    filePath: string;\n    itemCount: number;\n    success: boolean;\n    error?: Error;\n  }\n  ```\n- **Dependencies:** Code Formatter Utility, File Writer Utility\n- **Reuses:** ComponentInfo interface from aegisx-mcp\n\n### 6. Commands Generator (commands-generator.ts)\n\n- **Purpose:** Generate `libs/aegisx-mcp/src/data/crud-commands.ts` from extracted data\n- **Location:** `libs/aegisx-mcp/scripts/sync/generators/commands-generator.ts`\n- **Responsibilities:**\n  - Transform ExtractedCommand[] and ExtractedPackage[] to target format\n  - Generate valid TypeScript with proper structure\n  - Format code consistently\n  - Add generation metadata\n- **Dependencies:** Code Formatter Utility, File Writer Utility\n- **Reuses:** CommandInfo and PackageInfo interfaces from aegisx-mcp\n\n### 7. Patterns Generator (patterns-generator.ts)\n\n- **Purpose:** Generate `libs/aegisx-mcp/src/data/patterns.ts` from extracted data\n- **Location:** `libs/aegisx-mcp/scripts/sync/generators/patterns-generator.ts`\n- **Responsibilities:**\n  - Transform ExtractedPattern[] to CodePattern[] format\n  - Generate valid TypeScript\n  - Preserve code snippets with proper escaping\n- **Dependencies:** Code Formatter Utility, File Writer Utility\n- **Reuses:** CodePattern interface from aegisx-mcp\n\n### Shared Utilities\n\n#### TypeScript Parser Utility (ts-parser.ts)\n\n- **Location:** `libs/aegisx-mcp/scripts/sync/utils/ts-parser.ts`\n- **Purpose:** Wrapper around TypeScript compiler API for common parsing tasks\n- **Functions:**\n  - `createSourceFile(filePath: string): ts.SourceFile`\n  - `findDecorator(node: ts.Node, name: string): ts.Decorator | undefined`\n  - `getDecoratorArguments(decorator: ts.Decorator): any[]`\n  - `getPropertyType(property: ts.PropertyDeclaration): string`\n  - `getPropertyInitializer(property: ts.PropertyDeclaration): string | undefined`\n\n#### JSDoc Parser Utility (jsdoc-parser.ts)\n\n- **Location:** `libs/aegisx-mcp/scripts/sync/utils/jsdoc-parser.ts`\n- **Purpose:** Extract and parse JSDoc comments from TypeScript nodes\n- **Functions:**\n  - `getJSDocComment(node: ts.Node): string`\n  - `getJSDocTags(node: ts.Node): Map<string, string>`\n  - `parseExampleTag(node: ts.Node): string | undefined`\n  - `parseDescriptionTag(node: ts.Node): string`\n\n#### File Scanner Utility (file-scanner.ts)\n\n- **Location:** `libs/aegisx-mcp/scripts/sync/utils/file-scanner.ts`\n- **Purpose:** Recursively scan directories for specific file patterns\n- **Functions:**\n  - `scanDirectory(dirPath: string, pattern: RegExp): string[]`\n  - `readFileContent(filePath: string): string`\n  - `isComponentFile(filePath: string): boolean`\n\n#### Code Formatter Utility (code-formatter.ts)\n\n- **Location:** `libs/aegisx-mcp/scripts/sync/utils/code-formatter.ts`\n- **Purpose:** Format generated TypeScript code consistently\n- **Functions:**\n  - `formatTypeScript(code: string): string`\n  - `addFileHeader(code: string, metadata: { generatedAt: Date }): string`\n  - `indentCode(code: string, level: number): string`\n\n#### File Writer Utility (file-writer.ts)\n\n- **Location:** `libs/aegisx-mcp/scripts/sync/utils/file-writer.ts`\n- **Purpose:** Safe file writing with validation\n- **Functions:**\n  - `writeFile(path: string, content: string, options: WriteOptions): Promise<void>`\n  - `validateTypeScript(code: string): boolean`\n  - `ensureDirectoryExists(dirPath: string): void`\n\n## Data Models\n\n### Generated File Structure\n\nAll generated files follow this structure:\n\n```typescript\n/**\n * [File Description]\n * Auto-generated by aegisx-mcp sync tool\n * DO NOT EDIT MANUALLY - Changes will be overwritten\n *\n * Generated: 2025-12-19T14:52:00.000Z\n * Source: [Source directory path]\n */\n\n// Interface definitions (if needed)\nexport interface [InterfaceName] {\n  // ...\n}\n\n// Data exports\nexport const [dataArrayName]: [InterfaceName][] = [\n  // Generated data items\n];\n\n// Additional exports (categories, helpers, etc.)\nexport const [helperName] = ...;\n```\n\n### Package.json Scripts\n\nAdd to `libs/aegisx-mcp/package.json`:\n\n```json\n{\n  \"scripts\": {\n    \"sync\": \"tsx scripts/sync/sync.ts\",\n    \"sync:dry-run\": \"tsx scripts/sync/sync.ts --dry-run\",\n    \"sync:verbose\": \"tsx scripts/sync/sync.ts --verbose\",\n    \"presync\": \"echo 'Starting aegisx-mcp sync...'\",\n    \"prebuild\": \"pnpm run sync\"\n  },\n  \"devDependencies\": {\n    \"tsx\": \"^4.7.0\"\n  }\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Source file not found**\n   - **Handling:** Log warning, continue with other files\n   - **User Impact:** Missing components/commands in generated data\n   - **Recovery:** Sync will succeed but report incomplete data\n\n2. **Malformed TypeScript/JSDoc**\n   - **Handling:** Catch parsing errors, log file path and error\n   - **User Impact:** Specific component/command skipped\n   - **Recovery:** Continue processing other files\n\n3. **Invalid component structure**\n   - **Handling:** Validate required fields, log validation errors\n   - **User Impact:** Component excluded from generated data\n   - **Recovery:** Proceed with valid components only\n\n4. **TypeScript compilation error in generated file**\n   - **Handling:** Validate generated code before writing\n   - **User Impact:** Build fails with clear error message\n   - **Recovery:** Manual fix required, dry-run helps prevent\n\n5. **File write permission error**\n   - **Handling:** Catch I/O errors, exit with status code 1\n   - **User Impact:** Sync fails, build cannot proceed\n   - **Recovery:** Check file permissions, retry\n\n6. **Missing dependencies (typescript, tsx)**\n   - **Handling:** Check for required packages on startup\n   - **User Impact:** Sync fails immediately with clear message\n   - **Recovery:** Run `pnpm install` in aegisx-mcp\n\n### Error Reporting Format\n\n```typescript\ninterface SyncError {\n  phase: 'extraction' | 'generation' | 'validation';\n  source: string; // File path or component name\n  message: string;\n  stack?: string;\n  recoverable: boolean;\n}\n```\n\nAll errors collected and reported at end of sync:\n\n```\n✖ Sync completed with errors:\n\nExtraction Phase:\n  • libs/aegisx-ui/src/lib/components/broken/broken.component.ts\n    Failed to parse decorator: Unexpected token\n\nGeneration Phase:\n  • libs/aegisx-mcp/src/data/components.ts\n    Generated code contains TypeScript errors\n\nSummary: 45 components found, 2 errors (1 recoverable)\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n**Tool:** Vitest (already in aegisx-mcp devDependencies)\n\n**Test Files:**\n- `scripts/sync/__tests__/component-extractor.test.ts`\n- `scripts/sync/__tests__/command-extractor.test.ts`\n- `scripts/sync/__tests__/pattern-extractor.test.ts`\n- `scripts/sync/__tests__/generators.test.ts`\n- `scripts/sync/__tests__/utilities.test.ts`\n\n**Coverage Requirements:**\n- Extractors: 80% coverage\n- Generators: 90% coverage (critical path)\n- Utilities: 85% coverage\n\n**Key Test Cases:**\n- Component extractor handles various decorator patterns\n- JSDoc parser extracts examples and descriptions\n- Generators produce valid TypeScript\n- Error handling gracefully skips invalid files\n- Dry-run mode doesn't write files\n\n### Integration Testing\n\n**Approach:** Test full sync process against sample data\n\n**Test Setup:**\n- Create `scripts/sync/__tests__/fixtures/` with sample components/commands\n- Mock file system operations where needed\n- Verify generated files match expected output\n\n**Key Flows:**\n1. Full sync: Extract from fixtures → Generate → Validate output\n2. Partial sync: Some invalid files → Gracefully skip → Report errors\n3. Dry-run: Extract → Generate (in memory) → No files written\n4. Verbose mode: Extract → Log detailed info → Generate\n\n### Manual Testing\n\n**Pre-release Checklist:**\n1. Run sync on actual aegisx-ui and aegisx-cli\n2. Verify generated files compile successfully\n3. Build aegisx-mcp: `pnpm run build`\n4. Test MCP server: `node dist/index.js`\n5. Verify components/commands accessible via MCP tools\n6. Check for missing components (compare against manual count)\n\n### Validation Testing\n\n**TypeScript Compilation:**\n- Generated files must pass `tsc --noEmit` check\n- All interfaces must match existing types\n- No `any` types in generated code\n\n**Data Integrity:**\n- All required fields present in generated data\n- No duplicate component selectors\n- Valid TypeScript syntax in code snippets\n\n## Performance Considerations\n\n### Optimization Strategies\n\n1. **Parallel Extraction:** Run component, command, and pattern extractors in parallel using `Promise.all()`\n2. **Incremental Updates (Future):** Only process files modified since last sync (requires cache mechanism)\n3. **Streaming Large Files:** Use streams for reading very large source files\n4. **Lazy AST Parsing:** Only parse files that match component/command patterns\n\n### Performance Targets\n\n- Full sync (cold): < 5 seconds\n- Full sync (warm cache, future): < 2 seconds\n- Memory usage: < 500MB peak\n- CPU usage: Multi-threaded extraction where beneficial\n\n### Monitoring\n\nLog performance metrics:\n```\nSync Performance:\n  • Component extraction: 1.2s (45 files)\n  • Command extraction: 0.8s (12 files)\n  • Pattern extraction: 0.1s (25 patterns)\n  • Generation: 0.3s (3 files)\n  • Total: 2.4s\n```\n\n## Build Integration\n\n### Pre-build Hook\n\nModify `libs/aegisx-mcp/package.json`:\n\n```json\n{\n  \"scripts\": {\n    \"prebuild\": \"pnpm run sync\",\n    \"build\": \"tsc\"\n  }\n}\n```\n\nThis ensures:\n1. Every build starts with fresh, synced data\n2. CI/CD pipelines automatically sync before deployment\n3. Local development stays in sync with source libraries\n\n### Development Workflow\n\n**Standard Development:**\n1. Modify aegisx-ui component or aegisx-cli command\n2. Run `pnpm run build` in aegisx-mcp\n3. Sync runs automatically (prebuild hook)\n4. Build compiles with updated data\n\n**Manual Sync:**\n1. Make changes to aegisx-ui or aegisx-cli\n2. Run `pnpm run sync` in aegisx-mcp to update data only\n3. Test changes without full build\n\n**Dry-run Preview:**\n1. Run `pnpm run sync:dry-run` to preview changes\n2. Review console output for extraction results\n3. Run `pnpm run sync` to apply changes\n\n## Future Enhancements\n\n### Phase 2 Improvements (Not in Initial Implementation)\n\n1. **Incremental Sync:** Cache file timestamps, only re-extract modified files\n2. **Watch Mode:** Auto-sync when source files change during development\n3. **Pattern Extraction from Templates:** Auto-discover patterns from aegisx-cli templates\n4. **Validation Rules:** Configurable rules for required component metadata\n5. **Sync Report:** Generate HTML report of sync results with statistics\n6. **Multi-workspace Support:** Sync from multiple monorepo packages\n\n### Configuration File (Future)\n\n```json\n// .aegisx-mcp-sync.json\n{\n  \"sources\": {\n    \"components\": \"libs/aegisx-ui/src/lib/components\",\n    \"commands\": \"libs/aegisx-cli/lib\",\n    \"patterns\": \"libs/aegisx-cli/templates\"\n  },\n  \"output\": {\n    \"components\": \"libs/aegisx-mcp/src/data/components.ts\",\n    \"commands\": \"libs/aegisx-mcp/src/data/crud-commands.ts\",\n    \"patterns\": \"libs/aegisx-mcp/src/data/patterns.ts\"\n  },\n  \"extraction\": {\n    \"ignorePatterns\": [\"**/*.spec.ts\", \"**/*.test.ts\"],\n    \"componentCategories\": {\n      \"data-display\": \"data-display\",\n      \"forms\": \"forms\"\n    }\n  },\n  \"validation\": {\n    \"requireDescription\": true,\n    \"requireUsageExample\": true,\n    \"requireBestPractices\": false\n  }\n}\n```\n\n## Migration Path\n\n### Transition Strategy\n\n1. **Phase 1:** Implement extractors and generators, run alongside manual updates\n2. **Validation:** Compare generated output with current data files for accuracy\n3. **Phase 2:** Replace manual data files with generated ones\n4. **Phase 3:** Remove manual update documentation, enforce generated-only approach\n\n### Rollback Plan\n\nIf sync fails:\n1. Keep backup of current data files in `src/data/.backup/`\n2. Sync errors exit with non-zero code, build fails\n3. Restore from backup: `cp src/data/.backup/* src/data/`\n4. Fix sync issues, retry\n\n## Security Considerations\n\n- **Input Validation:** Sanitize all extracted strings before code generation\n- **Code Injection Prevention:** No `eval()` or dynamic code execution\n- **Path Traversal:** Validate all file paths are within expected directories\n- **Dependency Security:** Only use trusted, well-maintained packages (TypeScript compiler API)\n- **Generated Code Review:** Manual spot-check of generated files before first release\n",
  "fileStats": {
    "size": 20396,
    "lines": 631,
    "lastModified": "2025-12-19T14:54:57.802Z"
  },
  "comments": []
}
