{
  "id": "snapshot_1765724379879_p5i3grt3p",
  "approvalId": "approval_1765724379870_p2h53rjm8",
  "approvalTitle": "Design - Drug Return Frontend UI",
  "version": 1,
  "timestamp": "2025-12-14T14:59:39.879Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Drug Return Frontend UI\n\n## Architecture Overview\n\nThe Drug Return Frontend UI follows Angular 18+ standalone component architecture with Signals-based reactive state management. The design implements a feature module with lazy loading, smart/dumb component pattern, comprehensive workflow dialogs for the 4-stage return process (Create → Verify → Post → Dispose), and real-time updates via WebSocket.\n\n### High-Level Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Drug Return Feature Module\"\n        Router[Drug Return Router]\n\n        subgraph \"Container Components (Smart)\"\n            ReturnDashboard[ReturnDashboardPage]\n            ReturnDetail[ReturnDetailPage]\n            CreateReturn[CreateReturnPage]\n            VerifyReturn[VerifyReturnPage]\n            QuarantineManagement[QuarantineManagementPage]\n            ReturnAnalytics[ReturnAnalyticsPage]\n        end\n\n        subgraph \"Presentation Components (Dumb)\"\n            ReturnTable[ReturnTableComponent]\n            QuickStats[QuickStatsComponent]\n            StatusBadge[StatusBadgeComponent]\n            ReturnItemsTable[ReturnItemsTableComponent]\n            TimelineComponent[AuditTimelineComponent]\n            QuarantineLotsTable[QuarantineLotsTableComponent]\n            AnalyticsCharts[AnalyticsChartsComponent]\n        end\n\n        subgraph \"Dialogs (Smart)\"\n            PostConfirmDialog[PostReturnConfirmationDialog]\n            ScheduleDisposalDialog[ScheduleDisposalDialog]\n            CompleteDisposalDialog[CompleteDisposalDialog]\n            LotPreviewDialog[LotPreviewDialog]\n            ReasonManagementDialog[ReasonManagementDialog]\n        end\n\n        subgraph \"Services\"\n            DrugReturnApi[DrugReturnApiService]\n            DrugReturnState[DrugReturnStateService]\n            DrugReturnWS[DrugReturnWebSocketService]\n            DisposalApi[DisposalApiService]\n        end\n\n        subgraph \"Models\"\n            Interfaces[TypeScript Interfaces]\n            Enums[Enums & Constants]\n            Validators[Custom Validators]\n        end\n    end\n\n    Router --> ReturnDashboard\n    Router --> ReturnDetail\n    Router --> CreateReturn\n    Router --> VerifyReturn\n    Router --> QuarantineManagement\n    Router --> ReturnAnalytics\n\n    ReturnDashboard --> ReturnTable\n    ReturnDashboard --> QuickStats\n\n    ReturnDetail --> ReturnItemsTable\n    ReturnDetail --> StatusBadge\n    ReturnDetail --> TimelineComponent\n    ReturnDetail --> PostConfirmDialog\n\n    CreateReturn --> ReturnItemsTable\n    VerifyReturn --> ReturnItemsTable\n\n    QuarantineManagement --> QuarantineLotsTable\n    QuarantineManagement --> ScheduleDisposalDialog\n    QuarantineManagement --> CompleteDisposalDialog\n\n    ReturnAnalytics --> AnalyticsCharts\n\n    ReturnDashboard --> DrugReturnState\n    ReturnDetail --> DrugReturnState\n    CreateReturn --> DrugReturnState\n    VerifyReturn --> DrugReturnState\n    QuarantineManagement --> DrugReturnState\n    DrugReturnState --> DrugReturnApi\n    DrugReturnState --> DisposalApi\n    DrugReturnState --> DrugReturnWS\n\n    DrugReturnApi --> Backend[Backend API - 15 Endpoints]\n    DisposalApi --> Backend\n    DrugReturnWS --> WSServer[WebSocket Server]\n```\n\n### Technology Stack\n\n- **Framework**: Angular 18+ (standalone components)\n- **State Management**: Angular Signals + RxJS (for async operations)\n- **UI Library**: AegisX UI + Angular Material\n- **Styling**: TailwindCSS with custom design tokens\n- **Forms**: Angular Reactive Forms with custom validators\n- **HTTP**: HttpClient with interceptors (auth, error handling)\n- **WebSocket**: Custom service with auto-reconnect and heartbeat\n- **Routing**: Feature-based lazy loading with route guards\n- **Date**: date-fns for formatting and calculations\n- **File Upload**: Custom upload service with progress tracking\n- **Export**: xlsx library for Excel export, jsPDF for PDF generation\n- **Validation**: Real-time quantity validation (total = good + damaged)\n\n---\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThis design follows AegisX technical standards:\n\n- **Component Architecture**: Standalone components with dependency injection\n- **State Management**: Signals for reactive state, RxJS for async flows\n- **API Integration**: TypeBox-validated backend contracts\n- **WebSocket Pattern**: Real-time updates with auto-reconnect\n- **Error Handling**: Centralized error interceptor + user-friendly messages\n- **Form Validation**: Reactive forms with custom validators\n- **Styling**: TailwindCSS utility-first approach\n\n### Project Structure (structure.md)\n\nFiles will follow project organization:\n\n```\napps/admin/src/app/\n├── features/\n│   └── drug-returns/\n│       ├── pages/\n│       │   ├── return-dashboard/\n│       │   ├── return-detail/\n│       │   ├── create-return/\n│       │   ├── verify-return/\n│       │   ├── quarantine-management/\n│       │   └── return-analytics/\n│       ├── components/\n│       │   ├── return-table/\n│       │   ├── return-items-table/\n│       │   ├── quick-stats/\n│       │   ├── status-badge/\n│       │   ├── audit-timeline/\n│       │   ├── quarantine-lots-table/\n│       │   └── analytics-charts/\n│       ├── dialogs/\n│       │   ├── post-confirmation/\n│       │   ├── schedule-disposal/\n│       │   ├── complete-disposal/\n│       │   ├── lot-preview/\n│       │   └── reason-management/\n│       ├── services/\n│       │   ├── drug-return-api.service.ts\n│       │   ├── drug-return-state.service.ts\n│       │   ├── drug-return-websocket.service.ts\n│       │   └── disposal-api.service.ts\n│       ├── models/\n│       │   ├── drug-return.interface.ts\n│       │   ├── drug-return-item.interface.ts\n│       │   ├── disposal.interface.ts\n│       │   └── enums.ts\n│       ├── validators/\n│       │   └── quantity-validators.ts\n│       └── drug-returns.routes.ts\n```\n\n---\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **AegisX UI Components**:\n  - `ax-table` - Data tables with sorting, filtering, pagination\n  - `ax-button` - Consistent button styling\n  - `ax-badge` - Status badges with color variants\n  - `ax-dialog` - Modal dialogs\n  - `ax-form` - Form layouts\n  - `ax-input` - Text inputs with validation\n  - `ax-select` - Dropdowns with search\n  - `ax-datepicker` - Date selection\n  - `ax-kpi-card` - Statistics cards\n  - `ax-skeleton` - Loading placeholders\n  - `ax-drawer` - Side panels\n\n- **Angular Material Components**:\n  - `mat-icon` - Icons\n  - `mat-tooltip` - Tooltips\n  - `mat-checkbox` - Checkboxes\n  - `mat-radio-group` - Radio buttons\n  - `mat-slide-toggle` - Toggle switches\n  - `MatDialog` - Dialog service\n\n- **Shared Services**:\n  - `AuthService` - User authentication and roles\n  - `NotificationService` - Toast notifications\n  - `ExportService` - Excel/PDF export\n  - `AttachmentService` - File upload/download\n  - `ErrorHandlerService` - Centralized error handling\n\n### Integration Points\n\n- **Backend API**: All API calls via `drug-return-backend-api` endpoints\n- **Inventory Module**: View inventory levels when creating returns\n- **Distribution Module**: View distribution history to verify return lots\n- **Master Data**: Departments, locations, return reasons\n- **Attachment System**: Upload disposal photos\n- **WebSocket**: Real-time status updates across all users\n- **Notification System**: Email/SMS notifications for workflow events\n\n---\n\n## Component Specifications\n\n### 1. ReturnDashboardPage (Container Component)\n\n**Path**: `apps/admin/src/app/features/drug-returns/pages/return-dashboard/return-dashboard.page.ts`\n\n**Responsibility**: Main dashboard for viewing all returns with filtering, search, and quick stats.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dr-return-dashboard-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    RouterModule,\n    ReturnTableComponent,\n    QuickStatsComponent,\n    AxSelect,\n    AxInput,\n    AxButton,\n    AxDateRangePicker,\n    AxSkeleton,\n  ],\n  templateUrl: './return-dashboard.page.html',\n})\nexport class ReturnDashboardPage implements OnInit, OnDestroy {\n  // Signals\n  returns = signal<DrugReturn[]>([]);\n  quickStats = computed(() => this.calculateStats(this.returns()));\n\n  // Filters\n  statusFilter = signal<ReturnStatus | 'ALL'>('ALL');\n  departmentFilter = signal<string | null>(null);\n  dateRange = signal<{ from: Date | null; to: Date | null }>({ from: null, to: null });\n  searchTerm = signal<string>('');\n  isLoading = signal<boolean>(false);\n\n  // Filtered returns\n  filteredReturns = computed(() => {\n    let items = this.returns();\n    const status = this.statusFilter();\n    const dept = this.departmentFilter();\n    const search = this.searchTerm().toLowerCase();\n    const dateRange = this.dateRange();\n\n    if (status !== 'ALL') {\n      items = items.filter((r) => r.status === status);\n    }\n\n    if (dept) {\n      items = items.filter((r) => r.departmentId === dept);\n    }\n\n    if (search) {\n      items = items.filter(\n        (r) =>\n          r.returnNumber.toLowerCase().includes(search) ||\n          r.department?.name.toLowerCase().includes(search)\n      );\n    }\n\n    if (dateRange.from && dateRange.to) {\n      items = items.filter((r) => {\n        const returnDate = new Date(r.returnDate);\n        return returnDate >= dateRange.from! && returnDate <= dateRange.to!;\n      });\n    }\n\n    return items;\n  });\n\n  // Master data\n  departments = signal<Department[]>([]);\n  currentUser = signal<User | null>(null);\n\n  constructor(\n    private drugReturnState: DrugReturnStateService,\n    private router: Router,\n    private authService: AuthService\n  ) {}\n\n  ngOnInit(): void {\n    this.loadCurrentUser();\n    this.loadReturns();\n    this.loadMasterData();\n    this.subscribeToRealtimeUpdates();\n  }\n\n  loadCurrentUser(): void {\n    this.currentUser.set(this.authService.currentUser());\n  }\n\n  loadReturns(): void {\n    this.isLoading.set(true);\n    this.drugReturnState.fetchDrugReturns().subscribe({\n      next: (data) => {\n        this.returns.set(data);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        this.handleError(err);\n      },\n    });\n  }\n\n  loadMasterData(): void {\n    // Load departments for filter\n    this.drugReturnState.fetchDepartments().subscribe({\n      next: (data) => this.departments.set(data),\n      error: (err) => this.handleError(err),\n    });\n  }\n\n  subscribeToRealtimeUpdates(): void {\n    this.drugReturnState.returnUpdates$\n      .pipe(takeUntilDestroyed(this.destroyRef))\n      .subscribe((update) => {\n        this.handleReturnUpdate(update);\n      });\n  }\n\n  onStatusFilterChange(status: ReturnStatus | 'ALL'): void {\n    this.statusFilter.set(status);\n  }\n\n  onDepartmentFilterChange(deptId: string | null): void {\n    this.departmentFilter.set(deptId);\n  }\n\n  onDateRangeChange(range: { from: Date | null; to: Date | null }): void {\n    this.dateRange.set(range);\n  }\n\n  onSearchChange(term: string): void {\n    this.searchTerm.set(term);\n  }\n\n  onCreateReturn(): void {\n    this.router.navigate(['/drug-returns/create']);\n  }\n\n  onViewReturn(drugReturn: DrugReturn): void {\n    this.router.navigate(['/drug-returns', drugReturn.id]);\n  }\n\n  onExportReport(): void {\n    this.drugReturnState.exportReturns(this.filteredReturns());\n  }\n\n  private calculateStats(items: DrugReturn[]): QuickStats {\n    return {\n      total: items.length,\n      pendingVerification: items.filter((r) => r.status === 'SUBMITTED').length,\n      verifiedToday: items.filter((r) => {\n        if (r.status === 'VERIFIED' || r.status === 'POSTED') {\n          const verifiedDate = r.verifiedAt ? new Date(r.verifiedAt) : null;\n          const today = new Date();\n          return (\n            verifiedDate &&\n            verifiedDate.getDate() === today.getDate() &&\n            verifiedDate.getMonth() === today.getMonth() &&\n            verifiedDate.getFullYear() === today.getFullYear()\n          );\n        }\n        return false;\n      }).length,\n      quarantineItems: 0, // Will be fetched separately\n    };\n  }\n\n  private handleReturnUpdate(update: ReturnUpdateEvent): void {\n    if (update.type === 'created') {\n      this.returns.update((items) => [update.return, ...items]);\n    } else if (update.type === 'updated') {\n      this.returns.update((items) =>\n        items.map((item) => (item.id === update.return.id ? update.return : item))\n      );\n    }\n  }\n\n  private handleError(error: any): void {\n    // Error handling delegated to ErrorHandlerService\n    console.error('Error in ReturnDashboardPage:', error);\n  }\n\n  ngOnDestroy(): void {\n    // Cleanup handled by takeUntilDestroyed\n  }\n}\n```\n\n**Template Structure**:\n\n```html\n<div class=\"return-dashboard-container p-6\">\n  <!-- Header -->\n  <div class=\"header-section mb-6 flex items-center justify-between\">\n    <h1 class=\"text-2xl font-bold text-gray-900\">Drug Returns</h1>\n    @if (currentUser()?.hasPermission('drug_return.create')) {\n      <ax-button color=\"primary\" (click)=\"onCreateReturn()\">\n        <mat-icon>add</mat-icon>\n        Create Return\n      </ax-button>\n    }\n  </div>\n\n  <!-- Quick Stats -->\n  <dr-quick-stats\n    [stats]=\"quickStats()\"\n    (statClick)=\"onStatusFilterChange($event)\"\n    class=\"mb-6\"\n  ></dr-quick-stats>\n\n  <!-- Filters -->\n  <div class=\"filter-section mb-6 grid grid-cols-1 md:grid-cols-4 gap-4\">\n    <ax-input\n      [(ngModel)]=\"searchTerm\"\n      (ngModelChange)=\"onSearchChange($event)\"\n      placeholder=\"Search by return number or department...\"\n      prefixIcon=\"search\"\n    ></ax-input>\n\n    <ax-select\n      [(ngModel)]=\"statusFilter\"\n      (ngModelChange)=\"onStatusFilterChange($event)\"\n      placeholder=\"All Status\"\n    >\n      <ax-option value=\"ALL\">All Status</ax-option>\n      <ax-option value=\"DRAFT\">Draft</ax-option>\n      <ax-option value=\"SUBMITTED\">Submitted</ax-option>\n      <ax-option value=\"VERIFIED\">Verified</ax-option>\n      <ax-option value=\"POSTED\">Posted</ax-option>\n      <ax-option value=\"CANCELLED\">Cancelled</ax-option>\n    </ax-select>\n\n    <ax-select\n      [(ngModel)]=\"departmentFilter\"\n      (ngModelChange)=\"onDepartmentFilterChange($event)\"\n      placeholder=\"All Departments\"\n    >\n      <ax-option [value]=\"null\">All Departments</ax-option>\n      @for (dept of departments(); track dept.id) {\n        <ax-option [value]=\"dept.id\">{{ dept.name }}</ax-option>\n      }\n    </ax-select>\n\n    <ax-date-range-picker\n      [(ngModel)]=\"dateRange\"\n      (ngModelChange)=\"onDateRangeChange($event)\"\n      placeholder=\"Select date range\"\n    ></ax-date-range-picker>\n  </div>\n\n  <!-- Return Table -->\n  @if (isLoading()) {\n    <ax-skeleton rows=\"10\"></ax-skeleton>\n  } @else {\n    <dr-return-table\n      [returns]=\"filteredReturns()\"\n      [currentUser]=\"currentUser()\"\n      (viewReturn)=\"onViewReturn($event)\"\n    ></dr-return-table>\n  }\n\n  <!-- Actions -->\n  <div class=\"actions-section mt-6\">\n    <ax-button variant=\"outline\" (click)=\"onExportReport()\">\n      <mat-icon>download</mat-icon>\n      Export to Excel\n    </ax-button>\n  </div>\n</div>\n```\n\n---\n\n### 2. CreateReturnPage (Container Component)\n\n**Path**: `apps/admin/src/app/features/drug-returns/pages/create-return/create-return.page.ts`\n\n**Responsibility**: Form for creating new drug return request with multiple items.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dr-create-return-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    ReactiveFormsModule,\n    ReturnItemsTableComponent,\n    AxForm,\n    AxInput,\n    AxSelect,\n    AxTextarea,\n    AxDatepicker,\n    AxButton,\n    AxRadioGroup,\n  ],\n  templateUrl: './create-return.page.html',\n})\nexport class CreateReturnPage implements OnInit {\n  returnForm: FormGroup;\n  itemsFormArray: FormArray;\n\n  // Master data\n  departments = signal<Department[]>([]);\n  locations = signal<Location[]>([]);\n  returnReasons = signal<ReturnReason[]>([]);\n  users = signal<User[]>([]);\n\n  // Item selection\n  availableDrugs = signal<Drug[]>([]);\n  availableLotsForDrug = signal<DrugLot[]>([]);\n\n  isLoading = signal<boolean>(false);\n  isSaving = signal<boolean>(false);\n\n  constructor(\n    private fb: FormBuilder,\n    private drugReturnState: DrugReturnStateService,\n    private router: Router,\n    private authService: AuthService,\n    private notificationService: NotificationService\n  ) {\n    this.returnForm = this.createReturnForm();\n    this.itemsFormArray = this.returnForm.get('items') as FormArray;\n  }\n\n  ngOnInit(): void {\n    this.loadMasterData();\n    this.prefillDefaults();\n  }\n\n  createReturnForm(): FormGroup {\n    return this.fb.group({\n      departmentId: [null, Validators.required],\n      toLocationId: [null, Validators.required],\n      returnDate: [new Date(), Validators.required],\n      returnBy: [null, Validators.required],\n      returnReason: ['', Validators.required],\n      notes: [''],\n      items: this.fb.array([], Validators.minLength(1)),\n    });\n  }\n\n  createItemFormGroup(): FormGroup {\n    return this.fb.group({\n      drugId: [null, Validators.required],\n      lotNumber: ['', Validators.required],\n      expiryDate: [{ value: null, disabled: true }],\n      totalQuantity: [null, [Validators.required, Validators.min(0.01)]],\n      unit: [{ value: '', disabled: true }],\n      condition: ['GOOD'], // Informational only\n      availableQuantity: [{ value: null, disabled: true }],\n    });\n  }\n\n  loadMasterData(): void {\n    this.isLoading.set(true);\n\n    forkJoin({\n      departments: this.drugReturnState.fetchDepartments(),\n      locations: this.drugReturnState.fetchLocations(),\n      returnReasons: this.drugReturnState.fetchReturnReasons(),\n      users: this.drugReturnState.fetchUsers(),\n    }).subscribe({\n      next: (data) => {\n        this.departments.set(data.departments);\n        this.locations.set(data.locations);\n        this.returnReasons.set(data.returnReasons.filter((r) => r.isActive));\n        this.users.set(data.users);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        this.handleError(err);\n      },\n    });\n  }\n\n  prefillDefaults(): void {\n    const currentUser = this.authService.currentUser();\n    if (currentUser) {\n      this.returnForm.patchValue({\n        departmentId: currentUser.departmentId,\n        returnBy: currentUser.id,\n        returnDate: new Date(),\n      });\n    }\n\n    // Default to Central Pharmacy\n    const centralPharmacy = this.locations().find((l) => l.code === 'CENTRAL_PHARMACY');\n    if (centralPharmacy) {\n      this.returnForm.patchValue({ toLocationId: centralPharmacy.id });\n    }\n  }\n\n  onAddItem(): void {\n    const itemGroup = this.createItemFormGroup();\n\n    // Watch for drug selection to load lots\n    itemGroup.get('drugId')?.valueChanges.subscribe((drugId) => {\n      if (drugId) {\n        this.loadLotsForDrug(drugId, itemGroup);\n      }\n    });\n\n    // Watch for lot selection to auto-fill expiry and unit\n    itemGroup.get('lotNumber')?.valueChanges.subscribe((lotNumber) => {\n      if (lotNumber) {\n        this.onLotSelected(lotNumber, itemGroup);\n      }\n    });\n\n    this.itemsFormArray.push(itemGroup);\n  }\n\n  onRemoveItem(index: number): void {\n    this.itemsFormArray.removeAt(index);\n  }\n\n  loadLotsForDrug(drugId: string, itemGroup: FormGroup): void {\n    const departmentId = this.returnForm.get('departmentId')?.value;\n    if (!departmentId) {\n      this.notificationService.showError('Please select department first');\n      return;\n    }\n\n    this.drugReturnState.fetchLotsForDrug(drugId, departmentId).subscribe({\n      next: (lots) => {\n        this.availableLotsForDrug.set(lots);\n      },\n      error: (err) => this.handleError(err),\n    });\n  }\n\n  onLotSelected(lotNumber: string, itemGroup: FormGroup): void {\n    const lot = this.availableLotsForDrug().find((l) => l.lotNumber === lotNumber);\n    if (lot) {\n      itemGroup.patchValue({\n        expiryDate: lot.expiryDate,\n        unit: lot.drug.unit,\n        availableQuantity: lot.quantityAvailable,\n      });\n\n      // Add validator to ensure return quantity doesn't exceed available\n      const qtyControl = itemGroup.get('totalQuantity');\n      qtyControl?.setValidators([\n        Validators.required,\n        Validators.min(0.01),\n        Validators.max(lot.quantityAvailable),\n      ]);\n      qtyControl?.updateValueAndValidity();\n    }\n  }\n\n  onSaveDraft(): void {\n    if (!this.validateForm()) {\n      return;\n    }\n\n    this.isSaving.set(true);\n    const formData = this.returnForm.getRawValue();\n    formData.status = 'DRAFT';\n\n    this.drugReturnState.createDrugReturn(formData).subscribe({\n      next: (result) => {\n        this.isSaving.set(false);\n        this.notificationService.showSuccess(\n          `Return draft saved: ${result.returnNumber}`\n        );\n        this.router.navigate(['/drug-returns', result.id]);\n      },\n      error: (err) => {\n        this.isSaving.set(false);\n        this.handleError(err);\n      },\n    });\n  }\n\n  onSubmitReturn(): void {\n    if (!this.validateForm()) {\n      return;\n    }\n\n    this.isSaving.set(true);\n    const formData = this.returnForm.getRawValue();\n    formData.status = 'SUBMITTED';\n\n    this.drugReturnState.createDrugReturn(formData).subscribe({\n      next: (result) => {\n        this.isSaving.set(false);\n        this.notificationService.showSuccess(\n          `Return submitted for verification: ${result.returnNumber}`\n        );\n        this.router.navigate(['/drug-returns', result.id]);\n      },\n      error: (err) => {\n        this.isSaving.set(false);\n        this.handleError(err);\n      },\n    });\n  }\n\n  validateForm(): boolean {\n    if (this.returnForm.invalid) {\n      this.returnForm.markAllAsTouched();\n      this.notificationService.showError('Please fill all required fields');\n      return false;\n    }\n\n    if (this.itemsFormArray.length === 0) {\n      this.notificationService.showError('Please add at least one item');\n      return false;\n    }\n\n    return true;\n  }\n\n  onCancel(): void {\n    if (confirm('Discard changes and return to dashboard?')) {\n      this.router.navigate(['/drug-returns']);\n    }\n  }\n\n  private handleError(error: any): void {\n    console.error('Error in CreateReturnPage:', error);\n  }\n}\n```\n\n---\n\n### 3. VerifyReturnPage (Container Component)\n\n**Path**: `apps/admin/src/app/features/drug-returns/pages/verify-return/verify-return.page.ts`\n\n**Responsibility**: Pharmacist verification form with good/damaged separation.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dr-verify-return-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    ReactiveFormsModule,\n    ReturnItemsTableComponent,\n    AxForm,\n    AxInput,\n    AxSelect,\n    AxTextarea,\n    AxDatepicker,\n    AxButton,\n  ],\n  templateUrl: './verify-return.page.html',\n})\nexport class VerifyReturnPage implements OnInit {\n  returnId = signal<string>('');\n  drugReturn = signal<DrugReturn | null>(null);\n  verificationForm: FormGroup;\n  itemsFormArray: FormArray;\n\n  isLoading = signal<boolean>(false);\n  isSaving = signal<boolean>(false);\n\n  // Validation\n  totalGoodQuantity = computed(() => {\n    return this.itemsFormArray.controls.reduce((sum, control) => {\n      return sum + (control.get('goodQuantity')?.value || 0);\n    }, 0);\n  });\n\n  totalDamagedQuantity = computed(() => {\n    return this.itemsFormArray.controls.reduce((sum, control) => {\n      return sum + (control.get('damagedQuantity')?.value || 0);\n    }, 0);\n  });\n\n  constructor(\n    private fb: FormBuilder,\n    private route: ActivatedRoute,\n    private router: Router,\n    private drugReturnState: DrugReturnStateService,\n    private authService: AuthService,\n    private notificationService: NotificationService\n  ) {\n    this.verificationForm = this.createVerificationForm();\n    this.itemsFormArray = this.verificationForm.get('items') as FormArray;\n  }\n\n  ngOnInit(): void {\n    this.route.params.subscribe((params) => {\n      this.returnId.set(params['id']);\n      this.loadReturn();\n    });\n  }\n\n  createVerificationForm(): FormGroup {\n    return this.fb.group({\n      verifiedBy: [null, Validators.required],\n      verifiedDate: [new Date(), Validators.required],\n      verificationNotes: [''],\n      items: this.fb.array([]),\n    });\n  }\n\n  createItemVerificationFormGroup(item: DrugReturnItem): FormGroup {\n    const group = this.fb.group({\n      itemId: [item.id],\n      drugName: [{ value: item.drug.name, disabled: true }],\n      lotNumber: [{ value: item.lotNumber, disabled: true }],\n      expiryDate: [{ value: item.expiryDate, disabled: true }],\n      claimedQuantity: [{ value: item.totalQuantity, disabled: true }],\n      actualQuantity: [\n        item.totalQuantity,\n        [Validators.required, Validators.min(0)],\n      ],\n      goodQuantity: [0, [Validators.required, Validators.min(0)]],\n      damagedQuantity: [0, [Validators.required, Validators.min(0)]],\n      itemNotes: [''],\n    });\n\n    // Real-time validation: good + damaged = actual\n    group.get('actualQuantity')?.valueChanges.subscribe((actual) => {\n      this.validateQuantities(group);\n    });\n\n    group.get('goodQuantity')?.valueChanges.subscribe(() => {\n      this.validateQuantities(group);\n    });\n\n    group.get('damagedQuantity')?.valueChanges.subscribe(() => {\n      this.validateQuantities(group);\n    });\n\n    return group;\n  }\n\n  validateQuantities(itemGroup: FormGroup): void {\n    const actual = itemGroup.get('actualQuantity')?.value || 0;\n    const good = itemGroup.get('goodQuantity')?.value || 0;\n    const damaged = itemGroup.get('damagedQuantity')?.value || 0;\n    const sum = good + damaged;\n\n    const goodControl = itemGroup.get('goodQuantity');\n    const damagedControl = itemGroup.get('damagedQuantity');\n\n    if (Math.abs(sum - actual) > 0.001) {\n      goodControl?.setErrors({ quantityMismatch: true });\n      damagedControl?.setErrors({ quantityMismatch: true });\n    } else {\n      // Clear quantity mismatch error, but preserve other errors\n      const goodErrors = { ...goodControl?.errors };\n      const damagedErrors = { ...damagedControl?.errors };\n      delete goodErrors?.['quantityMismatch'];\n      delete damagedErrors?.['quantityMismatch'];\n\n      goodControl?.setErrors(\n        Object.keys(goodErrors).length > 0 ? goodErrors : null\n      );\n      damagedControl?.setErrors(\n        Object.keys(damagedErrors).length > 0 ? damagedErrors : null\n      );\n    }\n  }\n\n  loadReturn(): void {\n    this.isLoading.set(true);\n    this.drugReturnState.fetchDrugReturnById(this.returnId()).subscribe({\n      next: (data) => {\n        this.drugReturn.set(data);\n\n        if (data.status !== 'SUBMITTED') {\n          this.notificationService.showError(\n            'Only SUBMITTED returns can be verified'\n          );\n          this.router.navigate(['/drug-returns', data.id]);\n          return;\n        }\n\n        this.populateForm(data);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        this.handleError(err);\n      },\n    });\n  }\n\n  populateForm(drugReturn: DrugReturn): void {\n    const currentUser = this.authService.currentUser();\n    this.verificationForm.patchValue({\n      verifiedBy: currentUser?.id,\n      verifiedDate: new Date(),\n    });\n\n    // Populate items\n    drugReturn.items.forEach((item) => {\n      this.itemsFormArray.push(this.createItemVerificationFormGroup(item));\n    });\n  }\n\n  onRejectReturn(): void {\n    const reason = prompt('Enter reason for rejection:');\n    if (!reason) {\n      return;\n    }\n\n    if (confirm('Reject this return and send back to department?')) {\n      this.drugReturnState\n        .rejectDrugReturn(this.returnId(), reason)\n        .subscribe({\n          next: () => {\n            this.notificationService.showSuccess('Return rejected');\n            this.router.navigate(['/drug-returns']);\n          },\n          error: (err) => this.handleError(err),\n        });\n    }\n  }\n\n  onSaveProgress(): void {\n    if (this.verificationForm.invalid) {\n      this.verificationForm.markAllAsTouched();\n      this.notificationService.showError('Please fill all required fields');\n      return;\n    }\n\n    this.isSaving.set(true);\n    const formData = this.verificationForm.getRawValue();\n\n    this.drugReturnState\n      .saveVerificationProgress(this.returnId(), formData)\n      .subscribe({\n        next: () => {\n          this.isSaving.set(false);\n          this.notificationService.showSuccess('Progress saved');\n        },\n        error: (err) => {\n          this.isSaving.set(false);\n          this.handleError(err);\n        },\n      });\n  }\n\n  onCompleteVerification(): void {\n    if (!this.validateVerificationForm()) {\n      return;\n    }\n\n    this.isSaving.set(true);\n    const formData = this.verificationForm.getRawValue();\n\n    this.drugReturnState\n      .verifyDrugReturn(this.returnId(), formData)\n      .subscribe({\n        next: () => {\n          this.isSaving.set(false);\n          this.notificationService.showSuccess(\n            'Verification complete. Return ready to post.'\n          );\n          this.router.navigate(['/drug-returns', this.returnId()]);\n        },\n        error: (err) => {\n          this.isSaving.set(false);\n          this.handleError(err);\n        },\n      });\n  }\n\n  validateVerificationForm(): boolean {\n    if (this.verificationForm.invalid) {\n      this.verificationForm.markAllAsTouched();\n      this.notificationService.showError(\n        'Please correct all validation errors'\n      );\n      return false;\n    }\n\n    // Check all items have valid quantities\n    for (const control of this.itemsFormArray.controls) {\n      const actual = control.get('actualQuantity')?.value || 0;\n      const good = control.get('goodQuantity')?.value || 0;\n      const damaged = control.get('damagedQuantity')?.value || 0;\n\n      if (Math.abs(good + damaged - actual) > 0.001) {\n        this.notificationService.showError(\n          'Good + Damaged must equal Actual quantity for all items'\n        );\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  private handleError(error: any): void {\n    console.error('Error in VerifyReturnPage:', error);\n  }\n}\n```\n\n---\n\n### 4. QuarantineManagementPage (Container Component)\n\n**Path**: `apps/admin/src/app/features/drug-returns/pages/quarantine-management/quarantine-management.page.ts`\n\n**Responsibility**: View and manage quarantine lots, schedule disposals.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dr-quarantine-management-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    QuarantineLotsTableComponent,\n    QuickStatsComponent,\n    ScheduleDisposalDialog,\n    CompleteDisposalDialog,\n    AxSelect,\n    AxButton,\n    AxDateRangePicker,\n    AxCheckbox,\n  ],\n  templateUrl: './quarantine-management.page.html',\n})\nexport class QuarantineManagementPage implements OnInit {\n  quarantineLots = signal<QuarantineLot[]>([]);\n  selectedLots = signal<Set<string>>(new Set());\n\n  quickStats = computed(() => this.calculateStats(this.quarantineLots()));\n\n  // Filters\n  disposalStatusFilter = signal<DisposalStatus | 'ALL'>('ALL');\n  dateRange = signal<{ from: Date | null; to: Date | null }>({\n    from: null,\n    to: null,\n  });\n\n  filteredLots = computed(() => {\n    let items = this.quarantineLots();\n    const status = this.disposalStatusFilter();\n    const dateRange = this.dateRange();\n\n    if (status !== 'ALL') {\n      items = items.filter((lot) => lot.disposalStatus === status);\n    }\n\n    if (dateRange.from && dateRange.to) {\n      items = items.filter((lot) => {\n        const receivedDate = new Date(lot.receivedDate);\n        return receivedDate >= dateRange.from! && receivedDate <= dateRange.to!;\n      });\n    }\n\n    return items;\n  });\n\n  isLoading = signal<boolean>(false);\n\n  constructor(\n    private drugReturnState: DrugReturnStateService,\n    private dialog: MatDialog\n  ) {}\n\n  ngOnInit(): void {\n    this.loadQuarantineLots();\n    this.subscribeToRealtimeUpdates();\n  }\n\n  loadQuarantineLots(): void {\n    this.isLoading.set(true);\n    this.drugReturnState.fetchQuarantineLots().subscribe({\n      next: (data) => {\n        this.quarantineLots.set(data);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        this.handleError(err);\n      },\n    });\n  }\n\n  subscribeToRealtimeUpdates(): void {\n    this.drugReturnState.quarantineUpdates$\n      .pipe(takeUntilDestroyed(this.destroyRef))\n      .subscribe((update) => {\n        this.handleQuarantineUpdate(update);\n      });\n  }\n\n  onDisposalStatusFilterChange(status: DisposalStatus | 'ALL'): void {\n    this.disposalStatusFilter.set(status);\n  }\n\n  onDateRangeChange(range: { from: Date | null; to: Date | null }): void {\n    this.dateRange.set(range);\n  }\n\n  onToggleSelectAll(checked: boolean): void {\n    if (checked) {\n      const allIds = this.filteredLots().map((lot) => lot.id);\n      this.selectedLots.set(new Set(allIds));\n    } else {\n      this.selectedLots.set(new Set());\n    }\n  }\n\n  onToggleSelectLot(lotId: string, checked: boolean): void {\n    const selected = new Set(this.selectedLots());\n    if (checked) {\n      selected.add(lotId);\n    } else {\n      selected.delete(lotId);\n    }\n    this.selectedLots.set(selected);\n  }\n\n  onScheduleDisposal(): void {\n    if (this.selectedLots().size === 0) {\n      this.notificationService.showError('Please select at least one lot');\n      return;\n    }\n\n    const dialogRef = this.dialog.open(ScheduleDisposalDialog, {\n      width: '800px',\n      data: {\n        selectedLotIds: Array.from(this.selectedLots()),\n        lots: this.quarantineLots().filter((lot) =>\n          this.selectedLots().has(lot.id)\n        ),\n      },\n    });\n\n    dialogRef.afterClosed().subscribe((result) => {\n      if (result?.success) {\n        this.selectedLots.set(new Set());\n        this.loadQuarantineLots();\n      }\n    });\n  }\n\n  private calculateStats(lots: QuarantineLot[]): QuarantineStats {\n    return {\n      totalItems: lots.length,\n      totalValue: lots.reduce(\n        (sum, lot) => sum + lot.quantity * lot.unitCost,\n        0\n      ),\n      pendingDisposal: lots.filter((lot) => lot.disposalStatus === 'PENDING')\n        .length,\n      disposedThisMonth: lots.filter((lot) => {\n        if (lot.disposalStatus === 'COMPLETED' && lot.disposalDate) {\n          const disposalDate = new Date(lot.disposalDate);\n          const now = new Date();\n          return (\n            disposalDate.getMonth() === now.getMonth() &&\n            disposalDate.getFullYear() === now.getFullYear()\n          );\n        }\n        return false;\n      }).length,\n    };\n  }\n\n  private handleQuarantineUpdate(update: QuarantineUpdateEvent): void {\n    this.loadQuarantineLots();\n  }\n\n  private handleError(error: any): void {\n    console.error('Error in QuarantineManagementPage:', error);\n  }\n}\n```\n\n---\n\n## Data Models and Interfaces\n\n**Path**: `apps/admin/src/app/features/drug-returns/models/`\n\n### drug-return.interface.ts\n\n```typescript\nexport interface DrugReturn {\n  id: string;\n  returnNumber: string;\n  departmentId: string;\n  department?: Department;\n  toLocationId: string;\n  toLocation?: Location;\n  returnDate: Date;\n  returnBy: string;\n  returnByUser?: User;\n  returnReason: string;\n  status: ReturnStatus;\n  totalItems: number;\n  totalAmount: number;\n  verifiedBy?: string;\n  verifiedByUser?: User;\n  verifiedAt?: Date;\n  receivedBy?: string;\n  receivedByUser?: User;\n  actionTaken?: string;\n  notes?: string;\n  items: DrugReturnItem[];\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface DrugReturnItem {\n  id: string;\n  returnId: string;\n  drugId: string;\n  drug: Drug;\n  totalQuantity: number;\n  goodQuantity: number;\n  damagedQuantity: number;\n  lotNumber: string;\n  expiryDate: Date;\n  returnType: 'PURCHASED' | 'FREE';\n  locationId: string;\n  location?: Location;\n  notes?: string;\n}\n\nexport enum ReturnStatus {\n  DRAFT = 'DRAFT',\n  SUBMITTED = 'SUBMITTED',\n  VERIFIED = 'VERIFIED',\n  POSTED = 'POSTED',\n  CANCELLED = 'CANCELLED',\n}\n\nexport interface QuickStats {\n  total: number;\n  pendingVerification: number;\n  verifiedToday: number;\n  quarantineItems: number;\n}\n```\n\n### disposal.interface.ts\n\n```typescript\nexport interface QuarantineLot {\n  id: string;\n  drugId: string;\n  drug: Drug;\n  lotNumber: string;\n  quantity: number;\n  unitCost: number;\n  expiryDate: Date;\n  receivedDate: Date;\n  daysInQuarantine: number;\n  sourceReturnId: string;\n  sourceReturn?: DrugReturn;\n  disposalStatus: DisposalStatus;\n  disposalDate?: Date;\n  notes?: string;\n}\n\nexport enum DisposalStatus {\n  PENDING = 'PENDING',\n  SCHEDULED = 'SCHEDULED',\n  COMPLETED = 'COMPLETED',\n}\n\nexport interface Disposal {\n  id: string;\n  disposalDate: Date;\n  disposalMethod: string;\n  committeeMembers: string[];\n  totalItems: number;\n  totalQuantity: number;\n  notes?: string;\n  status: DisposalStatus;\n  completedAt?: Date;\n  photoEvidence?: string[];\n  items: DisposalItem[];\n}\n\nexport interface DisposalItem {\n  id: string;\n  disposalId: string;\n  lotId: string;\n  lot?: QuarantineLot;\n  drugId: string;\n  drug?: Drug;\n  quantityDisposed: number;\n  lotNumber: string;\n  expiryDate: Date;\n}\n\nexport interface QuarantineStats {\n  totalItems: number;\n  totalValue: number;\n  pendingDisposal: number;\n  disposedThisMonth: number;\n}\n```\n\n---\n\n## Services\n\n### DrugReturnApiService\n\n**Path**: `apps/admin/src/app/features/drug-returns/services/drug-return-api.service.ts`\n\n**Responsibility**: HTTP API calls to backend.\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class DrugReturnApiService {\n  private readonly baseUrl = `${environment.apiUrl}/inventory/operations/drug-returns`;\n\n  constructor(private http: HttpClient) {}\n\n  // CRUD\n  getDrugReturns(filters?: any): Observable<DrugReturn[]> {\n    return this.http.get<DrugReturn[]>(this.baseUrl, { params: filters });\n  }\n\n  getDrugReturnById(id: string): Observable<DrugReturn> {\n    return this.http.get<DrugReturn>(`${this.baseUrl}/${id}`);\n  }\n\n  createDrugReturn(data: CreateDrugReturnDto): Observable<DrugReturn> {\n    return this.http.post<DrugReturn>(this.baseUrl, data);\n  }\n\n  updateDrugReturn(id: string, data: UpdateDrugReturnDto): Observable<DrugReturn> {\n    return this.http.put<DrugReturn>(`${this.baseUrl}/${id}`, data);\n  }\n\n  deleteDrugReturn(id: string): Observable<void> {\n    return this.http.delete<void>(`${this.baseUrl}/${id}`);\n  }\n\n  // Workflows\n  submitReturn(id: string): Observable<DrugReturn> {\n    return this.http.post<DrugReturn>(`${this.baseUrl}/${id}/submit`, {});\n  }\n\n  verifyReturn(id: string, data: VerifyReturnDto): Observable<DrugReturn> {\n    return this.http.post<DrugReturn>(`${this.baseUrl}/${id}/verify`, data);\n  }\n\n  rejectReturn(id: string, reason: string): Observable<DrugReturn> {\n    return this.http.post<DrugReturn>(`${this.baseUrl}/${id}/reject`, { reason });\n  }\n\n  postReturn(id: string): Observable<DrugReturn> {\n    return this.http.post<DrugReturn>(`${this.baseUrl}/${id}/post`, {});\n  }\n\n  // Analytics\n  getAnalytics(filters: any): Observable<ReturnAnalytics> {\n    return this.http.get<ReturnAnalytics>(`${this.baseUrl}/analytics`, { params: filters });\n  }\n}\n```\n\n### DrugReturnWebSocketService\n\n**Path**: `apps/admin/src/app/features/drug-returns/services/drug-return-websocket.service.ts`\n\n**Responsibility**: Real-time updates via WebSocket.\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class DrugReturnWebSocketService {\n  private socket: WebSocket | null = null;\n  private readonly wsUrl = `${environment.wsUrl}/drug-returns`;\n\n  private returnUpdatesSubject = new Subject<ReturnUpdateEvent>();\n  public returnUpdates$ = this.returnUpdatesSubject.asObservable();\n\n  private quarantineUpdatesSubject = new Subject<QuarantineUpdateEvent>();\n  public quarantineUpdates$ = this.quarantineUpdatesSubject.asObservable();\n\n  constructor(private authService: AuthService) {\n    this.connect();\n  }\n\n  connect(): void {\n    const token = this.authService.getToken();\n    this.socket = new WebSocket(`${this.wsUrl}?token=${token}`);\n\n    this.socket.onmessage = (event) => {\n      const message = JSON.parse(event.data);\n      this.handleMessage(message);\n    };\n\n    this.socket.onerror = (error) => {\n      console.error('WebSocket error:', error);\n    };\n\n    this.socket.onclose = () => {\n      console.log('WebSocket closed. Reconnecting in 5s...');\n      setTimeout(() => this.connect(), 5000);\n    };\n  }\n\n  private handleMessage(message: any): void {\n    if (message.type === 'return.created' || message.type === 'return.updated') {\n      this.returnUpdatesSubject.next(message);\n    } else if (message.type === 'quarantine.updated') {\n      this.quarantineUpdatesSubject.next(message);\n    }\n  }\n\n  disconnect(): void {\n    if (this.socket) {\n      this.socket.close();\n      this.socket = null;\n    }\n  }\n}\n```\n\n---\n\n## Routing Configuration\n\n**Path**: `apps/admin/src/app/features/drug-returns/drug-returns.routes.ts`\n\n```typescript\nimport { Routes } from '@angular/router';\nimport { AuthGuard } from '@/core/guards/auth.guard';\nimport { RoleGuard } from '@/core/guards/role.guard';\n\nexport const drugReturnsRoutes: Routes = [\n  {\n    path: '',\n    canActivate: [AuthGuard],\n    children: [\n      {\n        path: '',\n        loadComponent: () =>\n          import('./pages/return-dashboard/return-dashboard.page').then(\n            (m) => m.ReturnDashboardPage\n          ),\n      },\n      {\n        path: 'create',\n        canActivate: [RoleGuard],\n        data: { requiredPermission: 'drug_return.create' },\n        loadComponent: () =>\n          import('./pages/create-return/create-return.page').then(\n            (m) => m.CreateReturnPage\n          ),\n      },\n      {\n        path: ':id',\n        loadComponent: () =>\n          import('./pages/return-detail/return-detail.page').then(\n            (m) => m.ReturnDetailPage\n          ),\n      },\n      {\n        path: ':id/verify',\n        canActivate: [RoleGuard],\n        data: { requiredPermission: 'drug_return.verify' },\n        loadComponent: () =>\n          import('./pages/verify-return/verify-return.page').then(\n            (m) => m.VerifyReturnPage\n          ),\n      },\n      {\n        path: 'quarantine/management',\n        canActivate: [RoleGuard],\n        data: { requiredPermission: 'drug_return.quarantine.view' },\n        loadComponent: () =>\n          import('./pages/quarantine-management/quarantine-management.page').then(\n            (m) => m.QuarantineManagementPage\n          ),\n      },\n      {\n        path: 'analytics',\n        canActivate: [RoleGuard],\n        data: { requiredPermission: 'drug_return.analytics.view' },\n        loadComponent: () =>\n          import('./pages/return-analytics/return-analytics.page').then(\n            (m) => m.ReturnAnalyticsPage\n          ),\n      },\n    ],\n  },\n];\n```\n\n---\n\n## Error Handling Strategy\n\n### API Error Interceptor\n\n```typescript\n@Injectable()\nexport class DrugReturnErrorInterceptor implements HttpInterceptor {\n  constructor(private notificationService: NotificationService) {}\n\n  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n    return next.handle(req).pipe(\n      catchError((error: HttpErrorResponse) => {\n        if (error.status === 400 && error.error?.validationErrors) {\n          // Display field-specific validation errors\n          Object.keys(error.error.validationErrors).forEach((field) => {\n            this.notificationService.showError(\n              `${field}: ${error.error.validationErrors[field]}`\n            );\n          });\n        } else if (error.status === 401) {\n          this.notificationService.showError('Session expired. Please log in.');\n        } else if (error.status === 403) {\n          this.notificationService.showError(\n            'You do not have permission to perform this action'\n          );\n        } else if (error.status === 500) {\n          this.notificationService.showError(\n            'An error occurred. Please try again or contact support.'\n          );\n        } else {\n          this.notificationService.showError(\n            error.error?.message || 'An unexpected error occurred'\n          );\n        }\n\n        return throwError(() => error);\n      })\n    );\n  }\n}\n```\n\n---\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Component Tests**: Test all container and presentation components with Jasmine/Karma\n- **Service Tests**: Mock HttpClient for API services, test all methods\n- **Validator Tests**: Test custom quantity validators\n- **Computed Signal Tests**: Test all computed values\n\n### Integration Testing\n\n- **Form Integration**: Test complete create/verify workflows with mock backend\n- **WebSocket Integration**: Test real-time update handling\n- **Route Guard Integration**: Test permission-based navigation\n\n### End-to-End Testing\n\n- **Critical Workflows**:\n  - Create return → Submit → Verify → Post (full cycle)\n  - Quarantine lot disposal workflow\n  - Analytics report generation\n- **Tools**: Playwright or Cypress\n- **Coverage**: All user journeys for Ward Staff and Pharmacist roles\n\n---\n\n## Performance Optimization\n\n### Lazy Loading\n\n- Feature module lazy loaded via Angular router\n- Dialog components lazy loaded on-demand\n\n### Virtual Scrolling\n\n- Large tables (>100 rows) use CDK Virtual Scroll\n\n### Signal-Based Reactivity\n\n- Computed signals for derived state (no manual subscriptions)\n- Fine-grained reactivity reduces unnecessary re-renders\n\n### WebSocket Optimization\n\n- Auto-reconnect with exponential backoff\n- Heartbeat to detect stale connections\n- Selective subscriptions based on user role and department\n\n### Image Optimization\n\n- Lazy load disposal photos\n- Compress images before upload (client-side)\n- Display thumbnails, full size on click\n\n---\n\n## Accessibility (WCAG 2.1 AA Compliance)\n\n### Keyboard Navigation\n\n- All interactive elements keyboard accessible\n- Focus indicators visible (outline with theme color)\n- Dialogs support Escape key to close\n\n### Screen Reader Support\n\n- ARIA labels on all form inputs\n- ARIA live regions for toast notifications\n- Table headers properly associated with cells\n- Button labels descriptive (not just \"Submit\")\n\n### Color Contrast\n\n- Status badges meet 4.5:1 contrast ratio\n- Error messages use color + icon + text\n\n### Form Accessibility\n\n- Labels associated with inputs via `for` attribute\n- Error messages announced to screen readers\n- Required fields marked with `aria-required`\n\n---\n\n## Summary\n\nThis design document provides a comprehensive architecture for the Drug Return Frontend UI, leveraging AegisX UI components, Angular Material, and TailwindCSS to deliver a modern, accessible, and user-friendly interface. The design emphasizes:\n\n- **Workflow-driven UX**: Clear separation of create, verify, post, and disposal phases\n- **Real-time updates**: WebSocket integration for immediate status changes\n- **Role-based access**: Proper segregation of duties between ward staff, pharmacists, and committee members\n- **Data validation**: Real-time quantity validation (good + damaged = total)\n- **Comprehensive error handling**: User-friendly messages with technical details for support\n- **Performance optimization**: Lazy loading, virtual scrolling, signal-based reactivity\n- **Accessibility compliance**: WCAG 2.1 AA standards for inclusive design\n\nThe implementation follows Angular 18+ best practices with standalone components, Signals-based state management, and full integration with the drug-return-backend-api.\n",
  "fileStats": {
    "size": 47588,
    "lines": 1662,
    "lastModified": "2025-12-14T14:59:26.784Z"
  },
  "comments": []
}
