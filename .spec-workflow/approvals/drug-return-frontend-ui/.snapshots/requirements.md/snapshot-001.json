{
  "id": "snapshot_1765723259336_bzbazbf2c",
  "approvalId": "approval_1765723259319_9dd4feog3",
  "approvalTitle": "Requirements - Drug Return Frontend UI",
  "version": 1,
  "timestamp": "2025-12-14T14:40:59.336Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document - Drug Return Frontend UI\n\n## Introduction\n\nThe Drug Return Frontend UI provides an intuitive, workflow-driven interface for hospital departments and pharmacy staff to manage drug returns efficiently. This Angular-based application integrates with the drug-return-backend-api to deliver a complete drug return lifecycle from creation through disposal, with real-time status updates and comprehensive audit trails.\n\n**Purpose:** Enable efficient drug return management through user-friendly workflows that support pharmacy verification, good/damaged separation, and quarantine management while maintaining full traceability.\n\n**Value to Users:**\n\n- Streamlined return request creation with lot number tracking\n- Clear verification workflow for pharmacist inspection\n- Automated good/damaged separation with inventory integration\n- Real-time status updates for all stakeholders\n- Complete visibility of quarantine stock and disposal processes\n- Full audit trail for compliance and accountability\n\n## Alignment with Product Vision\n\nThis feature aligns with INVS Modern's core objectives:\n\n1. **Enhance Inventory Accuracy**: Proper return processing ensures inventory records match physical stock, especially for returned drugs\n2. **Minimize Drug Waste**: Early detection and systematic handling of damaged/expired drugs reduces losses (target: 25% reduction in untracked waste)\n3. **Support Data-Driven Decisions**: Comprehensive return analytics help identify patterns and optimize procurement\n4. **Ensure Compliance**: Complete audit trail for all returns meets Ministry of Public Health requirements\n5. **Improve User Experience**: Intuitive workflows reduce training time and processing errors\n\n## Requirements\n\n### REQ-1: Return Dashboard\n\n**User Story:** As a ward staff or pharmacist, I want to view all drug returns with status filtering, so that I can track and manage returns efficiently.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Return Dashboard **THEN** system **SHALL** display:\n   - Quick stats summary (Total Returns, Pending Verification, Verified Today, Quarantine Items)\n   - Return list table with columns: Return Number, Department, Date, Status, Total Items, Total Value, Actions\n   - Status filter buttons (All/Draft/Submitted/Verified/Posted/Cancelled)\n   - Date range picker\n   - Search bar (by return number, department name)\n   - Department filter dropdown (if user has access to multiple departments)\n\n2. **WHEN** status is DRAFT **THEN** system **SHALL** display badge with üìù gray color\n3. **WHEN** status is SUBMITTED **THEN** system **SHALL** display badge with üîµ blue color\n4. **WHEN** status is VERIFIED **THEN** system **SHALL** display badge with üü¢ green color\n5. **WHEN** status is POSTED **THEN** system **SHALL** display badge with ‚úÖ success color\n6. **WHEN** status is CANCELLED **THEN** system **SHALL** display badge with ‚ùå red color\n\n7. **WHEN** user clicks status filter button **THEN** system **SHALL** filter table to show only returns with that status\n\n8. **WHEN** user applies date range **THEN** system **SHALL** filter returns by return_date within range\n\n9. **WHEN** user types in search bar **THEN** system **SHALL** filter results by return number or department name (case-insensitive, partial match)\n\n10. **WHEN** user clicks \"View Details\" button **THEN** system **SHALL** navigate to Return Details page\n\n11. **WHEN** user clicks \"Create Return\" button **THEN** system **SHALL** navigate to Create Return page\n\n12. **WHEN** backend emits WebSocket event for return update **THEN** system **SHALL** refresh dashboard data automatically\n\n### REQ-2: Quick Stats Cards\n\n**User Story:** As a pharmacist, I want to see summary statistics at a glance, so that I can prioritize verification work.\n\n#### Acceptance Criteria\n\n1. **WHEN** Return Dashboard loads **THEN** system **SHALL** display 4 stat cards:\n   - üì¶ Total Returns (count of all returns in selected period)\n   - ‚è≥ Pending Verification (count with status=SUBMITTED)\n   - ‚úÖ Verified Today (count verified today)\n   - ‚ö†Ô∏è Quarantine Items (count of lots in quarantine)\n\n2. **WHEN** user clicks on stat card **THEN** system **SHALL** filter table to show relevant returns\n\n3. **WHEN** backend data updates **THEN** system **SHALL** refresh stat cards automatically (via WebSocket)\n\n### REQ-3: Create Return Form\n\n**User Story:** As a ward staff, I want to create a drug return request with multiple items, so that I can return excess, expired, or damaged drugs to pharmacy.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Create Return page **THEN** system **SHALL** display form with sections:\n   - **Return Information**:\n     - From Department (dropdown, auto-selected for ward users)\n     - To Location (dropdown, defaults to \"Central Pharmacy\")\n     - Return Date (date picker, defaults to today)\n     - Return By (user selector dropdown)\n     - Return Reason (dropdown with common reasons: Excess Stock, Near Expiry, Damaged, Wrong Drug, Patient Discharged, Other)\n     - Notes (textarea, optional)\n   - **Items to Return**:\n     - Dynamic table with \"Add Item\" button\n     - Columns: Drug, Lot Number, Expiry Date, Total Quantity, Unit, Condition, Actions\n\n2. **WHEN** user clicks \"Add Item\" button **THEN** system **SHALL** add new row with:\n   - Drug selector (searchable dropdown via API)\n   - Lot Number selector (filtered by selected drug and department)\n   - Expiry Date (auto-filled from selected lot, read-only)\n   - Total Quantity (number input, required, must be > 0)\n   - Unit (auto-filled from drug master, read-only)\n   - Condition radio buttons (Good/Damaged, informational only)\n   - Remove button (trash icon)\n\n3. **WHEN** user selects drug **THEN** system **SHALL** call GET /api/lots?drug_id=X&location_id=Y to populate lot dropdown\n\n4. **WHEN** user selects lot number **THEN** system **SHALL**:\n   - Auto-fill expiry date\n   - Display available quantity for that lot\n   - Validate that return quantity ‚â§ available quantity\n\n5. **IF** return quantity > available quantity **THEN** system **SHALL** display error \"Cannot return more than available quantity (X units)\"\n\n6. **WHEN** user clicks \"Save Draft\" button **THEN** system **SHALL**:\n   - Validate all required fields (department, return reason, at least 1 item)\n   - Call POST /api/inventory/operations/drug-returns with status=DRAFT\n   - Display success message \"Return draft saved (RET-YYYY-MM-###)\"\n   - Navigate back to Return Dashboard\n\n7. **WHEN** user clicks \"Submit Return\" button **THEN** system **SHALL**:\n   - Validate all required fields\n   - Validate at least 1 item exists\n   - Call POST /api/inventory/operations/drug-returns with status=SUBMITTED\n   - Display success message \"Return submitted for verification\"\n   - Emit WebSocket event to notify pharmacist\n   - Navigate back to Return Dashboard\n\n8. **WHEN** user clicks \"Cancel\" button **THEN** system **SHALL** show confirmation dialog, and if confirmed, discard changes and navigate back\n\n9. **WHEN** user clicks remove item button **THEN** system **SHALL** remove that row from table\n\n10. **WHEN** form has validation errors **THEN** system **SHALL** display inline error messages with red border\n\n### REQ-4: Return Details View\n\n**User Story:** As a user, I want to view complete details of a return request, so that I can review all information and history.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Return Details page **THEN** system **SHALL** call GET /api/inventory/operations/drug-returns/:id and display:\n   - **Header Section**:\n     - Return Number (large, prominent)\n     - Status badge with color coding\n     - From Department ‚Üí To Location (with arrow)\n     - Return Date, Return By\n   - **Return Information**:\n     - Return Reason\n     - Notes\n     - Total Items count\n     - Total Value (if verified/posted)\n   - **Items Table**:\n     - Columns: #, Drug Name, Lot Number, Expiry Date, Total Qty, Good Qty, Damaged Qty, Unit, Notes\n     - Color-coded rows: good_quantity > 0 (green), damaged_quantity > 0 (orange)\n   - **Status History Timeline**:\n     - DRAFT ‚Üí SUBMITTED ‚Üí VERIFIED ‚Üí POSTED\n     - Show timestamp and user for each status\n   - **Action Buttons** (context-dependent):\n     - If status=DRAFT and user is creator: \"Edit\", \"Submit\", \"Delete\"\n     - If status=SUBMITTED and user is pharmacist: \"Verify Return\"\n     - If status=VERIFIED and user is pharmacist: \"Post to Inventory\"\n\n2. **WHEN** user clicks \"Edit\" button (DRAFT only) **THEN** system **SHALL** navigate to Edit Return page with pre-filled data\n\n3. **WHEN** user clicks \"Submit\" button (DRAFT only) **THEN** system **SHALL**:\n   - Call PUT /api/inventory/operations/drug-returns/:id/submit\n   - Update status to SUBMITTED\n   - Display success message\n   - Refresh page\n\n4. **WHEN** user clicks \"Delete\" button (DRAFT only) **THEN** system **SHALL**:\n   - Show confirmation dialog \"Are you sure you want to delete this return?\"\n   - If confirmed, call DELETE /api/inventory/operations/drug-returns/:id\n   - Display success message\n   - Navigate back to Return Dashboard\n\n5. **WHEN** user clicks \"Verify Return\" button (SUBMITTED) **THEN** system **SHALL** navigate to Verify Return page\n\n6. **WHEN** user clicks \"Post to Inventory\" button (VERIFIED) **THEN** system **SHALL**:\n   - Show confirmation dialog \"Post this return to inventory? This will update stock levels.\"\n   - If confirmed, call POST /api/inventory/operations/drug-returns/:id/post\n   - Display success message \"Return posted successfully. Inventory updated.\"\n   - Refresh page\n\n7. **WHEN** user clicks \"Print\" button **THEN** system **SHALL** open printable view with return details\n\n8. **WHEN** backend emits WebSocket event for this return **THEN** system **SHALL** refresh page data automatically\n\n### REQ-5: Verify Return Form (Pharmacist)\n\n**User Story:** As a pharmacist, I want to verify returned items and separate good/damaged quantities, so that I can properly process returns and update inventory.\n\n#### Acceptance Criteria\n\n1. **WHEN** pharmacist opens Verify Return page **THEN** system **SHALL** display:\n   - **Return Header** (read-only):\n     - Return Number, Department, Return Reason, Total Items\n   - **Verification Form**:\n     - Items table with columns: Drug Name, Lot Number, Expiry Date, Claimed Qty, Actual Qty (input), Good Qty (input), Damaged Qty (input), Notes (input)\n     - Verified By (user selector, defaults to current user)\n     - Verified Date (date picker, defaults to today)\n     - Verification Notes (textarea, optional)\n   - **Action Buttons**:\n     - \"Reject Return\" (returns to department)\n     - \"Save Progress\" (saves as SUBMITTED, can continue later)\n     - \"Complete Verification\" (changes to VERIFIED)\n\n2. **WHEN** pharmacist enters Actual Qty **THEN** system **SHALL**:\n   - Auto-copy to Good Qty if Actual Qty matches Claimed Qty\n   - Validate Actual Qty ‚â• 0\n\n3. **WHEN** pharmacist enters Good Qty and Damaged Qty **THEN** system **SHALL**:\n   - Real-time validation: Good Qty + Damaged Qty = Actual Qty\n   - Display error if sum ‚â† Actual Qty: \"Good + Damaged must equal Actual (X units)\"\n   - Auto-calculate and display: Total Good, Total Damaged across all items\n\n4. **IF** Good Qty + Damaged Qty ‚â† Actual Qty **THEN** system **SHALL**:\n   - Highlight row with red border\n   - Display inline error message\n   - Disable \"Complete Verification\" button\n\n5. **WHEN** pharmacist clicks \"Reject Return\" **THEN** system **SHALL**:\n   - Show confirmation dialog with reason input\n   - If confirmed, call POST /api/inventory/operations/drug-returns/:id/reject with reason\n   - Update status to CANCELLED\n   - Display message \"Return rejected. Department notified.\"\n   - Navigate back to Return Dashboard\n\n6. **WHEN** pharmacist clicks \"Save Progress\" **THEN** system **SHALL**:\n   - Validate at least some quantities entered\n   - Call PUT /api/inventory/operations/drug-returns/:id with partial verification data\n   - Keep status as SUBMITTED\n   - Display success message \"Progress saved\"\n   - Stay on page\n\n7. **WHEN** pharmacist clicks \"Complete Verification\" **THEN** system **SHALL**:\n   - Validate all items have Good Qty + Damaged Qty = Actual Qty\n   - Validate Verified By is selected\n   - Call POST /api/inventory/operations/drug-returns/:id/verify with complete verification data\n   - Update status to VERIFIED\n   - Display success message \"Verification complete. Return ready to post.\"\n   - Navigate to Return Details page\n\n8. **WHEN** verification is complete **THEN** system **SHALL** emit WebSocket event to notify department and inventory managers\n\n### REQ-6: Post Return Confirmation\n\n**User Story:** As a pharmacist, I want to post verified returns to inventory with clear preview of changes, so that I can ensure accuracy before updating stock.\n\n#### Acceptance Criteria\n\n1. **WHEN** pharmacist clicks \"Post to Inventory\" on VERIFIED return **THEN** system **SHALL** display confirmation dialog with:\n   - **Summary**:\n     - Total Good Quantity (will be added to inventory)\n     - Total Damaged Quantity (will move to quarantine)\n   - **Inventory Changes Preview**:\n     - Table showing: Drug, Location, Current Stock, Good Qty, New Stock (Current + Good)\n   - **Quarantine Lots**:\n     - Table showing: Drug, Lot Number, Damaged Qty, Quarantine Location\n   - **Warnings**:\n     - If any items have damaged_quantity > 0: \"‚ö†Ô∏è X items will be moved to quarantine for disposal\"\n   - **Action Buttons**:\n     - \"Cancel\"\n     - \"Confirm & Post to Inventory\"\n\n2. **WHEN** pharmacist clicks \"Confirm & Post to Inventory\" **THEN** system **SHALL**:\n   - Call POST /api/inventory/operations/drug-returns/:id/post\n   - Display loading indicator with message \"Posting return to inventory...\"\n   - On success:\n     - Display success message \"Return posted successfully. Inventory updated, X items in quarantine.\"\n     - Emit WebSocket event to refresh inventory views\n     - Close dialog and refresh Return Details page\n   - On error:\n     - Display error message with details\n     - Keep dialog open\n\n3. **WHEN** posting fails (API error) **THEN** system **SHALL**:\n   - Display user-friendly error message\n   - Show technical details in collapsible section (for support)\n   - Suggest retry or contact support\n   - Keep return in VERIFIED status (can retry)\n\n### REQ-7: Quarantine Management View\n\n**User Story:** As a pharmacist, I want to view all items in quarantine with disposal status, so that I can plan and execute disposal procedures.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Quarantine Management page **THEN** system **SHALL** display:\n   - **Summary Cards**:\n     - Total Quarantine Items (count of lots)\n     - Total Value (sum of lot values)\n     - Pending Disposal (count awaiting disposal committee review)\n     - Disposed This Month (count of completed disposals)\n   - **Quarantine Lots Table**:\n     - Columns: Drug Name, Lot Number, Quantity, Unit Cost, Total Value, Expiry Date, Days in Quarantine, Source (Return Number link), Disposal Status, Actions\n   - **Filters**:\n     - Disposal Status (All/Pending/Scheduled/Completed)\n     - Date range (received in quarantine)\n     - Drug search\n   - **Bulk Actions**:\n     - \"Select All\" checkbox\n     - \"Schedule Disposal\" button (for selected items)\n\n2. **WHEN** disposal status is Pending **THEN** system **SHALL** display badge with ‚è≥ yellow color\n\n3. **WHEN** disposal status is Scheduled **THEN** system **SHALL** display badge with üìÖ blue color and disposal date\n\n4. **WHEN** disposal status is Completed **THEN** system **SHALL** display badge with ‚úÖ green color and disposal date\n\n5. **WHEN** user clicks \"View Details\" on quarantine lot **THEN** system **SHALL** open dialog showing:\n   - Complete lot information\n   - Source return details (link to return)\n   - Damaged reason from verification\n   - Photos (if uploaded)\n   - Disposal history (if applicable)\n\n6. **WHEN** user selects lots and clicks \"Schedule Disposal\" **THEN** system **SHALL** open Schedule Disposal dialog\n\n7. **WHEN** user clicks Source return number link **THEN** system **SHALL** navigate to Return Details page for that return\n\n8. **WHEN** table displays **THEN** system **SHALL** calculate and show totals in footer:\n   - Total lots count\n   - Total quantity\n   - Total value\n\n### REQ-8: Schedule Disposal Dialog\n\n**User Story:** As a pharmacist, I want to schedule disposal for quarantine items with committee assignment, so that I can organize disposal procedures.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Schedule Disposal dialog **THEN** system **SHALL** display form with:\n   - **Selected Items Summary**:\n     - Count of lots selected\n     - Total quantity\n     - Total value\n     - Table preview: Drug Name, Lot Number, Quantity\n   - **Disposal Information**:\n     - Disposal Date (date picker, defaults to today, can set future date)\n     - Disposal Method dropdown (Incineration, Chemical Destruction, Return to Vendor, Landfill, Other)\n     - Committee Members (multi-select user picker, minimum 3 required)\n     - Notes (textarea, optional)\n   - **Action Buttons**:\n     - \"Cancel\"\n     - \"Schedule Disposal\"\n\n2. **WHEN** user selects disposal method **THEN** system **SHALL** display method-specific guidelines (from master data)\n\n3. **WHEN** user selects fewer than 3 committee members **THEN** system **SHALL**:\n   - Display validation error \"Disposal requires at least 3 committee members\"\n   - Disable \"Schedule Disposal\" button\n\n4. **WHEN** user clicks \"Schedule Disposal\" button **THEN** system **SHALL**:\n   - Validate all required fields\n   - Call POST /api/inventory/operations/drug-disposals with selected lot IDs and disposal info\n   - Display success message \"Disposal scheduled for [date]. Committee members notified.\"\n   - Close dialog\n   - Refresh Quarantine Management page\n\n5. **WHEN** disposal is scheduled **THEN** system **SHALL** emit WebSocket event to notify committee members\n\n### REQ-9: Complete Disposal Form\n\n**User Story:** As a disposal committee member, I want to record disposal completion with photo evidence, so that I can maintain compliance documentation.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Complete Disposal page (from scheduled disposal) **THEN** system **SHALL** display:\n   - **Disposal Information** (read-only):\n     - Disposal Date, Method, Committee Members\n   - **Items Being Disposed**:\n     - Table: Drug Name, Lot Number, Quantity, Expiry Date\n   - **Completion Form**:\n     - Actual Disposal Date (date picker)\n     - Disposal Location (text input, e.g., \"Hospital Incinerator #2\")\n     - Photo Evidence (file upload, multiple files, required)\n     - Committee Signatures (checkboxes for each member to confirm)\n     - Completion Notes (textarea)\n   - **Action Buttons**:\n     - \"Cancel\"\n     - \"Complete Disposal\"\n\n2. **WHEN** user uploads photo **THEN** system **SHALL**:\n   - Validate file type (JPEG, PNG, PDF only)\n   - Validate file size (max 10MB per file)\n   - Display thumbnail preview\n   - Allow multiple files (min 1, max 10)\n\n3. **WHEN** user tries to complete without all signatures **THEN** system **SHALL**:\n   - Display error \"All committee members must sign off\"\n   - Disable \"Complete Disposal\" button\n\n4. **WHEN** user tries to complete without photo evidence **THEN** system **SHALL**:\n   - Display error \"Photo evidence is required\"\n   - Disable \"Complete Disposal\" button\n\n5. **WHEN** user clicks \"Complete Disposal\" **THEN** system **SHALL**:\n   - Validate all required fields and signatures\n   - Upload photos to backend via POST /api/attachments\n   - Call PUT /api/inventory/operations/drug-disposals/:id/complete with photo URLs\n   - Update quarantine lot status to DISPOSED\n   - Deactivate lots (quantity_available = 0)\n   - Display success message \"Disposal completed and documented\"\n   - Navigate to Disposal History page\n\n6. **WHEN** disposal is completed **THEN** system **SHALL** emit WebSocket event to update dashboards\n\n### REQ-10: Return Analytics Dashboard\n\n**User Story:** As an inventory manager, I want to view return analytics and trends, so that I can identify patterns and improve inventory management.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Return Analytics page **THEN** system **SHALL** display:\n   - **KPI Cards**:\n     - Total Returns (this month)\n     - Good Return Rate (good_qty / total_qty %)\n     - Damaged Value (total value of damaged items)\n     - Average Processing Time (SUBMITTED ‚Üí POSTED)\n   - **Charts**:\n     - Returns by Reason (pie chart)\n     - Returns Trend (line chart, last 6 months)\n     - Top Departments by Return Count (bar chart)\n     - Good vs Damaged Quantities (stacked bar chart)\n   - **Filters**:\n     - Date range picker\n     - Department filter\n     - Return reason filter\n\n2. **WHEN** user applies date range **THEN** system **SHALL** call GET /api/inventory/operations/drug-returns/analytics?from=X&to=Y and refresh all charts\n\n3. **WHEN** user clicks chart segment **THEN** system **SHALL** drill down to detailed data:\n   - Pie chart segment ‚Üí filter returns by that reason\n   - Bar chart bar ‚Üí filter returns by that department\n\n4. **WHEN** user hovers over chart element **THEN** system **SHALL** display tooltip with:\n   - Label\n   - Value\n   - Percentage (if applicable)\n\n5. **WHEN** user clicks \"Export Report\" **THEN** system **SHALL** download Excel file with:\n   - Summary sheet (KPIs)\n   - Returns list sheet (all returns in period)\n   - Analytics sheet (chart data)\n\n### REQ-11: Return Reason Master Data\n\n**User Story:** As an administrator, I want to manage return reason codes, so that users can select from standardized reasons.\n\n#### Acceptance Criteria\n\n1. **WHEN** admin opens Return Reasons page **THEN** system **SHALL** display:\n   - Table with columns: Reason Code, Reason Description, Is Active, Created Date, Actions\n   - \"Add Reason\" button\n   - Search bar\n\n2. **WHEN** admin clicks \"Add Reason\" **THEN** system **SHALL** open dialog with:\n   - Reason Code (text input, required, unique)\n   - Reason Description (textarea, required)\n   - Is Active checkbox (defaults to true)\n\n3. **WHEN** admin saves new reason **THEN** system **SHALL**:\n   - Validate uniqueness of reason code\n   - Call POST /api/master-data/return-reasons\n   - Display success message\n   - Refresh table\n\n4. **WHEN** admin clicks \"Edit\" **THEN** system **SHALL** open dialog with pre-filled data\n\n5. **WHEN** admin clicks \"Deactivate\" **THEN** system **SHALL**:\n   - Show confirmation dialog\n   - If confirmed, call PUT /api/master-data/return-reasons/:id with is_active=false\n   - Refresh table\n\n6. **WHEN** reason is deactivated **THEN** system **SHALL**:\n   - Keep existing returns with that reason unchanged\n   - Hide from dropdown in Create Return form\n\n### REQ-12: Real-time Updates via WebSocket\n\n**User Story:** As a user, I want to receive real-time updates when returns are created, verified, or posted, so that I always see current data.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens any Drug Return page **THEN** system **SHALL**:\n   - Connect to WebSocket endpoint /ws/drug-returns\n   - Subscribe to relevant events based on user role and department\n\n2. **WHEN** WebSocket receives \"return.created\" event **THEN** system **SHALL**:\n   - If on Return Dashboard: add new return to table or refresh table\n   - Display toast notification \"New return created: RET-YYYY-MM-###\"\n\n3. **WHEN** WebSocket receives \"return.submitted\" event **THEN** system **SHALL**:\n   - If user is pharmacist: display toast notification \"Return awaiting verification: RET-YYYY-MM-###\"\n   - If on Return Dashboard: update return status badge\n\n4. **WHEN** WebSocket receives \"return.verified\" event **THEN** system **SHALL**:\n   - If on Return Dashboard: update status and verified_by columns\n   - Display toast notification \"Return verified: RET-YYYY-MM-###\"\n\n5. **WHEN** WebSocket receives \"return.posted\" event **THEN** system **SHALL**:\n   - If on Return Dashboard: update status to POSTED\n   - If on Inventory Dashboard (other module): refresh stock levels\n   - Display toast notification \"Return posted to inventory: RET-YYYY-MM-###\"\n\n6. **WHEN** WebSocket receives \"disposal.scheduled\" event **THEN** system **SHALL**:\n   - If on Quarantine Management page: refresh table\n   - If user is committee member: display notification \"You are assigned to disposal committee\"\n\n7. **WHEN** WebSocket connection is lost **THEN** system **SHALL**:\n   - Attempt auto-reconnect every 5 seconds\n   - Display warning banner \"Real-time updates paused. Reconnecting...\"\n   - Remove banner when reconnected\n\n### REQ-13: Permissions and Role-Based Access\n\n**User Story:** As a system administrator, I want to control who can create, verify, and post returns based on roles, so that I can maintain proper segregation of duties.\n\n#### Acceptance Criteria\n\n1. **WHEN** user with role \"Ward Staff\" logs in **THEN** system **SHALL** allow:\n   - ‚úÖ Create returns for their department\n   - ‚úÖ View returns for their department\n   - ‚úÖ Edit/Delete DRAFT returns they created\n   - ‚ùå Verify returns\n   - ‚ùå Post returns\n   - ‚ùå Access Quarantine Management\n\n2. **WHEN** user with role \"Pharmacist\" logs in **THEN** system **SHALL** allow:\n   - ‚úÖ View all returns\n   - ‚úÖ Verify returns (SUBMITTED ‚Üí VERIFIED)\n   - ‚úÖ Post returns (VERIFIED ‚Üí POSTED)\n   - ‚úÖ Access Quarantine Management\n   - ‚úÖ Schedule disposals\n   - ‚ùå Edit returns created by departments\n\n3. **WHEN** user with role \"Disposal Committee\" logs in **THEN** system **SHALL** allow:\n   - ‚úÖ View scheduled disposals\n   - ‚úÖ Complete disposals (record evidence)\n   - ‚úÖ View Quarantine Management (read-only)\n   - ‚ùå Create returns\n   - ‚ùå Verify returns\n   - ‚ùå Schedule disposals (only pharmacist can)\n\n4. **WHEN** user with role \"Inventory Manager\" logs in **THEN** system **SHALL** allow:\n   - ‚úÖ View all returns (all departments)\n   - ‚úÖ Access Return Analytics\n   - ‚úÖ Export reports\n   - ‚ùå Create/Edit/Verify/Post returns\n\n5. **WHEN** user with role \"Administrator\" logs in **THEN** system **SHALL** allow:\n   - ‚úÖ All actions\n   - ‚úÖ Manage Return Reasons master data\n\n6. **WHEN** user attempts unauthorized action **THEN** system **SHALL**:\n   - Hide action buttons not allowed for their role\n   - If API call attempted: display error \"You do not have permission to perform this action\"\n\n### REQ-14: Mobile Responsive Design\n\n**User Story:** As a ward staff using a tablet, I want the interface to work well on mobile devices, so that I can create returns at the point of care.\n\n#### Acceptance Criteria\n\n1. **WHEN** user accesses Drug Return UI on tablet (width 768px-1024px) **THEN** system **SHALL**:\n   - Display tables with horizontal scroll if needed\n   - Stack form fields vertically\n   - Use full-width buttons\n   - Maintain readable font sizes (min 14px)\n\n2. **WHEN** user accesses Drug Return UI on mobile (width <768px) **THEN** system **SHALL**:\n   - Hide non-essential columns in tables (show Drug, Qty, Status only)\n   - Use card layout instead of table for Return List\n   - Stack all form sections vertically\n   - Use mobile-optimized date/time pickers\n   - Ensure touch targets are min 44px\n\n3. **WHEN** user opens dialogs on mobile **THEN** system **SHALL**:\n   - Display as full-screen modal\n   - Add \"Back\" button in header\n   - Stack all content vertically\n\n### REQ-15: Accessibility (WCAG 2.1 AA)\n\n**User Story:** As a user with visual impairment, I want the interface to be accessible with screen readers, so that I can perform my job independently.\n\n#### Acceptance Criteria\n\n1. **WHEN** user navigates with keyboard only **THEN** system **SHALL**:\n   - Support Tab/Shift+Tab for focus navigation\n   - Show visible focus indicators (outline)\n   - Support Enter/Space for button activation\n   - Support Escape to close dialogs\n\n2. **WHEN** user uses screen reader **THEN** system **SHALL**:\n   - Provide ARIA labels for all interactive elements\n   - Announce form validation errors\n   - Announce dynamic content updates (toast notifications)\n   - Provide table headers and row/column labels\n\n3. **WHEN** displaying color-coded status badges **THEN** system **SHALL**:\n   - Include text label in addition to color\n   - Use icon + text + color (not color alone)\n   - Maintain 4.5:1 contrast ratio\n\n4. **WHEN** displaying charts **THEN** system **SHALL**:\n   - Provide alternative text description\n   - Include data table view option\n   - Support keyboard navigation\n\n### REQ-16: Error Handling and User Feedback\n\n**User Story:** As a user, I want clear error messages and loading indicators, so that I understand system status and know how to fix issues.\n\n#### Acceptance Criteria\n\n1. **WHEN** form validation fails **THEN** system **SHALL**:\n   - Display inline error message below invalid field (red text)\n   - Highlight field with red border\n   - Focus on first invalid field\n   - Display summary error message at top of form\n\n2. **WHEN** API call is in progress **THEN** system **SHALL**:\n   - Display loading spinner on button that triggered the action\n   - Disable submit buttons to prevent double-submit\n   - For slow operations (>2s): display progress message\n\n3. **WHEN** API call succeeds **THEN** system **SHALL**:\n   - Display success toast notification (green) with message\n   - Auto-dismiss after 5 seconds\n   - Provide \"Undo\" option if applicable\n\n4. **WHEN** API call fails **THEN** system **SHALL**:\n   - Display error toast notification (red) with user-friendly message\n   - Show technical error in collapsible section (for support)\n   - Provide \"Retry\" button if operation is retryable\n   - Suggest next steps or contact support\n\n5. **WHEN** network is offline **THEN** system **SHALL**:\n   - Display persistent banner \"You are offline. Some features unavailable.\"\n   - Cache read-only data for viewing\n   - Queue mutations to retry when online (if feasible)\n\n6. **WHEN** session expires **THEN** system **SHALL**:\n   - Display dialog \"Your session has expired. Please log in again.\"\n   - Redirect to login page\n   - Preserve unsaved form data in localStorage (if possible, recover after re-login)\n\n### REQ-17: Performance and Optimization\n\n**User Story:** As a user, I want the interface to load quickly and respond smoothly, so that I can work efficiently.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Return Dashboard **THEN** system **SHALL**:\n   - Load initial view within 2 seconds\n   - Use pagination or virtual scrolling for large tables (>100 rows)\n   - Display skeleton loaders during data fetch\n\n2. **WHEN** user filters or searches **THEN** system **SHALL**:\n   - Debounce search input (300ms delay)\n   - Show loading indicator if API call takes >500ms\n   - Cancel previous API call if new filter applied\n\n3. **WHEN** user scrolls large table **THEN** system **SHALL**:\n   - Use virtual scrolling (render only visible rows + buffer)\n   - Maintain smooth scrolling (60fps)\n\n4. **WHEN** user navigates between pages **THEN** system **SHALL**:\n   - Prefetch data for likely next pages (e.g., Return Details when hovering row)\n   - Use route guards to prevent navigation with unsaved changes\n\n5. **WHEN** displaying images (disposal photos) **THEN** system **SHALL**:\n   - Use lazy loading (load when scrolled into view)\n   - Display placeholder while loading\n   - Compress images client-side before upload\n\n### REQ-18: Print and Export\n\n**User Story:** As a pharmacist, I want to print return documents and export data for audits, so that I can maintain physical records.\n\n#### Acceptance Criteria\n\n1. **WHEN** user clicks \"Print\" on Return Details **THEN** system **SHALL**:\n   - Open print preview with formatted document\n   - Include: Return header, items table, signatures (verified_by, received_by)\n   - Hide action buttons and navigation\n   - Use print-friendly CSS (@media print)\n\n2. **WHEN** user clicks \"Export to Excel\" on Return Dashboard **THEN** system **SHALL**:\n   - Generate Excel file with columns: Return Number, Date, Department, Status, Total Items, Total Value, Verified By, Posted By\n   - Include only filtered/visible rows\n   - Auto-download file named \"drug-returns-YYYY-MM-DD.xlsx\"\n\n3. **WHEN** user clicks \"Export Analytics Report\" **THEN** system **SHALL**:\n   - Generate Excel file with multiple sheets:\n     - Summary (KPIs)\n     - Returns List (detailed)\n     - Charts (data tables)\n   - Auto-download file named \"drug-return-analytics-YYYY-MM-DD.xlsx\"\n\n4. **WHEN** user clicks \"Export Disposal Report\" **THEN** system **SHALL**:\n   - Generate PDF with disposal document format\n   - Include: Disposal header, items table, committee signatures, photo thumbnails\n   - Auto-download file named \"disposal-report-YYYY-MM-DD.pdf\"\n\n### REQ-19: Integration with Backend API\n\n**User Story:** As a developer, I want all frontend components to integrate seamlessly with drug-return-backend-api, so that data flows correctly.\n\n#### Acceptance Criteria\n\n1. **WHEN** frontend makes API calls **THEN** system **SHALL**:\n   - Use environment-specific base URL (from environment.ts)\n   - Include authentication token in Authorization header\n   - Set Content-Type: application/json for POST/PUT requests\n\n2. **WHEN** API returns 401 Unauthorized **THEN** system **SHALL**:\n   - Clear stored token\n   - Redirect to login page\n   - Display message \"Session expired. Please log in.\"\n\n3. **WHEN** API returns 403 Forbidden **THEN** system **SHALL**:\n   - Display error \"You do not have permission to perform this action\"\n   - Do not retry request\n\n4. **WHEN** API returns 400 Bad Request with validation errors **THEN** system **SHALL**:\n   - Parse error response (expected format: { field: \"error message\" })\n   - Display inline validation errors on corresponding form fields\n\n5. **WHEN** API returns 500 Internal Server Error **THEN** system **SHALL**:\n   - Display generic error \"An error occurred. Please try again or contact support.\"\n   - Log full error to console for debugging\n   - Optionally report to error tracking service\n\n6. **WHEN** API call times out (>30s) **THEN** system **SHALL**:\n   - Cancel request\n   - Display error \"Request timed out. Please check your connection and try again.\"\n\n### REQ-20: Component Reusability\n\n**User Story:** As a developer, I want to build reusable components following AegisX UI + Angular Material patterns, so that I can maintain consistency and reduce code duplication.\n\n#### Acceptance Criteria\n\n1. **WHEN** building UI components **THEN** system **SHALL**:\n   - Use AegisX UI components as base (ax-table, ax-form, ax-dialog, ax-badge, ax-button)\n   - Extend with Angular Material components where AegisX doesn't provide (mat-datepicker, mat-select)\n   - Apply TailwindCSS utility classes for spacing, colors, responsive design\n   - Follow project theming (primary, accent, warn colors)\n\n2. **WHEN** creating shared components **THEN** system **SHALL**:\n   - Place in libs/aegisx-ui or apps/admin/src/app/shared/components\n   - Provide @Input() for configuration\n   - Emit @Output() events for actions\n   - Include JSDoc comments for public API\n   - Create Storybook stories for documentation\n\n3. **WHEN** creating feature components **THEN** system **SHALL**:\n   - Place in apps/admin/src/app/features/drug-returns/\n   - Use standalone components (Angular 17+ pattern)\n   - Inject services via constructor\n   - Use Signals for state management\n\n4. **WHEN** styling components **THEN** system **SHALL**:\n   - Use TailwindCSS utility-first approach\n   - Follow spacing scale (p-4, m-2, gap-6, etc.)\n   - Use semantic color classes (bg-primary, text-error)\n   - Apply responsive classes (md:flex, lg:grid-cols-3)\n\n## Summary\n\nThis specification defines a comprehensive Drug Return Frontend UI that streamlines the complete drug return lifecycle from creation through disposal. By leveraging AegisX UI components, Angular Material, and TailwindCSS, we deliver a modern, accessible, and user-friendly interface that integrates seamlessly with the drug-return-backend-api.\n\n**Key Features:**\n- Intuitive return creation with lot tracking\n- Structured verification workflow with good/damaged separation\n- Real-time updates via WebSocket\n- Comprehensive quarantine and disposal management\n- Rich analytics and reporting\n- Role-based access control\n- Mobile-responsive design\n- Full accessibility compliance\n\n**Impact:**\n- Reduce return processing time by 40%\n- Improve inventory accuracy through proper return handling\n- Minimize untracked drug waste by 25%\n- Ensure compliance with disposal documentation requirements\n- Enhance user satisfaction with intuitive workflows\n",
  "fileStats": {
    "size": 36549,
    "lines": 791,
    "lastModified": "2025-12-14T14:40:49.710Z"
  },
  "comments": []
}
