{
  "id": "snapshot_1766115569193_6jndj64j9",
  "approvalId": "approval_1766115569076_l1ocu1vah",
  "approvalTitle": "Requirements - Item-Level Budget Control",
  "version": 1,
  "timestamp": "2025-12-19T03:39:29.193Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document - Item-Level Budget Control\n\n## Introduction\n\nThis feature implements per-item budget control with three levels (NONE/SOFT/HARD) for both quantity and price validation during Purchase Request (PR) creation. The system allows granular budget control per drug/item with configurable variance tolerances, enabling hospitals to enforce different budget policies based on drug importance, cost, and regulatory requirements.\n\nThe feature addresses the need for flexible budget enforcement where critical/expensive drugs require strict control (HARD), general medicines allow warnings with justification (SOFT), and low-risk items like vitamins can be purchased without budget checks (NONE).\n\n## Alignment with Product Vision\n\nThis feature supports:\n- **Granular Control**: Fine-grained budget management at the item level rather than blanket policies\n- **Risk-Based Approach**: Different control levels for different drug categories (controlled substances, expensive drugs, general medicines, supplements)\n- **Operational Flexibility**: Allows warnings with justifications for SOFT control, balancing control with operational needs\n- **Compliance**: Ensures critical/expensive items stay within budget while maintaining audit trails\n- **User Experience**: Clear visual feedback (red/yellow/green) and real-time validation during PR creation\n\n## Requirements\n\n### Requirement 1: Configure Item-Level Budget Control\n\n**User Story:** As a Finance Manager, I want to configure budget control settings for each drug item (quantity control type, price control type, variance tolerances), so that I can enforce different budget policies based on drug importance and cost.\n\n#### Acceptance Criteria\n\n1. WHEN viewing a budget request item THEN the system SHALL display controls for quantity_control_type with options: NONE, SOFT, HARD\n2. WHEN viewing a budget request item THEN the system SHALL display controls for price_control_type with options: NONE, SOFT, HARD\n3. WHEN selecting SOFT or HARD control THEN the system SHALL allow setting variance tolerance percentage (0-100%)\n4. IF quantity_control_type is HARD with 10% tolerance THEN the system SHALL allow ¬±10% variance from planned quantity\n5. IF price_control_type is SOFT with 15% tolerance THEN the system SHALL warn (not block) if price exceeds ¬±15% variance\n6. WHEN saving control settings THEN the system SHALL store: quantity_control_type, price_control_type, quantity_variance_percent, price_variance_percent\n7. WHEN displaying control settings THEN the system SHALL use visual indicators: üî¥ Red (HARD), üü° Yellow (SOFT), ‚ö™ Gray (NONE)\n\n### Requirement 2: Validate PR Against Budget Control\n\n**User Story:** As a Procurement Officer, I want the system to validate my Purchase Request items against configured budget controls, so that I know which items exceed budget limits before submission.\n\n#### Acceptance Criteria\n\n1. WHEN creating a PR with items THEN the system SHALL call check_item_budget_control() for each item\n2. WHEN an item has NONE control THEN the system SHALL skip validation and return status 'OK'\n3. WHEN an item is within tolerance THEN the system SHALL return status 'OK'\n4. WHEN an item exceeds tolerance with SOFT control THEN the system SHALL return status 'WARNING'\n5. WHEN an item exceeds tolerance with HARD control THEN the system SHALL return status 'BLOCKED'\n6. IF any item has status 'BLOCKED' THEN the system SHALL prevent PR submission with error BUDGET_CONTROL_BLOCKED\n7. IF any item has status 'WARNING' and no reason provided THEN the system SHALL prevent submission with error BUDGET_EXCEED_REASON_REQUIRED\n8. WHEN validation completes THEN the system SHALL return details: quantity status, price status, planned qty, purchased qty, remaining qty, requested qty, diff percentage\n\n### Requirement 3: Display Budget Validation Results in UI\n\n**User Story:** As a Procurement Officer, I want to see clear visual feedback about budget validation results (errors, warnings, passed), so that I can understand which items need attention and what actions to take.\n\n#### Acceptance Criteria\n\n1. WHEN PR validation returns HARD blocks THEN the system SHALL display a red expandable alert box at the top of the form\n2. WHEN PR validation returns SOFT warnings THEN the system SHALL display a yellow expandable alert box\n3. WHEN displaying errors/warnings THEN the system SHALL show per-item breakdown: drug name, planned qty/amount, purchased qty/amount, remaining qty/amount, requested qty/amount, exceeded amount/percentage\n4. IF SOFT warnings exist THEN the system SHALL display a textarea requiring the user to enter justification\n5. WHEN HARD errors exist THEN the system SHALL disable the submit button with a lock icon (üîí)\n6. WHEN all items pass validation THEN the system SHALL show green status badges (‚úÖ Passed)\n7. WHEN items have SOFT warnings with reason provided THEN the system SHALL enable submit button\n8. WHEN expanding alert boxes THEN the system SHALL use accordion UI with expand/collapse icons (‚ñº/‚ñ≤)\n\n### Requirement 4: Provide Real-Time Impact Preview\n\n**User Story:** As a Finance Manager, I want to see real-time examples of how my control settings will affect PR creation, so that I can understand the impact before saving the configuration.\n\n#### Acceptance Criteria\n\n1. WHEN changing control type or variance percentage THEN the system SHALL display a \"‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤\" (Impact Preview) section\n2. WHEN previewing impact THEN the system SHALL show example scenarios: ‚úÖ Allowed, ‚ùå Blocked, ‚ö†Ô∏è Warning\n3. WHEN showing examples THEN the system SHALL calculate based on current quarter's remaining budget\n4. IF quantity control is HARD ¬±10% and remaining is 2,500 units THEN preview SHALL show: ‚úÖ 2,500 units allowed, ‚ùå 3,000 units blocked (+20%)\n5. IF price control is SOFT ¬±15% and planned price is 2.50 baht THEN preview SHALL show: ‚ö†Ô∏è 2.60 baht warning (+4%), ‚ùå 3.00 baht blocked (+20%)\n6. WHEN control settings change THEN the preview SHALL update immediately without page reload\n\n### Requirement 5: Budget Dashboard with Item Status\n\n**User Story:** As a Finance Manager, I want to view a dashboard showing budget status for all items with visual indicators, so that I can quickly identify items that need attention or are approaching budget limits.\n\n#### Acceptance Criteria\n\n1. WHEN viewing budget dashboard THEN the system SHALL display summary cards: Total Budget, Used Budget, Remaining Budget\n2. WHEN displaying summary THEN the system SHALL show breakdown by control type: HARD count, SOFT count, NONE count\n3. WHEN listing items THEN the system SHALL show status badges: üî¥ Exceeded, üü° Warning (near limit), ‚úÖ Normal\n4. WHEN displaying item rows THEN the system SHALL show dual progress bars: one for budget amount, one for quantity\n5. IF item usage is <80% THEN progress bar SHALL be green\n6. IF item usage is 80-99% THEN progress bar SHALL be yellow\n7. IF item usage is ‚â•100% THEN progress bar SHALL be red\n8. WHEN filtering items THEN the system SHALL allow filter by: control type (HARD/SOFT/NONE), status (normal/warning/exceeded)\n9. WHEN clicking an item THEN the system SHALL show related PRs that consumed the budget\n\n### Requirement 6: Recommended Control Settings\n\n**User Story:** As a Finance Manager, I want to see recommended control settings based on drug category, so that I can quickly configure appropriate controls without manual analysis.\n\n#### Acceptance Criteria\n\n1. WHEN opening item settings modal THEN the system SHALL display a recommendations table showing suggested settings by drug type\n2. IF drug is \"‡∏¢‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©\" (controlled substance) THEN system SHALL recommend: Quantity HARD ¬±0%, Price HARD ¬±0%\n3. IF drug price > 100 baht/unit THEN system SHALL recommend: Quantity HARD ¬±5%, Price SOFT ¬±10%\n4. IF drug is essential medicine (Essential Drug List) THEN system SHALL recommend: Quantity SOFT ¬±10%, Price SOFT ¬±15%\n5. IF drug is vitamin/supplement THEN system SHALL recommend: Quantity NONE, Price NONE\n6. WHEN clicking \"‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥\" button THEN system SHALL auto-fill controls based on drug category\n7. WHEN displaying recommendations THEN system SHALL show reasoning: \"‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î\" (strict), \"‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô\" (cost control), \"‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÑ‡∏î‡πâ\" (flexible), \"‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô\" (not needed)\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Separate database functions for budget checking, separate UI components for validation display\n- **Modular Design**: Budget control logic in PostgreSQL function, validation in service layer, UI components reusable\n- **Dependency Management**: PR validation depends on budget request item configuration but is loosely coupled\n- **Clear Interfaces**: check_item_budget_control() function with well-defined input/output contract\n\n### Performance\n\n- **Validation Speed**: PR validation should complete within 500ms for 50 items (10ms per item)\n- **Database Queries**: Use batch processing for multiple items (Promise.all) to avoid sequential bottleneck\n- **UI Responsiveness**: Real-time preview should update within 100ms of user input change\n- **Progress Bar Rendering**: Dashboard should render 1,000+ items with virtual scrolling\n\n### Security\n\n- **Permission-Based Access**: Control configuration requires `budgetRequests:update` permission\n- **Audit Trail**: Log all control setting changes with user ID and timestamp\n- **Input Validation**: Variance percentage must be 0-100, control type must be NONE/SOFT/HARD\n- **SQL Injection Prevention**: Use parameterized queries in check_item_budget_control() function\n\n### Reliability\n\n- **Graceful Degradation**: If budget check fails, system should warn but not block PR creation entirely\n- **Data Integrity**: Variance percentages stored as integers (0-100), control types validated by CHECK constraint\n- **Error Handling**: Clear error messages distinguishing HARD blocks vs SOFT warnings vs validation failures\n- **Backward Compatibility**: Items without control settings default to SOFT with 10% quantity, 15% price tolerance\n\n### Usability\n\n- **Visual Clarity**: Use color coding (red/yellow/green) and icons (üî¥üü°‚ö™) for quick understanding\n- **Progressive Disclosure**: Use expandable accordion for error/warning details to avoid cluttering the UI\n- **Contextual Help**: Show examples and tooltips explaining NONE/SOFT/HARD differences\n- **Inline Validation**: Show real-time feedback in item settings modal before saving\n- **Responsive Design**: Dashboard and modals work on desktop and tablet screens\n\n## Business Rules\n\n1. **Default Control Levels**: New items default to SOFT control with ¬±10% quantity tolerance and ¬±15% price tolerance\n2. **Dual Independent Control**: Quantity control and price control are independent; an item can be HARD for quantity but SOFT for price\n3. **Quarterly Budget Basis**: Validation checks against current quarter's remaining budget (planned - purchased)\n4. **Reason Required for SOFT**: If SOFT warning triggers, user must provide justification before PR submission\n5. **HARD Control Blocks**: If HARD control triggers, PR cannot be submitted until quantities/prices are adjusted or budget is amended\n6. **Zero Tolerance Option**: Variance percentage of 0% means no deviation allowed (strict enforcement)\n7. **Validation Timing**: Budget control validation occurs during PR creation, not during budget request approval\n\n## Out of Scope\n\n- Budget amendment/transfer workflow (separate feature)\n- Automatic budget reallocation based on usage patterns\n- Multi-currency price control (THB only for now)\n- Machine learning for automatic control type recommendations\n- Budget forecasting/burn rate predictions\n- Integration with vendor contract prices (manual price entry for now)\n",
  "fileStats": {
    "size": 11979,
    "lines": 163,
    "lastModified": "2025-12-19T03:39:17.642Z"
  },
  "comments": []
}
