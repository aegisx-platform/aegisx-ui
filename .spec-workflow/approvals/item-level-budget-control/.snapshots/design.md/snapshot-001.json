{
  "id": "snapshot_1766116931788_kz0kn91lk",
  "approvalId": "approval_1766116931732_ocz3bdtb1",
  "approvalTitle": "Design - Item-Level Budget Control",
  "version": 1,
  "timestamp": "2025-12-19T04:02:11.788Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Item-Level Budget Control\n\n## Overview\n\nThe Item-Level Budget Control feature implements a three-tier budget enforcement system (NONE/SOFT/HARD) with independent quantity and price controls for each drug item in budget requests. The system validates Purchase Requests against configured tolerances, displays color-coded alerts in the UI, and provides a dashboard for monitoring budget status across all items.\n\nThis feature extends the existing budget management system by adding granular per-item controls while maintaining the current quarterly tracking and approval workflow. The design follows a layered architecture with PostgreSQL functions for validation logic, Fastify service integration for PR validation, and Angular components for configuration and visualization.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Database-First Design:**\n- Schema changes in migrations-inventory with CHECK constraints for data integrity\n- PostgreSQL function `check_item_budget_control()` encapsulates validation logic\n- Returns structured JSONB for detailed validation results\n\n**API-First Development:**\n- Validation occurs in service layer before PR creation\n- TypeBox schema updates for control type fields\n- Error responses distinguish HARD blocks vs SOFT warnings\n\n**TypeScript Patterns:**\n- Strict typing for control types: 'NONE' | 'SOFT' | 'HARD'\n- Interface definitions for validation results\n- Null safety with optional chaining for variance percentages\n\n### Project Structure (structure.md)\n\n**Backend Organization:**\n```\napps/api/src/\nâ”œâ”€â”€ database/migrations-inventory/\nâ”‚   â”œâ”€â”€ 20251219000002_add_item_budget_control.ts    # Schema changes\nâ”‚   â””â”€â”€ 20251219000003_create_item_budget_control_function.ts  # PG function\nâ”œâ”€â”€ layers/domains/inventory/\nâ”‚   â”œâ”€â”€ budget/budgetRequests/\nâ”‚   â”‚   â””â”€â”€ budget-requests.schemas.ts                # Add control type schemas\nâ”‚   â””â”€â”€ procurement/purchaseRequests/\nâ”‚       â””â”€â”€ purchase-requests.service.ts              # Add validation\n```\n\n**Frontend Organization:**\n```\napps/admin/src/app/\nâ””â”€â”€ modules/inventory/budget/\n    â”œâ”€â”€ components/\n    â”‚   â”œâ”€â”€ item-settings-modal/                      # Control configuration\n    â”‚   â”œâ”€â”€ pr-validation-alerts/                     # Error/warning display\n    â”‚   â””â”€â”€ budget-dashboard/                         # Status overview\n    â””â”€â”€ services/\n        â””â”€â”€ budget-control.service.ts                 # API integration\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **BaseRepository**: Extend for budget control CRUD operations\n- **TypeBox Validation**: Reuse schema patterns for control type validation\n- **AegisX UI Components**:\n  - `ax-drawer` for item settings modal\n  - `ax-alert` for validation error/warning boxes\n  - `ax-progress` for budget usage progress bars\n  - `ax-badge` for status indicators\n  - `ax-table` for dashboard item list\n\n### Integration Points\n\n- **Existing Budget Request Flow**: Hook into existing `budget_request_items` table without breaking current functionality\n- **Purchase Request Service**: Extend `validateCreate()` method to call budget control validation\n- **Quarterly Tracking**: Integrate with existing `q1_purchased_qty`, `q2_purchased_qty`, etc. fields\n- **Approval Workflow**: No changes to approval flow; validation happens before PR submission\n\n## Architecture\n\n### Layered Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Frontend Layer\"\n        A[Item Settings Modal] --> B[Budget Control Service]\n        C[PR Creation Form] --> B\n        D[Budget Dashboard] --> B\n    end\n    \n    subgraph \"API Layer\"\n        B --> E[Budget Requests Controller]\n        B --> F[Purchase Requests Controller]\n        E --> G[Budget Requests Service]\n        F --> H[Purchase Requests Service]\n    end\n    \n    subgraph \"Database Layer\"\n        G --> I[(budget_request_items)]\n        H --> J[check_item_budget_control Function]\n        J --> I\n        J --> K[(budget_allocations)]\n    end\n    \n    style A fill:#e3f2fd\n    style C fill:#e3f2fd\n    style D fill:#e3f2fd\n    style J fill:#fff3e0\n    style I fill:#f3e5f5\n    style K fill:#f3e5f5\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each UI component (settings modal, alerts, dashboard) in separate files\n- **Component Isolation**: Budget control logic isolated in PostgreSQL function; UI components don't duplicate validation\n- **Service Layer Separation**: \n  - Database function handles validation logic\n  - Service layer orchestrates validation calls\n  - Frontend components only display results\n- **Utility Modularity**: Shared functions for control type display, color mapping, variance calculation\n\n## Components and Interfaces\n\n### Component 1: Database Schema Enhancement\n\n**Purpose:** Store control settings per budget request item\n\n**Schema Changes:**\n```sql\n-- File: 20251219000002_add_item_budget_control.ts\nALTER TABLE inventory.budget_request_items\nADD COLUMN quantity_control_type VARCHAR(10) DEFAULT 'SOFT'\n  CHECK (quantity_control_type IN ('NONE', 'SOFT', 'HARD')),\nADD COLUMN price_control_type VARCHAR(10) DEFAULT 'SOFT'\n  CHECK (price_control_type IN ('NONE', 'SOFT', 'HARD')),\nADD COLUMN quantity_variance_percent INTEGER DEFAULT 10\n  CHECK (quantity_variance_percent >= 0 AND quantity_variance_percent <= 100),\nADD COLUMN price_variance_percent INTEGER DEFAULT 15\n  CHECK (price_variance_percent >= 0 AND price_variance_percent <= 100);\n```\n\n**Interface:**\n- Columns: quantity_control_type, price_control_type, quantity_variance_percent, price_variance_percent\n- Constraints: CHECK constraints ensure valid values\n- Defaults: SOFT control with 10% quantity, 15% price tolerance\n\n**Dependencies:** Existing budget_request_items table\n\n**Reuses:** Current quarterly tracking columns (q1_qty, q1_purchased_qty, etc.)\n\n---\n\n### Component 2: Budget Control Validation Function\n\n**Purpose:** Validate PR item against configured budget controls\n\n**PostgreSQL Function:**\n```sql\n-- File: 20251219000003_create_item_budget_control_function.ts\nCREATE FUNCTION inventory.check_item_budget_control(\n  p_budget_request_item_id BIGINT,\n  p_pr_quantity NUMERIC,\n  p_pr_unit_price NUMERIC,\n  p_quarter INTEGER\n)\nRETURNS TABLE(\n  allowed BOOLEAN,\n  quantity_status VARCHAR(10),  -- 'OK', 'WARNING', 'BLOCKED'\n  price_status VARCHAR(10),\n  message JSONB\n)\n```\n\n**Validation Logic:**\n1. Fetch item configuration and quarterly budget data\n2. Calculate remaining quantity: `planned_qty - purchased_qty`\n3. Calculate variance percentages: `((requested - remaining) / remaining) * 100`\n4. Check quantity control:\n   - NONE â†’ return 'OK'\n   - Within tolerance â†’ return 'OK'\n   - SOFT + exceeds â†’ return 'WARNING'\n   - HARD + exceeds â†’ return 'BLOCKED'\n5. Check price control (same logic)\n6. Overall allowed: `quantity_status != 'BLOCKED' AND price_status != 'BLOCKED'`\n\n**Interface:**\n- Input: item ID, requested quantity, unit price, quarter\n- Output: allowed flag, statuses, detailed message JSONB\n\n**Dependencies:** budget_request_items table\n\n**Reuses:** Quarterly purchased tracking columns\n\n---\n\n### Component 3: Purchase Request Service Enhancement\n\n**Purpose:** Integrate budget control validation into PR creation workflow\n\n**File:** `apps/api/src/layers/domains/inventory/procurement/purchaseRequests/purchase-requests.service.ts`\n\n**Method Addition:**\n```typescript\nasync validateCreate(data: CreatePurchaseRequests, userId: string): Promise<void> {\n  // ... existing validations ...\n  \n  // Budget control validation\n  const budgetValidations = await Promise.all(\n    data.items.map(async (item) => {\n      const result = await this.knex.raw(`\n        SELECT * FROM inventory.check_item_budget_control(?, ?, ?, ?)\n      `, [\n        item.budget_request_item_id,\n        item.quantity,\n        item.unit_price,\n        this.getCurrentQuarter()\n      ]);\n      \n      return {\n        item_id: item.budget_request_item_id,\n        drug_name: item.drug_name,\n        ...result.rows[0]\n      };\n    })\n  );\n  \n  // Separate HARD blocks and SOFT warnings\n  const hardBlocks = budgetValidations.filter(v => !v.allowed);\n  const softWarnings = budgetValidations.filter(v => \n    v.allowed && (v.quantity_status === 'WARNING' || v.price_status === 'WARNING')\n  );\n  \n  // Error handling (see Error Handling section)\n}\n```\n\n**Interface:**\n- Input: PR data with items array\n- Output: void (throws errors if validation fails)\n- Errors: BUDGET_CONTROL_BLOCKED, BUDGET_EXCEED_REASON_REQUIRED\n\n**Dependencies:** check_item_budget_control() function, knex instance\n\n**Reuses:** Existing validateCreate() framework\n\n---\n\n### Component 4: Item Settings Modal (Frontend)\n\n**Purpose:** Configure control types and variance tolerances per item\n\n**File:** `apps/admin/src/app/modules/inventory/budget/components/item-settings-modal/item-settings-modal.component.ts`\n\n**UI Structure:**\n```typescript\n@Component({\n  selector: 'app-item-settings-modal',\n  standalone: true,\n  imports: [AxDrawerComponent, ReactiveFormsModule, AxBadgeComponent]\n})\nexport class ItemSettingsModalComponent {\n  form = this.fb.group({\n    quantity_control_type: ['SOFT'],\n    quantity_variance_percent: [10],\n    price_control_type: ['SOFT'],\n    price_variance_percent: [15]\n  });\n  \n  impactPreview = computed(() => this.calculateImpact(this.form.value));\n  \n  saveSettings() {\n    // PATCH /api/inventory/budget/budget-requests/:id/items/:itemId\n  }\n}\n```\n\n**Interface:**\n- Input: item data (drug name, budget, purchased quantities)\n- Output: Updated control settings\n- Events: save, cancel\n\n**Dependencies:** Budget control service, AegisX drawer component\n\n**Reuses:** \n- Reactive forms patterns from existing components\n- AegisX UI components (ax-drawer, ax-badge, ax-select)\n\n---\n\n### Component 5: PR Validation Alerts (Frontend)\n\n**Purpose:** Display budget validation errors and warnings during PR creation\n\n**File:** `apps/admin/src/app/modules/inventory/budget/components/pr-validation-alerts/pr-validation-alerts.component.ts`\n\n**UI Structure:**\n```typescript\n@Component({\n  selector: 'app-pr-validation-alerts',\n  standalone: true,\n  imports: [AxAlertComponent, AxAccordionComponent]\n})\nexport class PrValidationAlertsComponent {\n  @Input() hardBlocks: ValidationResult[] = [];\n  @Input() softWarnings: ValidationResult[] = [];\n  @Output() reasonChange = new EventEmitter<string>();\n  \n  hardBlocksExpanded = signal(true);\n  softWarningsExpanded = signal(true);\n}\n```\n\n**Display Logic:**\n- Red alert box for HARD blocks (always visible, blocks submit)\n- Yellow alert box for SOFT warnings (expandable, requires reason)\n- Accordion for item-level details\n- Textarea for exceed reason (required for SOFT)\n\n**Interface:**\n- Inputs: validation results (hard blocks, soft warnings)\n- Outputs: reason text for SOFT warnings\n- UI States: expanded/collapsed per alert type\n\n**Dependencies:** Validation results from PR service\n\n**Reuses:** AegisX alert and accordion components\n\n---\n\n### Component 6: Budget Dashboard (Frontend)\n\n**Purpose:** Overview of budget status across all items with filtering\n\n**File:** `apps/admin/src/app/modules/inventory/budget/components/budget-dashboard/budget-dashboard.component.ts`\n\n**UI Structure:**\n```typescript\n@Component({\n  selector: 'app-budget-dashboard',\n  standalone: true,\n  imports: [AxTableComponent, AxProgressComponent, AxBadgeComponent]\n})\nexport class BudgetDashboardComponent {\n  items = signal<BudgetItemStatus[]>([]);\n  filters = signal({ controlType: 'ALL', status: 'ALL' });\n  \n  summaryCards = computed(() => this.calculateSummary(this.items()));\n  filteredItems = computed(() => this.applyFilters(this.items(), this.filters()));\n  \n  loadData() {\n    // GET /api/inventory/budget/budget-requests/:id/items-status\n  }\n}\n```\n\n**Display Features:**\n- Summary cards: Total budget, used, remaining\n- Control type breakdown: HARD/SOFT/NONE counts\n- Item table with dual progress bars (quantity + amount)\n- Color-coded status badges\n- Filters: by control type, by status\n\n**Interface:**\n- Input: Budget request ID\n- Output: Dashboard view with item statuses\n- Actions: Filter, view item details, view related PRs\n\n**Dependencies:** Budget control service for data fetching\n\n**Reuses:** \n- AegisX table component with virtual scrolling\n- AegisX progress bars\n- Existing badge and filter patterns\n\n## Data Models\n\n### BudgetRequestItem (Extended)\n\n```typescript\ninterface BudgetRequestItem {\n  // Existing fields\n  id: number;\n  budget_request_id: number;\n  item_id: number;\n  requested_qty: number;\n  unit_price: number;\n  q1_qty: number;\n  q2_qty: number;\n  q3_qty: number;\n  q4_qty: number;\n  q1_purchased_qty: number;\n  q2_purchased_qty: number;\n  q3_purchased_qty: number;\n  q4_purchased_qty: number;\n  \n  // NEW: Control settings\n  quantity_control_type: 'NONE' | 'SOFT' | 'HARD';\n  price_control_type: 'NONE' | 'SOFT' | 'HARD';\n  quantity_variance_percent: number; // 0-100\n  price_variance_percent: number;    // 0-100\n}\n```\n\n### ValidationResult\n\n```typescript\ninterface ValidationResult {\n  item_id: number;\n  drug_name: string;\n  allowed: boolean;\n  quantity_status: 'OK' | 'WARNING' | 'BLOCKED';\n  price_status: 'OK' | 'WARNING' | 'BLOCKED';\n  message: {\n    quantity: {\n      planned: number;\n      purchased: number;\n      remaining: number;\n      requested: number;\n      diff_percent: number;\n      tolerance: number;\n      control_type: string;\n    };\n    price: {\n      planned: number;\n      requested: number;\n      diff_percent: number;\n      tolerance: number;\n      control_type: string;\n    };\n  };\n}\n```\n\n### BudgetItemStatus (Dashboard)\n\n```typescript\ninterface BudgetItemStatus {\n  item_id: number;\n  drug_code: string;\n  drug_name: string;\n  quantity_control_type: string;\n  price_control_type: string;\n  planned_qty: number;\n  purchased_qty: number;\n  remaining_qty: number;\n  usage_percent: number;\n  status: 'normal' | 'warning' | 'exceeded';\n  related_prs: number[]; // PR IDs that consumed this item's budget\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n#### 1. HARD Control Exceeded\n**Description:** PR item quantity or price exceeds tolerance with HARD control\n\n**Handling:**\n```typescript\nif (hardBlocks.length > 0) {\n  throw new AppError({\n    code: 'BUDGET_CONTROL_BLOCKED',\n    message: 'Some items exceed budget limits (HARD control)',\n    statusCode: 400,\n    details: {\n      hard_blocks: hardBlocks,\n      soft_warnings: softWarnings\n    }\n  });\n}\n```\n\n**User Impact:**\n- Red alert box displays at top of PR form\n- Submit button disabled with lock icon (ðŸ”’)\n- Per-item details show exceeded amounts and percentages\n- User must adjust quantities/prices or request budget amendment\n\n#### 2. SOFT Warning Without Reason\n**Description:** PR has items with SOFT warnings but user hasn't provided justification\n\n**Handling:**\n```typescript\nif (softWarnings.length > 0 && !data.budget_exceed_reason) {\n  throw new AppError({\n    code: 'BUDGET_EXCEED_REASON_REQUIRED',\n    message: 'Budget exceed reason is required for items with warnings',\n    statusCode: 400,\n    details: {\n      soft_warnings: softWarnings\n    }\n  });\n}\n```\n\n**User Impact:**\n- Yellow alert box displays below HARD errors (if any)\n- Textarea appears requiring user to enter reason\n- Submit button enabled only after reason is provided\n- Reason saved with PR for audit trail\n\n#### 3. Validation Function Failure\n**Description:** check_item_budget_control() function returns error (e.g., item not found)\n\n**Handling:**\n```typescript\nif (result.rows[0].quantity_status === 'BLOCKED' && \n    result.rows[0].message.error) {\n  // Log error but don't block PR creation entirely\n  this.logger.error({\n    item_id,\n    error: result.rows[0].message.error\n  }, 'Budget validation function error');\n  \n  // Treat as SOFT warning\n  return { ...result.rows[0], quantity_status: 'WARNING', allowed: true };\n}\n```\n\n**User Impact:**\n- Yellow warning displayed instead of red error\n- User can proceed but should investigate\n- Error logged for admin review\n\n## Testing Strategy\n\n### Unit Testing\n\n**Database Function Tests:**\n```typescript\ndescribe('check_item_budget_control()', () => {\n  it('should return OK when within tolerance', async () => {\n    // Setup: item with SOFT Â±10%, remaining 1000, request 1050 (5% over)\n    const result = await knex.raw('SELECT * FROM check_item_budget_control(?, ?, ?, ?)', \n      [itemId, 1050, 2.50, 2]);\n    expect(result.rows[0].quantity_status).toBe('OK');\n    expect(result.rows[0].allowed).toBe(true);\n  });\n  \n  it('should return WARNING for SOFT control exceeded', async () => {\n    // Setup: item with SOFT Â±10%, remaining 1000, request 1200 (20% over)\n    const result = await knex.raw('SELECT * FROM check_item_budget_control(?, ?, ?, ?)', \n      [itemId, 1200, 2.50, 2]);\n    expect(result.rows[0].quantity_status).toBe('WARNING');\n    expect(result.rows[0].allowed).toBe(true);\n  });\n  \n  it('should return BLOCKED for HARD control exceeded', async () => {\n    // Setup: item with HARD Â±10%, remaining 1000, request 1200 (20% over)\n    const result = await knex.raw('SELECT * FROM check_item_budget_control(?, ?, ?, ?)', \n      [itemId, 1200, 2.50, 2]);\n    expect(result.rows[0].quantity_status).toBe('BLOCKED');\n    expect(result.rows[0].allowed).toBe(false);\n  });\n});\n```\n\n**Service Layer Tests:**\n```typescript\ndescribe('PurchaseRequestsService.validateCreate()', () => {\n  it('should throw BUDGET_CONTROL_BLOCKED for HARD errors', async () => {\n    await expect(service.validateCreate(prData, userId))\n      .rejects.toThrow('BUDGET_CONTROL_BLOCKED');\n  });\n  \n  it('should throw BUDGET_EXCEED_REASON_REQUIRED for SOFT without reason', async () => {\n    await expect(service.validateCreate(prDataNoReason, userId))\n      .rejects.toThrow('BUDGET_EXCEED_REASON_REQUIRED');\n  });\n  \n  it('should allow PR with SOFT warnings and reason', async () => {\n    await expect(service.validateCreate(prDataWithReason, userId))\n      .resolves.not.toThrow();\n  });\n});\n```\n\n### Integration Testing\n\n**Full Workflow Tests:**\n\n1. **Configure Control â†’ Create PR â†’ Validation**\n   - Create budget request with items\n   - Set control types via PATCH endpoint\n   - Create PR that exceeds HARD limit\n   - Verify error response with details\n   - Adjust PR quantities\n   - Verify successful creation\n\n2. **Dashboard Data Accuracy**\n   - Create budget request with multiple items\n   - Create several PRs consuming budget\n   - Fetch dashboard data\n   - Verify usage percentages match expected calculations\n   - Verify status badges (normal/warning/exceeded) are correct\n\n3. **Concurrent PR Creation**\n   - Create two PRs simultaneously for same item\n   - Verify both check against same remaining budget\n   - Verify proper error handling if both would exceed\n\n### End-to-End Testing\n\n**User Scenarios:**\n\n1. **Finance Manager Configures Controls**\n   - Login as Finance Manager\n   - Navigate to budget request\n   - Click item settings icon\n   - Change Paracetamol to HARD Â±5%\n   - Save settings\n   - Verify UI shows red HARD badge\n   - Verify preview updates with examples\n\n2. **Procurement Officer Creates PR with HARD Error**\n   - Login as Procurement Officer\n   - Create new PR\n   - Add item that exceeds HARD limit\n   - Click validate/submit\n   - Verify red alert box appears\n   - Verify submit button is disabled\n   - Verify detailed breakdown shows exceeded amount\n\n3. **Procurement Officer Creates PR with SOFT Warning**\n   - Add item that exceeds SOFT limit\n   - Verify yellow warning box appears\n   - Verify textarea for reason appears\n   - Enter reason: \"Seasonal demand increase\"\n   - Verify submit button enables\n   - Submit PR\n   - Verify PR created successfully with reason logged\n\n4. **Finance Views Dashboard**\n   - Login as Finance Manager\n   - Navigate to budget dashboard\n   - Verify summary cards show correct totals\n   - Filter by \"HARD\" control type\n   - Verify only HARD-controlled items appear\n   - Filter by \"exceeded\" status\n   - Verify red progress bars appear\n   - Click item row\n   - Verify related PRs list appears\n",
  "fileStats": {
    "size": 20079,
    "lines": 641,
    "lastModified": "2025-12-19T04:02:02.798Z"
  },
  "comments": []
}
