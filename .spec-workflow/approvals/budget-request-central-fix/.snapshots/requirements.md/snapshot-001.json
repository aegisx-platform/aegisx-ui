{
  "id": "snapshot_1765986603340_zghhukjn5",
  "approvalId": "approval_1765986603298_ow61ox23p",
  "approvalTitle": "Budget Request Central Fix - Requirements Document",
  "version": 1,
  "timestamp": "2025-12-17T15:50:03.340Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Budget Request Central Fix - Requirements\n\n**Version:** 1.0.0\n**Created:** 2025-12-17\n**Status:** Active\n**Priority:** High\n\n---\n\n## Overview\n\nFix budget request creation to support central (hospital-wide) budget requests where `department_id = null`. Currently, users without department assignment cannot create budget requests due to validation errors.\n\n---\n\n## Business Requirements\n\n### BR-1: Support Central Budget Requests\n\n**Priority:** High (Blocker)\n**Description:** Allow creation of hospital-wide budget requests with `department_id = null`\n\n**Current Problem:**\n- Users without `department_id` (e.g., Finance, Admin) cannot create budget requests\n- Error: `USER_NO_DEPARTMENT` (422) thrown at service.ts:112-121\n- Blocks collaborative budget planning workflow\n\n**Business Context:**\n- Budget request is CENTRAL (hospital-wide, not per department)\n- Drug list covers entire hospital (~5,000 items)\n- ONE request per fiscal year (collaborative editing)\n- Multiple users from different departments contribute\n- Workflow: Create → Edit → Submit → Approve (Dept) → Approve (Finance) → PO/PR\n\n**Acceptance Criteria:**\n- ✅ Users without `department_id` can create budget requests\n- ✅ Budget request with `department_id = null` is valid\n- ✅ No \"USER_NO_DEPARTMENT\" error thrown\n- ✅ Central requests flow through approval workflow successfully\n\n---\n\n### BR-2: Finance Approval for Central Requests\n\n**Priority:** High\n**Description:** Allow finance approval to complete for central budget requests without creating department-specific allocations\n\n**Current Problem:**\n- Finance approval fails if `department_id = null`\n- Error: `BUDGET_REQUEST_NO_DEPARTMENT` (400) at service.ts:618-628\n- Blocks final approval stage\n\n**Business Logic:**\n- Central requests don't need immediate budget allocations\n- Allocations created later at PO/PR stage when items distributed to departments\n- Finance approval indicates budget availability, not allocation\n\n**Acceptance Criteria:**\n- ✅ Finance approval succeeds for central requests\n- ✅ No error about missing department_id\n- ✅ Status changes to `FINANCE_APPROVED`\n- ✅ Logs indicate skipped allocation (audit trail)\n\n---\n\n### BR-3: Collaborative Editing\n\n**Priority:** High\n**Description:** Support multiple users editing the same central budget request\n\n**Business Context:**\n- Finance user creates request (department_id = null)\n- Pharmacy staff updates drug quantities\n- Nursing staff updates medical supplies\n- Multiple users work simultaneously on same request\n\n**Acceptance Criteria:**\n- ✅ All users can edit items regardless of their department_id\n- ✅ Permission-based access (not department-based)\n- ✅ No conflicts with null department_id\n\n---\n\n## Technical Requirements\n\n### TR-1: Remove Auto-Population Logic\n\n**File:** `budget-requests.service.ts`\n**Location:** Lines 100-132 in `create()` method\n\n**Requirements:**\n- Remove auto-populate department_id from user profile\n- Accept department_id from request data directly\n- Allow null values for central requests\n- Keep 0 → null conversion for TypeBox coercion\n\n---\n\n### TR-2: Skip Budget Allocations for Central Requests\n\n**File:** `budget-requests.service.ts`\n**Location:** Lines 618-628 in `approveFinance()` method\n\n**Requirements:**\n- Check if department_id is null\n- Skip budget_allocations creation (don't throw error)\n- Log info message for audit trail\n- Allow approval to complete successfully\n\n---\n\n### TR-3: Schema Validation\n\n**File:** `budget-requests.schemas.ts`\n\n**Current Status:** ✅ Already correct\n- `department_id` is `Type.Optional(Type.Union([Type.Integer(), Type.Null()]))`\n- Schema already allows null values\n\n**Requirements:**\n- Verify schema accepts null\n- No changes needed\n\n---\n\n### TR-4: Frontend Compatibility\n\n**File:** `budget-requests-form.component.ts`\n\n**Current Status:** ✅ Already correct\n- Form has optional department dropdown\n- Auto-populates from user if available\n- Sends null if not selected\n- Shows informational warning (not error)\n\n**Requirements:**\n- Verify form behavior with null department_id\n- No changes needed\n\n---\n\n## User Scenarios\n\n### Scenario 1: Finance User Creates Central Request\n```\nUser: Finance Officer (department_id = null)\nAction: Create budget request for fiscal year 2568\nExpected: Success (201 Created)\n```\n\n### Scenario 2: Department User Edits Items\n```\nUser: Pharmacy Head (department_id = 5)\nAction: Update drug quantities in central request\nExpected: Success (PATCH succeeds)\n```\n\n### Scenario 3: Finance Approval\n```\nUser: Finance Manager\nAction: Approve central budget request (department_id = null)\nExpected: Status → FINANCE_APPROVED (no allocations created)\n```\n\n---\n\n## Constraints\n\n### Business Constraints\n- ✅ One central request per fiscal year\n- ✅ department_id must always be null for central requests\n- ✅ Allocations deferred to PO/PR stage\n\n### Technical Constraints\n- ✅ Must maintain backward compatibility with department-specific requests\n- ✅ No breaking changes to existing API\n- ✅ Schema already correct (no migration needed)\n\n---\n\n## Success Metrics\n\n1. **Error Rate:** Zero \"USER_NO_DEPARTMENT\" errors\n2. **Approval Success:** 100% finance approval success rate for central requests\n3. **User Satisfaction:** Finance team can create budgets without admin intervention\n4. **Code Quality:** Reduced from ~60 lines to ~30 lines in create() method\n\n---\n\n## Out of Scope\n\n- ❌ Budget allocation distribution logic (future PO/PR module)\n- ❌ Permission-based access control (already implemented)\n- ❌ Frontend UI changes (already supports null department_id)\n- ❌ Multi-fiscal-year requests (one per year only)\n",
  "fileStats": {
    "size": 5658,
    "lines": 196,
    "lastModified": "2025-12-17T15:49:55.250Z"
  },
  "comments": []
}
