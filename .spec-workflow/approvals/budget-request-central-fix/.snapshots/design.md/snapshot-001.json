{
  "id": "snapshot_1765988288042_2mll3d79u",
  "approvalId": "approval_1765988288026_zgf1pq9ao",
  "approvalTitle": "Budget Request Central Fix - Design Document",
  "version": 1,
  "timestamp": "2025-12-17T16:18:08.042Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Budget Request Central Fix - Technical Design\n\n**Version:** 1.0.0\n**Created:** 2025-12-17\n**Last Updated:** 2025-12-17\n\n---\n\n## Architecture Overview\n\n### Current Flow (Broken)\n```\nUser without department_id\n    ↓\nFrontend sends: { fiscal_year: 2568, department_id: null }\n    ↓\nBackend service.create() tries auto-populate\n    ↓\nuser.department_id is also null\n    ↓\n❌ Throws: USER_NO_DEPARTMENT (422)\n```\n\n### New Flow (Fixed)\n```\nUser (any department_id or null)\n    ↓\nFrontend sends: { fiscal_year: 2568, department_id: null }\n    ↓\nBackend service.create() accepts null directly\n    ↓\n✅ Budget request created with department_id = null\n    ↓\nWorkflow: Submit → Dept Approve → Finance Approve\n    ↓\nFinance Approve: Skip allocations, log info\n    ↓\n✅ Status: FINANCE_APPROVED\n```\n\n---\n\n## Design Decisions\n\n### Decision 1: Remove Auto-Population Logic\n\n**Problem:** Auto-population logic throws error if user has no department_id\n\n**Options Considered:**\n1. **Remove auto-populate entirely** ✅ CHOSEN\n   - Pros: Simplest, allows null values, reduces code complexity\n   - Cons: Users must explicitly select department (but that's okay for central requests)\n\n2. Allow null as fallback (keep auto-populate)\n   - Pros: Backward compatible\n   - Cons: More complex logic, still tries to query user\n\n3. Check permission instead of department\n   - Pros: More flexible\n   - Cons: Permission system already handles access control separately\n\n**Chosen Solution:** Remove auto-populate logic\n- Accept department_id from request data directly\n- Allow null for central requests\n- Simplify code from ~60 lines to ~30 lines\n\n---\n\n### Decision 2: Budget Allocations Handling\n\n**Problem:** Finance approval tries to create allocations but department_id is null\n\n**Options Considered:**\n1. **Skip allocation creation** ✅ CHOSEN\n   - Pros: Clean separation, allocations created later at PO/PR stage\n   - Cons: Two-stage allocation process\n\n2. Create allocations for \"Central\" department (ID = 1)\n   - Pros: Allocations exist immediately\n   - Cons: Artificial department, complicates queries\n\n3. Reject approval until department assigned\n   - Pros: Enforces department requirement\n   - Cons: Blocks business workflow\n\n**Chosen Solution:** Skip allocation creation\n- Log info message for audit trail\n- Allocations created later when items distributed to departments (PO/PR stage)\n- Cleaner separation of concerns\n\n---\n\n## Component Design\n\n### Component 1: BudgetRequestsService.create()\n\n**Current Implementation (Lines 87-148):**\n```typescript\nasync create(data: CreateBudgetRequests, userId?: string) {\n  let departmentId = data.department_id;\n\n  // ❌ PROBLEM: Auto-populate logic\n  if ((!departmentId || departmentId === 0) && userId) {\n    const user = await this.usersRepository.findById(userId);\n\n    if (!user) {\n      throw error: 'USER_NOT_FOUND' (404)\n    }\n\n    // ❌ Throws error if user has no department\n    if (!user.department_id) {\n      throw error: 'USER_NO_DEPARTMENT' (422)\n    }\n\n    departmentId = user.department_id;\n  }\n\n  // Create with auto-populated departmentId\n  return super.create({\n    ...data,\n    department_id: departmentId === 0 ? null : departmentId,\n  });\n}\n```\n\n**New Implementation (~30 lines):**\n```typescript\nasync create(data: CreateBudgetRequests, userId?: string): Promise<BudgetRequests> {\n  // Auto-generate request_number\n  const requestNumber = data.request_number ||\n    await this.generateRequestNumber(data.fiscal_year);\n\n  // Use department_id from request (allow null)\n  let departmentId = data.department_id;\n\n  // Convert 0 to null (TypeBox coercion)\n  if (departmentId === 0) {\n    departmentId = null;\n  }\n\n  // Log for audit (if null)\n  if (departmentId === null) {\n    this.logger.info(\n      { userId, fiscalYear: data.fiscal_year, requestNumber },\n      'Creating central budget request (department_id = null)'\n    );\n  }\n\n  // Build create data\n  const createData: CreateBudgetRequests = {\n    ...data,\n    request_number: requestNumber,\n    status: data.status || 'DRAFT',\n    total_requested_amount: data.total_requested_amount ?? 0,\n    department_id: departmentId,  // Allow null\n  };\n\n  return await super.create(createData);\n}\n```\n\n**Changes:**\n- ✅ Removed lines 100-132 (auto-populate logic)\n- ✅ Accept null department_id directly\n- ✅ Added audit logging\n- ✅ Simplified from ~60 lines to ~30 lines\n\n---\n\n### Component 2: BudgetRequestsService.approveFinance()\n\n**Current Implementation (Lines 618-628):**\n```typescript\nasync approveFinance(id: string | number, userId: string, comments?: string) {\n  // ... fetch request and items ...\n\n  for (const item of requestItems) {\n    // ❌ PROBLEM: Throws error if department_id is null\n    if (!request.department_id) {\n      throw error: 'BUDGET_REQUEST_NO_DEPARTMENT' (400)\n    }\n\n    // Create budget_allocations\n    await knex('inventory.budget_allocations').insert({\n      department_id: request.department_id,  // Requires non-null\n      // ...\n    });\n  }\n}\n```\n\n**New Implementation:**\n```typescript\nasync approveFinance(id: string | number, userId: string, comments?: string) {\n  // ... fetch request and items ...\n\n  for (const item of requestItems) {\n    // ✅ Skip allocation for central requests\n    if (!request.department_id) {\n      this.logger.info(\n        {\n          budgetRequestId: id,\n          fiscalYear: request.fiscal_year,\n          itemCount: requestItems.length,\n        },\n        'Skipping budget_allocations creation for central budget request ' +\n        '(department_id = null). Allocations will be created at PO/PR stage.'\n      );\n      continue;  // Skip this item\n    }\n\n    // Create allocation for specific department\n    await knex('inventory.budget_allocations').insert({\n      department_id: request.department_id,\n      // ...\n    });\n  }\n\n  // Update status to FINANCE_APPROVED\n  // (works even if no allocations created)\n}\n```\n\n**Changes:**\n- ✅ Removed error throw for null department_id\n- ✅ Added skip logic with continue\n- ✅ Added audit logging\n- ✅ Approval completes successfully\n\n---\n\n## Data Flow\n\n### Creation Flow\n```\n┌─────────────────────────────────────┐\n│ Frontend Form                       │\n│ - fiscal_year: 2568                 │\n│ - department_id: null               │\n│ - justification: \"...\"              │\n└─────────────────────────────────────┘\n           ↓ POST /api/.../budget-requests\n┌─────────────────────────────────────┐\n│ Controller                          │\n│ - Validate schema (already allows   │\n│   null)                             │\n│ - Extract userId from auth          │\n└─────────────────────────────────────┘\n           ↓\n┌─────────────────────────────────────┐\n│ Service.create()                    │\n│ - Accept department_id: null        │\n│ - Generate request_number           │\n│ - Log audit message                 │\n│ - Create record                     │\n└─────────────────────────────────────┘\n           ↓\n┌─────────────────────────────────────┐\n│ Database                            │\n│ INSERT INTO budget_requests         │\n│ (fiscal_year, department_id, ...)  │\n│ VALUES (2568, NULL, ...)            │\n└─────────────────────────────────────┘\n           ↓\n┌─────────────────────────────────────┐\n│ Response: 201 Created               │\n│ {                                   │\n│   id: 123,                          │\n│   request_number: \"BR-2568-001\",    │\n│   department_id: null,              │\n│   status: \"DRAFT\"                   │\n│ }                                   │\n└─────────────────────────────────────┘\n```\n\n### Finance Approval Flow\n```\n┌─────────────────────────────────────┐\n│ Budget Request                      │\n│ - status: DEPT_APPROVED             │\n│ - department_id: null               │\n│ - items: 5000                       │\n└─────────────────────────────────────┘\n           ↓ POST .../approve-finance\n┌─────────────────────────────────────┐\n│ Service.approveFinance()            │\n│ - Fetch request + items             │\n│ - Loop through items                │\n│ - Check: department_id is null?     │\n│   Yes → Skip allocation, log info   │\n│   No → Create allocation            │\n│ - Update status: FINANCE_APPROVED   │\n└─────────────────────────────────────┘\n           ↓\n┌─────────────────────────────────────┐\n│ Response: 200 OK                    │\n│ {                                   │\n│   id: 123,                          │\n│   status: \"FINANCE_APPROVED\",       │\n│   finance_reviewed_by: \"user-456\"   │\n│ }                                   │\n│                                     │\n│ Logs:                               │\n│ \"Skipping budget_allocations...\"    │\n└─────────────────────────────────────┘\n```\n\n---\n\n## Error Handling\n\n### Scenario 1: Null Department (BEFORE FIX)\n```\nInput: { fiscal_year: 2568, department_id: null }\nError: USER_NO_DEPARTMENT (422)\nResponse: {\n  success: false,\n  error: {\n    code: \"USER_NO_DEPARTMENT\",\n    message: \"You are not assigned to a department...\",\n    statusCode: 422\n  }\n}\n```\n\n### Scenario 1: Null Department (AFTER FIX)\n```\nInput: { fiscal_year: 2568, department_id: null }\nSuccess: 201 Created\nResponse: {\n  success: true,\n  data: {\n    id: 123,\n    request_number: \"BR-2568-001\",\n    fiscal_year: 2568,\n    department_id: null,  ← Allowed\n    status: \"DRAFT\"\n  }\n}\n```\n\n---\n\n## Database Schema\n\n### budget_requests Table\n```sql\nCREATE TABLE inventory.budget_requests (\n  id SERIAL PRIMARY KEY,\n  request_number VARCHAR(50) UNIQUE NOT NULL,\n  fiscal_year INTEGER NOT NULL,\n  department_id INTEGER REFERENCES departments(id),  ← Nullable FK\n  status VARCHAR(50) DEFAULT 'DRAFT',\n  -- ... other fields\n);\n```\n\n**Key Point:** `department_id` is already nullable in database schema!\n\n---\n\n## Testing Strategy\n\n### Unit Tests\n```typescript\ndescribe('BudgetRequestsService.create()', () => {\n  it('should create budget request with null department_id', async () => {\n    const data = {\n      fiscal_year: 2568,\n      department_id: null,  // Central request\n    };\n\n    const result = await service.create(data, 'user-123');\n\n    expect(result.department_id).toBeNull();\n    expect(result.status).toBe('DRAFT');\n  });\n\n  it('should not throw USER_NO_DEPARTMENT error', async () => {\n    const data = { fiscal_year: 2568, department_id: null };\n\n    await expect(service.create(data, 'user-123')).resolves.not.toThrow();\n  });\n});\n\ndescribe('BudgetRequestsService.approveFinance()', () => {\n  it('should approve central request without creating allocations', async () => {\n    const request = {\n      id: 123,\n      department_id: null,\n      status: 'DEPT_APPROVED',\n    };\n\n    const result = await service.approveFinance(123, 'finance-user', 'Approved');\n\n    expect(result.status).toBe('FINANCE_APPROVED');\n    // Verify no allocations created\n    const allocations = await knex('budget_allocations')\n      .where({ fiscal_year: 2568 });\n    expect(allocations).toHaveLength(0);\n  });\n});\n```\n\n---\n\n## Rollback Plan\n\nIf issues occur:\n\n### Immediate Rollback\n```bash\ngit revert <commit-hash>\ngit push origin develop\n```\n\n### Temporary Workaround\n```sql\n-- Assign all users to \"Central\" department\nUPDATE users SET department_id = 1 WHERE department_id IS NULL;\n```\n\n### Long-term Fix\n- Implement permission-based creation\n- Add \"can_create_central_budgets\" permission\n- Remove department_id requirement entirely\n\n---\n\n## Security Considerations\n\n### Permission Checks\n- ✅ Already implemented: `budgetRequests:create` permission\n- ✅ Permission-based, not department-based\n- ✅ No security impact from allowing null department_id\n\n### Audit Trail\n- ✅ Log central request creation\n- ✅ Log allocation skipping\n- ✅ Track all user actions\n\n---\n\n## Performance Impact\n\n### Before Fix\n- ~60 lines in create() method\n- Extra database query (user lookup)\n- Auto-populate logic overhead\n\n### After Fix\n- ~30 lines in create() method (50% reduction)\n- No extra database query\n- Simpler, faster execution\n\n**Expected:** 10-15ms faster request creation\n\n---\n\n## Backward Compatibility\n\n### Department-Specific Requests (Still Supported)\n```json\nPOST /api/inventory/budget/budget-requests\n{\n  \"fiscal_year\": 2568,\n  \"department_id\": 5  ← Still works!\n}\n```\n\n### Finance Approval (Still Creates Allocations)\n- If department_id is not null → creates allocations\n- If department_id is null → skips allocations\n- Both cases succeed\n\n**Impact:** ✅ Zero breaking changes\n",
  "fileStats": {
    "size": 13848,
    "lines": 477,
    "lastModified": "2025-12-17T16:17:59.655Z"
  },
  "comments": []
}
