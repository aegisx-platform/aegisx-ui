{
  "id": "snapshot_1765722055677_paaquwnid",
  "approvalId": "approval_1765722055664_316fz4q9n",
  "approvalTitle": "Requirements - Drug Return Backend API",
  "version": 1,
  "timestamp": "2025-12-14T14:20:55.677Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document - Drug Return Backend API\n\n## Introduction\n\nThe **Drug Return Backend API** provides comprehensive backend services for the hospital drug return management system. This API handles the complete lifecycle of drug returns from departments back to the pharmacy, including good/damaged separation, inventory updates, and disposal management.\n\n**System Overview:**\nThe Drug Return system manages returns from departments/wards when they have:\n- Excess stock (patient discharged, order cancelled)\n- Expired or near-expiry drugs\n- Damaged drugs (broken packaging, contamination)\n- Wrong drugs (dispensing errors)\n- Adverse drug reactions (ADR - patient cannot tolerate)\n\n**Core Workflow:**\n1. **Department creates return** → Records drugs to return with lot numbers and reasons\n2. **Pharmacist verifies** → Physically inspects and separates good vs damaged quantities\n3. **System posts to inventory** → Good drugs restocked, damaged moved to quarantine\n4. **Disposal management** → Periodic disposal of damaged/expired drugs with committee approval\n\n**Value to Users:**\n- Department staff can return excess/unused drugs efficiently with proper documentation\n- Pharmacists can verify and accept returns with good/damaged separation\n- Inventory automatically updated with RETURN transactions and lot tracking\n- Finance officers can track value of returned drugs for cost recovery\n- Management can monitor return patterns to identify issues (overstocking, dispensing errors)\n- Compliance team can maintain complete audit trail for regulatory inspections\n\n**Technical Foundation:**\n- 3 database tables: `drug_returns`, `drug_return_items`, `return_reasons`\n- Status workflow: DRAFT → SUBMITTED → VERIFIED → POSTED\n- Integration with Inventory API for stock updates and lot management\n- Integration with Distribution API for original lot traceability\n- Ministry compliance: Supports disposal documentation requirements\n\n## Alignment with Product Vision\n\nThis feature supports the **INVS Modern** vision of a comprehensive hospital drug inventory management system by:\n\n1. **Closed-Loop Inventory Management**: Completes the inventory cycle by handling returns, ensuring accurate stock levels across all locations\n2. **Quality Control Integration**: Good/damaged separation ensures only quality drugs are restocked, maintaining pharmacy standards\n3. **FIFO/FEFO Integrity**: Lot-based returns maintain traceability from distribution → usage → return → restock or disposal\n4. **Waste Reduction**: Enables departments to return excess drugs for reuse instead of disposal, reducing costs\n5. **Audit Trail Compliance**: Complete transaction history from return request to inventory posting for regulatory compliance\n6. **Cross-System Integration**: Seamless data flow between Distribution, Drug Return, and Inventory systems\n\n**Technical Alignment:**\n- Follows AegisX platform standards (TypeBox schemas, Fastify routes, service layer pattern)\n- Implements domain-driven design in `inventory/operations` domain\n- Uses PostgreSQL schema `inventory` with transaction support\n- Integrates with existing Inventory API for stock updates\n- Reuses Distribution API patterns for lot validation\n\n**Business Impact:**\n- Reduces drug waste through efficient return and restock processes\n- Improves inventory accuracy by accounting for all drug movements\n- Enables cost recovery from returned drugs\n- Supports quality management through damaged drug tracking\n\n## Requirements\n\n### Phase 1: CRUD Operations\n\n#### REQ-1: List Drug Returns with Filters\n\n**User Story:** As a pharmacist, I want to view all drug returns with filtering options, so that I can prioritize pending returns and track return history.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-returns` **THEN** system **SHALL** return paginated list of drug returns\n2. **WHEN** `status` query parameter provided **THEN** system **SHALL** filter returns by status (DRAFT, SUBMITTED, VERIFIED, POSTED, CANCELLED)\n3. **WHEN** `departmentId` query parameter provided **THEN** system **SHALL** filter returns by department\n4. **WHEN** `dateFrom` and `dateTo` parameters provided **THEN** system **SHALL** filter by return_date range\n5. **WHEN** `search` parameter provided **THEN** system **SHALL** search by return_number or department name\n6. **WHEN** return data returned **THEN** system **SHALL** include department details, total items, total amount, and status\n7. **WHEN** return data returned **THEN** system **SHALL** order by return_date DESC (newest first) by default\n8. **IF** user has department restriction **THEN** system **SHALL** filter to show only returns from authorized departments\n\n#### REQ-2: Get Return Details\n\n**User Story:** As a pharmacist, I want to view complete details of a specific return including all items, so that I can verify and process the return.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-returns/:id` **THEN** system **SHALL** return complete return details\n2. **IF** return not found **THEN** system **SHALL** return 404 with error code `RETURN_NOT_FOUND`\n3. **WHEN** return details returned **THEN** system **SHALL** include all header fields (return_number, department, return_date, reason, status)\n4. **WHEN** return details returned **THEN** system **SHALL** include all return items with drug details, lot numbers, quantities\n5. **WHEN** return details returned **THEN** system **SHALL** include good_quantity and damaged_quantity for each item if verified\n6. **WHEN** return details returned **THEN** system **SHALL** include return reason details from return_reasons table\n7. **WHEN** return details returned **THEN** system **SHALL** include audit fields (created_by, verified_by, received_by, timestamps)\n\n#### REQ-3: Create Drug Return Request\n\n**User Story:** As a department staff member, I want to create a return request for excess or expired drugs, so that I can return them to the pharmacy properly.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-returns` **THEN** system **SHALL** validate that department_id exists\n2. **WHEN** creating return **THEN** system **SHALL** auto-generate return_number in format RET-{YYYY}-{MM}-{###}\n3. **WHEN** creating return **THEN** system **SHALL** validate that all item lot_numbers exist in drug_lots table\n4. **WHEN** creating return **THEN** system **SHALL** validate that return_reason_id exists in return_reasons table\n5. **WHEN** creating return **THEN** system **SHALL** set initial status to DRAFT\n6. **WHEN** creating return **THEN** system **SHALL** calculate total_items count automatically\n7. **WHEN** return items added **THEN** system **SHALL** require drug_id, total_quantity, lot_number, expiry_date, return_type (PURCHASED/FREE), location_id for each item\n8. **WHEN** return created successfully **THEN** system **SHALL** return complete return details with generated return_number\n9. **IF** any validation fails **THEN** system **SHALL** rollback transaction and return appropriate error\n\n#### REQ-4: Update Draft Return\n\n**User Story:** As a department staff member, I want to edit my draft return request before submitting, so that I can correct mistakes or add more items.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `PUT /api/inventory/operations/drug-returns/:id` **THEN** system **SHALL** validate that return status is DRAFT\n2. **IF** return status is not DRAFT **THEN** system **SHALL** return 400 error \"Cannot edit return after submission\"\n3. **WHEN** updating return **THEN** system **SHALL** allow changes to return_reason, notes, and items\n4. **WHEN** updating items **THEN** system **SHALL** validate lot numbers and quantities\n5. **WHEN** updating items **THEN** system **SHALL** recalculate total_items count\n6. **WHEN** update successful **THEN** system **SHALL** update updated_at timestamp\n7. **WHEN** update successful **THEN** system **SHALL** return updated return details\n\n#### REQ-5: Delete/Cancel Return\n\n**User Story:** As a department staff member, I want to cancel a return request that I created by mistake, so that it doesn't clutter the system.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `DELETE /api/inventory/operations/drug-returns/:id` **THEN** system **SHALL** validate that return status is DRAFT\n2. **IF** return status is SUBMITTED or later **THEN** system **SHALL** use cancel workflow instead (status = CANCELLED)\n3. **WHEN** deleting DRAFT return **THEN** system **SHALL** delete return items first, then return header\n4. **WHEN** cancelling return (SUBMITTED/VERIFIED) **THEN** system **SHALL** update status to CANCELLED and record cancellation reason\n5. **WHEN** cancelling return **THEN** system **SHALL** record cancelled_by user and cancelled_at timestamp\n6. **IF** return already POSTED **THEN** system **SHALL** return 400 error \"Cannot cancel posted return\"\n7. **WHEN** cancel successful **THEN** system **SHALL** return confirmation message\n\n#### REQ-6: List Return Reasons\n\n**User Story:** As a department staff member, I want to see available return reasons, so that I can select the appropriate reason for my return.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/return-reasons` **THEN** system **SHALL** return list of all active return reasons\n2. **WHEN** return reasons returned **THEN** system **SHALL** include reason_code, reason_name, reason_category (CLINICAL, OPERATIONAL, QUALITY)\n3. **WHEN** return reasons returned **THEN** system **SHALL** order by reason_category, then reason_name\n4. **WHEN** `category` parameter provided **THEN** system **SHALL** filter by reason_category\n5. **WHEN** return reasons returned **THEN** system **SHALL** include is_active flag\n\n### Phase 2: Workflow Endpoints\n\n#### REQ-7: Submit Return for Verification\n\n**User Story:** As a department staff member, I want to submit my return request for pharmacist verification, so that the return can be processed.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-returns/:id/submit` **THEN** system **SHALL** validate that return status is DRAFT\n2. **IF** return status is not DRAFT **THEN** system **SHALL** return 400 error \"Return already submitted\"\n3. **WHEN** submitting return **THEN** system **SHALL** validate that return has at least 1 item\n4. **WHEN** submitting return **THEN** system **SHALL** update status to SUBMITTED\n5. **WHEN** submitting return **THEN** system **SHALL** record submitted_at timestamp\n6. **WHEN** submit successful **THEN** system **SHALL** send notification to pharmacy department (via event bus)\n7. **WHEN** submit successful **THEN** system **SHALL** return updated return details with SUBMITTED status\n\n#### REQ-8: Verify and Separate Good/Damaged Quantities\n\n**User Story:** As a pharmacist, I want to verify returned drugs and separate good vs damaged quantities, so that only quality drugs are restocked.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-returns/:id/verify` **THEN** system **SHALL** validate that return status is SUBMITTED\n2. **IF** return status is not SUBMITTED **THEN** system **SHALL** return 400 error \"Return must be submitted before verification\"\n3. **WHEN** verifying return **THEN** system **SHALL** require good_quantity and damaged_quantity for each item\n4. **WHEN** verifying return **THEN** system **SHALL** validate that `total_quantity = good_quantity + damaged_quantity` for each item\n5. **IF** quantities don't match **THEN** system **SHALL** return 400 error with item details \"Good + Damaged must equal Total\"\n6. **WHEN** verification data valid **THEN** system **SHALL** update all items with good_quantity and damaged_quantity\n7. **WHEN** verification successful **THEN** system **SHALL** update status to VERIFIED\n8. **WHEN** verification successful **THEN** system **SHALL** record verified_by user and verified_at timestamp\n9. **WHEN** verification successful **THEN** system **SHALL** calculate total_amount based on good_quantity × unit_cost\n10. **WHEN** verification successful **THEN** system **SHALL** return updated return details with VERIFIED status\n\n#### REQ-9: Post Return to Inventory\n\n**User Story:** As a pharmacist, I want to post verified returns to inventory, so that good drugs are automatically restocked and damaged drugs moved to quarantine.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-returns/:id/post` **THEN** system **SHALL** validate that return status is VERIFIED\n2. **IF** return status is not VERIFIED **THEN** system **SHALL** return 400 error \"Return must be verified before posting\"\n3. **WHEN** posting return **THEN** system **SHALL** process within database transaction for atomicity\n4. **FOR EACH** item with good_quantity > 0:\n   - **THEN** system **SHALL** find or create inventory record for (drug_id, location_id)\n   - **THEN** system **SHALL** increment inventory.quantity_on_hand by good_quantity\n   - **THEN** system **SHALL** find or create drug lot with matching lot_number\n   - **THEN** system **SHALL** increment drug_lot.quantity_available by good_quantity\n   - **THEN** system **SHALL** create inventory_transaction with type = RETURN and reference to return\n5. **FOR EACH** item with damaged_quantity > 0:\n   - **THEN** system **SHALL** find QUARANTINE location (location_code = 'QUARANTINE')\n   - **IF** QUARANTINE not found **THEN** system **SHALL** return 400 error \"Quarantine location not configured\"\n   - **THEN** system **SHALL** create drug lot in QUARANTINE with lot_number suffix \"-DMG\"\n   - **THEN** system **SHALL** set lot is_active = false (for disposal only)\n6. **WHEN** all items processed **THEN** system **SHALL** update return status to POSTED\n7. **WHEN** posting successful **THEN** system **SHALL** record received_by user and posted_at timestamp\n8. **WHEN** posting successful **THEN** system **SHALL** return posting summary (items restocked, items quarantined)\n9. **IF** any step fails **THEN** system **SHALL** rollback entire transaction and return error\n\n#### REQ-10: Cancel Return Workflow\n\n**User Story:** As a department manager, I want to cancel a return request that is no longer needed, so that it doesn't proceed to posting.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-returns/:id/cancel` **THEN** system **SHALL** validate that return status is SUBMITTED or VERIFIED\n2. **IF** return already POSTED **THEN** system **SHALL** return 400 error \"Cannot cancel posted return\"\n3. **WHEN** cancelling return **THEN** system **SHALL** require cancellation_reason\n4. **WHEN** cancel successful **THEN** system **SHALL** update status to CANCELLED\n5. **WHEN** cancel successful **THEN** system **SHALL** record cancelled_by user, cancelled_at timestamp, and cancellation_reason\n6. **WHEN** cancel successful **THEN** system **SHALL** send notification to requester\n7. **WHEN** cancel successful **THEN** system **SHALL** return updated return details with CANCELLED status\n\n### Phase 3: Inventory Integration\n\n#### REQ-11: Create Inventory Transactions for Returns\n\n**User Story:** As a system, I want to create proper inventory transactions for all returns, so that there is complete audit trail of stock movements.\n\n##### Acceptance Criteria\n\n1. **WHEN** return is posted **THEN** system **SHALL** create inventory_transaction record for each item with good_quantity > 0\n2. **WHEN** creating transaction **THEN** system **SHALL** set transaction_type = RETURN\n3. **WHEN** creating transaction **THEN** system **SHALL** set quantity = good_quantity (positive number for stock increase)\n4. **WHEN** creating transaction **THEN** system **SHALL** set reference_type = \"drug_return\" and reference_id = return.id\n5. **WHEN** creating transaction **THEN** system **SHALL** include notes with department name, lot number, and quantities\n6. **WHEN** creating transaction **THEN** system **SHALL** record created_by user\n7. **WHEN** transaction created **THEN** system **SHALL** ensure transaction is immutable (no updates allowed)\n\n#### REQ-12: Update Inventory Quantities\n\n**User Story:** As a system, I want to update inventory quantities correctly when returns are posted, so that stock levels are accurate.\n\n##### Acceptance Criteria\n\n1. **WHEN** posting return with good_quantity **THEN** system **SHALL** find inventory record by (drug_id, location_id)\n2. **IF** inventory record not found **THEN** system **SHALL** create new inventory record with quantity = good_quantity\n3. **IF** inventory record exists **THEN** system **SHALL** increment quantity_on_hand by good_quantity\n4. **WHEN** updating inventory **THEN** system **SHALL** update last_updated timestamp\n5. **WHEN** creating new inventory **THEN** system **SHALL** initialize average_cost and last_cost to 0 (will be updated by costing system)\n6. **WHEN** inventory updated **THEN** system **SHALL** return updated inventory details\n\n#### REQ-13: Update/Create Drug Lots\n\n**User Story:** As a system, I want to update or create drug lots when returns are posted, so that lot traceability is maintained.\n\n##### Acceptance Criteria\n\n1. **WHEN** posting return with good_quantity **THEN** system **SHALL** search for existing lot by (drug_id, location_id, lot_number)\n2. **IF** lot found **THEN** system **SHALL** increment lot.quantity_available by good_quantity\n3. **IF** lot found **THEN** system **SHALL** set is_active = true (reactivate if was inactive)\n4. **IF** lot not found **THEN** system **SHALL** create new lot with:\n   - drug_id, location_id, lot_number, expiry_date from return item\n   - quantity_available = good_quantity\n   - unit_cost = 0 (will be updated by costing system)\n   - received_date = return.return_date\n   - is_active = true\n5. **WHEN** lot created/updated **THEN** system **SHALL** validate expiry_date is in future\n6. **IF** expiry_date < current_date **THEN** system **SHALL** log warning but allow creation (for audit purposes)\n\n#### REQ-14: Move Damaged Drugs to Quarantine\n\n**User Story:** As a system, I want to move damaged drugs to quarantine location when returns are posted, so that they are isolated for disposal.\n\n##### Acceptance Criteria\n\n1. **WHEN** posting return with damaged_quantity > 0 **THEN** system **SHALL** find QUARANTINE location\n2. **IF** QUARANTINE location not found **THEN** system **SHALL** return 400 error \"Quarantine location not configured\"\n3. **WHEN** moving to quarantine **THEN** system **SHALL** create new drug lot in QUARANTINE with:\n   - lot_number = original_lot_number + \"-DMG\" suffix\n   - quantity_available = damaged_quantity\n   - is_active = false (cannot be used for distribution)\n   - notes = \"Damaged return from {department_name}. Reason: {return_reason}\"\n4. **WHEN** quarantine lot created **THEN** system **SHALL** record source return information\n5. **WHEN** quarantine lot created **THEN** system **SHALL** return quarantine lot details\n\n#### REQ-15: Validate Lot Traceability\n\n**User Story:** As a system, I want to validate that returned lots match original distribution lots, so that returns are traceable to their source.\n\n##### Acceptance Criteria\n\n1. **WHEN** creating return item **THEN** system **SHALL** validate that lot_number exists in drug_lots table\n2. **WHEN** validating lot **THEN** system **SHALL** validate that lot belongs to the specified drug_id\n3. **WHEN** validating lot **THEN** system **SHALL** check if lot was distributed to the returning department (optional validation)\n4. **IF** lot not found **THEN** system **SHALL** return 400 error \"Invalid lot number for this drug\"\n5. **WHEN** lot valid **THEN** system **SHALL** allow return creation\n6. **WHEN** return posted **THEN** system **SHALL** maintain link to original lot in transaction notes\n\n### Phase 4: Reporting & Analytics\n\n#### REQ-16: Return History by Department\n\n**User Story:** As a department manager, I want to view return history for my department, so that I can identify patterns and improve ordering.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-returns/department/:departmentId/history` **THEN** system **SHALL** return list of returns for that department\n2. **WHEN** `dateFrom` and `dateTo` parameters provided **THEN** system **SHALL** filter by return_date range\n3. **WHEN** `status` parameter provided **THEN** system **SHALL** filter by status\n4. **WHEN** return history returned **THEN** system **SHALL** include summary statistics:\n   - Total returns count\n   - Total items returned\n   - Total value of returns\n   - Return reasons breakdown\n5. **WHEN** return history returned **THEN** system **SHALL** order by return_date DESC\n6. **WHEN** return history returned **THEN** system **SHALL** include item details for each return\n\n#### REQ-17: Damaged Drugs Summary\n\n**User Story:** As a quality manager, I want to see summary of damaged drugs returned, so that I can identify quality issues with vendors or storage.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-returns/damaged-summary` **THEN** system **SHALL** return summary of all damaged quantities\n2. **WHEN** `dateFrom` and `dateTo` parameters provided **THEN** system **SHALL** filter by return_date range\n3. **WHEN** damaged summary returned **THEN** system **SHALL** group by drug and show:\n   - Drug name and code\n   - Total damaged quantity\n   - Number of returns with damage\n   - Most common damage reasons\n   - Total value of damaged drugs\n4. **WHEN** damaged summary returned **THEN** system **SHALL** order by total damaged quantity DESC\n5. **WHEN** damaged summary returned **THEN** system **SHALL** include percentage of total returns that were damaged\n\n#### REQ-18: Quarantine Stock Report\n\n**User Story:** As a pharmacist, I want to view all drugs currently in quarantine, so that I can plan for disposal.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-returns/quarantine` **THEN** system **SHALL** return list of drug lots in QUARANTINE location\n2. **WHEN** quarantine stock returned **THEN** system **SHALL** filter to lots with is_active = false\n3. **WHEN** quarantine stock returned **THEN** system **SHALL** include:\n   - Drug details (name, code)\n   - Lot number and expiry date\n   - Quantity in quarantine\n   - Days in quarantine (since lot created)\n   - Source return information\n4. **WHEN** quarantine stock returned **THEN** system **SHALL** order by days_in_quarantine DESC (oldest first)\n5. **WHEN** quarantine stock returned **THEN** system **SHALL** include summary: total items, total quantity, total value\n\n#### REQ-19: Return Statistics Dashboard\n\n**User Story:** As management, I want to view return statistics and trends, so that I can make informed decisions about procurement and inventory management.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-returns/statistics` **THEN** system **SHALL** return comprehensive statistics\n2. **WHEN** `period` parameter provided (daily, weekly, monthly, yearly) **THEN** system **SHALL** aggregate by specified period\n3. **WHEN** statistics returned **THEN** system **SHALL** include:\n   - Total returns count by status\n   - Total value returned (good + damaged)\n   - Average processing time (submitted to posted)\n   - Top 10 most returned drugs\n   - Return reasons distribution\n   - Good vs damaged ratio\n   - Returns by department ranking\n4. **WHEN** statistics returned **THEN** system **SHALL** include trend data (comparison with previous period)\n5. **WHEN** statistics returned **THEN** system **SHALL** return data in format suitable for charts/graphs\n\n### Phase 5: Disposal Management (Optional)\n\n#### REQ-20: Create Disposal Document\n\n**User Story:** As a pharmacy manager, I want to create disposal documents for quarantined drugs, so that I can properly document drug destruction.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-disposals` **THEN** system **SHALL** require array of quarantine lot IDs\n2. **WHEN** creating disposal **THEN** system **SHALL** validate that all lots exist and are in QUARANTINE (is_active = false)\n3. **WHEN** creating disposal **THEN** system **SHALL** require disposal_method (INCINERATION, CHEMICAL_DESTRUCTION, RETURN_TO_VENDOR)\n4. **WHEN** creating disposal **THEN** system **SHALL** require minimum 3 committee members (chairman, member, secretary)\n5. **WHEN** disposal created **THEN** system **SHALL** auto-generate disposal_number in format DISP-{YYYY}-{MM}-{###}\n6. **WHEN** disposal created **THEN** system **SHALL** set status to PENDING\n7. **WHEN** disposal created **THEN** system **SHALL** calculate total_items and total_quantity from selected lots\n8. **WHEN** disposal created **THEN** system **SHALL** return disposal details with items\n\n#### REQ-21: Disposal Committee Management\n\n**User Story:** As a pharmacy manager, I want to assign committee members to disposal documents, so that proper authorities approve drug destruction.\n\n##### Acceptance Criteria\n\n1. **WHEN** creating disposal **THEN** system **SHALL** create records in disposal_committee table for each member\n2. **WHEN** adding committee member **THEN** system **SHALL** require user_id and role (CHAIRMAN, MEMBER, SECRETARY)\n3. **WHEN** committee member assigned **THEN** system **SHALL** validate that user exists and has appropriate permissions\n4. **WHEN** disposal has fewer than 3 members **THEN** system **SHALL** prevent completion\n5. **WHEN** all members assigned **THEN** system **SHALL** allow disposal completion\n\n#### REQ-22: Complete Disposal with Evidence\n\n**User Story:** As a pharmacy manager, I want to mark disposal as complete with photo evidence, so that there is proof of drug destruction.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-disposals/:id/complete` **THEN** system **SHALL** validate that disposal status is PENDING\n2. **WHEN** completing disposal **THEN** system **SHALL** require at least 3 committee signatures\n3. **WHEN** completing disposal **THEN** system **SHALL** require photo evidence URLs (minimum 2 photos)\n4. **WHEN** completing disposal **THEN** system **SHALL** process within transaction:\n   - Update all quarantine lots: set quantity_available = 0\n   - Update all quarantine lots: append disposal notes\n   - Update disposal status to COMPLETED\n   - Record completed_at timestamp\n5. **WHEN** disposal completed **THEN** system **SHALL** store photo URLs in disposal record\n6. **WHEN** disposal completed **THEN** system **SHALL** return completion confirmation\n7. **IF** any step fails **THEN** system **SHALL** rollback transaction and return error\n\n#### REQ-23: List Disposal Documents\n\n**User Story:** As a compliance officer, I want to view all disposal documents, so that I can audit drug destruction processes.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-disposals` **THEN** system **SHALL** return paginated list of disposals\n2. **WHEN** `status` parameter provided **THEN** system **SHALL** filter by status (PENDING, COMPLETED)\n3. **WHEN** `dateFrom` and `dateTo` parameters provided **THEN** system **SHALL** filter by disposal_date range\n4. **WHEN** disposal list returned **THEN** system **SHALL** include:\n   - Disposal number and date\n   - Disposal method\n   - Total items and quantity\n   - Committee members\n   - Status\n5. **WHEN** disposal list returned **THEN** system **SHALL** order by disposal_date DESC\n6. **WHEN** `includeItems=true` **THEN** system **SHALL** include detailed item list for each disposal\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Each file should have a single, well-defined purpose\n  - Controllers handle HTTP request/response only\n  - Services contain business logic and validation\n  - Repositories handle database operations only\n  - Schemas define data structures and validation rules\n\n- **Modular Design**: Components should be isolated and reusable\n  - Drug return workflow logic separate from inventory updates\n  - Quarantine management reusable across different contexts\n  - Disposal logic independent of return logic\n\n- **Dependency Management**: Minimize interdependencies between modules\n  - Drug Return API depends on Inventory API for stock updates\n  - Drug Return API depends on Master Data API for drugs/departments/locations\n  - No circular dependencies between services\n\n- **Clear Interfaces**: Define clean contracts between components\n  - TypeBox schemas for all API inputs and outputs\n  - Service layer interfaces documented with JSDoc\n  - Repository methods with clear parameter and return types\n\n### Performance\n\n- **Response Time**:\n  - List operations: < 500ms for 100 records\n  - Single record retrieval: < 200ms\n  - Create/update operations: < 1s\n  - Post to inventory: < 3s (includes inventory transactions)\n\n- **Concurrency**:\n  - Support 50 concurrent return requests\n  - Handle 10 concurrent posting operations\n  - Database connection pooling (max 20 connections)\n\n- **Scalability**:\n  - Horizontal scaling via stateless API design\n  - Database indexing on frequently queried fields (status, department_id, return_date)\n  - Pagination for all list endpoints (max 100 records per page)\n\n### Security\n\n- **Authentication**:\n  - JWT-based authentication for all endpoints\n  - Token validation on every request\n  - Session timeout after 8 hours\n\n- **Authorization**:\n  - Role-based access control (RBAC)\n  - Department-level data access restrictions\n  - Pharmacists can verify/post all returns\n  - Department staff can only create/view their own returns\n  - Finance managers can view all returns for reporting\n\n- **Data Protection**:\n  - Input validation using TypeBox schemas\n  - SQL injection prevention via parameterized queries\n  - No sensitive data in logs\n  - Audit trail for all status changes\n\n### Reliability\n\n- **Data Integrity**:\n  - Database transactions for multi-step operations\n  - Rollback on any failure during posting\n  - Foreign key constraints to prevent orphaned records\n  - Check constraints for quantity validations (good + damaged = total)\n\n- **Error Handling**:\n  - Graceful error handling with user-friendly messages\n  - Detailed error logging for troubleshooting\n  - Retry logic for transient failures\n  - Circuit breaker for external API calls\n\n- **Availability**:\n  - 99.9% uptime SLA\n  - Database backup every 24 hours\n  - Point-in-time recovery capability\n  - Health check endpoint for monitoring\n\n### Usability\n\n- **API Design**:\n  - RESTful URL conventions\n  - Consistent error response format\n  - Pagination metadata in responses\n  - Clear HTTP status codes (200, 201, 400, 404, 500)\n\n- **Documentation**:\n  - OpenAPI/Swagger documentation auto-generated\n  - Example requests and responses\n  - Error code reference\n  - Integration guide for frontend developers\n\n- **Logging**:\n  - Structured JSON logging\n  - Request ID for tracing\n  - Operation timestamps\n  - User action audit trail\n\n### Maintainability\n\n- **Code Quality**:\n  - TypeScript strict mode enabled\n  - ESLint rules enforced\n  - Unit test coverage > 80%\n  - Integration test coverage for critical workflows\n\n- **Database**:\n  - Database schema versioning\n  - Migration scripts for schema changes\n  - Seed data for development/testing\n  - Index optimization for query performance\n",
  "fileStats": {
    "size": 31477,
    "lines": 550,
    "lastModified": "2025-12-14T14:20:44.385Z"
  },
  "comments": []
}
