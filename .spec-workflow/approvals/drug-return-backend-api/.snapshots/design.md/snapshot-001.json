{
  "id": "snapshot_1765722334992_6h8pyv686",
  "approvalId": "approval_1765722334982_pi3z1jjse",
  "approvalTitle": "Design - Drug Return Backend API",
  "version": 1,
  "timestamp": "2025-12-14T14:25:34.992Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Drug Return Backend API\n\n## Overview\n\nThe Drug Return Backend API implements a comprehensive drug return management system for hospital pharmacies, handling the complete return lifecycle from department initiation through pharmacist verification to inventory restocking and disposal management. This API bridges the gap between Distribution and Inventory systems, ensuring complete traceability of returned drugs with proper good/damaged separation.\n\n**System Position in INVS Modern:**\n```\nDistribution → Drug Return → Inventory\n     ↓             ↓             ↓\n  Dispense      Return       Restock\n   Drugs        Drugs        or Dispose\n```\n\n**Key Design Principles:**\n\n- **API-First Development**: Complete specification before implementation following existing procurement/inventory patterns\n- **Domain-Driven Design**: Operations domain (`inventory/operations/drug-returns`) with clear bounded contexts\n- **Workflow State Machine**: DRAFT → SUBMITTED → VERIFIED → POSTED with validation at each transition\n- **Good/Damaged Separation**: Core business logic ensuring only quality drugs return to stock\n- **Inventory Integration**: Atomic transactions for RETURN movements with lot traceability\n- **Audit Trail**: Immutable transaction log for regulatory compliance\n- **Quarantine Management**: Isolated storage for damaged drugs pending disposal\n\n**Architecture Approach:**\n\n- **Repository Pattern**: Clean data access layer extending BaseRepository\n- **Service Layer**: Business logic orchestration with workflow services\n- **TypeBox Validation**: Type-safe request/response contracts\n- **Transaction Management**: Knex transactions for atomic multi-step operations\n- **WebSocket Events**: Real-time UI updates for status changes\n- **Database Functions**: Complex validation logic in PostgreSQL (optional)\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThis design follows AegisX platform standards:\n\n1. **Fastify Framework**\n   - All endpoints use Fastify with TypeBox schema validation\n   - Routes registered via plugin pattern\n   - Dependency injection via `fastify.decorate()`\n\n2. **Layered Architecture**\n   - **Routes Layer**: HTTP endpoint definitions with schemas\n   - **Controller Layer**: Request/response handling, parameter extraction\n   - **Service Layer**: Business logic, workflow orchestration\n   - **Repository Layer**: Database operations via Knex/BaseRepository\n   - **Database Layer**: PostgreSQL with `inventory` schema\n\n3. **TypeScript Standards**\n   - Strict mode enabled, no `any` types\n   - Interface-first design for all contracts\n   - Type exports from `.types.ts` files\n   - Generic types for reusable patterns\n\n4. **BaseRepository Pattern**\n   - Extends `BaseRepository<T, CreateDto, UpdateDto>`\n   - Automatic pagination, filtering, sorting\n   - UUID validation for all ID fields\n   - Consistent error handling\n\n5. **Authentication & Authorization**\n   - JWT authentication via `fastify.authenticate` hook\n   - RBAC via `fastify.verifyPermission` hook\n   - Department-level data access restrictions\n\n6. **Error Handling**\n   - Custom AppError classes with error codes\n   - HTTP status mapping (400, 404, 403, 500)\n   - Localized error messages (EN/TH)\n   - Structured error responses\n\n7. **Logging & Monitoring**\n   - Structured logging with correlation IDs\n   - Request/response logging via Fastify\n   - Error tracking with stack traces\n   - Performance metrics (response times)\n\n8. **WebSocket Events**\n   - Real-time updates via EventService\n   - CRUD event helpers for automatic broadcasting\n   - Room-based events for department filtering\n\n9. **Database Migrations**\n   - Knex migration files in `migrations-inventory/`\n   - Version-controlled schema changes\n   - Rollback support for failed migrations\n\n10. **Testing Standards**\n    - Unit tests for services (target: 80% coverage)\n    - Integration tests for workflows\n    - API endpoint testing with Fastify inject\n    - Mock external dependencies\n\n### Project Structure (structure.md)\n\nImplementation follows `inventory/operations` domain organization:\n\n```\napps/api/src/layers/inventory/operations/\n├── drug-returns/\n│   ├── drug-returns.repository.ts        # Data access layer\n│   ├── drug-returns.service.ts           # Business logic (CRUD)\n│   ├── drug-returns.controller.ts        # HTTP request handling\n│   ├── drug-returns.routes.ts            # Route definitions\n│   ├── drug-returns.schemas.ts           # TypeBox schemas\n│   ├── drug-returns.types.ts             # TypeScript types\n│   ├── drug-returns.plugin.ts            # Fastify plugin\n│   ├── index.ts                          # Public exports\n│   └── __tests__/\n│       ├── drug-returns.repository.spec.ts\n│       ├── drug-returns.service.spec.ts\n│       └── drug-returns.controller.spec.ts\n├── drug-return-items/\n│   ├── drug-return-items.repository.ts\n│   ├── drug-return-items.service.ts\n│   ├── drug-return-items.controller.ts\n│   ├── drug-return-items.routes.ts\n│   ├── drug-return-items.schemas.ts\n│   ├── drug-return-items.types.ts\n│   ├── index.ts\n│   └── __tests__/\n├── drug-return-workflows/\n│   ├── submit-return.workflow.ts         # DRAFT → SUBMITTED\n│   ├── verify-return.workflow.ts         # SUBMITTED → VERIFIED\n│   ├── post-return.workflow.ts           # VERIFIED → POSTED\n│   ├── cancel-return.workflow.ts         # Any → CANCELLED\n│   ├── workflow.types.ts\n│   └── __tests__/\n├── return-reasons/\n│   ├── return-reasons.repository.ts\n│   ├── return-reasons.service.ts\n│   ├── return-reasons.controller.ts\n│   ├── return-reasons.routes.ts\n│   ├── return-reasons.schemas.ts\n│   └── index.ts\n├── quarantine-management/\n│   ├── quarantine.service.ts             # Quarantine operations\n│   ├── quarantine.controller.ts\n│   ├── quarantine.routes.ts\n│   ├── quarantine.schemas.ts\n│   └── __tests__/\n├── disposal-management/                  # Optional - Phase 5\n│   ├── disposals.repository.ts\n│   ├── disposals.service.ts\n│   ├── disposals.controller.ts\n│   ├── disposals.routes.ts\n│   ├── disposals.schemas.ts\n│   └── __tests__/\n└── integrations/\n    ├── inventory-integration.service.ts  # Inventory stock updates\n    ├── lot-integration.service.ts        # Lot management\n    └── transaction-integration.service.ts # Inventory transactions\n```\n\n**Database Schema**: `inventory` (same as Inventory API)\n\n**Tables Used**:\n- `inventory.drug_returns` (new)\n- `inventory.drug_return_items` (new)\n- `inventory.return_reasons` (new - master data)\n- `inventory.inventory` (existing - update quantities)\n- `inventory.drug_lots` (existing - update/create lots)\n- `inventory.inventory_transactions` (existing - create RETURN transactions)\n- `inventory.locations` (existing - validate return location, quarantine)\n\n**Migration Path**: `apps/api/src/database/migrations-inventory/`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n1. **BaseRepository** (`shared/repositories/base.repository.ts`)\n   - **Usage**: All repositories extend BaseRepository\n   - **Features**:\n     - `findById()`, `list()`, `create()`, `update()`, `delete()`\n     - Automatic pagination with metadata\n     - Filtering and sorting\n     - Field selection\n     - Search functionality\n     - UUID validation\n   - **Our Implementation**:\n     - `DrugReturnsRepository extends BaseRepository<DrugReturn, CreateDrugReturnDto, UpdateDrugReturnDto>`\n     - `DrugReturnItemsRepository extends BaseRepository<DrugReturnItem, CreateReturnItemDto, UpdateReturnItemDto>`\n     - `ReturnReasonsRepository extends BaseRepository<ReturnReason, CreateReturnReasonDto, UpdateReturnReasonDto>`\n\n2. **BaseService** (`shared/services/base.service.ts`)\n   - **Usage**: All services extend BaseService\n   - **Features**:\n     - `getById()`, `getList()`, `create()`, `update()`, `delete()`\n     - Validation hooks: `validateCreate`, `beforeCreate`, `afterCreate`\n     - Error handling with AppError\n     - Logging and audit trails\n   - **Our Implementation**:\n     - `DrugReturnsService extends BaseService` for CRUD operations\n     - Separate `DrugReturnWorkflowService` for workflow operations (composition)\n\n3. **EventService** (`shared/websocket/event.service.ts`)\n   - **Usage**: Real-time WebSocket notifications\n   - **Features**:\n     - `emitCRUDEvent()` - Auto-broadcast create/update/delete\n     - Room-based events (e.g., department-specific)\n     - Structured event payloads\n   - **Our Implementation**:\n     - Emit events on status changes (SUBMITTED, VERIFIED, POSTED)\n     - Department-specific rooms for notifications\n     - Real-time UI updates for pending returns list\n\n4. **AppError** (`core/errors/app-error.ts`)\n   - **Usage**: Standardized error responses\n   - **Error Codes**:\n     - `RETURN_NOT_FOUND` (404)\n     - `INVALID_STATUS_TRANSITION` (400)\n     - `INSUFFICIENT_STOCK` (400)\n     - `QUARANTINE_NOT_CONFIGURED` (400)\n     - `INVALID_QUANTITY_SEPARATION` (400)\n   - **Our Implementation**: Use existing AppError for all business logic errors\n\n5. **TypeBox Base Schemas** (`schemas/base.schemas.ts`)\n   - **Usage**: Reusable schema patterns\n   - **Schemas**:\n     - `PaginationQuerySchema`\n     - `SortingQuerySchema`\n     - `ApiSuccessResponseSchema<T>`\n     - `PaginatedResponseSchema<T>`\n     - `UUIDSchema`\n     - `DateStringSchema`\n   - **Our Implementation**: Extend base schemas for return-specific queries\n\n6. **Authentication Hooks** (`core/auth/hooks/`)\n   - **Usage**: JWT validation and RBAC\n   - **Hooks**:\n     - `fastify.authenticate` - Validates JWT token\n     - `fastify.verifyPermission(['pharmacist', 'department_staff'])` - RBAC check\n   - **Our Implementation**:\n     - All endpoints require authentication\n     - Verify/post operations require 'pharmacist' role\n     - Create/view operations allow 'department_staff'\n\n7. **Response Helpers** (`core/response/response-helper.ts`)\n   - **Usage**: Standardized response formats\n   - **Methods**:\n     - `reply.paginated(data, pagination)` - Paginated responses\n     - `reply.success(data, message)` - Success responses\n     - `reply.error(error)` - Error responses\n   - **Our Implementation**: Use for all controller responses\n\n8. **Knex Query Builder** (`database/knex.client.ts`)\n   - **Usage**: Database queries and transactions\n   - **Features**:\n     - Transaction support: `knex.transaction(async (trx) => {...})`\n     - Query builder: `knex('drug_returns').where(...)`\n     - Raw queries: `knex.raw('SELECT ...')`\n   - **Our Implementation**:\n     - Use transactions for all workflow operations (submit, verify, post)\n     - Repository queries via BaseRepository (which uses Knex)\n\n### Existing Components to Extend\n\n1. **Inventory Service** (existing)\n   - **Location**: `apps/api/src/layers/inventory/operations/inventory/inventory.service.ts`\n   - **Current**: CRUD operations for inventory records\n   - **Extension**: Called by DrugReturnWorkflowService to update stock\n   - **Integration**: `InventoryIntegrationService` wrapper\n\n2. **Drug Lots Service** (existing)\n   - **Location**: `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.service.ts`\n   - **Current**: CRUD operations for lot records\n   - **Extension**: Called to create/update lots when posting returns\n   - **Integration**: `LotIntegrationService` wrapper\n\n3. **Inventory Transactions Service** (existing)\n   - **Location**: `apps/api/src/layers/inventory/operations/inventory-transactions/`\n   - **Current**: CRUD operations for transaction log\n   - **Extension**: Called to create RETURN transactions\n   - **Integration**: `TransactionIntegrationService` wrapper\n\n4. **Locations Service** (Master Data)\n   - **Location**: `apps/api/src/layers/platform/locations/` (assumed)\n   - **Current**: CRUD for locations\n   - **Extension**: Validate location_id, find QUARANTINE location\n   - **Integration**: Direct service calls\n\n### Integration Points\n\n1. **Inventory Management Integration** (Same Database)\n   - **Tables**: `inventory.inventory`, `inventory.drug_lots`, `inventory.inventory_transactions`\n   - **Operations**:\n     - **Posting Returns**: Update inventory quantities, create/update lots, create transactions\n     - **Quarantine**: Create inactive lots in QUARANTINE location\n   - **Method**: Direct Knex transactions (no API calls)\n   - **Service**: `InventoryIntegrationService`\n   - **Error Handling**: Atomic transactions with rollback on failure\n\n2. **Distribution API Integration** (Optional - for validation)\n   - **Purpose**: Validate returned lots match distributed lots\n   - **Endpoint**: `GET /api/inventory/operations/distributions/items?lotNumber={lot}`\n   - **Method**: Service-to-service HTTP call (optional)\n   - **Fallback**: Skip validation if Distribution API unavailable\n\n3. **Master Data Tables**\n   - **Tables**: `public.drugs`, `public.departments`, `public.locations`\n   - **Validation**: Foreign key constraints + service validation\n   - **Error Handling**: Return 404 if master data not found\n\n4. **Notification System** (Optional)\n   - **Purpose**: Notify stakeholders on workflow transitions\n   - **Events**:\n     - Return submitted → Notify pharmacy department\n     - Return verified → Notify requester\n     - Return posted → Notify inventory manager\n   - **Method**: EventService WebSocket + optional email service\n   - **Fallback**: Continue operation if notification fails\n\n5. **WebSocket Events**\n   - **Events**:\n     - `drug-return.created` - New return request\n     - `drug-return.status.changed` - Status transition\n     - `drug-return.posted` - Inventory updated\n   - **Rooms**: Department-specific rooms for filtering\n   - **Method**: EventService.emitCRUDEvent()\n\n## Architecture\n\n### Overall System Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Client Layer\"\n        UI[Frontend Application]\n        WS[WebSocket Client]\n    end\n\n    subgraph \"API Gateway - Fastify\"\n        Routes[Routes + TypeBox Schemas]\n        Auth[Authentication Hook]\n        RBAC[Authorization Hook]\n    end\n\n    subgraph \"Controller Layer\"\n        DrugReturnController[Drug Returns Controller]\n        WorkflowController[Workflow Controller]\n        QuarantineController[Quarantine Controller]\n        DisposalController[Disposal Controller]\n    end\n\n    subgraph \"Service Layer\"\n        DrugReturnService[Drug Returns Service<br/>CRUD Operations]\n        WorkflowService[Workflow Service<br/>Submit/Verify/Post/Cancel]\n        QuarantineService[Quarantine Service]\n        DisposalService[Disposal Service]\n    end\n\n    subgraph \"Integration Services\"\n        InventoryIntegration[Inventory Integration<br/>Stock Updates]\n        LotIntegration[Lot Integration<br/>Create/Update Lots]\n        TransactionIntegration[Transaction Integration<br/>RETURN Transactions]\n    end\n\n    subgraph \"Repository Layer\"\n        DrugReturnsRepo[Drug Returns Repository]\n        ReturnItemsRepo[Return Items Repository]\n        ReturnReasonsRepo[Return Reasons Repository]\n        DisposalsRepo[Disposals Repository]\n    end\n\n    subgraph \"Database - PostgreSQL\"\n        InventorySchema[(Inventory Schema:<br/>drug_returns<br/>drug_return_items<br/>return_reasons<br/>inventory<br/>drug_lots<br/>inventory_transactions)]\n        PublicSchema[(Public Schema:<br/>drugs<br/>departments<br/>locations)]\n    end\n\n    subgraph \"External Services\"\n        EventService[Event Service<br/>WebSocket]\n        NotificationService[Notification Service<br/>Email/SMS]\n    end\n\n    UI --> Routes\n    WS -.-> EventService\n    Routes --> Auth\n    Auth --> RBAC\n    RBAC --> DrugReturnController\n    RBAC --> WorkflowController\n    RBAC --> QuarantineController\n    RBAC --> DisposalController\n\n    DrugReturnController --> DrugReturnService\n    WorkflowController --> WorkflowService\n    QuarantineController --> QuarantineService\n    DisposalController --> DisposalService\n\n    DrugReturnService --> DrugReturnsRepo\n    DrugReturnService --> ReturnItemsRepo\n    DrugReturnService --> ReturnReasonsRepo\n\n    WorkflowService --> DrugReturnService\n    WorkflowService --> InventoryIntegration\n    WorkflowService --> LotIntegration\n    WorkflowService --> TransactionIntegration\n    WorkflowService --> EventService\n    WorkflowService --> NotificationService\n\n    QuarantineService --> LotIntegration\n    DisposalService --> DisposalsRepo\n    DisposalService --> LotIntegration\n\n    DrugReturnsRepo --> InventorySchema\n    ReturnItemsRepo --> InventorySchema\n    ReturnReasonsRepo --> InventorySchema\n    DisposalsRepo --> InventorySchema\n\n    InventoryIntegration --> InventorySchema\n    LotIntegration --> InventorySchema\n    TransactionIntegration --> InventorySchema\n\n    DrugReturnService -.-> PublicSchema\n```\n\n### Workflow State Machine\n\n```mermaid\nstateDiagram-v2\n    [*] --> DRAFT: createReturn()\n    DRAFT --> SUBMITTED: submitReturn()\n    DRAFT --> CANCELLED: cancelReturn()\n    DRAFT --> [*]: deleteReturn()\n\n    SUBMITTED --> VERIFIED: verifyReturn()\n    SUBMITTED --> CANCELLED: cancelReturn()\n\n    VERIFIED --> POSTED: postReturn()\n    VERIFIED --> CANCELLED: cancelReturn()\n\n    POSTED --> [*]\n    CANCELLED --> [*]\n\n    note right of DRAFT\n        Department creates return\n        Can add/edit items\n        Can delete entirely\n    end note\n\n    note right of SUBMITTED\n        Waiting pharmacist review\n        Items locked\n        Can cancel\n    end note\n\n    note right of VERIFIED\n        Good/damaged separated\n        Ready for posting\n        Can cancel\n    end note\n\n    note right of POSTED\n        Inventory updated\n        Immutable\n        Cannot cancel\n    end note\n```\n\n### Module Responsibilities\n\n#### 1. Drug Returns Module (CRUD)\n\n**Responsibility**: Manage drug return records (header)\n\n**Components**:\n- `DrugReturnsRepository` - Data access\n- `DrugReturnsService` - Business logic\n- `DrugReturnsController` - HTTP handling\n- `DrugReturnsRoutes` - Endpoint definitions\n\n**Operations**:\n- Create return (DRAFT)\n- List returns with filters\n- Get return by ID\n- Update return (DRAFT only)\n- Delete return (DRAFT only)\n- Get return statistics\n\n#### 2. Drug Return Items Module (CRUD)\n\n**Responsibility**: Manage return item records (line items)\n\n**Components**:\n- `DrugReturnItemsRepository` - Data access\n- `DrugReturnItemsService` - Business logic\n- `DrugReturnItemsController` - HTTP handling\n- `DrugReturnItemsRoutes` - Endpoint definitions\n\n**Operations**:\n- Add items to return (DRAFT only)\n- Update item quantities (DRAFT only)\n- Remove items (DRAFT only)\n- List items for return\n- Validate lot numbers\n\n#### 3. Workflow Module\n\n**Responsibility**: Orchestrate return workflow transitions\n\n**Components**:\n- `SubmitReturnWorkflow` - DRAFT → SUBMITTED\n- `VerifyReturnWorkflow` - SUBMITTED → VERIFIED\n- `PostReturnWorkflow` - VERIFIED → POSTED\n- `CancelReturnWorkflow` - Any → CANCELLED\n\n**Operations**:\n- Submit return for verification\n- Verify and separate good/damaged\n- Post to inventory (atomic)\n- Cancel return\n\n#### 4. Inventory Integration Module\n\n**Responsibility**: Update inventory when returns posted\n\n**Components**:\n- `InventoryIntegrationService` - Stock quantity updates\n- `LotIntegrationService` - Lot creation/updates\n- `TransactionIntegrationService` - RETURN transactions\n\n**Operations**:\n- Update/create inventory records\n- Update/create drug lots\n- Create inventory transactions\n- Move damaged to quarantine\n\n#### 5. Quarantine Management Module\n\n**Responsibility**: Manage damaged drugs in quarantine\n\n**Components**:\n- `QuarantineService` - Quarantine operations\n- `QuarantineController` - HTTP handling\n- `QuarantineRoutes` - Endpoints\n\n**Operations**:\n- List quarantine stock\n- Get quarantine lot details\n- Search quarantine by drug/expiry\n- Quarantine summary reports\n\n#### 6. Disposal Management Module (Optional - Phase 5)\n\n**Responsibility**: Document drug disposal\n\n**Components**:\n- `DisposalsRepository` - Data access\n- `DisposalsService` - Business logic\n- `DisposalsController` - HTTP handling\n- `DisposalsRoutes` - Endpoints\n\n**Operations**:\n- Create disposal document\n- Assign committee members\n- Complete disposal with evidence\n- List disposal documents\n\n## Components and Interfaces\n\n### Component 1: DrugReturnsService\n\n**Purpose**: CRUD operations for drug return records\n\n**Extends**: `BaseService<DrugReturn, CreateDrugReturnDto, UpdateDrugReturnDto>`\n\n**Public Methods**:\n```typescript\nclass DrugReturnsService extends BaseService {\n  // Inherited from BaseService\n  async getById(id: string): Promise<DrugReturn>\n  async getList(query: ListQueryDto): Promise<PaginatedResult<DrugReturn>>\n  async create(dto: CreateDrugReturnDto): Promise<DrugReturn>\n  async update(id: string, dto: UpdateDrugReturnDto): Promise<DrugReturn>\n  async delete(id: string): Promise<void>\n\n  // Custom methods\n  async getReturnWithItems(id: string): Promise<DrugReturnWithItems>\n  async getDepartmentReturns(departmentId: string, query: ListQueryDto): Promise<PaginatedResult<DrugReturn>>\n  async getReturnsByStatus(status: ReturnStatus, query: ListQueryDto): Promise<PaginatedResult<DrugReturn>>\n  async getReturnStatistics(filters: StatisticsFilterDto): Promise<ReturnStatistics>\n}\n```\n\n**Dependencies**:\n- `DrugReturnsRepository`\n- `ReturnItemsRepository`\n- `EventService`\n\n**Validation Hooks**:\n- `validateCreate`: Check department exists, return reason exists\n- `beforeCreate`: Generate return_number, set status=DRAFT, calculate totals\n- `afterCreate`: Emit WebSocket event\n- `validateUpdate`: Check status is DRAFT\n- `beforeUpdate`: Recalculate totals\n- `afterUpdate`: Emit WebSocket event\n\n**Reuses**:\n- `BaseService` for standard CRUD operations\n- `BaseRepository` for database queries\n- `AppError` for error handling\n\n### Component 2: DrugReturnWorkflowService\n\n**Purpose**: Orchestrate workflow state transitions\n\n**Dependencies**:\n- `DrugReturnsService`\n- `DrugReturnItemsService`\n- `InventoryIntegrationService`\n- `LotIntegrationService`\n- `TransactionIntegrationService`\n- `EventService`\n- Knex transaction manager\n\n**Public Methods**:\n```typescript\nclass DrugReturnWorkflowService {\n  async submitReturn(id: string, submittedBy: string): Promise<DrugReturn>\n  async verifyReturn(id: string, dto: VerifyReturnDto, verifiedBy: string): Promise<DrugReturn>\n  async postReturn(id: string, receivedBy: string, userId: string): Promise<PostReturnResult>\n  async cancelReturn(id: string, reason: string, cancelledBy: string): Promise<DrugReturn>\n\n  // Helper methods\n  private validateStatusTransition(currentStatus: ReturnStatus, targetStatus: ReturnStatus): void\n  private validateGoodDamagedQuantities(items: VerifyReturnItemDto[]): void\n  private processGoodQuantities(trx: Knex.Transaction, item: DrugReturnItem): Promise<void>\n  private processDamagedQuantities(trx: Knex.Transaction, item: DrugReturnItem): Promise<void>\n}\n```\n\n**Workflow Logic**:\n\n1. **Submit Return** (DRAFT → SUBMITTED):\n```typescript\nasync submitReturn(id: string, submittedBy: string) {\n  // 1. Validate current status is DRAFT\n  // 2. Validate has at least 1 item\n  // 3. Update status to SUBMITTED\n  // 4. Record submitted_at timestamp\n  // 5. Emit event to pharmacy department\n  // 6. Return updated record\n}\n```\n\n2. **Verify Return** (SUBMITTED → VERIFIED):\n```typescript\nasync verifyReturn(id: string, dto: VerifyReturnDto, verifiedBy: string) {\n  return knex.transaction(async (trx) => {\n    // 1. Validate current status is SUBMITTED\n    // 2. Validate total_quantity = good_quantity + damaged_quantity for each item\n    // 3. Update all items with good/damaged quantities\n    // 4. Calculate total_amount (good_quantity × unit_cost)\n    // 5. Update return status to VERIFIED\n    // 6. Record verified_by and verified_at\n    // 7. Emit event\n    // 8. Return updated record\n  })\n}\n```\n\n3. **Post Return** (VERIFIED → POSTED):\n```typescript\nasync postReturn(id: string, receivedBy: string, userId: string) {\n  return knex.transaction(async (trx) => {\n    // 1. Validate current status is VERIFIED\n    // 2. Get all items with good/damaged quantities\n\n    // For each item with good_quantity > 0:\n    //   a. Update/create inventory record (increment quantity)\n    //   b. Update/create drug lot (increment quantity, set active)\n    //   c. Create RETURN inventory transaction\n\n    // For each item with damaged_quantity > 0:\n    //   d. Find QUARANTINE location (throw error if not found)\n    //   e. Create inactive lot in QUARANTINE with suffix \"-DMG\"\n\n    // 3. Update return status to POSTED\n    // 4. Record received_by and posted_at\n    // 5. Emit event\n    // 6. Return posting summary (items restocked, items quarantined)\n  })\n}\n```\n\n4. **Cancel Return** (Any → CANCELLED):\n```typescript\nasync cancelReturn(id: string, reason: string, cancelledBy: string) {\n  // 1. Validate current status is not POSTED\n  // 2. Update status to CANCELLED\n  // 3. Record cancellation_reason, cancelled_by, cancelled_at\n  // 4. Emit event\n  // 5. Return updated record\n}\n```\n\n**Reuses**:\n- Existing Inventory/Lot/Transaction services\n- Knex transactions for atomicity\n- EventService for WebSocket notifications\n\n### Component 3: InventoryIntegrationService\n\n**Purpose**: Update inventory stock levels when returns posted\n\n**Public Methods**:\n```typescript\nclass InventoryIntegrationService {\n  async updateInventoryFromReturn(\n    trx: Knex.Transaction,\n    drugId: string,\n    locationId: string,\n    quantity: number\n  ): Promise<void>\n\n  async findOrCreateInventory(\n    trx: Knex.Transaction,\n    drugId: string,\n    locationId: string\n  ): Promise<Inventory>\n\n  async incrementQuantity(\n    trx: Knex.Transaction,\n    inventoryId: string,\n    quantity: number\n  ): Promise<void>\n}\n```\n\n**Dependencies**:\n- `InventoryRepository` (existing)\n- Knex transaction\n\n**Reuses**: Existing Inventory Service via wrapper pattern\n\n### Component 4: LotIntegrationService\n\n**Purpose**: Create or update drug lots when returns posted\n\n**Public Methods**:\n```typescript\nclass LotIntegrationService {\n  async findOrCreateLot(\n    trx: Knex.Transaction,\n    dto: FindOrCreateLotDto\n  ): Promise<DrugLot>\n\n  async incrementLotQuantity(\n    trx: Knex.Transaction,\n    lotId: string,\n    quantity: number\n  ): Promise<void>\n\n  async createQuarantineLot(\n    trx: Knex.Transaction,\n    dto: CreateQuarantineLotDto\n  ): Promise<DrugLot>\n}\n```\n\n**Dependencies**:\n- `DrugLotsRepository` (existing)\n- Knex transaction\n\n**Reuses**: Existing Drug Lots Service via wrapper pattern\n\n### Component 5: TransactionIntegrationService\n\n**Purpose**: Create inventory transaction records for audit trail\n\n**Public Methods**:\n```typescript\nclass TransactionIntegrationService {\n  async createReturnTransaction(\n    trx: Knex.Transaction,\n    dto: CreateReturnTransactionDto\n  ): Promise<InventoryTransaction>\n\n  async createBatchReturnTransactions(\n    trx: Knex.Transaction,\n    transactions: CreateReturnTransactionDto[]\n  ): Promise<InventoryTransaction[]>\n}\n```\n\n**Dependencies**:\n- `InventoryTransactionsRepository` (existing)\n- Knex transaction\n\n**Reuses**: Existing Inventory Transactions Service\n\n### Component 6: QuarantineService\n\n**Purpose**: Manage quarantine stock and reports\n\n**Public Methods**:\n```typescript\nclass QuarantineService {\n  async getQuarantineStock(query: ListQueryDto): Promise<PaginatedResult<QuarantineLot>>\n  async getQuarantineLotDetails(lotId: string): Promise<QuarantineLotDetails>\n  async getQuarantineSummary(): Promise<QuarantineSummary>\n  async searchQuarantine(filters: QuarantineFilterDto): Promise<QuarantineLot[]>\n\n  private async findQuarantineLocation(): Promise<Location>\n}\n```\n\n**Dependencies**:\n- `DrugLotsRepository`\n- `LocationsRepository`\n\n**Reuses**: BaseService patterns for list operations\n\n### Component 7: DisposalsService (Optional - Phase 5)\n\n**Purpose**: Manage disposal documents and committee\n\n**Public Methods**:\n```typescript\nclass DisposalsService {\n  async createDisposal(dto: CreateDisposalDto): Promise<Disposal>\n  async assignCommittee(disposalId: string, members: CommitteeMemberDto[]): Promise<void>\n  async completeDisposal(disposalId: string, dto: CompleteDisposalDto): Promise<void>\n  async getDisposalList(query: ListQueryDto): Promise<PaginatedResult<Disposal>>\n}\n```\n\n**Dependencies**:\n- `DisposalsRepository`\n- `LotIntegrationService`\n- Knex transaction\n\n## Data Models\n\n### TypeBox Schemas\n\n#### DrugReturn (Header)\n\n```typescript\nexport const DrugReturnSchema = Type.Object({\n  id: Type.String({ format: 'uuid' }),\n  return_number: Type.String(), // RET-{YYYY}-{MM}-{###}\n  department_id: Type.String({ format: 'uuid' }),\n  return_date: Type.String({ format: 'date' }),\n  return_reason_id: Type.String({ format: 'uuid' }),\n  return_reason_text: Type.Optional(Type.String()), // Custom reason\n  status: Type.Union([\n    Type.Literal('DRAFT'),\n    Type.Literal('SUBMITTED'),\n    Type.Literal('VERIFIED'),\n    Type.Literal('POSTED'),\n    Type.Literal('CANCELLED')\n  ]),\n  total_items: Type.Number({ minimum: 0 }),\n  total_amount: Type.Number({ minimum: 0 }),\n  verified_by: Type.Optional(Type.String()),\n  verified_at: Type.Optional(Type.String({ format: 'date-time' })),\n  received_by: Type.Optional(Type.String()),\n  posted_at: Type.Optional(Type.String({ format: 'date-time' })),\n  action_taken: Type.Optional(Type.String()),\n  cancellation_reason: Type.Optional(Type.String()),\n  cancelled_by: Type.Optional(Type.String()),\n  cancelled_at: Type.Optional(Type.String({ format: 'date-time' })),\n  notes: Type.Optional(Type.String()),\n  created_at: Type.String({ format: 'date-time' }),\n  updated_at: Type.String({ format: 'date-time' })\n})\n\nexport type DrugReturn = Static<typeof DrugReturnSchema>\n```\n\n#### DrugReturnItem (Line Item)\n\n```typescript\nexport const DrugReturnItemSchema = Type.Object({\n  id: Type.String({ format: 'uuid' }),\n  return_id: Type.String({ format: 'uuid' }),\n  drug_id: Type.String({ format: 'uuid' }),\n  total_quantity: Type.Number({ minimum: 0 }),\n  good_quantity: Type.Number({ minimum: 0, default: 0 }),\n  damaged_quantity: Type.Number({ minimum: 0, default: 0 }),\n  lot_number: Type.String(),\n  expiry_date: Type.String({ format: 'date' }),\n  return_type: Type.Union([\n    Type.Literal('PURCHASED'),\n    Type.Literal('FREE')\n  ]),\n  location_id: Type.String({ format: 'uuid' }), // Return to location\n  notes: Type.Optional(Type.String()),\n  created_at: Type.String({ format: 'date-time' })\n})\n\nexport type DrugReturnItem = Static<typeof DrugReturnItemSchema>\n```\n\n#### ReturnReason (Master Data)\n\n```typescript\nexport const ReturnReasonSchema = Type.Object({\n  id: Type.String({ format: 'uuid' }),\n  reason_code: Type.String(),\n  reason_name: Type.String(),\n  reason_category: Type.Union([\n    Type.Literal('CLINICAL'),\n    Type.Literal('OPERATIONAL'),\n    Type.Literal('QUALITY')\n  ]),\n  description: Type.Optional(Type.String()),\n  is_active: Type.Boolean({ default: true }),\n  created_at: Type.String({ format: 'date-time' }),\n  updated_at: Type.String({ format: 'date-time' })\n})\n\nexport type ReturnReason = Static<typeof ReturnReasonSchema>\n```\n\n#### Create/Update DTOs\n\n```typescript\nexport const CreateDrugReturnSchema = Type.Object({\n  department_id: Type.String({ format: 'uuid' }),\n  return_date: Type.Optional(Type.String({ format: 'date' })), // Default: today\n  return_reason_id: Type.String({ format: 'uuid' }),\n  return_reason_text: Type.Optional(Type.String()),\n  notes: Type.Optional(Type.String()),\n  items: Type.Array(Type.Object({\n    drug_id: Type.String({ format: 'uuid' }),\n    total_quantity: Type.Number({ minimum: 0 }),\n    lot_number: Type.String(),\n    expiry_date: Type.String({ format: 'date' }),\n    return_type: Type.Union([Type.Literal('PURCHASED'), Type.Literal('FREE')]),\n    location_id: Type.String({ format: 'uuid' }),\n    notes: Type.Optional(Type.String())\n  }), { minItems: 1 })\n})\n\nexport const UpdateDrugReturnSchema = Type.Partial(\n  Type.Pick(CreateDrugReturnSchema, ['return_reason_id', 'return_reason_text', 'notes', 'items'])\n)\n\nexport const VerifyReturnSchema = Type.Object({\n  items: Type.Array(Type.Object({\n    item_id: Type.String({ format: 'uuid' }),\n    good_quantity: Type.Number({ minimum: 0 }),\n    damaged_quantity: Type.Number({ minimum: 0 }),\n    notes: Type.Optional(Type.String())\n  }), { minItems: 1 }),\n  verified_by: Type.String()\n})\n\nexport const PostReturnSchema = Type.Object({\n  received_by: Type.String(),\n  action_taken: Type.Optional(Type.String())\n})\n\nexport const CancelReturnSchema = Type.Object({\n  cancellation_reason: Type.String({ minLength: 10 }),\n  cancelled_by: Type.String()\n})\n```\n\n#### Response DTOs\n\n```typescript\nexport const DrugReturnWithItemsSchema = Type.Intersect([\n  DrugReturnSchema,\n  Type.Object({\n    department: DepartmentSchema,\n    return_reason: ReturnReasonSchema,\n    items: Type.Array(Type.Intersect([\n      DrugReturnItemSchema,\n      Type.Object({\n        drug: DrugSchema,\n        location: LocationSchema\n      })\n    ]))\n  })\n])\n\nexport const PostReturnResultSchema = Type.Object({\n  return: DrugReturnSchema,\n  summary: Type.Object({\n    items_restocked: Type.Number(),\n    items_quarantined: Type.Number(),\n    total_good_quantity: Type.Number(),\n    total_damaged_quantity: Type.Number(),\n    inventory_transactions_created: Type.Number()\n  })\n})\n\nexport const ReturnStatisticsSchema = Type.Object({\n  total_returns: Type.Number(),\n  by_status: Type.Record(Type.String(), Type.Number()),\n  total_value: Type.Number(),\n  total_items: Type.Number(),\n  good_vs_damaged_ratio: Type.Object({\n    good_percentage: Type.Number(),\n    damaged_percentage: Type.Number()\n  }),\n  top_returned_drugs: Type.Array(Type.Object({\n    drug_id: Type.String(),\n    drug_name: Type.String(),\n    total_quantity: Type.Number(),\n    return_count: Type.Number()\n  }), { maxItems: 10 }),\n  return_reasons_distribution: Type.Array(Type.Object({\n    reason_id: Type.String(),\n    reason_name: Type.String(),\n    count: Type.Number()\n  }))\n})\n```\n\n## Error Handling\n\n### Error Scenarios\n\n#### 1. Return Not Found (404)\n**Description**: Requested return ID doesn't exist\n\n**Handling**:\n```typescript\nthrow new AppError('RETURN_NOT_FOUND', 'Drug return not found', 404, {\n  returnId: id\n})\n```\n\n**User Impact**: Error message displayed: \"ไม่พบข้อมูลการคืนยา\"\n\n#### 2. Invalid Status Transition (400)\n**Description**: Attempting invalid state transition (e.g., POST from DRAFT)\n\n**Handling**:\n```typescript\nthrow new AppError('INVALID_STATUS_TRANSITION',\n  `Cannot ${action} return with status ${currentStatus}`, 400, {\n    currentStatus,\n    attemptedAction: action\n  })\n```\n\n**User Impact**: Error message: \"สถานะไม่ถูกต้องสำหรับการดำเนินการนี้\"\n\n#### 3. Invalid Quantity Separation (400)\n**Description**: good_quantity + damaged_quantity ≠ total_quantity\n\n**Handling**:\n```typescript\nthrow new AppError('INVALID_QUANTITY_SEPARATION',\n  'Good quantity + Damaged quantity must equal Total quantity', 400, {\n    itemId,\n    totalQuantity,\n    goodQuantity,\n    damagedQuantity,\n    calculatedTotal: goodQuantity + damagedQuantity\n  })\n```\n\n**User Impact**: Error message with details for correction\n\n#### 4. Quarantine Location Not Found (400)\n**Description**: QUARANTINE location not configured\n\n**Handling**:\n```typescript\nthrow new AppError('QUARANTINE_NOT_CONFIGURED',\n  'Quarantine location not found. Please configure QUARANTINE location first.', 400)\n```\n\n**User Impact**: Error message: \"ไม่พบสถานที่กักกันยา กรุณาตั้งค่า QUARANTINE location\"\n\n#### 5. Cannot Edit After Submission (400)\n**Description**: Attempting to edit return with status ≠ DRAFT\n\n**Handling**:\n```typescript\nthrow new AppError('CANNOT_EDIT_SUBMITTED_RETURN',\n  'Cannot edit return after submission', 400, {\n    currentStatus\n  })\n```\n\n**User Impact**: Error message: \"ไม่สามารถแก้ไขการคืนยาที่ส่งไปแล้ว\"\n\n#### 6. Lot Not Found (404)\n**Description**: Lot number doesn't exist in drug_lots table\n\n**Handling**:\n```typescript\nthrow new AppError('LOT_NOT_FOUND',\n  'Lot number not found for this drug', 404, {\n    drugId,\n    lotNumber\n  })\n```\n\n**User Impact**: Error message: \"ไม่พบหมายเลข Lot ของยานี้\"\n\n#### 7. Database Transaction Failed (500)\n**Description**: Knex transaction rollback\n\n**Handling**:\n```typescript\ntry {\n  await knex.transaction(async (trx) => {\n    // Operations\n  })\n} catch (error) {\n  logger.error('Transaction failed', { error, returnId })\n  throw new AppError('TRANSACTION_FAILED',\n    'Failed to post return to inventory. All changes rolled back.', 500)\n}\n```\n\n**User Impact**: Error message: \"เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองใหม่อีกครั้ง\"\n\n### Error Response Format\n\nAll errors follow standard AppError format:\n\n```typescript\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"RETURN_NOT_FOUND\",\n    \"message\": \"Drug return not found\",\n    \"statusCode\": 404,\n    \"details\": {\n      \"returnId\": \"123e4567-e89b-12d3-a456-426614174000\"\n    }\n  }\n}\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n**Test Coverage Target**: 80% minimum\n\n**Components to Test**:\n\n1. **Services** (Priority: High)\n   - DrugReturnsService: CRUD operations\n   - DrugReturnWorkflowService: All workflow methods\n   - InventoryIntegrationService: Stock update logic\n   - LotIntegrationService: Lot creation/update logic\n   - QuarantineService: Quarantine operations\n\n2. **Repositories** (Priority: Medium)\n   - DrugReturnsRepository: Custom queries\n   - DrugReturnItemsRepository: Item operations\n   - DisposalsRepository: Disposal queries\n\n3. **Validation** (Priority: High)\n   - Status transition validation\n   - Quantity validation (good + damaged = total)\n   - Lot number validation\n\n**Testing Tools**:\n- Jest for test runner\n- Supertest for API testing\n- Fastify inject for route testing\n- Mock Knex transactions\n\n**Example Unit Test**:\n```typescript\ndescribe('DrugReturnWorkflowService', () => {\n  describe('verifyReturn', () => {\n    it('should verify return and update quantities', async () => {\n      const mockReturn = createMockReturn({ status: 'SUBMITTED' })\n      const verifyDto = createMockVerifyDto({\n        items: [{\n          item_id: 'item-1',\n          good_quantity: 80,\n          damaged_quantity: 20\n        }]\n      })\n\n      const result = await service.verifyReturn(mockReturn.id, verifyDto, 'user-1')\n\n      expect(result.status).toBe('VERIFIED')\n      expect(result.verified_by).toBe('user-1')\n      expect(mockReturnItemsRepo.updateMany).toHaveBeenCalledWith(\n        expect.arrayContaining([\n          expect.objectContaining({\n            good_quantity: 80,\n            damaged_quantity: 20\n          })\n        ])\n      )\n    })\n\n    it('should throw error if quantities dont match total', async () => {\n      const mockReturn = createMockReturn({ status: 'SUBMITTED' })\n      const invalidDto = createMockVerifyDto({\n        items: [{\n          item_id: 'item-1',\n          good_quantity: 70, // Total should be 100\n          damaged_quantity: 20\n        }]\n      })\n\n      await expect(\n        service.verifyReturn(mockReturn.id, invalidDto, 'user-1')\n      ).rejects.toThrow('INVALID_QUANTITY_SEPARATION')\n    })\n  })\n})\n```\n\n### Integration Testing\n\n**Test Coverage**: Critical workflows end-to-end\n\n**Workflows to Test**:\n\n1. **Complete Return Workflow**\n   - Create DRAFT → Submit → Verify → Post\n   - Validate inventory updated correctly\n   - Validate transactions created\n   - Validate quarantine lots created\n\n2. **Cancel Workflow**\n   - Create → Submit → Cancel\n   - Create → Verify → Cancel\n   - Validate status updated\n   - Validate no inventory changes\n\n3. **Error Scenarios**\n   - Invalid status transitions\n   - Invalid quantity separations\n   - Missing quarantine location\n   - Database transaction failures\n\n**Testing Setup**:\n- Test database with seeded data\n- Knex migrations run before tests\n- Cleanup after each test\n\n**Example Integration Test**:\n```typescript\ndescribe('Drug Return Workflow - Integration', () => {\n  beforeAll(async () => {\n    await runMigrations()\n    await seedTestData()\n  })\n\n  afterEach(async () => {\n    await cleanupTestData()\n  })\n\n  it('should complete full return workflow and update inventory', async () => {\n    // 1. Create return\n    const createResponse = await app.inject({\n      method: 'POST',\n      url: '/api/inventory/operations/drug-returns',\n      headers: { authorization: `Bearer ${token}` },\n      payload: mockCreateDto\n    })\n    expect(createResponse.statusCode).toBe(201)\n    const returnId = createResponse.json().data.id\n\n    // 2. Submit\n    const submitResponse = await app.inject({\n      method: 'POST',\n      url: `/api/inventory/operations/drug-returns/${returnId}/submit`,\n      headers: { authorization: `Bearer ${token}` }\n    })\n    expect(submitResponse.statusCode).toBe(200)\n    expect(submitResponse.json().data.status).toBe('SUBMITTED')\n\n    // 3. Verify\n    const verifyResponse = await app.inject({\n      method: 'POST',\n      url: `/api/inventory/operations/drug-returns/${returnId}/verify`,\n      headers: { authorization: `Bearer ${token}` },\n      payload: mockVerifyDto\n    })\n    expect(verifyResponse.statusCode).toBe(200)\n    expect(verifyResponse.json().data.status).toBe('VERIFIED')\n\n    // 4. Post\n    const postResponse = await app.inject({\n      method: 'POST',\n      url: `/api/inventory/operations/drug-returns/${returnId}/post`,\n      headers: { authorization: `Bearer ${token}` },\n      payload: { received_by: 'pharmacist-1' }\n    })\n    expect(postResponse.statusCode).toBe(200)\n    expect(postResponse.json().data.return.status).toBe('POSTED')\n\n    // 5. Verify inventory updated\n    const inventory = await knex('inventory.inventory')\n      .where({ drug_id: mockDrugId, location_id: mockLocationId })\n      .first()\n    expect(inventory.quantity_on_hand).toBe(initialQuantity + goodQuantity)\n\n    // 6. Verify transaction created\n    const transactions = await knex('inventory.inventory_transactions')\n      .where({ reference_id: returnId, transaction_type: 'RETURN' })\n    expect(transactions).toHaveLength(1)\n\n    // 7. Verify quarantine lot created\n    const quarantineLots = await knex('inventory.drug_lots')\n      .where('lot_number', 'like', '%-DMG')\n    expect(quarantineLots).toHaveLength(1)\n    expect(quarantineLots[0].quantity_available).toBe(damagedQuantity)\n  })\n})\n```\n\n### End-to-End Testing\n\n**User Scenarios to Test**:\n\n1. **Department Staff Creates Return**\n   - Login as department staff\n   - Navigate to returns page\n   - Create new return\n   - Add items with lot numbers\n   - Submit for verification\n   - View submission confirmation\n\n2. **Pharmacist Verifies Return**\n   - Login as pharmacist\n   - View pending returns\n   - Open return details\n   - Inspect items\n   - Enter good/damaged quantities\n   - Verify return\n   - View verification confirmation\n\n3. **Pharmacist Posts Return**\n   - View verified returns\n   - Select return to post\n   - Review posting preview\n   - Confirm post\n   - View posting summary\n   - Verify inventory updated in real-time\n\n4. **Manager Views Reports**\n   - Login as manager\n   - View return statistics dashboard\n   - Filter by date range\n   - Export damaged drugs report\n   - View quarantine stock\n\n**Testing Tools**:\n- Playwright for browser automation\n- Accessibility testing (axe-core)\n- Visual regression testing\n- Performance testing (Lighthouse)\n\n**Example E2E Test** (Playwright):\n```typescript\ntest.describe('Drug Return - Department Staff Flow', () => {\n  test('should create and submit return successfully', async ({ page }) => {\n    // Login\n    await page.goto('/login')\n    await page.fill('[data-testid=\"username\"]', 'dept-staff-1')\n    await page.fill('[data-testid=\"password\"]', 'password')\n    await page.click('[data-testid=\"login-button\"]')\n\n    // Navigate to returns\n    await page.click('text=Drug Returns')\n    await page.click('text=Create New Return')\n\n    // Fill form\n    await page.selectOption('[data-testid=\"department\"]', 'DEPT-001')\n    await page.selectOption('[data-testid=\"return-reason\"]', 'REASON-001')\n\n    // Add item\n    await page.click('text=Add Item')\n    await page.fill('[data-testid=\"drug-search\"]', 'Paracetamol')\n    await page.click('text=Paracetamol 500mg')\n    await page.fill('[data-testid=\"lot-number\"]', 'LOT-2024-001')\n    await page.fill('[data-testid=\"quantity\"]', '100')\n\n    // Submit\n    await page.click('[data-testid=\"submit-button\"]')\n\n    // Verify confirmation\n    await expect(page.locator('text=Return submitted successfully')).toBeVisible()\n    await expect(page.locator('[data-testid=\"return-status\"]')).toHaveText('SUBMITTED')\n  })\n})\n```\n\n### Performance Testing\n\n**Performance Targets**:\n- List returns (100 records): < 500ms\n- Get return details: < 200ms\n- Create return: < 1s\n- Verify return: < 1s\n- Post return to inventory: < 3s\n\n**Load Testing**:\n- 50 concurrent requests\n- 1000 requests/minute peak load\n- Response time p95 < 2s\n- Error rate < 0.1%\n\n**Testing Tools**:\n- Artillery for load testing\n- New Relic for monitoring\n- Lighthouse for frontend performance\n",
  "fileStats": {
    "size": 45539,
    "lines": 1412,
    "lastModified": "2025-12-14T14:25:24.179Z"
  },
  "comments": []
}
