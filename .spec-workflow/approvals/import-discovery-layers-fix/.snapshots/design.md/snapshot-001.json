{
  "id": "snapshot_1765846724447_qchiuo3w1",
  "approvalId": "approval_1765846724340_ikcrvjced",
  "approvalTitle": "Design Document - Import Discovery Layers Fix",
  "version": 1,
  "timestamp": "2025-12-16T00:58:44.447Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Import Discovery Service is responsible for automatically discovering import services decorated with `@ImportService` across the codebase. Currently, it scans only `modules/` and `core/` directories, missing import services in the new layered architecture (`layers/platform/`, `layers/core/`, `layers/domains/`).\n\nThis design implements a minimal, surgical fix: **adding one line to the `basePaths` array** in the `scanForImportServices()` method to include `apps/api/src/layers/`. This ensures comprehensive coverage of all architectural layers while maintaining existing functionality and performance characteristics.\n\n**Design Philosophy:**\n- Minimal change, maximum impact\n- Zero breaking changes to existing code\n- Reuse existing directory scanning logic\n- Maintain sub-100ms discovery performance\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Auto-Discovery Pattern:**\n- Follows existing decorator-based registration pattern\n- No manual configuration required\n- Maintains zero-config philosophy\n\n**Layered Architecture Support:**\n- Recognizes platform, core, and domains layers\n- Allows import services to reside in architecturally appropriate locations\n- Supports the migration from monolithic to layered structure\n\n**Performance Standards:**\n- Maintains sub-100ms discovery time requirement\n- Uses efficient recursive directory traversal\n- No additional overhead beyond existing scan logic\n\n### Project Structure (structure.md)\n\n**Import Service Locations:**\n```\napps/api/src/\n├── modules/          # Legacy location (still supported)\n├── core/             # Core utilities (still supported)\n└── layers/           # NEW: Layered architecture\n    ├── platform/     # Platform services (departments, rbac, files, etc.)\n    ├── core/         # Core shared services (auth, monitoring, audit)\n    └── domains/      # Business domains (admin, inventory, etc.)\n```\n\n**Convention:**\n- Import services end with `-import.service.ts`\n- Decorated with `@ImportService({ module, domain, ... })`\n- Located alongside their respective feature modules\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`ImportDiscoveryService.scanDirectory()`**: Recursive directory traversal algorithm\n  - **Reuse:** 100% - No changes needed\n  - **Why:** Algorithm efficiently scans subdirectories and filters import service files\n\n- **`ImportDiscoveryService.dynamicImportServices()`**: Dynamic module loading\n  - **Reuse:** 100% - No changes needed\n  - **Why:** Works with any file path, handles dist/ mapping automatically\n\n- **`ImportDiscoveryService.buildRegistry()`**: Service instantiation and registration\n  - **Reuse:** 100% - No changes needed\n  - **Why:** Creates instances from discovered metadata regardless of source directory\n\n- **`ImportDiscoveryService.buildDependencyGraph()`**: Dependency analysis\n  - **Reuse:** 100% - No changes needed\n  - **Why:** Builds graph from service metadata, not file locations\n\n### Integration Points\n\n- **Fastify Plugin System**: ImportDiscoveryService registered as `fastify.importDiscovery`\n  - **Integration:** Transparent - plugin initialization unchanged\n  - **Impact:** Additional services from layers/ automatically available to all consumers\n\n- **System Init Service**: Consumes discovery service via `fastify.importDiscovery`\n  - **Integration:** Automatic - no changes required in System Init\n  - **Benefit:** Departments and other layer-based import services appear immediately\n\n- **Database Registry**: `import_service_registry` table stores discovered services\n  - **Integration:** Seamless - persistRegistry() method unchanged\n  - **Benefit:** All discovered services persisted regardless of source directory\n\n## Architecture\n\n### High-Level Flow\n\n```mermaid\ngraph TB\n    A[API Server Start] --> B[Import Discovery Plugin Init]\n    B --> C[Create ImportDiscoveryService]\n    C --> D[Call discoverServices]\n\n    D --> E[scanForImportServices]\n    E --> E1[Scan modules/]\n    E --> E2[Scan core/]\n    E --> E3[Scan layers/]\n\n    E1 --> F[File Paths Array]\n    E2 --> F\n    E3 --> F\n\n    F --> G[dynamicImportServices]\n    G --> H[Decorator Registration]\n    H --> I[buildRegistry]\n    I --> J[buildDependencyGraph]\n    J --> K[Validate Dependencies]\n    K --> L[Topological Sort]\n    L --> M[Persist to Database]\n    M --> N[Decorate Fastify Instance]\n    N --> O[System Init Can Access]\n```\n\n### Change Impact Diagram\n\n```mermaid\ngraph LR\n    A[scanForImportServices Method] -->|MODIFIED| B[basePaths Array]\n    B -->|includes| C1[modules/]\n    B -->|includes| C2[core/]\n    B -->|NEW includes| C3[layers/]\n\n    C3 --> D[Discovers departments-import.service.ts]\n    D --> E[Registry includes departments]\n    E --> F[System Init shows departments]\n\n    style A fill:#ffe6e6\n    style B fill:#fff4e6\n    style C3 fill:#e1f5e1\n    style D fill:#e1f5e1\n    style E fill:#e1f5e1\n    style F fill:#e1f5e1\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Only `import-discovery.service.ts` is modified\n- **Component Isolation**: Change isolated to one method in one service\n- **Service Layer Separation**: No changes to business logic, only discovery scope\n- **Utility Modularity**: Existing recursive scan utility reused without modification\n\n## Components and Interfaces\n\n### ImportDiscoveryService.scanForImportServices()\n\n**File:** `apps/api/src/layers/platform/import/discovery/import-discovery.service.ts`\n**Lines:** 140-174 (method definition)\n**Change Location:** Lines 143-147 (basePaths array)\n\n**Purpose:**\nScan file system for `*-import.service.ts` files following naming convention\n\n**Current Implementation:**\n```typescript\nprivate scanForImportServices(): string[] {\n  const files: string[] = [];\n  const basePaths = [\n    path.join(process.cwd(), 'apps/api/src/modules'),\n    path.join(process.cwd(), 'apps/api/src/core'),\n    // ❌ Missing: layers/\n  ];\n  // ... scanning logic\n}\n```\n\n**New Implementation:**\n```typescript\nprivate scanForImportServices(): string[] {\n  const files: string[] = [];\n  const basePaths = [\n    path.join(process.cwd(), 'apps/api/src/modules'),\n    path.join(process.cwd(), 'apps/api/src/core'),\n    path.join(process.cwd(), 'apps/api/src/layers'),  // ✅ ADDED\n  ];\n  // ... scanning logic (unchanged)\n}\n```\n\n**Interfaces (Unchanged):**\n- **Returns:** `string[]` - Array of file paths relative to project root\n- **No Parameters:** Pure function based on file system state\n- **Side Effects:** None (read-only file system access)\n\n**Dependencies:**\n- Node.js `fs` module (unchanged)\n- Node.js `path` module (unchanged)\n- `scanDirectory()` helper method (unchanged)\n\n**Reuses:**\n- Existing recursive directory traversal logic\n- File filtering by naming convention (`*-import.service.ts`)\n- Path normalization and validation\n\n### scanDirectory() Helper Method\n\n**Purpose:**\nRecursively traverse directory tree and collect matching files\n\n**Implementation:** No changes required\n\n**Why No Changes:**\n- Generic recursive algorithm works for any base path\n- Already handles subdirectories efficiently\n- File filtering logic already correct\n- Error handling already graceful\n\n## Data Models\n\n### Discovery Result (Unchanged)\n\n```typescript\ninterface DiscoveryResult {\n  totalServices: number;\n  discoveredServices: string[];      // Module names\n  dependencies: DependencyGraph;     // Module dependency map\n  importOrder: string[];             // Topologically sorted order\n  circularDependencies: CircularDependencyError[];\n  validationErrors: string[];\n}\n```\n\n**Impact:** `totalServices` and `discoveredServices` will include departments and other layer-based services\n\n### Import Service Registry Record (Unchanged)\n\n```typescript\ninterface ImportServiceRegistryRecord {\n  module_name: string;\n  domain: string;\n  subdomain: string | null;\n  display_name: string;\n  description: string | null;\n  dependencies: string;              // JSON array\n  priority: number;\n  tags: string;                      // JSON array\n  supports_rollback: boolean;\n  version: string | null;\n  file_path: string | null;\n  discovered_at: Date;\n  updated_at: Date;\n}\n```\n\n**Impact:** Records for departments and other layer services will be inserted\n\n## Error Handling\n\n### Error Scenarios\n\n1. **layers/ directory doesn't exist**\n   - **Handling:** `fs.existsSync(basePath)` check before scanning (existing logic)\n   - **User Impact:** None - gracefully skipped, logged if logging enabled\n   - **Behavior:** Server starts normally, discovers modules/core services only\n\n2. **Permission denied reading layers/ directory**\n   - **Handling:** `try-catch` in `scanDirectory()` logs warning and continues (existing logic)\n   - **User Impact:** None - partial discovery completes\n   - **Logging:** Warning logged for directory that failed to scan\n\n3. **departments-import.service.ts has syntax errors**\n   - **Handling:** `try-catch` in `dynamicImportServices()` logs error and continues (existing logic)\n   - **User Impact:** Departments won't appear in System Init (as it currently doesn't)\n   - **Logging:** Error logged with file path and error message\n\n4. **departments service has missing decorator**\n   - **Handling:** Won't be registered in `buildRegistry()` (existing validation)\n   - **User Impact:** Service skipped, validation error logged\n   - **Recovery:** Developer must add `@ImportService` decorator\n\n### New Scenarios (Edge Cases)\n\n5. **layers/ contains thousands of nested directories**\n   - **Handling:** Recursive scan might take longer but will complete\n   - **Performance:** May trigger 100ms warning if extreme nesting\n   - **Mitigation:** Only scan up to file depth where import services actually exist\n\n6. **Duplicate import services across layers/ and modules/**\n   - **Handling:** Both will be discovered; duplicate module name will cause validation error\n   - **User Impact:** Clear error message about duplicate module names\n   - **Resolution:** Developer must rename or consolidate duplicate services\n\n## Testing Strategy\n\n### Unit Testing\n\n**File:** `apps/api/src/layers/platform/import/discovery/import-discovery.service.spec.ts` (if exists)\n\n**Test Cases:**\n1. **Should scan layers/ directory when it exists**\n   - Mock fs.existsSync to return true for layers/\n   - Verify layers/ path included in scanned directories\n\n2. **Should discover departments-import.service.ts in layers/platform/departments/**\n   - Create test fixture with mock file structure\n   - Assert departments appears in discovered services\n\n3. **Should handle missing layers/ directory gracefully**\n   - Mock fs.existsSync to return false for layers/\n   - Verify no errors thrown, discovery completes\n\n4. **Should maintain performance under 100ms with layers/ included**\n   - Benchmark discovery time with all three base paths\n   - Assert discovery time < 100ms\n\n### Integration Testing\n\n**Goal:** Verify departments import service is discovered and usable\n\n**Test Cases:**\n1. **Server startup discovers departments module**\n   - Start API server\n   - Query `fastify.importDiscovery.getAllServices()`\n   - Assert departments module exists in result\n\n2. **System Init API returns departments in available modules**\n   - Call `GET /v1/admin/system-init/modules`\n   - Assert response includes departments module\n   - Verify metadata: domain=core, priority=1, dependencies=[]\n\n3. **Import order includes departments at priority 1**\n   - Call `GET /v1/admin/system-init/import-order`\n   - Assert departments appears early in order (priority 1)\n   - Verify no circular dependency errors\n\n### End-to-End Testing\n\n**Goal:** Verify System Init Dashboard displays and allows departments import\n\n**User Scenarios:**\n1. **System Administrator views available modules**\n   - Navigate to System Init Dashboard\n   - Verify \"Departments (แผนก)\" appears in modules list\n   - Verify metadata shown: domain, priority, dependencies\n\n2. **System Administrator downloads departments template**\n   - Select departments module\n   - Click \"Download Template\"\n   - Verify CSV/Excel template has columns: code, name, parent_code, is_active\n\n3. **System Administrator imports departments data**\n   - Upload valid departments CSV\n   - Verify validation shows no errors\n   - Execute import\n   - Verify departments records inserted into database\n\n### Manual Verification Checklist\n\nAfter deployment, verify:\n- [ ] API server startup logs show \"[Platform ImportDiscovery] Registered: departments (Departments (แผนก))\"\n- [ ] No validation errors in discovery logs\n- [ ] Discovery completes in < 100ms\n- [ ] System Init Dashboard shows departments module\n- [ ] Departments module shows priority 1, domain core, no dependencies\n- [ ] Import order places departments near the top\n- [ ] Can download departments import template\n- [ ] Can successfully import departments CSV\n\n## Implementation Notes\n\n### Change Scope\n- **1 file modified:** `import-discovery.service.ts`\n- **1 line added:** `path.join(process.cwd(), 'apps/api/src/layers'),`\n- **0 breaking changes**\n- **0 new dependencies**\n\n### Deployment Considerations\n- **Database migrations:** None required\n- **Configuration changes:** None required\n- **Server restart:** Required (as with any backend code change)\n- **Backward compatibility:** 100% - existing imports continue working\n\n### Rollback Plan\nIf issues arise, revert the single line addition:\n```diff\nconst basePaths = [\n  path.join(process.cwd(), 'apps/api/src/modules'),\n  path.join(process.cwd(), 'apps/api/src/core'),\n- path.join(process.cwd(), 'apps/api/src/layers'),\n];\n```\n\nServer restart will restore previous behavior.\n",
  "fileStats": {
    "size": 13608,
    "lines": 385,
    "lastModified": "2025-12-16T00:58:37.474Z"
  },
  "comments": []
}
