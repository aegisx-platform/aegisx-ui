{
  "id": "snapshot_1765868906871_vck6sz9a7",
  "approvalId": "approval_1765868906852_1tf55yjv7",
  "approvalTitle": "Design: Monitoring & Audit Modules Architecture",
  "version": 1,
  "timestamp": "2025-12-16T07:08:26.871Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Monitoring & Audit Modules Restoration\n\n## Overview\n\nThis design document outlines the technical architecture for restoring four critical backend modules (Error Logs, Activity Logs, User Profile, API Keys) that were deleted during the API Architecture Standardization migration. The design follows the established layer-based architecture, reuses existing base classes extensively, and implements modern UI/UX using AegisX UI, Angular Material, and TailwindCSS.\n\n**Key Design Principles:**\n- **Code Reuse First**: Leverage `BaseAuditController`, `BaseAuditService`, `BaseAuditRepository` for audit logs\n- **Layer-Based Routing**: Core layer for audit logs (`/api/error-logs`, `/api/activity-logs`), Platform layer for user features (`/api/v1/platform/profile`, `/api/v1/platform/api-keys`)\n- **Signal-Based State**: Use Angular Signals for reactive state management\n- **Component Library**: Use AegisX UI + Angular Material for consistent UI\n- **Type Safety**: TypeBox schemas for all API contracts\n- **Test-Driven**: Unit, integration, and E2E tests for all features\n\n---\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Backend:**\n- ✅ Fastify framework with plugin-based architecture\n- ✅ TypeBox for schema validation and type generation\n- ✅ PostgreSQL with Knex.js query builder\n- ✅ Redis for caching (error/activity stats)\n- ✅ JWT authentication with RBAC authorization\n- ✅ Layer-based routing (Core, Platform, Domains)\n\n**Frontend:**\n- ✅ Angular 17+ with standalone components\n- ✅ Signals for reactive state management\n- ✅ HttpClient with interceptors for API calls\n- ✅ Angular Material + AegisX UI component library\n- ✅ TailwindCSS for utility-first styling\n- ✅ Lazy-loaded feature modules\n\n### Project Structure (structure.md)\n\n**Backend Structure:**\n```\napps/api/src/\n├── layers/\n│   ├── core/\n│   │   └── audit/\n│   │       ├── base/                  # Reusable base classes ✅\n│   │       ├── error-logs/            # NEW MODULE\n│   │       │   ├── error-logs.controller.ts\n│   │       │   ├── error-logs.service.ts\n│   │       │   ├── error-logs.repository.ts\n│   │       │   ├── error-logs.routes.ts\n│   │       │   ├── error-logs.schemas.ts\n│   │       │   ├── error-logs.plugin.ts\n│   │       │   └── index.ts\n│   │       └── activity-logs/         # NEW MODULE\n│   │           ├── activity-logs.controller.ts\n│   │           ├── activity-logs.service.ts\n│   │           ├── activity-logs.repository.ts\n│   │           ├── activity-logs.routes.ts\n│   │           ├── activity-logs.schemas.ts\n│   │           ├── activity-logs.plugin.ts\n│   │           └── index.ts\n│   └── platform/\n│       ├── user-profile/              # NEW MODULE\n│       │   ├── controllers/\n│       │   │   ├── profile.controller.ts\n│       │   │   ├── avatar.controller.ts\n│       │   │   ├── preferences.controller.ts\n│       │   │   └── activity.controller.ts\n│       │   ├── services/\n│       │   │   ├── profile.service.ts\n│       │   │   ├── avatar.service.ts\n│       │   │   └── preferences.service.ts\n│       │   ├── repositories/\n│       │   │   └── profile.repository.ts\n│       │   ├── routes/\n│       │   │   └── profile.routes.ts\n│       │   ├── schemas/\n│       │   │   └── profile.schemas.ts\n│       │   ├── user-profile.plugin.ts\n│       │   └── index.ts\n│       └── api-keys/                  # NEW MODULE\n│           ├── api-keys.controller.ts\n│           ├── api-keys.service.ts\n│           ├── api-keys.repository.ts\n│           ├── api-keys.routes.ts\n│           ├── api-keys.schemas.ts\n│           ├── api-keys.plugin.ts\n│           ├── middleware/\n│           │   └── api-key-auth.middleware.ts\n│           └── index.ts\n```\n\n**Frontend Structure:**\n```\napps/web/src/app/\n├── core/\n│   ├── monitoring/                    # EXISTING (update baseUrl)\n│   │   ├── services/\n│   │   │   ├── error-logs.service.ts  ✅ Update baseUrl\n│   │   │   └── activity-logs.service.ts ✅ Update baseUrl\n│   │   ├── models/\n│   │   │   └── monitoring.types.ts\n│   │   └── pages/\n│   │       ├── error-logs/            # NEW PAGES\n│   │       │   ├── error-logs-list.page.ts\n│   │       │   ├── error-logs-detail.page.ts\n│   │       │   └── error-logs.config.ts\n│   │       └── activity-logs/         # NEW PAGES\n│   │           ├── activity-logs-list.page.ts\n│   │           ├── activity-logs-detail.page.ts\n│   │           └── activity-logs.config.ts\n│   ├── users/                         # EXISTING\n│   │   ├── services/\n│   │   │   └── user.service.ts        ✅ Add profile methods\n│   │   └── pages/\n│   │       └── profile/               # NEW PAGES\n│   │           ├── profile.page.ts\n│   │           ├── profile.config.ts\n│   │           └── components/\n│   │               ├── profile-info.component.ts\n│   │               ├── profile-avatar.component.ts\n│   │               ├── profile-preferences.component.ts\n│   │               └── profile-activity.component.ts\n│   └── api-keys/                      # NEW MODULE\n│       ├── services/\n│       │   └── api-keys.service.ts    # NEW\n│       ├── models/\n│       │   └── api-keys.types.ts\n│       └── pages/\n│           ├── api-keys-list.page.ts\n│           ├── api-keys-detail.page.ts\n│           └── api-keys.config.ts\n└── shared/\n    └── components/                    # NEW REUSABLE COMPONENTS\n        ├── data-table/\n        │   └── data-table.component.ts\n        ├── filter-panel/\n        │   └── filter-panel.component.ts\n        ├── export-button/\n        │   └── export-button.component.ts\n        └── stats-cards/\n            └── stats-cards.component.ts\n```\n\n---\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n**Backend Base Classes (Critical for Audit Logs):**\n- **`BaseAuditController`** (`apps/api/src/layers/core/audit/base/base.controller.ts`)\n  - Provides: `findAll`, `findById`, `getStats`, `deleteById`, `cleanup`, `export`\n  - Will extend for: `ErrorLogsController`, `ActivityLogsController`\n\n- **`BaseAuditService`** (`apps/api/src/layers/core/audit/base/base.service.ts`)\n  - Provides: Pagination, filtering, statistics calculation, export formatting\n  - Will extend for: `ErrorLogsService`, `ActivityLogsService`\n\n- **`BaseAuditRepository`** (`apps/api/src/layers/core/audit/base/base.repository.ts`)\n  - Provides: CRUD operations, query building, date range filters\n  - Will extend for: `ErrorLogsRepository`, `ActivityLogsRepository`\n\n**Frontend Services (Already Implemented):**\n- **`ErrorLogsService`** (`apps/web/src/app/core/monitoring/services/error-logs.service.ts`)\n  - Status: ✅ Fully implemented with Signal-based state\n  - Action: Update `baseUrl` from `/error-logs` to `/error-logs` (Core layer)\n\n- **`ActivityLogsService`** (`apps/web/src/app/core/monitoring/services/activity-logs.service.ts`)\n  - Status: ✅ Fully implemented with Signal-based state\n  - Action: Update `baseUrl` from `/activity-logs` to `/activity-logs` (Core layer)\n\n**File Upload Infrastructure:**\n- **`FileUploadPlugin`** (`apps/api/src/layers/platform/file-upload/`)\n  - Will use for: Avatar uploads in User Profile\n  - Features: Validation, storage, thumbnails, cleanup\n\n**Authentication & Authorization:**\n- **JWT Auth Strategies** (`apps/api/src/layers/core/auth/strategies/`)\n  - Will use: `authenticate` preValidation hook on all routes\n- **RBAC Permissions** (`apps/api/src/layers/platform/rbac/`)\n  - Will use: `verifyPermission` hook for authorization checks\n\n**Database Tables (Already Exist):**\n- ✅ `error_logs` table (from migration `001_create_monitoring_tables.ts`)\n- ✅ `activity_logs` table (from migration `001_create_monitoring_tables.ts`)\n- ✅ `users` table with `department_id` (recently added)\n- ⚠️ `api_keys` table needs creation (new migration required)\n\n### Integration Points\n\n**Existing Systems:**\n1. **Monitoring Module** (`apps/api/src/layers/core/monitoring/`)\n   - Integration: Error logs will store errors posted to `/monitoring/client-errors`\n   - Flow: Client errors → Monitoring plugin → `error_logs` table → Error Logs module for viewing\n\n2. **Activity Logging Middleware** (`apps/api/src/plugins/activity-logging/`)\n   - Integration: Currently disabled, will re-enable and connect to Activity Logs module\n   - Flow: User actions → Activity middleware → `activity_logs` table → Activity Logs module for viewing\n\n3. **User Service** (`apps/api/src/layers/platform/users/`)\n   - Integration: User Profile will extend Users module\n   - Flow: Profile operations → User service → `users` table + avatar storage\n\n4. **Department Integration** (Recent Addition)\n   - Integration: User Profile displays and updates `department_id`\n   - Flow: Profile page → Department selector → User service → `users.department_id`\n\n---\n\n## Architecture\n\n### System Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph \"Frontend - Angular\"\n        UI[UI Components<br/>AegisX + Material]\n        Pages[Feature Pages]\n        Services[Angular Services<br/>Signal State]\n        Interceptors[HTTP Interceptors<br/>Auth + Base URL]\n    end\n\n    subgraph \"Backend - Fastify\"\n        Routes[API Routes]\n        Controllers[Controllers]\n        BusinessLogic[Services]\n        DataAccess[Repositories]\n        Middleware[Middleware<br/>Auth + RBAC]\n    end\n\n    subgraph \"Data Layer\"\n        DB[(PostgreSQL)]\n        Redis[(Redis Cache)]\n        Storage[File Storage]\n    end\n\n    UI --> Pages\n    Pages --> Services\n    Services --> Interceptors\n    Interceptors --> Routes\n    Routes --> Middleware\n    Middleware --> Controllers\n    Controllers --> BusinessLogic\n    BusinessLogic --> DataAccess\n    DataAccess --> DB\n    BusinessLogic --> Redis\n    BusinessLogic --> Storage\n```\n\n### Backend Module Architecture\n\n#### Error Logs Module (Core Layer)\n\n**Route Pattern:** `/api/error-logs/*`\n\n```mermaid\ngraph LR\n    Client[Client] --> Route[error-logs.routes.ts]\n    Route --> Auth[JWT Auth]\n    Auth --> RBAC[RBAC Permission:<br/>monitoring:read]\n    RBAC --> Controller[ErrorLogsController<br/>extends BaseAuditController]\n    Controller --> Service[ErrorLogsService<br/>extends BaseAuditService]\n    Service --> Repo[ErrorLogsRepository<br/>extends BaseAuditRepository]\n    Repo --> DB[(error_logs table)]\n    Service --> Cache[(Redis Cache<br/>stats cache)]\n```\n\n**Class Hierarchy:**\n```typescript\nBaseAuditController<ErrorLog, ErrorQuery, ErrorStats>\n  ↓ extends\nErrorLogsController\n  - Minimal code: Just plugin registration\n  - Inherits: findAll, findById, getStats, cleanup, export\n  - Override: getExportFilename() to return 'error-logs'\n```\n\n#### Activity Logs Module (Core Layer)\n\n**Route Pattern:** `/api/activity-logs/*`\n\n```mermaid\ngraph LR\n    Client[Client] --> Route[activity-logs.routes.ts]\n    Route --> Auth[JWT Auth]\n    Auth --> RBAC[RBAC Permission:<br/>audit:read]\n    RBAC --> Controller[ActivityLogsController<br/>extends BaseAuditController]\n    Controller --> Service[ActivityLogsService<br/>extends BaseAuditService]\n    Service --> Repo[ActivityLogsRepository<br/>extends BaseAuditRepository]\n    Repo --> DB[(activity_logs table)]\n    Service --> Cache[(Redis Cache<br/>stats cache)]\n```\n\n**Integration with Activity Middleware:**\n```typescript\n// Re-enable activity-logging middleware\n// apps/api/src/plugins/activity-logging/activity-logging.plugin.ts\n// This middleware will automatically log activities to activity_logs table\n// Activity Logs module provides READ access to view these logs\n```\n\n#### User Profile Module (Platform Layer)\n\n**Route Pattern:** `/api/v1/platform/profile/*`\n\n```mermaid\ngraph TB\n    Client[Client] --> Routes[profile.routes.ts]\n    Routes --> Auth[JWT Auth]\n    Auth --> ProfileCtrl[ProfileController]\n    Auth --> AvatarCtrl[AvatarController]\n    Auth --> PrefsCtrl[PreferencesController]\n    Auth --> ActivityCtrl[ActivityController<br/>Read-only]\n\n    ProfileCtrl --> ProfileSvc[ProfileService]\n    AvatarCtrl --> AvatarSvc[AvatarService]\n    PrefsCtrl --> PrefsSvc[PreferencesService]\n    ActivityCtrl --> ActivitySvc[ActivityLogsService]\n\n    ProfileSvc --> UserRepo[UserRepository<br/>from users module]\n    AvatarSvc --> FileUpload[FileUploadPlugin]\n    PrefsSvc --> UserRepo\n    ActivitySvc --> ActivityRepo[ActivityLogsRepository]\n\n    UserRepo --> DB[(users table)]\n    FileUpload --> Storage[File Storage]\n    ActivityRepo --> DB2[(activity_logs table)]\n```\n\n**Controllers:**\n- **ProfileController**: Basic profile CRUD (GET, PUT)\n- **AvatarController**: Avatar upload/delete (POST, DELETE)\n- **PreferencesController**: User preferences (GET, PUT)\n- **ActivityController**: User's activity history (GET, read-only)\n\n**Department Integration:**\n```typescript\n// Profile includes department_id field\n// Frontend displays department selector\n// On update, validates department exists and user has access\n```\n\n#### API Keys Module (Platform Layer)\n\n**Route Pattern:** `/api/v1/platform/api-keys/*`\n\n```mermaid\ngraph TB\n    Client[Client] --> Routes[api-keys.routes.ts]\n    Routes --> Auth[JWT Auth]\n    Auth --> RBAC[RBAC Permission:<br/>api-keys:manage]\n    RBAC --> Controller[ApiKeysController]\n    Controller --> Service[ApiKeysService]\n    Service --> Repo[ApiKeysRepository]\n    Service --> Crypto[CryptoService<br/>Key hashing]\n    Service --> Activity[ActivityLogsService<br/>Audit trail]\n    Repo --> DB[(api_keys table)]\n\n    APIRequest[API Request<br/>with X-API-Key] --> Middleware[ApiKeyAuthMiddleware]\n    Middleware --> ValidateKey[Validate & Hash]\n    ValidateKey --> CheckDB[Check api_keys table]\n    CheckDB --> Authorize[Set request.user]\n```\n\n**Security Flow:**\n1. User creates API key → Generate secure random key\n2. Hash key with bcrypt (cost=12)\n3. Store hash in database, return plain key ONCE\n4. On API request with key → Hash incoming key → Compare with stored hash\n5. If valid → Load user + permissions → Continue request\n\n---\n\n### Frontend Architecture\n\n#### State Management Pattern (Signals)\n\nAll frontend services use Angular Signals for reactive state:\n\n```typescript\n// Pattern used across all services\n@Injectable({ providedIn: 'root' })\nexport class ExampleService {\n  private _state = signal<ExampleState>({\n    data: [],\n    loading: false,\n    error: null,\n    pagination: null\n  });\n\n  // Read-only state\n  readonly state = this._state.asReadonly();\n  readonly data = () => this._state().data;\n  readonly loading = () => this._state().loading;\n  readonly error = () => this._state().error;\n\n  // Mutations\n  private updateState(partial: Partial<ExampleState>) {\n    this._state.update(current => ({ ...current, ...partial }));\n  }\n}\n```\n\n#### Component Hierarchy\n\n**Error Logs Feature:**\n```\nerror-logs-list.page.ts (Container)\n├── data-table.component.ts (Shared)\n│   ├── mat-table (Angular Material)\n│   ├── mat-paginator\n│   └── mat-sort\n├── filter-panel.component.ts (Shared)\n│   └── mat-expansion-panel (Angular Material)\n├── stats-cards.component.ts (Shared)\n│   └── ax-stats-card (AegisX UI)\n└── export-button.component.ts (Shared)\n    └── ax-button (AegisX UI)\n\nerror-logs-detail.page.ts (Container)\n├── ax-card (AegisX UI)\n├── ax-badge (AegisX UI) - Error level\n└── ax-description-list (AegisX UI) - Error details\n```\n\n**Activity Logs Feature:**\n```\nactivity-logs-list.page.ts (Container)\n├── ax-timeline (AegisX UI) - Activity timeline\n├── filter-panel.component.ts (Shared)\n├── stats-cards.component.ts (Shared)\n└── export-button.component.ts (Shared)\n\nactivity-logs-detail.page.ts (Container)\n├── ax-card (AegisX UI)\n└── ax-description-list (AegisX UI)\n```\n\n**User Profile Feature:**\n```\nprofile.page.ts (Container)\n├── profile-info.component.ts\n│   ├── ax-card (AegisX UI)\n│   ├── mat-form-field (Angular Material)\n│   ├── mat-input\n│   └── mat-select - Department selector\n├── profile-avatar.component.ts\n│   ├── ax-avatar (AegisX UI)\n│   └── File upload with drag-and-drop\n├── profile-preferences.component.ts\n│   ├── ax-card (AegisX UI)\n│   ├── mat-slide-toggle - Theme, notifications\n│   └── mat-select - Language\n└── profile-activity.component.ts\n    └── ax-timeline (AegisX UI) - Recent activities\n```\n\n**API Keys Feature:**\n```\napi-keys-list.page.ts (Container)\n├── data-table.component.ts (Shared)\n├── ax-badge (AegisX UI) - Key status\n└── ax-button (AegisX UI) - Create key\n\napi-keys-detail.page.ts (Container)\n├── ax-card (AegisX UI)\n├── Key creation wizard (mat-stepper)\n│   ├── Step 1: Name\n│   ├── Step 2: Permissions (mat-checkbox-group)\n│   ├── Step 3: Expiration (mat-datepicker)\n│   └── Step 4: Review\n├── One-time key display (copyable)\n│   └── ax-button - Copy to clipboard\n└── Usage chart (Canvas + Chart.js)\n```\n\n#### UI Design Tokens\n\n**Color Palette (TailwindCSS + AegisX):**\n```typescript\n// Error severity colors\nerror: 'text-red-600 bg-red-50'\nwarn: 'text-yellow-600 bg-yellow-50'\ninfo: 'text-blue-600 bg-blue-50'\n\n// Status colors\nactive: 'text-green-600 bg-green-50'\nexpired: 'text-gray-600 bg-gray-50'\nrevoked: 'text-red-600 bg-red-50'\n\n// Component variants (AegisX)\nax-button: 'primary' | 'secondary' | 'success' | 'warning' | 'danger'\nax-badge: 'default' | 'primary' | 'success' | 'warning' | 'danger' | 'info'\n```\n\n**Spacing Scale:**\n```\n4px base unit\n- xs: 4px (1)\n- sm: 8px (2)\n- md: 16px (4)\n- lg: 24px (6)\n- xl: 32px (8)\n- 2xl: 48px (12)\n```\n\n**Typography:**\n```\n// Headings\nh1: text-3xl font-bold\nh2: text-2xl font-semibold\nh3: text-xl font-semibold\nh4: text-lg font-medium\n\n// Body\nbody: text-base\nsmall: text-sm\ntiny: text-xs\n```\n\n---\n\n## Components and Interfaces\n\n### Backend Components\n\n#### 1. ErrorLogsController\n\n**Purpose:** Handle HTTP requests for error logs CRUD operations\n\n**Interfaces:**\n```typescript\nclass ErrorLogsController extends BaseAuditController<\n  ErrorLog,\n  ErrorQuery,\n  ErrorStats,\n  ErrorLogsService\n> {\n  constructor(service: ErrorLogsService) {\n    super(service, 'Error log');\n  }\n\n  protected getExportFilename(): string {\n    return 'error-logs';\n  }\n\n  // Inherits from BaseAuditController:\n  // - async findAll(request, reply): Promise<void>\n  // - async findById(request, reply): Promise<void>\n  // - async getStats(request, reply): Promise<void>\n  // - async deleteById(request, reply): Promise<void>\n  // - async cleanup(request, reply): Promise<void>\n  // - async export(request, reply): Promise<void>\n}\n```\n\n**Dependencies:**\n- ErrorLogsService\n- BaseAuditController (extends)\n\n**Reuses:** BaseAuditController provides all CRUD endpoints\n\n---\n\n#### 2. ErrorLogsService\n\n**Purpose:** Business logic for error logs operations\n\n**Interfaces:**\n```typescript\nclass ErrorLogsService extends BaseAuditService<\n  ErrorLog,\n  ErrorQuery,\n  ErrorStats,\n  ErrorLogsRepository\n> {\n  constructor(repository: ErrorLogsRepository) {\n    super(repository, 'error_logs');\n  }\n\n  // Inherits from BaseAuditService:\n  // - async findAll(query): Promise<PaginationResult<ErrorLog>>\n  // - async findById(id): Promise<ErrorLog | null>\n  // - async getStats(query): Promise<ErrorStats>\n  // - async deleteById(id): Promise<boolean>\n  // - async cleanup(query): Promise<number>\n  // - async export(query, options): Promise<string>\n\n  // Custom method:\n  async getStatsByLevel(): Promise<ErrorStatsByLevel> {\n    // Group errors by level (error, warn, info)\n    // Return counts and percentages\n  }\n}\n```\n\n**Dependencies:**\n- ErrorLogsRepository\n- BaseAuditService (extends)\n- Redis (for caching stats)\n\n**Reuses:** BaseAuditService provides pagination, filtering, statistics\n\n---\n\n#### 3. ActivityLogsController\n\n**Purpose:** Handle HTTP requests for activity logs\n\n**Interfaces:**\n```typescript\nclass ActivityLogsController extends BaseAuditController<\n  ActivityLog,\n  ActivityQuery,\n  ActivityStats,\n  ActivityLogsService\n> {\n  constructor(service: ActivityLogsService) {\n    super(service, 'Activity log');\n  }\n\n  protected getExportFilename(): string {\n    return 'activity-logs';\n  }\n\n  // Inherits all CRUD from BaseAuditController\n}\n```\n\n**Dependencies:**\n- ActivityLogsService\n- BaseAuditController (extends)\n\n**Reuses:** BaseAuditController provides all CRUD endpoints\n\n---\n\n#### 4. ProfileController\n\n**Purpose:** Handle user profile CRUD operations\n\n**Interfaces:**\n```typescript\nclass ProfileController {\n  constructor(\n    private profileService: ProfileService,\n    private userRepository: UserRepository\n  ) {}\n\n  // GET /api/v1/platform/profile\n  async getProfile(request, reply): Promise<void> {\n    const userId = request.user.id;\n    const profile = await this.profileService.getProfile(userId);\n    return reply.success(profile);\n  }\n\n  // PUT /api/v1/platform/profile\n  async updateProfile(request, reply): Promise<void> {\n    const userId = request.user.id;\n    const data = request.body;\n    const profile = await this.profileService.updateProfile(userId, data);\n    return reply.success(profile);\n  }\n}\n```\n\n**Dependencies:**\n- ProfileService\n- UserRepository (from users module)\n\n**Reuses:** User Repository for database access\n\n---\n\n#### 5. AvatarController\n\n**Purpose:** Handle avatar upload/delete\n\n**Interfaces:**\n```typescript\nclass AvatarController {\n  constructor(\n    private avatarService: AvatarService,\n    private fileUploadPlugin: FileUploadPlugin\n  ) {}\n\n  // POST /api/v1/platform/profile/avatar\n  async uploadAvatar(request, reply): Promise<void> {\n    const userId = request.user.id;\n    const file = await request.file(); // Multipart file\n    const avatarUrl = await this.avatarService.uploadAvatar(userId, file);\n    return reply.success({ avatarUrl });\n  }\n\n  // DELETE /api/v1/platform/profile/avatar\n  async deleteAvatar(request, reply): Promise<void> {\n    const userId = request.user.id;\n    await this.avatarService.deleteAvatar(userId);\n    return reply.success({ message: 'Avatar deleted' });\n  }\n}\n```\n\n**Dependencies:**\n- AvatarService\n- FileUploadPlugin (for storage)\n\n**Reuses:** File Upload infrastructure\n\n---\n\n#### 6. ApiKeysController\n\n**Purpose:** Handle API key CRUD and usage tracking\n\n**Interfaces:**\n```typescript\nclass ApiKeysController {\n  constructor(\n    private apiKeysService: ApiKeysService,\n    private apiKeysRepository: ApiKeysRepository\n  ) {}\n\n  // GET /api/v1/platform/api-keys\n  async listKeys(request, reply): Promise<void> {\n    const userId = request.user.id;\n    const keys = await this.apiKeysService.listKeys(userId);\n    return reply.success(keys);\n  }\n\n  // POST /api/v1/platform/api-keys\n  async createKey(request, reply): Promise<void> {\n    const userId = request.user.id;\n    const { name, permissions, expiresAt } = request.body;\n    const { key, keyData } = await this.apiKeysService.createKey(\n      userId,\n      name,\n      permissions,\n      expiresAt\n    );\n    // Return plain key only once\n    return reply.success({ key, ...keyData });\n  }\n\n  // DELETE /api/v1/platform/api-keys/:id\n  async revokeKey(request, reply): Promise<void> {\n    const userId = request.user.id;\n    const keyId = request.params.id;\n    await this.apiKeysService.revokeKey(userId, keyId);\n    return reply.success({ message: 'API key revoked' });\n  }\n\n  // GET /api/v1/platform/api-keys/:id/usage\n  async getUsage(request, reply): Promise<void> {\n    const keyId = request.params.id;\n    const usage = await this.apiKeysService.getUsage(keyId);\n    return reply.success(usage);\n  }\n}\n```\n\n**Dependencies:**\n- ApiKeysService\n- ApiKeysRepository\n- CryptoService (for key hashing)\n- ActivityLogsService (for audit trail)\n\n**Reuses:** None (standalone module)\n\n---\n\n### Frontend Components\n\n#### 7. ErrorLogsListPage (Container Component)\n\n**Purpose:** Display paginated list of error logs with filters\n\n**Interfaces:**\n```typescript\n@Component({\n  selector: 'app-error-logs-list',\n  standalone: true,\n  imports: [\n    DataTableComponent,\n    FilterPanelComponent,\n    StatsCardsComponent,\n    ExportButtonComponent,\n    MatTableModule,\n    AegisXModule\n  ]\n})\nexport class ErrorLogsListPage implements OnInit {\n  private errorLogsService = inject(ErrorLogsService);\n\n  // Signals from service\n  errorLogs = this.errorLogsService.errorLogs;\n  errorStats = this.errorLogsService.errorStats;\n  loading = this.errorLogsService.loading;\n  pagination = this.errorLogsService.pagination;\n\n  // Component state\n  filters = signal<ErrorLogsQuery>({});\n\n  ngOnInit() {\n    this.loadErrorLogs();\n    this.loadStats();\n  }\n\n  loadErrorLogs() {\n    this.errorLogsService.getErrorLogs(this.filters()).subscribe();\n  }\n\n  loadStats() {\n    this.errorLogsService.getErrorStats().subscribe();\n  }\n\n  onFilterChange(filters: ErrorLogsQuery) {\n    this.filters.set(filters);\n    this.loadErrorLogs();\n  }\n\n  onExport(format: 'csv' | 'json') {\n    this.errorLogsService.exportLogs(this.filters()).subscribe();\n  }\n\n  onDelete(id: string) {\n    this.errorLogsService.deleteErrorLog(id).subscribe(() => {\n      this.loadErrorLogs();\n    });\n  }\n}\n```\n\n**Dependencies:**\n- ErrorLogsService (state + API calls)\n- DataTableComponent (shared)\n- FilterPanelComponent (shared)\n- StatsCardsComponent (shared)\n- ExportButtonComponent (shared)\n\n**Reuses:** Shared data table, filter panel, stats cards components\n\n---\n\n#### 8. ProfilePage (Container Component)\n\n**Purpose:** User profile management with tabs\n\n**Interfaces:**\n```typescript\n@Component({\n  selector: 'app-profile',\n  standalone: true,\n  imports: [\n    ProfileInfoComponent,\n    ProfileAvatarComponent,\n    ProfilePreferencesComponent,\n    ProfileActivityComponent,\n    MatTabsModule,\n    AegisXModule\n  ]\n})\nexport class ProfilePage implements OnInit {\n  private userService = inject(UserService);\n  private route = inject(ActivatedRoute);\n\n  // Signals\n  profile = signal<UserProfile | null>(null);\n  loading = signal(false);\n  activeTab = signal(0);\n\n  ngOnInit() {\n    this.loadProfile();\n  }\n\n  loadProfile() {\n    this.loading.set(true);\n    this.userService.getProfile().subscribe({\n      next: (profile) => {\n        this.profile.set(profile);\n        this.loading.set(false);\n      },\n      error: () => this.loading.set(false)\n    });\n  }\n\n  onProfileUpdate(data: Partial<UserProfile>) {\n    this.userService.updateProfile(data).subscribe(() => {\n      this.loadProfile();\n    });\n  }\n\n  onAvatarUpload(file: File) {\n    this.userService.uploadAvatar(file).subscribe(() => {\n      this.loadProfile();\n    });\n  }\n}\n```\n\n**Dependencies:**\n- UserService (state + API calls)\n- ProfileInfoComponent\n- ProfileAvatarComponent\n- ProfilePreferencesComponent\n- ProfileActivityComponent\n\n**Reuses:** Department selector from existing departments module\n\n---\n\n#### 9. DataTableComponent (Shared/Reusable)\n\n**Purpose:** Reusable data table with sorting, pagination, and actions\n\n**Interfaces:**\n```typescript\n@Component({\n  selector: 'app-data-table',\n  standalone: true,\n  imports: [MatTableModule, MatPaginatorModule, MatSortModule]\n})\nexport class DataTableComponent<T> {\n  @Input() data: T[] = [];\n  @Input() columns: TableColumn<T>[] = [];\n  @Input() totalItems = 0;\n  @Input() pageSize = 25;\n  @Input() loading = false;\n\n  @Output() pageChange = new EventEmitter<PageEvent>();\n  @Output() sortChange = new EventEmitter<Sort>();\n  @Output() rowClick = new EventEmitter<T>();\n  @Output() actionClick = new EventEmitter<{ action: string; row: T }>();\n\n  displayedColumns: string[] = [];\n  dataSource = new MatTableDataSource<T>();\n\n  ngOnChanges() {\n    this.dataSource.data = this.data;\n    this.displayedColumns = this.columns.map(col => col.key);\n  }\n\n  onPageChange(event: PageEvent) {\n    this.pageChange.emit(event);\n  }\n\n  onSortChange(event: Sort) {\n    this.sortChange.emit(event);\n  }\n}\n\ninterface TableColumn<T> {\n  key: string;\n  label: string;\n  sortable?: boolean;\n  type?: 'text' | 'date' | 'badge' | 'actions';\n  formatter?: (value: any, row: T) => string;\n}\n```\n\n**Dependencies:**\n- Angular Material Table, Paginator, Sort\n\n**Reuses:** None (base component)\n\n---\n\n## Data Models\n\n### 1. ErrorLog (Backend)\n\n```typescript\ninterface ErrorLog {\n  id: string;                    // UUID primary key\n  timestamp: Date;               // When error occurred\n  level: 'error' | 'warn' | 'info';\n  message: string;               // Error message\n  url: string;                   // URL where error occurred\n  user_agent: string;            // Browser user agent\n  user_id: string | null;        // User who encountered error (nullable)\n  session_id: string | null;     // Session ID\n  correlation_id: string;        // Request correlation ID\n  stack: string | null;          // Stack trace\n  context: Record<string, any> | null; // Additional context\n  type: 'javascript' | 'http' | 'angular' | 'custom' | 'backend' | 'system';\n  ip_address: string | null;     // Client IP\n  referer: string | null;        // Referer header\n  created_at: Date;              // Row creation time\n}\n\ninterface ErrorQuery {\n  page?: number;\n  limit?: number;\n  level?: 'error' | 'warn' | 'info';\n  type?: string;\n  user_id?: string;\n  from_date?: string;            // ISO date\n  to_date?: string;              // ISO date\n  search?: string;               // Search in message\n}\n\ninterface ErrorStats {\n  total: number;\n  by_level: {\n    error: number;\n    warn: number;\n    info: number;\n  };\n  by_type: Record<string, number>;\n  trend: Array<{ date: string; count: number }>;\n}\n```\n\n**Database Table:** `error_logs` (already exists)\n\n---\n\n### 2. ActivityLog (Backend)\n\n```typescript\ninterface ActivityLog {\n  id: string;                    // UUID primary key\n  user_id: string;               // User who performed action\n  action: string;                // Action type (e.g., 'user.login', 'profile.update')\n  description: string;           // Human-readable description\n  entity_type: string | null;    // Entity affected (e.g., 'user', 'document')\n  entity_id: string | null;      // Entity ID\n  ip_address: string | null;     // Client IP\n  user_agent: string | null;     // Browser user agent\n  correlation_id: string;        // Request correlation ID\n  metadata: Record<string, any> | null; // Additional data\n  severity: 'info' | 'warning' | 'error' | 'critical';\n  timestamp: Date;               // When action occurred\n  created_at: Date;              // Row creation time\n}\n\ninterface ActivityQuery {\n  page?: number;\n  limit?: number;\n  user_id?: string;\n  action?: string;\n  entity_type?: string;\n  severity?: 'info' | 'warning' | 'error' | 'critical';\n  from_date?: string;\n  to_date?: string;\n  search?: string;\n}\n\ninterface ActivityStats {\n  total: number;\n  by_user: Array<{ user_id: string; count: number }>;\n  by_action: Record<string, number>;\n  by_severity: Record<string, number>;\n  trend: Array<{ date: string; count: number }>;\n}\n```\n\n**Database Table:** `activity_logs` (already exists)\n\n---\n\n### 3. UserProfile (Backend)\n\n```typescript\ninterface UserProfile {\n  id: string;                    // UUID (from users table)\n  email: string;\n  first_name: string;\n  last_name: string;\n  department_id: string | null;  // NEW: Department association\n  avatar_url: string | null;     // Avatar file URL\n  theme: 'light' | 'dark' | 'auto';\n  language: 'en' | 'th';\n  notifications_enabled: boolean;\n  email_notifications: boolean;\n  created_at: Date;\n  updated_at: Date;\n}\n\ninterface UpdateProfileRequest {\n  first_name?: string;\n  last_name?: string;\n  department_id?: string | null;\n  theme?: 'light' | 'dark' | 'auto';\n  language?: 'en' | 'th';\n  notifications_enabled?: boolean;\n  email_notifications?: boolean;\n}\n```\n\n**Database Table:** `users` (existing, no changes needed - department_id already added)\n\n---\n\n### 4. ApiKey (Backend)\n\n```typescript\ninterface ApiKey {\n  id: string;                    // UUID primary key\n  user_id: string;               // Owner user ID\n  name: string;                  // User-defined name\n  key_hash: string;              // Bcrypt hash of the key\n  key_prefix: string;            // First 8 chars for display (e.g., \"pk_live_\")\n  permissions: string[];         // Array of permission strings\n  last_used_at: Date | null;     // Last usage timestamp\n  usage_count: number;           // Total request count\n  expires_at: Date | null;       // Expiration date (nullable)\n  revoked: boolean;              // Revoked status\n  revoked_at: Date | null;       // When revoked\n  created_at: Date;\n  updated_at: Date;\n}\n\ninterface CreateApiKeyRequest {\n  name: string;\n  permissions: string[];\n  expires_at?: string;           // ISO date (optional)\n}\n\ninterface ApiKeyResponse {\n  id: string;\n  name: string;\n  key_prefix: string;\n  permissions: string[];\n  expires_at: Date | null;\n  created_at: Date;\n  // Note: Full key is only returned on creation\n}\n```\n\n**Database Table:** `api_keys` (NEW - requires migration)\n\n**Migration:**\n```sql\nCREATE TABLE api_keys (\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  name VARCHAR(255) NOT NULL,\n  key_hash VARCHAR(255) NOT NULL,\n  key_prefix VARCHAR(20) NOT NULL,\n  permissions TEXT[] NOT NULL DEFAULT '{}',\n  last_used_at TIMESTAMP WITH TIME ZONE,\n  usage_count INTEGER NOT NULL DEFAULT 0,\n  expires_at TIMESTAMP WITH TIME ZONE,\n  revoked BOOLEAN NOT NULL DEFAULT FALSE,\n  revoked_at TIMESTAMP WITH TIME ZONE,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\nCREATE INDEX idx_api_keys_user_id ON api_keys(user_id);\nCREATE INDEX idx_api_keys_key_hash ON api_keys(key_hash);\nCREATE INDEX idx_api_keys_revoked ON api_keys(revoked) WHERE NOT revoked;\n```\n\n---\n\n## API Contracts\n\n### Error Logs API\n\n**Base URL:** `/api/error-logs`\n\n#### GET /api/error-logs\n**Description:** List error logs with pagination and filters\n**Auth:** Required (JWT)\n**Permission:** `monitoring:read`\n\n**Query Parameters:**\n```typescript\n{\n  page?: number;          // Default: 1\n  limit?: number;         // Default: 25\n  level?: 'error' | 'warn' | 'info';\n  type?: string;\n  user_id?: string;\n  from_date?: string;     // ISO date\n  to_date?: string;\n  search?: string;\n}\n```\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: ErrorLog[],\n  pagination: {\n    page: number,\n    limit: number,\n    total: number,\n    totalPages: number,\n    hasNext: boolean,\n    hasPrev: boolean\n  }\n}\n```\n\n---\n\n#### GET /api/error-logs/stats\n**Description:** Get error statistics\n**Auth:** Required\n**Permission:** `monitoring:read`\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: {\n    total: number,\n    by_level: { error: number, warn: number, info: number },\n    by_type: Record<string, number>,\n    trend: Array<{ date: string, count: number }>\n  }\n}\n```\n\n---\n\n#### GET /api/error-logs/:id\n**Description:** Get single error log details\n**Auth:** Required\n**Permission:** `monitoring:read`\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: ErrorLog\n}\n```\n\n---\n\n#### DELETE /api/error-logs/:id\n**Description:** Delete single error log\n**Auth:** Required\n**Permission:** `monitoring:write`\n\n**Response:**\n```typescript\n{\n  success: true,\n  message: \"Error log deleted successfully\"\n}\n```\n\n---\n\n#### DELETE /api/error-logs/cleanup\n**Description:** Bulk delete old error logs\n**Auth:** Required\n**Permission:** `monitoring:write`\n\n**Query Parameters:**\n```typescript\n{\n  days?: number;          // Delete logs older than X days (default: 90)\n  level?: string;         // Only delete logs of specific level\n}\n```\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: {\n    deletedCount: number\n  }\n}\n```\n\n---\n\n#### GET /api/error-logs/export\n**Description:** Export error logs to CSV\n**Auth:** Required\n**Permission:** `monitoring:read`\n\n**Query Parameters:** Same as list endpoint\n\n**Response:** CSV file download\n\n---\n\n### Activity Logs API\n\n**Base URL:** `/api/activity-logs`\n\nEndpoints mirror Error Logs API structure:\n- GET /api/activity-logs\n- GET /api/activity-logs/stats\n- GET /api/activity-logs/:id\n- DELETE /api/activity-logs/cleanup\n- GET /api/activity-logs/export\n\n**Permission Required:** `audit:read` (read), `audit:admin` (delete/export)\n\n---\n\n### User Profile API\n\n**Base URL:** `/api/v1/platform/profile`\n\n#### GET /api/v1/platform/profile\n**Description:** Get current user's profile\n**Auth:** Required\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: UserProfile\n}\n```\n\n---\n\n#### PUT /api/v1/platform/profile\n**Description:** Update current user's profile\n**Auth:** Required\n\n**Request Body:**\n```typescript\n{\n  first_name?: string,\n  last_name?: string,\n  department_id?: string | null,\n  theme?: 'light' | 'dark' | 'auto',\n  language?: 'en' | 'th',\n  notifications_enabled?: boolean,\n  email_notifications?: boolean\n}\n```\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: UserProfile\n}\n```\n\n---\n\n#### POST /api/v1/platform/profile/avatar\n**Description:** Upload avatar image\n**Auth:** Required\n**Content-Type:** multipart/form-data\n\n**Request:** File upload (max 5MB, image/* types)\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: {\n    avatar_url: string\n  }\n}\n```\n\n---\n\n#### DELETE /api/v1/platform/profile/avatar\n**Description:** Delete avatar image\n**Auth:** Required\n\n**Response:**\n```typescript\n{\n  success: true,\n  message: \"Avatar deleted successfully\"\n}\n```\n\n---\n\n#### GET /api/v1/platform/profile/preferences\n**Description:** Get user preferences\n**Auth:** Required\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: {\n    theme: 'light' | 'dark' | 'auto',\n    language: 'en' | 'th',\n    notifications_enabled: boolean,\n    email_notifications: boolean\n  }\n}\n```\n\n---\n\n#### PUT /api/v1/platform/profile/preferences\n**Description:** Update user preferences\n**Auth:** Required\n\n**Request Body:**\n```typescript\n{\n  theme?: 'light' | 'dark' | 'auto',\n  language?: 'en' | 'th',\n  notifications_enabled?: boolean,\n  email_notifications?: boolean\n}\n```\n\n---\n\n#### GET /api/v1/platform/profile/activity\n**Description:** Get user's activity history (read-only)\n**Auth:** Required\n\n**Query Parameters:**\n```typescript\n{\n  page?: number,\n  limit?: number,\n  from_date?: string,\n  to_date?: string\n}\n```\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: ActivityLog[],\n  pagination: PaginationInfo\n}\n```\n\n---\n\n### API Keys API\n\n**Base URL:** `/api/v1/platform/api-keys`\n\n#### GET /api/v1/platform/api-keys\n**Description:** List user's API keys\n**Auth:** Required\n**Permission:** `api-keys:manage`\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: ApiKeyResponse[]\n}\n```\n\n---\n\n#### POST /api/v1/platform/api-keys\n**Description:** Create new API key\n**Auth:** Required\n**Permission:** `api-keys:manage`\n\n**Request Body:**\n```typescript\n{\n  name: string,\n  permissions: string[],\n  expires_at?: string  // ISO date\n}\n```\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: {\n    key: string,  // ONLY returned once!\n    id: string,\n    name: string,\n    key_prefix: string,\n    permissions: string[],\n    expires_at: Date | null,\n    created_at: Date\n  }\n}\n```\n\n---\n\n#### GET /api/v1/platform/api-keys/:id\n**Description:** Get API key details (without secret)\n**Auth:** Required\n**Permission:** `api-keys:manage`\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: ApiKeyResponse\n}\n```\n\n---\n\n#### PUT /api/v1/platform/api-keys/:id\n**Description:** Update API key (name, permissions, expiration)\n**Auth:** Required\n**Permission:** `api-keys:manage`\n\n**Request Body:**\n```typescript\n{\n  name?: string,\n  permissions?: string[],\n  expires_at?: string\n}\n```\n\n---\n\n#### DELETE /api/v1/platform/api-keys/:id\n**Description:** Revoke API key\n**Auth:** Required\n**Permission:** `api-keys:manage`\n\n**Response:**\n```typescript\n{\n  success: true,\n  message: \"API key revoked successfully\"\n}\n```\n\n---\n\n#### GET /api/v1/platform/api-keys/:id/usage\n**Description:** Get API key usage statistics\n**Auth:** Required\n**Permission:** `api-keys:manage`\n\n**Response:**\n```typescript\n{\n  success: true,\n  data: {\n    total_requests: number,\n    last_used_at: Date | null,\n    requests_by_date: Array<{ date: string, count: number }>\n  }\n}\n```\n\n---\n\n## Error Handling\n\n### Error Scenarios\n\n#### 1. Unauthorized Access (401)\n**Scenario:** User attempts to access protected endpoint without valid JWT\n**Handling:** Authentication middleware returns 401\n**User Impact:** Redirected to login page with \"Session expired\" message\n\n#### 2. Insufficient Permissions (403)\n**Scenario:** User lacks required RBAC permission (e.g., `monitoring:write`)\n**Handling:** RBAC middleware returns 403\n**User Impact:** Error message \"You don't have permission to perform this action\"\n\n#### 3. Resource Not Found (404)\n**Scenario:** Requested error log/activity log/profile/API key doesn't exist\n**Handling:** Controller returns 404\n**User Impact:** Error message \"Resource not found\"\n\n#### 4. Validation Error (400)\n**Scenario:** Invalid request data (e.g., invalid date format, missing required fields)\n**Handling:** TypeBox validation returns 400 with field-specific errors\n**User Impact:** Form shows inline validation errors\n\n#### 5. File Upload Error (400)\n**Scenario:** Avatar upload fails (file too large, wrong type)\n**Handling:** File upload middleware returns 400\n**User Impact:** Error message \"File must be an image under 5MB\"\n\n#### 6. Database Error (500)\n**Scenario:** Database query fails (connection error, constraint violation)\n**Handling:** Service catches error, logs it, returns 500\n**User Impact:** Generic error message \"An error occurred. Please try again.\"\n\n#### 7. API Key Already Exists (409)\n**Scenario:** User tries to create API key with duplicate name\n**Handling:** Service checks for duplicate, returns 409\n**User Impact:** Error message \"An API key with this name already exists\"\n\n#### 8. Expired API Key (401)\n**Scenario:** Request uses expired API key\n**Handling:** API key middleware checks expiration, returns 401\n**User Impact:** API request fails with \"API key expired\" message\n\n---\n\n## Testing Strategy\n\n### Unit Testing\n\n**Backend:**\n- **Controllers:** Test request/response handling with mocked services\n- **Services:** Test business logic with mocked repositories\n- **Repositories:** Test query building with mocked Knex\n- **Schemas:** Test TypeBox schema validation with valid/invalid inputs\n- **Middleware:** Test authentication and authorization flows\n\n**Target Coverage:** >80%\n\n**Key Test Cases:**\n- Error Logs Service:\n  - ✅ Pagination with different page sizes\n  - ✅ Filtering by level, type, date range\n  - ✅ Statistics calculation\n  - ✅ Cleanup with retention period\n  - ✅ Export to CSV formatting\n\n- API Keys Service:\n  - ✅ Key generation with secure randomness\n  - ✅ Key hashing and verification\n  - ✅ Permission validation\n  - ✅ Expiration checking\n  - ✅ Revocation flow\n\n**Frontend:**\n- **Services:** Test HTTP calls with HttpTestingController\n- **Components:** Test rendering and user interactions with ComponentFixture\n- **State Management:** Test signal updates and side effects\n\n---\n\n### Integration Testing\n\n**Backend:**\n- **API Endpoints:** Test complete request/response flow with test database\n- **Authentication:** Test JWT validation and RBAC permissions\n- **Database:** Test actual queries against test PostgreSQL instance\n\n**Test Database:** Separate test database with seed data\n\n**Key Integration Tests:**\n- Error Logs:\n  - ✅ POST error to monitoring → stored in error_logs → GET via error-logs API\n  - ✅ Pagination returns correct page data and metadata\n  - ✅ Filter combinations work correctly\n  - ✅ Export generates valid CSV\n\n- Activity Logs:\n  - ✅ User action → Activity middleware logs → GET via activity-logs API\n  - ✅ User-specific activity filtering\n\n- User Profile:\n  - ✅ Update profile → Department validated → User updated → Profile returned\n  - ✅ Upload avatar → File stored → URL returned → Avatar displayed\n\n- API Keys:\n  - ✅ Create key → Hash stored → Plain key returned once\n  - ✅ Use key in request → Middleware validates → Request authorized\n  - ✅ Revoke key → Key invalidated → Subsequent requests fail\n\n---\n\n### End-to-End Testing\n\n**Tool:** Playwright\n\n**Key User Scenarios:**\n\n#### 1. Error Logs Management\n```gherkin\nScenario: Admin views and filters error logs\n  Given I am logged in as admin\n  When I navigate to Error Logs page\n  Then I see a list of error logs\n  When I filter by level \"error\"\n  Then I see only error-level logs\n  When I click on an error log\n  Then I see full error details with stack trace\n  When I click \"Export\"\n  Then a CSV file is downloaded\n```\n\n#### 2. Profile Management\n```gherkin\nScenario: User updates profile with department\n  Given I am logged in as a user\n  When I navigate to Profile page\n  And I change my first name to \"John\"\n  And I select department \"Engineering\"\n  And I upload an avatar image\n  And I click \"Save\"\n  Then I see a success message\n  And my profile is updated\n  And my new avatar is displayed\n```\n\n#### 3. API Key Creation\n```gherkin\nScenario: Developer creates API key\n  Given I am logged in as a developer\n  When I navigate to API Keys page\n  And I click \"Create API Key\"\n  And I enter name \"Production API\"\n  And I select permissions \"users:read\", \"data:read\"\n  And I set expiration to \"90 days\"\n  And I click \"Create\"\n  Then I see the generated API key once\n  And I can copy it to clipboard\n  And the key appears in my list with status \"Active\"\n```\n\n#### 4. Activity Log Audit Trail\n```gherkin\nScenario: Compliance officer views activity logs\n  Given I am logged in as compliance officer\n  When I navigate to Activity Logs page\n  Then I see recent user activities\n  When I filter by user \"john@example.com\"\n  Then I see only John's activities\n  When I click on an activity\n  Then I see full details including IP and user agent\n  When I export to CSV\n  Then all filtered activities are exported\n```\n\n---\n\n## Performance Optimizations\n\n### Backend\n\n1. **Redis Caching for Statistics**\n   - Cache error stats for 5 minutes\n   - Cache activity stats for 5 minutes\n   - Invalidate on new entries\n\n2. **Database Indexing**\n   - `error_logs(timestamp)` - for date range queries\n   - `error_logs(level)` - for level filters\n   - `error_logs(user_id)` - for user-specific queries\n   - `activity_logs(user_id, timestamp)` - for user activity\n   - `api_keys(key_hash)` - for key lookup\n   - `api_keys(user_id, revoked)` - for user's active keys\n\n3. **Query Optimization**\n   - Use pagination to limit result sets\n   - Use indexes for all filter columns\n   - Avoid N+1 queries with JOIN or batch loading\n\n4. **Response Compression**\n   - Enable gzip compression for all JSON responses\n   - Reduces payload size by ~70%\n\n### Frontend\n\n1. **Lazy Loading**\n   - Load monitoring modules only when accessed\n   - Load API keys module only when accessed\n\n2. **Virtual Scrolling**\n   - Use CDK virtual scroll for tables with >100 rows\n   - Renders only visible rows\n\n3. **Debounced Search**\n   - Debounce search input by 300ms\n   - Reduces unnecessary API calls\n\n4. **Optimistic Updates**\n   - Update UI immediately on profile changes\n   - Revert on error\n\n5. **Image Optimization**\n   - Resize avatars to 200x200px\n   - Convert to WebP format\n   - Max file size 200KB\n\n---\n\n## Security Considerations\n\n### Authentication\n- All endpoints require JWT authentication\n- JWT tokens expire after 24 hours\n- Refresh tokens stored in httpOnly cookies\n\n### Authorization\n- RBAC permissions checked on every request\n- User can only access their own data (profile, API keys, activity)\n- Admin permissions required for bulk operations\n\n### Input Validation\n- TypeBox schemas validate all inputs\n- SQL injection prevented by parameterized queries (Knex)\n- XSS prevented by Angular sanitization\n\n### API Key Security\n- Keys hashed with bcrypt (cost=12) before storage\n- Plain key shown only once at creation\n- Rate limiting: 1000 requests/hour per key\n- Usage tracked in activity logs\n\n### File Upload Security\n- Avatar uploads restricted to image types\n- Max file size: 5MB\n- Files scanned for malware (if applicable)\n- Files stored outside web root\n\n### Sensitive Data\n- Error logs may contain sensitive data - restrict access\n- Activity logs contain IP addresses - GDPR compliant retention\n- API keys grant programmatic access - require user consent\n\n---\n\n## Deployment Strategy\n\n### Phase 1: Backend Development (Week 1)\n1. Create error-logs module (Day 1-2)\n2. Create activity-logs module (Day 2-3)\n3. Create user-profile module (Day 3-4)\n4. Create api-keys module (Day 4-5)\n5. Integration testing (Day 5)\n\n### Phase 2: Frontend Development (Week 2)\n1. Update service baseUrls (Day 1)\n2. Create error-logs pages (Day 1-2)\n3. Create activity-logs pages (Day 2-3)\n4. Create profile page (Day 3-4)\n5. Create api-keys pages (Day 4-5)\n\n### Phase 3: Testing & Deployment (Week 2 End)\n1. E2E tests (Day 6)\n2. Bug fixes (Day 7)\n3. Production deployment\n\n### Rollout Plan\n1. Deploy backend to staging\n2. Run smoke tests\n3. Deploy frontend to staging\n4. User acceptance testing (UAT)\n5. Deploy to production (low-traffic window)\n6. Monitor for 24 hours\n\n---\n\n## Migration from Old Modules\n\n### Error Logs\n**Old Location:** `apps/api/src/core/error-logs/` (deleted)\n**New Location:** `apps/api/src/layers/core/audit/error-logs/`\n**Migration:** Re-implement using BaseAuditController (faster than restoring old code)\n\n### Activity Logs\n**Old Location:** `apps/api/src/core/user-profile/activity-logs.routes.ts` (deleted)\n**New Location:** `apps/api/src/layers/core/audit/activity-logs/`\n**Migration:** Re-implement using BaseAuditController\n\n### User Profile\n**Old Location:** `apps/api/src/core/user-profile/` (deleted)\n**New Location:** `apps/api/src/layers/platform/user-profile/`\n**Migration:** Re-implement with department integration\n\n### API Keys\n**Old Location:** `apps/api/src/core/api-keys/` (deleted)\n**New Location:** `apps/api/src/layers/platform/api-keys/`\n**Migration:** Re-implement with enhanced security\n\n**No Data Migration Required:** Database tables already exist and contain data\n\n---\n\n## Dependencies\n\n**Backend:**\n- ✅ Fastify 4.x\n- ✅ TypeBox\n- ✅ Knex.js\n- ✅ PostgreSQL\n- ✅ Redis\n- ✅ bcrypt (for API key hashing)\n- ✅ csv-stringify (for CSV export)\n\n**Frontend:**\n- ✅ Angular 17+\n- ✅ Angular Material 17+\n- ✅ AegisX UI 1.x\n- ✅ TailwindCSS 3.x\n- ✅ RxJS 7.x\n\n**Development:**\n- ✅ Vitest (unit tests)\n- ✅ Supertest (API tests)\n- ✅ Playwright (E2E tests)\n\n---\n\n## Open Questions\n\n1. **API Key Rate Limiting:** Should we implement per-key rate limits or per-user?\n   - **Recommendation:** Per-key limits (more granular control)\n\n2. **Error Log Retention:** Default retention period for error logs?\n   - **Recommendation:** 90 days (configurable via env variable)\n\n3. **Activity Log Privacy:** Should activity logs be visible to users for their own actions?\n   - **Recommendation:** Yes, in profile page (read-only)\n\n4. **API Key Permissions:** Should permissions be hierarchical (e.g., `users:*` grants all user permissions)?\n   - **Recommendation:** Yes, support wildcards for admin convenience\n\n5. **Department Validation:** Should we restrict department changes to admins only?\n   - **Recommendation:** Allow self-service but require department approval workflow (future enhancement)\n\n---\n\n## Future Enhancements (Out of Scope)\n\n1. **Real-Time Monitoring Dashboard** - Live error/activity charts with WebSocket updates\n2. **Advanced Analytics** - Trends, anomaly detection, predictive insights\n3. **Email Notifications** - Alert on critical errors or suspicious activities\n4. **Export Formats** - Add JSON, Excel, PDF export options\n5. **Audit Log Immutability** - Cryptographic signing of audit logs for compliance\n6. **API Key Scopes** - Fine-grained permissions (e.g., `users:read:own` vs `users:read:all`)\n7. **Multi-Factor Authentication for API Keys** - Require additional verification for sensitive operations\n8. **Internationalization** - Multi-language support for UI\n9. **Custom Retention Policies** - Per-log-type or per-user retention configuration\n10. **Integration with External Services** - Slack, PagerDuty, Jira for alerting and ticketing\n\n---\n\n## Conclusion\n\nThis design provides a comprehensive blueprint for restoring the four missing modules (Error Logs, Activity Logs, User Profile, API Keys) with modern UI/UX using AegisX UI, Angular Material, and TailwindCSS. The architecture heavily leverages existing base classes to minimize code duplication, follows the established layer-based routing standard, and includes robust security, testing, and performance considerations.\n\n**Key Success Factors:**\n- ✅ Maximum code reuse via base classes\n- ✅ Consistent UI/UX across all modules\n- ✅ Type-safe API contracts with TypeBox\n- ✅ Comprehensive testing strategy\n- ✅ Clear migration path from deleted modules\n- ✅ Production-ready security and performance\n\n**Next Steps:**\n1. Get design approval\n2. Break down into granular implementation tasks\n3. Begin Phase 1: Backend development\n",
  "fileStats": {
    "size": 53780,
    "lines": 1953,
    "lastModified": "2025-12-16T07:08:13.613Z"
  },
  "comments": []
}
