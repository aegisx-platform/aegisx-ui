{
  "id": "snapshot_1765868310980_2z7xv4kha",
  "approvalId": "approval_1765868310937_nqlshsmiu",
  "approvalTitle": "Requirements: Monitoring & Audit Modules Restoration",
  "version": 1,
  "timestamp": "2025-12-16T06:58:30.980Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: Monitoring & Audit Modules Restoration\n\n## Introduction\n\nThis specification addresses the restoration of four critical backend modules that were deleted during the API Architecture Standardization migration (December 15, 2025) but were never re-implemented in the new layer-based architecture. These modules are essential for production monitoring, audit compliance, user experience, and API security.\n\nThe modules to be restored and enhanced are:\n\n1. **Error Logs Module** - View and manage application errors\n2. **Activity Logs Module** - Track and audit user activities\n3. **User Profile Module** - Manage user profiles, avatars, and preferences\n4. **API Keys Module** - Manage API keys for third-party integrations\n\nAdditionally, this specification includes comprehensive UI/UX improvements using AegisX UI component library, Angular Material, and TailwindCSS to create a modern, consistent, and accessible user interface.\n\n### Background\n\nDuring the API Architecture Standardization migration (commit `76296b3e` on 2025-12-15), these modules were deleted from `apps/api/src/core/` with the assumption they would be migrated to the new `layers/` structure. However, they were never re-implemented, leaving the frontend services unable to function.\n\n**Current State:**\n- ✅ Database tables exist (`error_logs`, `activity_logs`, etc.)\n- ✅ Frontend services fully implemented\n- ✅ Base infrastructure available (`BaseAuditController`, `BaseAuditRepository`)\n- ❌ Backend REST API endpoints missing\n- ❌ UI/UX outdated and inconsistent\n\n**Value Proposition:**\n- **Production Readiness**: Enable critical monitoring and debugging capabilities\n- **Compliance**: Meet audit trail requirements (GDPR, SOC2, etc.)\n- **User Experience**: Provide modern, accessible UI for all user-facing features\n- **API Security**: Enable secure third-party integrations via API keys\n- **Developer Experience**: Consistent UI patterns across all modules\n\n## Alignment with Product Vision\n\nThis feature supports the following product goals:\n\n1. **Enterprise-Grade Platform**: Restore monitoring and audit capabilities essential for enterprise deployments\n2. **Security & Compliance**: Provide comprehensive audit trails and secure API access management\n3. **Modern User Experience**: Deliver consistent, accessible UI using design system standards\n4. **Developer Productivity**: Establish reusable patterns that speed up future development\n5. **Production Operations**: Enable effective monitoring, debugging, and troubleshooting\n\n## Requirements\n\n### 1. Error Logs Management\n\n**User Story:** As a system administrator, I want to view, filter, and manage error logs, so that I can quickly identify and resolve application issues.\n\n#### Acceptance Criteria\n\n1. WHEN I navigate to the Error Logs page THEN the system SHALL display a paginated list of all error logs with basic information (timestamp, level, message, user)\n2. WHEN I apply filters (date range, level, user, type) THEN the system SHALL display only matching error logs\n3. WHEN I click on an error log entry THEN the system SHALL display full error details including stack trace, context, and request information\n4. WHEN I view error statistics THEN the system SHALL display aggregated metrics (total errors, errors by level, errors by type, trend charts)\n5. WHEN I delete an error log THEN the system SHALL remove it and refresh the list\n6. WHEN I trigger bulk cleanup THEN the system SHALL delete old errors based on configured retention period\n7. WHEN I export error logs THEN the system SHALL generate a CSV file with all filtered errors\n8. IF I lack proper permissions THEN the system SHALL deny access and display an appropriate message\n\n**Backend API Requirements:**\n- `GET /api/error-logs` - List errors with pagination and filters\n- `GET /api/error-logs/stats` - Error statistics and metrics\n- `GET /api/error-logs/:id` - Single error details\n- `DELETE /api/error-logs/:id` - Delete single error\n- `DELETE /api/error-logs/cleanup` - Bulk cleanup\n- `GET /api/error-logs/export` - Export to CSV\n\n**UI/UX Requirements:**\n- Modern data table with sorting, filtering, and search using AegisX `ax-table` component\n- Error level badges with color coding (error=red, warn=yellow, info=blue)\n- Expandable row details for stack traces\n- Real-time error count updates via WebSocket\n- Responsive layout for mobile and tablet\n- Accessibility: ARIA labels, keyboard navigation, screen reader support\n\n---\n\n### 2. Activity Logs Auditing\n\n**User Story:** As a compliance officer, I want to view comprehensive activity logs of all user actions, so that I can ensure audit compliance and investigate security incidents.\n\n#### Acceptance Criteria\n\n1. WHEN I navigate to the Activity Logs page THEN the system SHALL display a paginated list of all user activities with timestamp, user, action, and status\n2. WHEN I filter by user, action type, date range, or resource THEN the system SHALL display only matching activities\n3. WHEN I click on an activity entry THEN the system SHALL display full activity details including metadata, IP address, user agent, and related entities\n4. WHEN I view activity statistics THEN the system SHALL display metrics (total activities, activities by type, activities by user, timeline chart)\n5. WHEN I export activity logs THEN the system SHALL generate a CSV file with all filtered activities\n6. WHEN I search by keyword THEN the system SHALL search across action descriptions, metadata, and user information\n7. IF I lack audit permissions THEN the system SHALL deny access\n\n**Backend API Requirements:**\n- `GET /api/activity-logs` - List activities with pagination and filters\n- `GET /api/activity-logs/stats` - Activity statistics\n- `GET /api/activity-logs/:id` - Single activity details\n- `GET /api/activity-logs/export` - Export to CSV\n- `DELETE /api/activity-logs/cleanup` - Bulk cleanup (admin only)\n\n**UI/UX Requirements:**\n- Timeline view with grouping by date\n- Activity type icons and color coding\n- User avatar integration\n- Advanced filtering panel with collapsible filters\n- Full-text search with highlighting\n- Export button with format options (CSV, JSON)\n- Responsive design for all screen sizes\n\n---\n\n### 3. User Profile Management\n\n**User Story:** As a user, I want to manage my profile information, avatar, and preferences, so that I can personalize my experience and keep my information up-to-date.\n\n#### Acceptance Criteria\n\n1. WHEN I navigate to my profile page THEN the system SHALL display my current profile information (name, email, department, avatar)\n2. WHEN I update my profile information THEN the system SHALL validate and save the changes\n3. WHEN I upload an avatar image THEN the system SHALL validate the file (type, size), upload it, and display the new avatar immediately\n4. WHEN I delete my avatar THEN the system SHALL remove it and display the default avatar\n5. WHEN I update my preferences (theme, language, notifications) THEN the system SHALL save them and apply immediately\n6. WHEN I view my activity history THEN the system SHALL display my recent activities (read-only view)\n7. WHEN I request account deletion THEN the system SHALL prompt for confirmation and process the deletion request\n8. IF I enter invalid data THEN the system SHALL display clear validation errors\n\n**Backend API Requirements:**\n- `GET /api/v1/platform/profile` - Get current user profile\n- `PUT /api/v1/platform/profile` - Update profile information\n- `POST /api/v1/platform/profile/avatar` - Upload avatar image\n- `DELETE /api/v1/platform/profile/avatar` - Delete avatar\n- `GET /api/v1/platform/profile/preferences` - Get user preferences\n- `PUT /api/v1/platform/profile/preferences` - Update preferences\n- `GET /api/v1/platform/profile/activity` - Get user's activity history\n- `DELETE /api/v1/platform/profile/delete` - Request account deletion\n\n**UI/UX Requirements:**\n- Card-based layout with sections (Basic Info, Avatar, Preferences, Security, Activity)\n- Avatar upload with drag-and-drop using AegisX `ax-file-upload`\n- Real-time preview of changes\n- Inline validation with clear error messages\n- Theme switcher with live preview\n- Language selector with flag icons\n- Activity timeline widget showing recent actions\n- Confirmation dialogs for destructive actions\n- Mobile-optimized responsive layout\n\n---\n\n### 4. API Keys Management\n\n**User Story:** As a developer, I want to create and manage API keys for third-party integrations, so that I can securely access the platform's API programmatically.\n\n#### Acceptance Criteria\n\n1. WHEN I navigate to the API Keys page THEN the system SHALL display all my API keys with name, prefix, created date, last used, and status\n2. WHEN I create a new API key THEN the system SHALL validate the name, generate a secure key, and display it once with a copy button\n3. WHEN I view an API key THEN the system SHALL display metadata but NOT the full key (only prefix)\n4. WHEN I revoke an API key THEN the system SHALL deactivate it immediately and mark it as revoked\n5. WHEN I set key permissions THEN the system SHALL validate and save the allowed scopes/permissions\n6. WHEN I set an expiration date THEN the system SHALL automatically revoke the key after expiration\n7. WHEN I view usage statistics THEN the system SHALL display request count, last used timestamp, and usage trends\n8. IF I attempt to exceed the key limit THEN the system SHALL prevent creation and display the limit\n\n**Backend API Requirements:**\n- `GET /api/v1/platform/api-keys` - List user's API keys\n- `POST /api/v1/platform/api-keys` - Create new API key\n- `GET /api/v1/platform/api-keys/:id` - Get API key details\n- `PUT /api/v1/platform/api-keys/:id` - Update API key (name, permissions, expiration)\n- `DELETE /api/v1/platform/api-keys/:id` - Revoke API key\n- `GET /api/v1/platform/api-keys/:id/usage` - Get usage statistics\n- `POST /api/v1/platform/api-keys/:id/rotate` - Rotate API key (generate new secret)\n\n**UI/UX Requirements:**\n- Master-detail layout: list on left, details on right\n- Create key wizard with steps (Name → Permissions → Expiration → Review)\n- Key display with one-time visibility warning and copy button\n- Permission selector with grouped checkboxes (read, write, admin scopes)\n- Expiration date picker with common presets (30d, 90d, 1y, never)\n- Usage charts showing requests over time\n- Status badges (Active, Expired, Revoked) with color coding\n- Search and filter by status, name, or creation date\n- Confirmation dialogs for revoke/delete operations\n- Security notice highlighting best practices\n\n---\n\n### 5. UI/UX Design System Compliance\n\n**User Story:** As a user, I want a consistent, modern, and accessible interface across all monitoring and audit features, so that I can efficiently use the system without confusion.\n\n#### Acceptance Criteria\n\n1. WHEN I navigate to any monitoring/audit page THEN the system SHALL use AegisX UI components consistently\n2. WHEN I interact with data tables THEN the system SHALL use `ax-table` with consistent column layouts, sorting, and pagination\n3. WHEN I view forms THEN the system SHALL use Angular Material form controls with TailwindCSS utility classes\n4. WHEN I trigger actions THEN the system SHALL use AegisX `ax-button` with consistent variants and sizes\n5. WHEN I see status indicators THEN the system SHALL use AegisX `ax-badge` with semantic colors\n6. WHEN I view cards THEN the system SHALL use AegisX `ax-card` with consistent spacing and shadows\n7. WHEN I encounter dialogs THEN the system SHALL use Angular Material dialogs with consistent styling\n8. WHEN I filter data THEN the system SHALL use AegisX `ax-filter-panel` with collapsible sections\n9. WHEN I export data THEN the system SHALL use AegisX `ax-export-button` with format selection\n10. IF I use keyboard navigation THEN the system SHALL support all interactions via keyboard\n11. IF I use a screen reader THEN the system SHALL provide appropriate ARIA labels and announcements\n\n**Design System Requirements:**\n- **AegisX UI Components**: Use library components for tables, cards, buttons, badges, filters\n- **Angular Material**: Use for forms, dialogs, date pickers, tooltips, menus\n- **TailwindCSS**: Use utility classes for spacing, colors, typography, responsive layouts\n- **Color Palette**: Follow AegisX color tokens (primary, success, warning, danger, info)\n- **Typography**: Use TailwindCSS typography plugin with consistent heading/body styles\n- **Spacing**: Use consistent spacing scale (4px base unit)\n- **Responsive**: Mobile-first design with breakpoints (sm, md, lg, xl)\n- **Dark Mode**: Support theme switching with CSS variables\n- **Accessibility**: WCAG 2.1 Level AA compliance\n\n---\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Layer Separation**: Backend modules in `apps/api/src/layers/core/audit/` (error-logs, activity-logs) and `apps/api/src/layers/platform/` (user-profile, api-keys)\n- **Base Class Reuse**: Extend `BaseAuditController`, `BaseAuditService`, `BaseAuditRepository` for audit logs\n- **Single Responsibility**: Each controller, service, repository, component has one clear purpose\n- **TypeBox Schemas**: All API routes use TypeBox for request/response validation\n- **Angular Signals**: Frontend uses Angular Signals for state management (no NgRx)\n- **Component Isolation**: Each feature has self-contained modules with lazy loading\n- **Shared Components**: Reusable UI components in `apps/web/src/app/shared/components/`\n\n### Performance\n\n- **Response Time**: All API endpoints SHALL respond within 200ms for simple queries, 1s for complex queries\n- **Pagination**: All list endpoints SHALL support pagination with configurable page sizes (10, 25, 50, 100)\n- **Caching**: Error/activity logs statistics SHALL be cached in Redis for 5 minutes\n- **Lazy Loading**: Frontend modules SHALL be lazy-loaded to reduce initial bundle size\n- **Virtual Scrolling**: Tables with >100 rows SHALL use virtual scrolling\n- **Image Optimization**: Avatar uploads SHALL be resized and optimized (max 200KB, WebP format)\n- **Bundle Size**: Each feature module SHALL be <100KB gzipped\n\n### Security\n\n- **Authentication**: All endpoints SHALL require JWT authentication\n- **Authorization**: RBAC permissions SHALL control access to monitoring/audit features\n  - `monitoring:read` - View error logs, activity logs\n  - `monitoring:write` - Delete error logs, cleanup\n  - `audit:read` - View activity logs\n  - `audit:admin` - Bulk cleanup, export\n  - `profile:write` - Update own profile\n  - `api-keys:manage` - Manage own API keys\n  - `api-keys:admin` - View all API keys (admin)\n- **Input Validation**: All user inputs SHALL be validated on both client and server\n- **XSS Prevention**: All user-generated content SHALL be sanitized\n- **CSRF Protection**: All state-changing endpoints SHALL use CSRF tokens\n- **API Key Security**: Keys SHALL be hashed (bcrypt) before storage, displayed only once at creation\n- **Rate Limiting**: API key endpoints SHALL be rate-limited to prevent abuse\n- **Audit Trail**: All API key operations SHALL be logged in activity logs\n\n### Reliability\n\n- **Error Handling**: All endpoints SHALL return standardized error responses\n- **Transaction Safety**: Database operations SHALL use transactions where appropriate\n- **Idempotency**: DELETE operations SHALL be idempotent (safe to retry)\n- **Data Validation**: Database constraints SHALL prevent invalid data insertion\n- **Graceful Degradation**: Frontend SHALL handle API failures gracefully with error messages\n- **Retry Logic**: Failed API requests SHALL retry with exponential backoff (3 attempts max)\n\n### Usability\n\n- **Responsive Design**: All pages SHALL work on mobile (320px), tablet (768px), and desktop (1024px+)\n- **Loading States**: All asynchronous operations SHALL show loading indicators\n- **Empty States**: All lists SHALL show helpful messages when empty with suggested actions\n- **Error Messages**: All errors SHALL provide clear, actionable messages\n- **Success Feedback**: All successful operations SHALL show confirmation messages (toast/snackbar)\n- **Keyboard Navigation**: All interactive elements SHALL be accessible via keyboard\n- **Screen Reader Support**: All components SHALL have proper ARIA labels and roles\n- **Help Text**: All forms SHALL provide inline help text and tooltips\n- **Consistent Patterns**: All CRUD operations SHALL follow the same interaction patterns\n\n### Testability\n\n- **Unit Tests**: All services and utilities SHALL have >80% code coverage\n- **Integration Tests**: All API endpoints SHALL have integration tests\n- **E2E Tests**: Critical user flows SHALL have Playwright E2E tests\n- **Test Data**: Use factories and fixtures for consistent test data\n- **Mock Services**: Frontend tests SHALL use mocked HTTP services\n\n### Documentation\n\n- **API Documentation**: All endpoints SHALL be documented in Swagger/OpenAPI\n- **Code Comments**: Complex logic SHALL have explanatory comments\n- **Component Documentation**: Reusable components SHALL have JSDoc comments\n- **README**: Each module SHALL have a README explaining purpose and usage\n- **Migration Guide**: Document migration from old modules to new modules\n\n---\n\n## Success Metrics\n\n1. **Completion**: All 4 modules fully implemented and deployed to production\n2. **Test Coverage**: >80% unit test coverage, 100% critical path E2E coverage\n3. **Performance**: All pages load in <2s, API responses <500ms (p95)\n4. **Accessibility**: WCAG 2.1 Level AA compliance verified with axe-core\n5. **User Adoption**: Monitoring pages accessed by >50% of active users within first week\n6. **Zero Regressions**: No breaking changes to existing features\n7. **Design Consistency**: 100% of UI components use AegisX/Material/Tailwind standards\n\n---\n\n## Out of Scope\n\nThe following are explicitly OUT of scope for this specification:\n\n1. **Advanced Analytics**: Complex dashboards, custom reports, data visualization beyond basic charts\n2. **Real-Time Monitoring**: Live tailing of logs, streaming updates (except basic WebSocket for counts)\n3. **Log Aggregation**: Integration with external log aggregation services (Elasticsearch, Splunk)\n4. **Alerting**: Email/SMS/Slack notifications for errors or activities\n5. **Machine Learning**: Anomaly detection, predictive analytics\n6. **Multi-Tenancy**: Organization-level isolation (single-tenant only)\n7. **Internationalization**: UI translations (English only for now)\n8. **Advanced Permissions**: Fine-grained permissions at resource level (use coarse-grained RBAC)\n9. **Audit Log Immutability**: Blockchain or cryptographic signing of audit logs\n10. **Custom Retention Policies**: Per-log-type retention configuration (use global retention)\n\nThese features may be addressed in future iterations but are not part of the initial release.\n\n---\n\n## Constraints\n\n1. **Technology Stack**: Must use existing stack (Fastify, Angular 17+, PostgreSQL, Redis)\n2. **Database Schema**: Cannot modify existing table structures (use as-is from migrations)\n3. **Authentication**: Must integrate with existing JWT-based auth system\n4. **RBAC**: Must use existing RBAC permission system\n5. **API Standards**: Must follow layer-based routing (Core: `/api/{resource}`, Platform: `/api/v1/platform/{resource}`)\n6. **Code Standards**: Must follow existing TypeScript, ESLint, Prettier configurations\n7. **Design System**: Must use AegisX UI v1.x (current stable version)\n8. **Browser Support**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+\n9. **Timeline**: Complete implementation within 2 weeks (80 development hours)\n10. **Budget**: Zero additional infrastructure costs (use existing servers)\n\n---\n\n## Dependencies\n\n1. **Database Tables**: `error_logs`, `activity_logs` tables must exist (already present from migrations)\n2. **Base Classes**: `BaseAuditController`, `BaseAuditService`, `BaseAuditRepository` in `apps/api/src/layers/core/audit/base/`\n3. **Auth System**: JWT authentication and RBAC authorization must be functional\n4. **AegisX UI Library**: `@aegisx/ui` package installed and configured\n5. **Angular Material**: `@angular/material` package installed and configured\n6. **TailwindCSS**: Tailwind configured with design tokens\n7. **Monitoring Module**: `apps/api/src/layers/core/monitoring/` for error logging infrastructure\n8. **File Upload Plugin**: `apps/api/src/layers/platform/file-upload/` for avatar uploads\n\n---\n\n## Assumptions\n\n1. **User Access**: All target users have appropriate RBAC permissions configured\n2. **Network**: Users have stable internet connection for real-time updates\n3. **Browser**: Users use modern browsers with JavaScript enabled\n4. **Training**: Users have basic familiarity with web applications\n5. **Data Volume**: Error logs <10K entries/day, Activity logs <50K entries/day\n6. **Concurrent Users**: <100 concurrent users accessing monitoring features\n7. **Retention**: Default retention period is 90 days for all logs\n8. **Backup**: Database backups are handled by existing infrastructure\n9. **Monitoring**: Application performance monitoring (APM) is already in place\n10. **Support**: Development team available for bug fixes and support post-launch\n\n---\n\n## Risks and Mitigation\n\n| Risk | Impact | Probability | Mitigation |\n|------|--------|-------------|------------|\n| Database migration issues | High | Low | Use existing tables, no schema changes |\n| Frontend-backend mismatch | High | Medium | Use TypeBox schemas, integration tests |\n| Performance degradation | Medium | Low | Implement caching, pagination, virtual scrolling |\n| Accessibility issues | Medium | Medium | Use axe-core testing, manual accessibility review |\n| Design inconsistency | Low | Medium | Follow strict component usage guidelines |\n| Security vulnerabilities | High | Low | Security audit, penetration testing |\n| Timeline overrun | Medium | Medium | Prioritize core features, defer enhancements |\n| User adoption failure | Medium | Low | User testing, gather feedback, iterate |\n\n---\n\n## References\n\n1. **API Architecture Standardization Spec**: `.spec-workflow/specs/api-architecture-standardization/`\n2. **Layer-Based Routing Docs**: `docs/architecture/layer-based-routing.md`\n3. **AegisX UI Documentation**: `libs/aegisx-ui/README.md`\n4. **Base Audit Controller**: `apps/api/src/layers/core/audit/base/base.controller.ts`\n5. **Frontend Architecture**: `docs/architecture/frontend-architecture.md`\n6. **CRUD Generator Docs**: `libs/aegisx-cli/docs/QUICK_REFERENCE.md`\n7. **Migration Commit**: Git commit `76296b3e` (2025-12-15)\n8. **Deleted Error Logs Module**: Git history `apps/api/src/core/error-logs/` (deleted)\n9. **Deleted User Profile Module**: Git history `apps/api/src/core/user-profile/` (deleted)\n10. **Deleted API Keys Module**: Git history `apps/api/src/core/api-keys/` (deleted)\n",
  "fileStats": {
    "size": 22750,
    "lines": 398,
    "lastModified": "2025-12-16T06:58:18.844Z"
  },
  "comments": []
}
