# Implementation Log: Task 5.2

**Summary:** Updated backend plugin template with layer-based conditional fp() wrapper logic following Phase 3 migration patterns. Template now generates three distinct plugin patterns (Core infrastructure with fp() + decoration, Platform/Domain leaf modules with plain async functions, Aggregator plugins with fp() for child registration) based on layer classifier variables. Added comprehensive documentation for template variables and integration guide.

**Timestamp:** 2025-12-14T14:35:33.354Z
**Log ID:** 814c2f0b-ff2b-45d6-aeb5-356e62362064

---

## Statistics

- **Lines Added:** +632
- **Lines Removed:** -142
- **Files Changed:** 3
- **Net Change:** 490

## Files Modified

- libs/aegisx-cli/templates/backend/domain/index.hbs
- .spec-workflow/specs/api-architecture-standardization/tasks.md

## Files Created

- libs/aegisx-cli/templates/backend/domain/TEMPLATE_VARIABLES.md

---

## Artifacts

### Functions

#### Conditional fp() Import Block

- **Purpose:** Conditionally imports fastify-plugin based on useFpWrapper variable
- **Location:** libs/aegisx-cli/templates/backend/domain/index.hbs:1-2
- **Signature:** {{#if useFpWrapper}}import fp from 'fastify-plugin';{{/if}}
- **Exported:** No

#### Conditional Export Wrapper Logic

- **Purpose:** Generates either fp()-wrapped or plain async function export based on layer and module type
- **Location:** libs/aegisx-cli/templates/backend/domain/index.hbs:44-50
- **Signature:** {{#if useFpWrapper}}export default fp(async function...{{else}}export default async function...{{/if}}
- **Exported:** No

#### Schema Registration with Wildcard Import

- **Purpose:** Registers module schemas using centralized schema registry with wildcard import pattern
- **Location:** libs/aegisx-cli/templates/backend/domain/index.hbs:14, 51-57
- **Signature:** import \* as {{moduleName}}Schemas; schemaRegistry.registerModuleSchemas('{{moduleName}}', {{moduleName}}Schemas)
- **Exported:** No

#### Conditional Infrastructure Decoration

- **Purpose:** Decorates Fastify instance with service only for infrastructure module type
- **Location:** libs/aegisx-cli/templates/backend/domain/index.hbs:85-88
- **Signature:** {{#if (eq moduleType 'infrastructure')}}fastify.decorate('{{moduleName}}Service', {{moduleName}}Service);{{/if}}
- **Exported:** No

#### Layer-Specific Plugin Naming

- **Purpose:** Generates plugin name following convention: platform-{module}, {domain}-{module}, or {module} based on layer
- **Location:** libs/aegisx-cli/templates/backend/domain/index.hbs:120
- **Signature:** name: '{{#if (eq layer 'platform')}}platform-{{moduleName}}{{else if (eq layer 'domains')}}{{domain}}-{{moduleName}}{{else}}{{moduleName}}{{/if}}-plugin'
- **Exported:** No

#### Dynamic Dependency Declaration

- **Purpose:** Declares plugin dependencies based on features (events, layer type)
- **Location:** libs/aegisx-cli/templates/backend/domain/index.hbs:121
- **Signature:** dependencies: ['knex-plugin'{{#if withEvents}}, 'websocket-plugin'{{/if}}{{#if (eq layer 'core')}}, 'response-handler-plugin', 'schemas-plugin'{{/if}}]
- **Exported:** No

#### Conditional TypeScript Declaration

- **Purpose:** Generates TypeScript module augmentation for decorated services (infrastructure only)
- **Location:** libs/aegisx-cli/templates/backend/domain/index.hbs:127-134
- **Signature:** {{#if (eq moduleType 'infrastructure')}}declare module 'fastify' { interface FastifyInstance { {{moduleName}}Service: {{ModuleName}}Service; }}{{/if}}
- **Exported:** No

### Integrations

#### Integration

- **Description:** Template consumes layer classifier variables to determine plugin pattern generation
- **Frontend Component:** Backend Plugin Template (index.hbs)
- **Backend Endpoint:** Layer Classifier Utility (layer-classifier.js)
- **Data Flow:** Generator calls determineLayer() → Returns classification object (layer, moduleType, useFpWrapper, urlPrefix, domain) → Template uses variables in conditionals → Generates appropriate plugin pattern (fp() wrapper for core/aggregators, plain async for platform/domain leaves)

#### Integration

- **Description:** Template uses schema registry for centralized schema registration
- **Frontend Component:** Generated Plugin Module
- **Backend Endpoint:** Schema Registry Plugin (fastify.schemaRegistry)
- **Data Flow:** Plugin initialization → Import schemas as wildcard → Call schemaRegistry.registerModuleSchemas() → Schemas available for validation/documentation

#### Integration

- **Description:** Infrastructure plugins decorate Fastify instance for cross-plugin service access
- **Frontend Component:** Generated Infrastructure Plugin
- **Backend Endpoint:** Fastify Instance Decoration
- **Data Flow:** Infrastructure plugin loads → Instantiate service → fastify.decorate('{{module}}Service', service) → Service available to all child plugins via fastify.{{module}}Service
