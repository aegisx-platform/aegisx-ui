#!/usr/bin/env sh

echo "ğŸš€ Running pre-push checks..."

# Allow bypass with SKIP_HOOKS=1
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "â­ï¸  Skipping pre-push hooks (SKIP_HOOKS=1)"
    exit 0
fi

# Quick mode for WIP commits
if [ "$QUICK_PUSH" = "1" ]; then
    echo "âš¡ Quick mode - only running lint"
    npx nx affected --base=origin/develop --target=lint --parallel=3
    exit $?
fi

# Use correct base branch
BASE_BRANCH="origin/develop"

# Check if there are any affected projects
AFFECTED=$(npx nx print-affected --base=$BASE_BRANCH --select=projects 2>/dev/null || echo "")

if [ -z "$AFFECTED" ]; then
    echo "âœ¨ No affected projects. Skipping checks."
    exit 0
fi

echo "ğŸ¯ Affected projects: $AFFECTED"

# Option 1: Minimal checks (recommended)
echo "ğŸ” Running quick lint check..."
if ! npx nx affected --base=$BASE_BRANCH --target=lint --parallel=3 --quiet; then
    echo "âŒ Linting failed!"
    echo "ğŸ’¡ Fix with: nx affected --target=lint --fix"
    echo "ğŸš¨ Or bypass: SKIP_HOOKS=1 git push"
    exit 1
fi

# Option 2: Type check only critical paths
echo "ğŸ“ Type checking (API only)..."
if ! npx nx run api:typecheck 2>/dev/null; then
    echo "âš ï¸  Type errors in API"
    echo "ğŸ’¡ Fix with: nx run api:typecheck"
fi

# Option 3: Skip tests on push, run in CI instead
echo "ğŸ’¡ Skipping tests (will run in CI/CD)"
echo "   To run locally: nx affected --target=test"

echo "âœ… Pre-push checks passed!"
echo "ğŸ“Œ Note: Full test suite will run in GitHub Actions"