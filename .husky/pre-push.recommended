#!/usr/bin/env sh

echo "ğŸš€ Running pre-push checks..."

# Environment variables for control
# SKIP_HOOKS=1 - Skip all hooks
# QUICK_PUSH=1 - Lint only
# NO_TESTS=1   - Skip tests

if [ "$SKIP_HOOKS" = "1" ]; then
    echo "â­ï¸  Skipping all hooks (SKIP_HOOKS=1)"
    exit 0
fi

BASE_BRANCH="origin/develop"
AFFECTED=$(npx nx print-affected --base=$BASE_BRANCH --select=projects 2>/dev/null || echo "")

if [ -z "$AFFECTED" ]; then
    echo "âœ¨ No affected projects."
    exit 0
fi

# Always run lint (fast)
echo "ğŸ” Linting..."
npx nx affected --base=$BASE_BRANCH --target=lint --parallel=3 --quiet || {
    echo "âŒ Lint failed! Fix with: nx affected --target=lint --fix"
    exit 1
}

# Type check only if not in quick mode
if [ "$QUICK_PUSH" != "1" ]; then
    echo "ğŸ“ Type checking..."
    npx nx affected --base=$BASE_BRANCH --target=typecheck --parallel=3 --quiet || {
        echo "âš ï¸  Type errors found"
    }
fi

# Skip tests by default (run in CI)
if [ "$RUN_TESTS" = "1" ]; then
    echo "ğŸ§ª Running tests..."
    npx nx affected --base=$BASE_BRANCH --target=test --parallel=3
else
    echo "ğŸ’¡ Skipping tests (will run in CI)"
fi

echo "âœ… Ready to push!"