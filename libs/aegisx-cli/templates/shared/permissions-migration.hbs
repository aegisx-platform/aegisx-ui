/**
 * Migration: Add {{ModuleName}} Permissions
 *
 * Creates {{moduleName}} role and permissions with role hierarchy support.
 * The {{moduleName}} role inherits from admin role automatically.
 *
 * Features:
 * - Idempotent: Safe to run multiple times
 * - Atomic: All operations in transaction
 * - Hierarchical: Supports role inheritance via parent_id
 * - Module role: Creates {{moduleName}} role and links all permissions to it
 * - Admin access: Admin role has wildcard permission (*:*) for automatic full access
 *
 * Architecture:
 * - Level 1: admin (parent_id: NULL) → Has *:* wildcard permission
 * - Level 2: {{moduleName}} (parent_id: admin.id) ← Creates this
 * - Level 3: Custom roles can be created under {{moduleName}} later
 *
 * Generated by: CRUD Generator v2.1.0
 * Resource: {{resourceName}}{{#if domain}}
 * Domain: {{domain}}{{/if}}
 * Generated: {{timestamp}}
 */

import { Knex } from 'knex';
import {
  createPermissions,
  createRoleIfNotExists,
  removePermissions,
} from '{{permissionHelperPath}}';

/**
 * {{ModuleName}} permissions definition
 */
const {{UPPER_MODULE_NAME}}_PERMISSIONS = [
  {{#each permissions}}
  {
    resource: '{{resource}}',
    action: '{{action}}',
    description: '{{description}}',
  },
  {{/each}}
];

/**
 * Apply migration
 */
export async function up(knex: Knex): Promise<void> {
  console.log('[Migration] Creating {{moduleName}} role and permissions...');

  // Step 1: Create {{moduleName}} role with admin as parent
  // This ensures {{moduleName}} role is part of the hierarchy
  await createRoleIfNotExists(
    knex,
    '{{moduleName}}',
    '{{ModuleName}} module role',
    'admin'
  );

  // Step 2: Create permissions and assign to {{moduleName}} role
  // Admin role has wildcard permission (*:*) and doesn't need explicit assignment
  await createPermissions(knex, {{UPPER_MODULE_NAME}}_PERMISSIONS, {
    roleAssignments: [
      {
        roleId: '{{moduleName}}',
        permissions: {{UPPER_MODULE_NAME}}_PERMISSIONS,
      },
      // Admin role access via wildcard (*:*) - no explicit assignment needed
    ],
  });

  console.log('[Migration] {{ModuleName}} role and permissions created successfully');
}

/**
 * Rollback migration
 */
export async function down(knex: Knex): Promise<void> {
  console.log('[Migration] Removing {{moduleName}} permissions...');

  await removePermissions(knex, {{UPPER_MODULE_NAME}}_PERMISSIONS);

  console.log('[Migration] {{ModuleName}} permissions removed successfully');
}