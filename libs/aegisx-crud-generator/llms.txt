# AegisX CRUD Generator

> Professional code generation CLI for AegisX platform - generates complete CRUD modules for Fastify backend and Angular frontend.

## Overview

`@aegisx/crud-generator` is a CLI tool that generates full-stack CRUD modules by:
- Reading database table schema (PostgreSQL)
- Generating Fastify backend (routes, controllers, services, repositories, schemas)
- Generating Angular frontend (components, services, forms, dialogs)
- Auto-registering routes and modules
- Supporting multiple feature packages (standard, enterprise, full)

## Quick Start

```bash
# Using pnpm scripts (recommended)
pnpm run crud -- products --force        # Basic CRUD
pnpm run crud:import -- budgets --force  # With Excel/CSV import
pnpm run crud:events -- notifications --force  # With WebSocket
pnpm run crud:full -- orders --force     # All features

# List available tables
pnpm run crud:list

# Validate generated module
pnpm run crud:validate -- products
```

---

## CLI Commands

### generate (g)
Generate CRUD module from database table.

```bash
./bin/cli.js generate <table-name> [options]
```

**Options:**
| Flag | Default | Description |
|------|---------|-------------|
| `-t, --target` | `backend` | Generation target (`backend` or `frontend`) |
| `-f, --force` | `false` | Overwrite existing files |
| `-d, --dry-run` | `false` | Preview files without creating |
| `--package` | `standard` | Feature package: `standard`, `enterprise`, `full` |
| `-e, --with-events` | `false` | Include WebSocket events |
| `--with-import` | `false` | Include bulk import (Excel/CSV) |
| `-a, --app` | `api` | Target app: `api`, `web`, `admin` |
| `--flat` | `false` | Use flat structure (not domain) |
| `--no-register` | `false` | Skip auto-registration |
| `--include-audit-fields` | `false` | Include audit fields in forms |
| `--direct-db` | `false` | Write roles directly to DB |
| `--no-roles` | `false` | Skip role generation |
| `--migration-only` | `false` | Only generate migration file |
| `--multiple-roles` | `false` | Generate admin/editor/viewer roles |
| `--smart-stats` | `false` | Enable smart statistics detection |

### domain (d)
Generate domain module with organized structure.

```bash
./bin/cli.js domain <domain-name> [options]
```

**Options:**
| Flag | Description |
|------|-------------|
| `-r, --routes` | Comma-separated list of routes |
| Other flags | Same as generate command |

### route (r)
Add route to existing domain.

```bash
./bin/cli.js route <domain/route> [options]
# Example: ./bin/cli.js route users/sessions
```

### list-tables (ls)
List available database tables.

```bash
./bin/cli.js list-tables
```

### validate
Validate generated module.

```bash
./bin/cli.js validate <module-name>
```

### packages (pkg)
Show available feature packages.

```bash
./bin/cli.js packages
```

### templates (t)
Template management commands.

```bash
./bin/cli.js templates list [backend|frontend|all]
./bin/cli.js templates set-default
./bin/cli.js templates add
./bin/cli.js templates remove
```

### config (cfg)
Configuration management.

```bash
./bin/cli.js config init [-f]
./bin/cli.js config show
```

---

## Feature Packages

### STANDARD (default)
- Basic CRUD operations
- REST API endpoints
- Role-based access control
- TypeBox schema validation
- Pagination and filtering

### ENTERPRISE
Everything in Standard, plus:
- Dropdown/Options API
- Bulk operations (create, update, delete)
- Status management (activate, deactivate)
- Statistics endpoints
- Enhanced error handling

### FULL
Everything in Enterprise, plus:
- Data validation before save
- Field uniqueness checking
- Advanced search
- Export capabilities
- Business rule validation

---

## Generated Files

### Backend (Fastify)

```
apps/api/src/modules/{module-name}/
├── {module-name}.plugin.ts      # Fastify plugin entry
├── {module-name}.routes.ts      # Route definitions
├── {module-name}.controller.ts  # Request handlers
├── {module-name}.service.ts     # Business logic
├── {module-name}.repository.ts  # Database queries
├── {module-name}.schemas.ts     # TypeBox schemas
├── {module-name}.types.ts       # TypeScript types
├── {module-name}.events.ts      # WebSocket events (optional)
└── {module-name}.import.ts      # Import service (optional)
```

### Frontend (Angular)

```
apps/admin/src/app/features/{module-name}/
├── {module-name}.routes.ts      # Angular routes
├── components/
│   ├── {module-name}-list/      # List component
│   ├── {module-name}-form/      # Form component (create/edit)
│   └── {module-name}-detail/    # Detail view
├── services/
│   └── {module-name}.service.ts # API service
├── dialogs/
│   └── {module-name}-dialog/    # CRUD dialog
└── types/
    └── {module-name}.types.ts   # TypeScript interfaces
```

---

## Templates

### Backend Templates
| Template | Description |
|----------|-------------|
| `domain` | Domain-driven structure (default) |
| `standard` | Flat module structure |

### Frontend Templates
| Template | Description |
|----------|-------------|
| `v2` | Modern Angular standalone (default) |
| `v1` | Legacy NgModule-based |

---

## Configuration File

Create `.crudgen.json` in project root:

```json
{
  "defaultTemplates": {
    "backend": "domain",
    "frontend": "v2"
  },
  "customTemplates": {
    "backend": {},
    "frontend": {}
  },
  "defaultFeatures": {
    "events": true,
    "bulkOperations": true,
    "export": false,
    "import": false
  }
}
```

---

## Programmatic Usage

```javascript
const {
  generateCrudModule,
  generateDomainModule,
  generateFrontendCrud,
  TemplateManager,
  database,
} = require('@aegisx/crud-generator');

// Generate backend module
await generateDomainModule('products', {
  withEvents: true,
  package: 'enterprise',
  withImport: true,
});

// Generate frontend module
await generateFrontendCrud('products', {
  enhanced: true,
  withImport: true,
});
```

---

## API Reference

### Core Classes

#### TemplateManager
Manages template discovery and rendering.

```javascript
const manager = new TemplateManager({
  templatesBasePath: './templates',
});
await manager.initialize();
const templates = await manager.listTemplates('backend');
```

#### TemplateRegistry
Registry of available templates.

#### TemplateRenderer
Handlebars template rendering engine.

### Generator Functions

| Function | Description |
|----------|-------------|
| `generateCrudModule()` | Generate flat CRUD module |
| `generateDomainModule()` | Generate domain-structured module |
| `addRouteToDomain()` | Add route to existing domain |
| `generateFrontendCrud()` | Generate Angular frontend |
| `generateRoles()` | Generate role migration |

### Utilities

| Module | Description |
|--------|-------------|
| `database` | Database introspection utilities |
| `validator` | Module validation |
| `DependencyValidator` | Check required dependencies |
| `knexConnection` | Knex database connection |

---

## Table Name Conventions

Database tables use `snake_case`, automatically converted:

| Database | Folder | TypeScript |
|----------|--------|------------|
| `test_products` | `test-products/` | `TestProducts` |
| `user_profiles` | `user-profiles/` | `UserProfiles` |
| `blog_posts` | `blog-posts/` | `BlogPosts` |

---

## Common Workflows

### Basic Feature (Backend + Frontend)

```bash
# 1. Generate backend
pnpm run crud -- products --force

# 2. Generate frontend
./bin/cli.js generate products --target frontend --force
```

### Feature with Import

```bash
# 1. Backend with import service
pnpm run crud:import -- budgets --force

# 2. Frontend with import dialog
./bin/cli.js generate budgets --target frontend --with-import --force
```

### Real-Time Feature

```bash
# 1. Backend with event emission
pnpm run crud:events -- notifications --force

# 2. Frontend with event handling
./bin/cli.js generate notifications --target frontend --with-events --force
```

### Domain with Multiple Routes

```bash
./bin/cli.js domain users --routes "core,profiles,preferences"
```

---

## Dependencies

```json
{
  "commander": "^12.0.0",    // CLI framework
  "handlebars": "^4.7.8",    // Template engine
  "chalk": "^4.1.2",         // Terminal colors
  "ora": "^5.4.1",           // Spinners
  "inquirer": "^8.2.6",      // Interactive prompts
  "knex": "^2.0.0",          // SQL query builder
  "pg": "^8.0.0",            // PostgreSQL client
  "exceljs": "^4.4.0",       // Excel file support
  "fast-csv": "^5.0.1"       // CSV parsing
}
```

---

## Environment Variables

Uses `.env` or `.env.local` for database connection:

```bash
DATABASE_URL=postgresql://user:pass@localhost:5432/dbname
# Or individual variables:
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=password
DB_NAME=aegisx
```

---

## File Structure

```
libs/aegisx-crud-generator/
├── bin/
│   └── cli.js               # CLI entry point
├── lib/
│   ├── index.js             # Public API exports
│   ├── config/
│   │   └── knex-connection.js
│   ├── core/
│   │   ├── template-manager.js
│   │   ├── template-registry.js
│   │   └── template-renderer.js
│   ├── generators/
│   │   ├── backend-generator.js
│   │   ├── frontend-generator.js
│   │   └── role-generator.js
│   ├── prompts/
│   │   ├── generate-prompts.js
│   │   └── template-prompts.js
│   └── utils/
│       ├── database.js
│       ├── validator.js
│       ├── dependency-validator.js
│       └── import-field-analyzer.js
├── templates/
│   ├── backend/
│   │   ├── domain/          # Domain template
│   │   ├── standard/        # Flat template
│   │   ├── import-routes.hbs
│   │   └── import-service.hbs
│   ├── frontend/
│   │   ├── v1/              # Legacy template
│   │   └── v2/              # Modern template
│   └── shared/
└── package.json
```

---

## Common Errors

### "Table not found"
- Run `pnpm run crud:list` to see available tables
- Ensure migrations are up to date: `pnpm run db:migrate`

### "Database connection failed"
- Check `.env.local` for correct database credentials
- Ensure PostgreSQL is running

### "Files already exist"
- Use `--force` flag to overwrite
- Or use `--dry-run` to preview changes first

### "Invalid package type"
- Valid packages: `standard`, `enterprise`, `full`
