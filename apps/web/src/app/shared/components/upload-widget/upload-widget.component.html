<!-- Upload Widget Container -->
<div class="space-y-4">
  <!-- Drag & Drop Zone -->
  <div
    [ngClass]="{
      'border-2 border-dashed rounded-xl transition-all duration-200': true,
      'border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50':
        !dragDropState().isDragging,
      'border-blue-500 bg-blue-50 dark:bg-blue-900/20':
        dragDropState().isDragging && dragDropState().isValidDrop,
      'border-red-500 bg-red-50 dark:bg-red-900/20':
        dragDropState().isDragging && !dragDropState().isValidDrop,
    }"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
  >
    <!-- File Input (hidden) -->
    <input
      #fileInput
      type="file"
      [accept]="accept"
      [multiple]="mode === 'multiple'"
      (change)="onFileSelected($event)"
      class="hidden"
    />

    <!-- Empty State -->
    @if (!hasFiles()) {
      <div class="py-12 px-6 text-center">
        <!-- Upload Icon -->
        <div class="flex justify-center mb-4">
          <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-full">
            <mat-icon
              class="text-gray-400 dark:text-gray-500"
              style="font-size: 48px; width: 48px; height: 48px"
            >
              cloud_upload
            </mat-icon>
          </div>
        </div>

        <!-- Title & Description -->
        <h3
          class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-1"
        >
          @if (enableDragDrop) {
            Drag & drop files here
          } @else {
            Select files to upload
          }
        </h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-8">
          {{ mode === 'single' ? 'Single file' : `Up to ${maxFiles} files` }} Â·
          Max {{ formatFileSize(maxFileSize) }}
        </p>

        <!-- Action Buttons -->
        <div
          class="flex flex-col sm:flex-row items-center justify-center gap-3"
        >
          <!-- Primary Action: Browse Files -->
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="fileInput.click()"
          >
            <mat-icon>folder_open</mat-icon>
            Browse Files
          </button>

          <!-- Secondary Action: Take Photo -->
          @if (showCameraButton()) {
            <button mat-stroked-button type="button" (click)="openCamera()">
              <mat-icon>camera_alt</mat-icon>
              Take Photo
            </button>
          }
        </div>

        <!-- Helpful Hint (optional) -->
        @if (enableDragDrop) {
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-4">
            or click Browse Files to select from your device
          </p>
        }
      </div>
    }

    <!-- File List -->
    @if (hasFiles()) {
      <div class="p-4 space-y-3">
        @for (file of selectedFiles(); track file.name; let i = $index) {
          <div
            class="flex items-center gap-4 p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg"
          >
            <!-- File Preview/Icon -->
            <div class="flex-shrink-0">
              @if (enableImagePreview && file.type.startsWith('image/')) {
                <img
                  [src]="getFilePreview(file)"
                  alt="{{ file.name }}"
                  class="w-12 h-12 rounded object-cover"
                />
              } @else {
                <mat-icon
                  class="text-gray-400 dark:text-gray-500"
                  style="font-size: 48px; width: 48px; height: 48px"
                  >{{ getFileIcon(file) }}</mat-icon
                >
              }
            </div>

            <!-- File Info -->
            <div class="flex-1 min-w-0">
              <div
                class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
              >
                {{ file.name }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                {{ formatFileSize(file.size) }}
              </div>

              <!-- Progress Bar (during upload) -->
              @if (uploadProgress(); as progress) {
                @if (progress.files[i]; as fileProgress) {
                  <div class="mt-2">
                    @if (fileProgress.status === 'uploading') {
                      <div class="space-y-1">
                        <mat-progress-bar
                          mode="determinate"
                          [value]="fileProgress.percentage"
                          class="h-2 rounded"
                        ></mat-progress-bar>
                        <span class="text-xs text-gray-600 dark:text-gray-400"
                          >{{ fileProgress.percentage }}%</span
                        >
                      </div>
                    }
                    @if (fileProgress.status === 'completed') {
                      <div
                        class="flex items-center gap-1 text-green-600 dark:text-green-400"
                      >
                        <mat-icon class="icon-size-4">check_circle</mat-icon>
                        <span class="text-xs">Uploaded</span>
                      </div>
                    }
                    @if (fileProgress.status === 'failed') {
                      <div
                        class="flex items-center gap-1 text-red-600 dark:text-red-400"
                      >
                        <mat-icon class="icon-size-4">error</mat-icon>
                        <span class="text-xs">{{ fileProgress.error }}</span>
                      </div>
                    }
                  </div>
                }
              }
            </div>

            <!-- Remove Button -->
            @if (!isUploading()) {
              <button
                type="button"
                (click)="removeFile(i)"
                class="flex-shrink-0 p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
                aria-label="Remove file"
              >
                <mat-icon class="icon-size-5">close</mat-icon>
              </button>
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- Actions -->
  @if (hasFiles()) {
    <div class="space-y-4">
      <!-- Overall Progress -->
      @if (uploadProgress(); as progress) {
        <div class="tremor-card p-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
              {{ progress.uploadedCount }} / {{ progress.totalFiles }} uploaded
            </span>
            @if (progress.failedCount > 0) {
              <span class="tremor-badge tremor-badge-red">
                {{ progress.failedCount }} failed
              </span>
            }
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="progressPercentage()"
            [color]="progress.failedCount > 0 ? 'warn' : 'primary'"
            class="h-2 rounded"
          ></mat-progress-bar>
        </div>
      }

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row justify-end gap-3">
        <!-- Clear Button -->
        <button
          mat-stroked-button
          type="button"
          (click)="clearFiles()"
          [disabled]="isUploading()"
        >
          <mat-icon>clear</mat-icon>
          Clear
        </button>

        <!-- Add More Button -->
        @if (!enableDragDrop || mode === 'multiple') {
          <button
            mat-stroked-button
            type="button"
            (click)="fileInput.click()"
            [disabled]="isUploading() || selectedFiles().length >= maxFiles"
          >
            <mat-icon>add</mat-icon>
            Add More
          </button>
        }

        <!-- Upload Button (Primary) -->
        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="startUpload()"
          [disabled]="!canUpload()"
        >
          <mat-icon>cloud_upload</mat-icon>
          {{ isUploading() ? 'Uploading...' : 'Upload' }}
        </button>
      </div>
    </div>
  }
</div>
