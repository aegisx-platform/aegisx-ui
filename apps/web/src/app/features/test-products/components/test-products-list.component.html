<div class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <ax-breadcrumb [items]="breadcrumbItems" [showIcons]="true"></ax-breadcrumb>

    <!-- Header with Stats (hide stats when permission error) -->
    <app-test-products-list-header
      [stats]="stats()"
      [loading]="testProductsService.loading()"
      [permissionError]="testProductsService.permissionError()"
      [hasError]="!!testProductsService.error()"
      (createClicked)="openCreateDialog()"
      (clearPermissionError)="testProductsService.clearPermissionError()"
    ></app-test-products-list-header>

    <!-- Filters Panel (hide when any error exists) -->
    @if (!testProductsService.error()) {
      <app-test-products-list-filters
        [activeFilterCount]="getActiveFilterCount()"
        [loading]="testProductsService.loading()"
        [(searchTerm)]="searchTerm"
        [(quickFilter)]="quickFilter"
        [(skuFilter)]="skuFilter"
        [(nameFilter)]="nameFilter"
        [(barcodeFilter)]="barcodeFilter"
        [(manufacturerFilter)]="manufacturerFilter"
        [(descriptionFilter)]="descriptionFilter"
        [(long_descriptionFilter)]="long_descriptionFilter"
        [(specificationsFilter)]="specificationsFilter"
        [(statusFilter)]="statusFilter"
        [(conditionFilter)]="conditionFilter"
        [(availabilityFilter)]="availabilityFilter"
        [(created_byFilter)]="created_byFilter"
        [(updated_byFilter)]="updated_byFilter"
        [(is_activeFilter)]="is_activeFilter"
        [(is_featuredFilter)]="is_featuredFilter"
        [(is_taxableFilter)]="is_taxableFilter"
        [(is_shippableFilter)]="is_shippableFilter"
        [(allow_backorderFilter)]="allow_backorderFilter"
        (searchClicked)="search()"
        (refreshClicked)="refresh()"
        (clearSearchClicked)="clearSearch()"
        (applyFiltersClicked)="applyFilterImmediate()"
        (clearAllClicked)="clearAllFilters()"
        (quickFilterChange)="setQuickFilter($event)"
        (dateFilterChange)="onDateFilterChange($event)"
      >
        <!-- Export Button Slot -->
        <app-export
          export
          [exportService]="exportServiceAdapter"
          [currentFilters]="getExportFilters()"
          [selectedItems]="selectedItems()"
          [availableFields]="availableExportFields"
          [moduleName]="'test_products'"
          (exportStarted)="onExportStarted($event)"
          (exportCompleted)="onExportCompleted($event)"
        ></app-export>

        <!-- Filter Chips Slot -->
        <div filter-chips>
          @if (searchTermSignal()) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-100 text-blue-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">search</mat-icon>
              Search: {{ searchTermSignal() }}
              <button
                (click)="searchTermSignal.set('')"
                class="hover:text-blue-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_activeFilterSignal() === true) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">check_circle</mat-icon>
              Is Active: Yes
              <button
                (click)="
                  is_activeInputSignal.set(undefined);
                  is_activeFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-green-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_activeFilterSignal() === false) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">block</mat-icon>
              Is Active: No
              <button
                (click)="
                  is_activeInputSignal.set(undefined);
                  is_activeFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-red-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_featuredFilterSignal() === true) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">check_circle</mat-icon>
              Is Featured: Yes
              <button
                (click)="
                  is_featuredInputSignal.set(undefined);
                  is_featuredFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-green-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_featuredFilterSignal() === false) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">block</mat-icon>
              Is Featured: No
              <button
                (click)="
                  is_featuredInputSignal.set(undefined);
                  is_featuredFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-red-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_taxableFilterSignal() === true) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">check_circle</mat-icon>
              Is Taxable: Yes
              <button
                (click)="
                  is_taxableInputSignal.set(undefined);
                  is_taxableFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-green-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_taxableFilterSignal() === false) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">block</mat-icon>
              Is Taxable: No
              <button
                (click)="
                  is_taxableInputSignal.set(undefined);
                  is_taxableFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-red-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_shippableFilterSignal() === true) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">check_circle</mat-icon>
              Is Shippable: Yes
              <button
                (click)="
                  is_shippableInputSignal.set(undefined);
                  is_shippableFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-green-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (is_shippableFilterSignal() === false) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">block</mat-icon>
              Is Shippable: No
              <button
                (click)="
                  is_shippableInputSignal.set(undefined);
                  is_shippableFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-red-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (allow_backorderFilterSignal() === true) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">check_circle</mat-icon>
              Allow Backorder: Yes
              <button
                (click)="
                  allow_backorderInputSignal.set(undefined);
                  allow_backorderFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-green-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
          @if (allow_backorderFilterSignal() === false) {
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-md text-xs font-medium"
            >
              <mat-icon class="!text-sm !w-4 !h-4">block</mat-icon>
              Allow Backorder: No
              <button
                (click)="
                  allow_backorderInputSignal.set(undefined);
                  allow_backorderFilterSignal.set(undefined);
                  quickFilter = 'all'
                "
                class="hover:text-red-900"
              >
                <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
              </button>
            </span>
          }
        </div>
      </app-test-products-list-filters>
    }

    <!-- Content Area: Show based on state priority -->
    <!-- Priority 1: Error (403 or other errors) -->
    @if (testProductsService.error() && !testProductsService.loading()) {
      <ax-error-state
        [statusCode]="testProductsService.lastErrorStatus()"
        [message]="testProductsService.error() || ''"
        [actions]="[
          {
            label: 'Try Again',
            icon: 'refresh',
            primary: true,
            callback: refresh.bind(this),
          },
        ]"
      >
      </ax-error-state>
    }

    <!-- Priority 2: Loading (initial load) - with delay to prevent flicker -->
    @else if (showLoadingIndicator() && dataSource.data.length === 0) {
      <div class="bg-white rounded-lg border border-gray-200 p-12 text-center">
        <mat-spinner class="!mx-auto" [diameter]="40"></mat-spinner>
        <p class="text-sm text-gray-600 mt-4">Loading test_products...</p>
      </div>
    }

    <!-- Priority 3: Empty State (no data, no error, not loading) -->
    @else if (!testProductsService.loading() && dataSource.data.length === 0) {
      <ax-empty-state
        icon="menu_book"
        title="No test_products found"
        [message]="
          hasActiveFilters()
            ? 'Try adjusting your search or filters'
            : 'Get started by adding your first testproduct'
        "
        [actions]="
          hasActiveFilters()
            ? [
                {
                  label: 'Clear filters',
                  primary: true,
                  callback: clearAllFilters.bind(this),
                },
              ]
            : [
                {
                  label: 'Add your first testproduct',
                  icon: 'add',
                  primary: true,
                  callback: openCreateDialog.bind(this),
                },
              ]
        "
      >
      </ax-empty-state>
    }

    <!-- Priority 4: Table with Data -->
    @else {
      <div
        class="bg-white rounded-lg border border-gray-200 overflow-hidden tremor-table relative"
      >
        <!-- Loading Overlay (for refresh while data exists) - with delay -->
        @if (showLoadingIndicator() && dataSource.data.length > 0) {
          <div
            class="absolute inset-0 bg-white/75 backdrop-blur-sm flex items-center justify-center z-10"
          >
            <div class="text-center">
              <mat-spinner class="!mx-auto" [diameter]="40"></mat-spinner>
              <p class="text-sm text-gray-600 mt-4">Refreshing...</p>
            </div>
          </div>
        }

        <!-- Bulk Actions -->
        @if (selection.selected.length > 0) {
          <div
            class="bg-blue-50 border-b border-blue-200 px-5 py-3 flex items-center justify-between"
          >
            <span class="text-sm font-medium text-blue-900"
              >{{ selection.selected.length }} selected</span
            >
            <button
              (click)="bulkDelete()"
              class="px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700"
            >
              Delete selected
            </button>
          </div>
        }

        <!-- Table Container -->
        <div class="overflow-x-auto">
          <table
            mat-table
            [dataSource]="dataSource"
            matSort
            multiTemplateDataRows
            class="w-full"
          >
            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef class="w-12">
                <mat-checkbox
                  (change)="$event ? toggleAllRows() : null"
                  [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()"
                  aria-label="Select all test_products"
                ></mat-checkbox>
              </th>
              <td
                mat-cell
                *matCellDef="let row"
                (click)="$event.stopPropagation()"
              >
                <mat-checkbox
                  (change)="$event ? selection.toggle(row) : null"
                  [checked]="selection.isSelected(row)"
                ></mat-checkbox>
              </td>
            </ng-container>

            <!-- Sku Column -->
            <ng-container matColumnDef="sku">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Sku</th>
              <td mat-cell *matCellDef="let testProduct" class="!py-3">
                <div class="flex items-center gap-2">
                  @if (testProduct.description) {
                    <button
                      type="button"
                      (click)="toggleExpandRow(testProduct); $event.stopPropagation()"
                      class="w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0"
                      [attr.aria-label]="
                        isRowExpanded(testProduct)
                          ? 'Collapse description'
                          : 'Expand description'
                      "
                    >
                      <mat-icon class="text-lg leading-none">{{
                        isRowExpanded(testProduct) ? 'expand_less' : 'expand_more'
                      }}</mat-icon>
                    </button>
                  } @else {
                    <div class="w-6 flex-shrink-0"></div>
                  }
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-semibold text-gray-900">
                      {{ testProduct.sku }}
                    </div>
                    @if (testProduct.description && !isRowExpanded(testProduct)) {
                      <div class="text-xs text-gray-500 mt-0.5 truncate">
                        {{ testProduct.description | slice: 0 : 80 }}...
                      </div>
                    }
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
              <td mat-cell *matCellDef="let testProduct">
                <span class="text-md text-gray-600">
                  {{ testProduct.name }}
                </span>
              </td>
            </ng-container>

            <!-- Barcode Column -->
            <ng-container matColumnDef="barcode">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Barcode</th>
              <td mat-cell *matCellDef="let testProduct">
                <span class="text-md text-gray-600">
                  {{ testProduct.barcode }}
                </span>
              </td>
            </ng-container>

            <!-- Manufacturer Column -->
            <ng-container matColumnDef="manufacturer">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Manufacturer</th>
              <td mat-cell *matCellDef="let testProduct">
                <span class="text-md text-gray-600">
                  {{ testProduct.manufacturer }}
                </span>
              </td>
            </ng-container>

            <!-- Description Column -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Description</th>
              <td mat-cell *matCellDef="let testProduct">
                <span class="text-md text-gray-600">
                  {{ testProduct.description | slice: 0 : 50 }}...
                </span>
              </td>
            </ng-container>

            <!-- Long Description Column -->
            <ng-container matColumnDef="long_description">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Long Description</th>
              <td mat-cell *matCellDef="let testProduct">
                <span class="text-md text-gray-600">
                  {{ testProduct.long_description }}
                </span>
              </td>
            </ng-container>


            <!-- Expanded Detail Column -->
            <ng-container matColumnDef="expandedDetail">
              <td
                mat-cell
                *matCellDef="let testProduct"
                [attr.colspan]="displayedColumns.length"
                class="!p-0 !border-b-0"
              >
                @if (isRowExpanded(testProduct)) {
                  <div class="pl-16 pr-5 py-3 bg-gray-50/50" [@detailExpand]>
                    <div class="max-w-4xl">
                      <div class="flex items-start gap-2">
                        <mat-icon class="text-gray-400 !text-base mt-0.5"
                          >description</mat-icon
                        >
                        <div class="flex-1">
                          <h4
                            class="text-xs font-semibold text-gray-700 mb-1.5"
                          >
                            Description
                          </h4>
                          <p class="text-sm text-gray-600 leading-relaxed">
                            {{ testProduct.description }}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-right w-20">
                Actions
              </th>
              <td
                mat-cell
                *matCellDef="let testProduct"
                class="text-right"
                (click)="$event.stopPropagation()"
              >
                <button
                  type="button"
                  mat-icon-button
                  [matMenuTriggerFor]="actionMenu"
                  matTooltip="Actions"
                  matTooltipPosition="above"
                  aria-label="More actions"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #actionMenu="matMenu" [hasBackdrop]="false">
                  <button
                    type="button"
                    mat-menu-item
                    (click)="onViewTestProduct(testProduct)"
                  >
                    <mat-icon>visibility</mat-icon><span>View</span>
                  </button>
                  <button
                    type="button"
                    mat-menu-item
                    (click)="onEditTestProduct(testProduct)"
                  >
                    <mat-icon>edit</mat-icon><span>Edit</span>
                  </button>

                  <button
                    type="button"
                    mat-menu-item
                    (click)="onDeleteTestProduct(testProduct)"
                  >
                    <mat-icon class="text-red-600">delete</mat-icon
                    ><span>Delete</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              class="hover:bg-gray-50 cursor-pointer"
              [attr.data-testproduct-id]="row.id"
              (click)="onViewTestProduct(row)"
            ></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: ['expandedDetail']"
              class="detail-row"
            ></tr>
          </table>
        </div>

        <!-- Paginator -->
        <mat-paginator
          [length]="testProductsService.totalTestProduct()"
          [pageSize]="25"
          [pageSizeOptions]="[10, 25, 50, 100]"
          [pageIndex]="0"
          showFirstLastButtons
          class="border-t border-gray-200"
        ></mat-paginator>
      </div>
    }
  </div>
</div>
