<div class="min-h-screen bg-[var(--ax-background-subtle)] p-6">
  <div class="max-w-7xl mx-auto space-y-4">
    <!-- Breadcrumb -->
    <ax-breadcrumb [items]="breadcrumbItems"></ax-breadcrumb>

    <!-- Header with Stats -->
    <app-budget-request-items-list-header
      [stats]="stats()"
      [loading]="budgetRequestItemsService.loading()"
      [hasError]="!!budgetRequestItemsService.error()"
      (createClicked)="openCreateDialog()"
    ></app-budget-request-items-list-header>

    <!-- Filters Panel (hide when any error exists) -->
    @if (!budgetRequestItemsService.error()) {
      <ax-card variant="outlined" size="md" [flat]="true">
        <app-budget-request-items-list-filters
          [activeFilterCount]="getActiveFilterCount()"
          [loading]="budgetRequestItemsService.loading()"
          [(searchTerm)]="searchTerm"
          [(quickFilter)]="quickFilter"
          [(item_justificationFilter)]="item_justificationFilter"
          [(generic_codeFilter)]="generic_codeFilter"
          [(generic_nameFilter)]="generic_nameFilter"
          [(package_sizeFilter)]="package_sizeFilter"
          [(unitFilter)]="unitFilter"
          (searchClicked)="search()"
          (refreshClicked)="refresh()"
          (clearSearchClicked)="clearSearch()"
          (applyFiltersClicked)="applyFilterImmediate()"
          (clearAllClicked)="clearAllFilters()"
          (quickFilterChange)="setQuickFilter($event)"
          (dateFilterChange)="onDateFilterChange($event)"
        >
          <!-- Export Button Slot -->

          <!-- Filter Chips Slot -->
          <div filter-chips>
            @if (searchTermSignal()) {
              <span
                class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-[var(--ax-info-faint)] text-[var(--ax-info-default)] rounded-md text-xs font-medium"
              >
                <mat-icon class="!text-sm !w-4 !h-4">search</mat-icon>
                Search: {{ searchTermSignal() }}
                <button
                  (click)="searchTermSignal.set('')"
                  class="hover:text-[var(--ax-info-hover)]"
                >
                  <mat-icon class="!text-sm !w-3 !h-3">close</mat-icon>
                </button>
              </span>
            }
          </div>
        </app-budget-request-items-list-filters>
      </ax-card>
    }

    <!-- Content Area: Show based on state priority -->
    <!-- Priority 1: Error (403 or other errors) -->
    @if (
      budgetRequestItemsService.error() && !budgetRequestItemsService.loading()
    ) {
      <ax-error-state
        [statusCode]="budgetRequestItemsService.lastErrorStatus()"
        [message]="budgetRequestItemsService.error() || ''"
        [actions]="[
          {
            label: 'Try Again',
            icon: 'refresh',
            primary: true,
            callback: refresh.bind(this),
          },
        ]"
      >
      </ax-error-state>
    }

    <!-- Priority 2: Loading (initial load) - with delay to prevent flicker -->
    @else if (showLoadingIndicator() && dataSource.data.length === 0) {
      <div
        class="bg-[var(--ax-background-default)] rounded-lg border border-[var(--ax-border-default)] p-12 text-center"
      >
        <mat-spinner class="!mx-auto" [diameter]="40"></mat-spinner>
        <p class="text-sm text-[var(--ax-text-secondary)] mt-4">
          Loading budget_request_items...
        </p>
      </div>
    }

    <!-- Priority 3: Empty State (no data, no error, not loading) -->
    @else if (
      !budgetRequestItemsService.loading() && dataSource.data.length === 0
    ) {
      <ax-empty-state
        icon="menu_book"
        title="No budget_request_items found"
        [message]="
          hasActiveFilters()
            ? 'Try adjusting your search or filters'
            : 'Get started by adding your first budgetrequestitem'
        "
        [actions]="
          hasActiveFilters()
            ? [
                {
                  label: 'Clear filters',
                  primary: true,
                  callback: clearAllFilters.bind(this),
                },
              ]
            : [
                {
                  label: 'Add your first budgetrequestitem',
                  icon: 'add',
                  primary: true,
                  callback: openCreateDialog.bind(this),
                },
              ]
        "
      >
      </ax-empty-state>
    }

    <!-- Priority 4: Table with Data -->
    @else {
      <mat-card
        appearance="outlined"
        class="overflow-hidden tremor-table relative shadow-sm !border-[var(--ax-border-emphasis)]"
      >
        <!-- Loading Overlay (for refresh while data exists) - with delay -->
        @if (showLoadingIndicator() && dataSource.data.length > 0) {
          <div
            class="absolute inset-0 bg-[var(--ax-background-default)]/75 backdrop-blur-sm flex items-center justify-center z-10"
          >
            <div class="text-center">
              <mat-spinner class="!mx-auto" [diameter]="40"></mat-spinner>
              <p class="text-sm text-[var(--ax-text-secondary)] mt-4">
                Refreshing...
              </p>
            </div>
          </div>
        }

        <!-- Bulk Actions -->
        @if (selection.selected.length > 0) {
          <div
            class="bg-[var(--ax-info-surface)] border-b border-[var(--ax-info-border)] px-4 py-2 flex items-center justify-between"
          >
            <span class="text-sm font-medium text-[var(--ax-info-default)]"
              >{{ selection.selected.length }} selected</span
            >
            <button mat-flat-button color="warn" (click)="bulkDelete()">
              <mat-icon>delete</mat-icon>
              Delete selected
            </button>
          </div>
        }

        <!-- Table Container -->
        <div class="overflow-x-auto">
          <table
            mat-table
            [dataSource]="dataSource"
            matSort
            multiTemplateDataRows
            class="w-full"
          >
            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef class="w-12">
                <mat-checkbox
                  (change)="$event ? toggleAllRows() : null"
                  [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()"
                  aria-label="Select all budget_request_items"
                ></mat-checkbox>
              </th>
              <td
                mat-cell
                *matCellDef="let row"
                (click)="$event.stopPropagation()"
              >
                <mat-checkbox
                  (change)="$event ? selection.toggle(row) : null"
                  [checked]="selection.isSelected(row)"
                ></mat-checkbox>
              </td>
            </ng-container>

            <!-- Budget Request Id Column -->
            <ng-container matColumnDef="budget_request_id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Budget Request Id
              </th>
              <td mat-cell *matCellDef="let budgetRequestItem" class="!py-3">
                <div class="flex items-center gap-2">
                  @if (budgetRequestItem.description) {
                    <button
                      type="button"
                      mat-icon-button
                      (click)="
                        toggleExpandRow(budgetRequestItem);
                        $event.stopPropagation()
                      "
                      class="!w-7 !h-7 !min-w-0 flex-shrink-0"
                      [attr.aria-label]="
                        isRowExpanded(budgetRequestItem)
                          ? 'Collapse description'
                          : 'Expand description'
                      "
                    >
                      <mat-icon class="!text-xl">{{
                        isRowExpanded(budgetRequestItem)
                          ? 'expand_less'
                          : 'expand_more'
                      }}</mat-icon>
                    </button>
                  } @else {
                    <div class="w-7 flex-shrink-0"></div>
                  }
                  <div class="flex-1 min-w-0">
                    <div
                      class="text-sm font-semibold text-[var(--ax-text-default)]"
                    >
                      {{ budgetRequestItem.budget_request_id }}
                    </div>
                    @if (
                      budgetRequestItem.description &&
                      !isRowExpanded(budgetRequestItem)
                    ) {
                      <div
                        class="text-xs text-[var(--ax-text-secondary)] mt-0.5 truncate"
                      >
                        {{ budgetRequestItem.description | slice: 0 : 80 }}...
                      </div>
                    }
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Budget Id Column -->
            <ng-container matColumnDef="budget_id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Budget Id
              </th>
              <td mat-cell *matCellDef="let budgetRequestItem">
                <span class="text-md text-[var(--ax-text-secondary)]">
                  {{ budgetRequestItem.budget_id }}
                </span>
              </td>
            </ng-container>

            <!-- Requested Amount Column -->
            <ng-container matColumnDef="requested_amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Requested Amount
              </th>
              <td mat-cell *matCellDef="let budgetRequestItem">
                <span class="text-md text-[var(--ax-text-secondary)]">
                  {{ budgetRequestItem.requested_amount }}
                </span>
              </td>
            </ng-container>

            <!-- Q1 Qty Column -->
            <ng-container matColumnDef="q1_qty">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Q1 Qty</th>
              <td mat-cell *matCellDef="let budgetRequestItem">
                <span class="text-md text-[var(--ax-text-secondary)]">
                  {{ budgetRequestItem.q1_qty }}
                </span>
              </td>
            </ng-container>

            <!-- Q2 Qty Column -->
            <ng-container matColumnDef="q2_qty">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Q2 Qty</th>
              <td mat-cell *matCellDef="let budgetRequestItem">
                <span class="text-md text-[var(--ax-text-secondary)]">
                  {{ budgetRequestItem.q2_qty }}
                </span>
              </td>
            </ng-container>

            <!-- Q3 Qty Column -->
            <ng-container matColumnDef="q3_qty">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Q3 Qty</th>
              <td mat-cell *matCellDef="let budgetRequestItem">
                <span class="text-md text-[var(--ax-text-secondary)]">
                  {{ budgetRequestItem.q3_qty }}
                </span>
              </td>
            </ng-container>

            <!-- Control Type Column -->
            <ng-container matColumnDef="control">
              <th mat-header-cell *matHeaderCellDef class="text-center">
                Control
              </th>
              <td
                mat-cell
                *matCellDef="let budgetRequestItem"
                class="text-center"
                (click)="$event.stopPropagation()"
              >
                <div class="flex items-center justify-center gap-2">
                  <!-- Quantity Control Badge -->
                  @if (
                    budgetRequestItem.quantity_control_type &&
                    budgetRequestItem.quantity_control_type !== 'NONE'
                  ) {
                    <button
                      type="button"
                      (click)="
                        onEditControlSettings(budgetRequestItem.id, $event)
                      "
                      [matTooltip]="
                        'Qty: ' +
                        getControlTypeTooltip(
                          budgetRequestItem.quantity_control_type,
                          budgetRequestItem.quantity_variance_percent,
                          null
                        )
                      "
                      matTooltipPosition="above"
                      class="p-0 border-0 bg-transparent cursor-pointer hover:opacity-80 transition-opacity"
                      aria-label="Edit quantity control settings"
                    >
                      <ax-badge
                        [type]="
                          getControlTypeBadgeColor(
                            budgetRequestItem.quantity_control_type
                          )
                        "
                        variant="soft"
                        size="sm"
                      >
                        {{ budgetRequestItem.quantity_control_type }}
                      </ax-badge>
                    </button>
                  }

                  <!-- Price Control Badge -->
                  @if (
                    budgetRequestItem.price_control_type &&
                    budgetRequestItem.price_control_type !== 'NONE'
                  ) {
                    <button
                      type="button"
                      (click)="
                        onEditControlSettings(budgetRequestItem.id, $event)
                      "
                      [matTooltip]="
                        'Price: ' +
                        getControlTypeTooltip(
                          budgetRequestItem.price_control_type,
                          null,
                          budgetRequestItem.price_variance_percent
                        )
                      "
                      matTooltipPosition="above"
                      class="p-0 border-0 bg-transparent cursor-pointer hover:opacity-80 transition-opacity"
                      aria-label="Edit price control settings"
                    >
                      <ax-badge
                        [type]="
                          getControlTypeBadgeColor(
                            budgetRequestItem.price_control_type
                          )
                        "
                        variant="soft"
                        size="sm"
                      >
                        {{ budgetRequestItem.price_control_type }}
                      </ax-badge>
                    </button>
                  }

                  <!-- No Controls Indicator -->
                  @if (
                    !budgetRequestItem.quantity_control_type &&
                    !budgetRequestItem.price_control_type
                  ) {
                    <button
                      type="button"
                      (click)="
                        onEditControlSettings(budgetRequestItem.id, $event)
                      "
                      matTooltip="Click to configure budget controls"
                      matTooltipPosition="above"
                      class="p-0 border-0 bg-transparent cursor-pointer hover:opacity-80 transition-opacity"
                      aria-label="Configure budget controls"
                    >
                      <ax-badge color="info" variant="soft" size="sm">
                        None
                      </ax-badge>
                    </button>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Expanded Detail Column -->
            <ng-container matColumnDef="expandedDetail">
              <td
                mat-cell
                *matCellDef="let budgetRequestItem"
                [attr.colspan]="displayedColumns.length"
                class="!p-0 !border-b-0"
              >
                @if (isRowExpanded(budgetRequestItem)) {
                  <div
                    class="pl-16 pr-5 py-3 bg-[var(--ax-background-subtle)]/50"
                    [@detailExpand]
                  >
                    <div class="max-w-4xl">
                      <div class="flex items-start gap-2">
                        <mat-icon
                          class="text-[var(--ax-text-disabled)] !text-base mt-0.5"
                          >description</mat-icon
                        >
                        <div class="flex-1">
                          <h4
                            class="text-xs font-semibold text-[var(--ax-text-secondary)] mb-1.5"
                          >
                            Description
                          </h4>
                          <p
                            class="text-sm text-[var(--ax-text-secondary)] leading-relaxed"
                          >
                            {{ budgetRequestItem.description }}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-right w-20">
                Actions
              </th>
              <td
                mat-cell
                *matCellDef="let budgetRequestItem"
                class="text-right"
                (click)="$event.stopPropagation()"
              >
                <button
                  type="button"
                  mat-icon-button
                  [matMenuTriggerFor]="actionMenu"
                  matTooltip="Actions"
                  matTooltipPosition="above"
                  aria-label="More actions"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #actionMenu="matMenu" [hasBackdrop]="false">
                  <button
                    type="button"
                    mat-menu-item
                    (click)="onViewBudgetRequestItem(budgetRequestItem)"
                  >
                    <mat-icon>visibility</mat-icon><span>View</span>
                  </button>
                  <button
                    type="button"
                    mat-menu-item
                    (click)="onEditBudgetRequestItem(budgetRequestItem)"
                  >
                    <mat-icon>edit</mat-icon><span>Edit</span>
                  </button>

                  <button
                    type="button"
                    mat-menu-item
                    (click)="onDeleteBudgetRequestItem(budgetRequestItem)"
                  >
                    <mat-icon class="text-[var(--ax-error-default)]"
                      >delete</mat-icon
                    ><span>Delete</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              class="hover:bg-[var(--ax-background-subtle)]"
              [attr.data-budgetrequestitem-id]="row.id"
            ></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: ['expandedDetail']"
              class="detail-row"
            ></tr>
          </table>
        </div>

        <!-- Paginator -->
        <mat-paginator
          [length]="budgetRequestItemsService.totalBudgetRequestItem()"
          [pageSize]="25"
          [pageSizeOptions]="[10, 25, 50, 100]"
          [pageIndex]="0"
          showFirstLastButtons
          class="border-t border-[var(--ax-border-default)]"
        ></mat-paginator>
      </mat-card>
    }
  </div>

  <!-- Item Settings Modal -->
  @if (selectedItemForSettings()) {
    <app-item-settings-modal
      [itemId]="selectedItemForSettings()!.id"
      [itemName]="
        selectedItemForSettings()!.drug_name ||
        selectedItemForSettings()!.generic_name
      "
      [currentSettings]="{
        quantity_control_type: selectedItemForSettings()!.quantity_control_type,
        price_control_type: selectedItemForSettings()!.price_control_type,
        quantity_variance_percent:
          selectedItemForSettings()!.quantity_variance_percent,
        price_variance_percent:
          selectedItemForSettings()!.price_variance_percent,
      }"
      (saved)="onSettingsSaved()"
      (closed)="onSettingsClosed()"
    />
  }
</div>
