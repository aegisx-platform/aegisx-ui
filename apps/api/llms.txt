# AegisX API (Fastify Backend)

> Enterprise-grade Fastify REST API with modular plugin architecture, RBAC, and real-time WebSocket support.

## Overview

The `apps/api` is a Fastify-based backend application featuring:
- Plugin-based modular architecture
- JWT authentication with refresh tokens
- Role-Based Access Control (RBAC)
- TypeBox schema validation
- PostgreSQL with Knex.js
- Redis caching
- WebSocket real-time events
- Swagger/OpenAPI documentation

## Quick Start

```bash
# Development
pnpm run dev:api

# Build
pnpm nx build api

# Test
pnpm nx test api
```

---

## Architecture

```
apps/api/src/
├── main.ts              # Entry point
├── bootstrap/           # Server factory & initialization
├── config/              # Configuration management
├── plugins/             # Fastify plugins
├── core/                # Core business modules
├── modules/             # Generated CRUD modules
├── shared/              # Shared utilities
├── schemas/             # Global schemas
├── services/            # Global services
├── database/            # Migrations & seeds
└── types/               # TypeScript types
```

---

## Core Modules (`src/core/`)

| Module | Description | Routes |
|--------|-------------|--------|
| `auth` | JWT authentication, login, logout, refresh | `/api/auth/*` |
| `users` | User management, registration | `/api/users/*` |
| `rbac` | Roles, permissions, assignments | `/api/rbac/*` |
| `user-profile` | User preferences, sessions, activity | `/api/profile/*` |
| `settings` | App settings, config | `/api/settings/*` |
| `navigation` | Dynamic navigation items | `/api/navigation/*` |
| `api-keys` | API key management | `/api/api-keys/*` |
| `file-upload` | File uploads with storage | `/api/files/*` |
| `attachments` | Entity attachments | `/api/attachments/*` |
| `email` | Email sending service | Internal |
| `pdf-templates` | PDF generation | `/api/pdf-templates/*` |
| `pdf-export` | Data export to PDF | `/api/export/*` |
| `audit-system` | Activity audit logs | `/api/audit/*` |
| `error-logs` | Error tracking | `/api/error-logs/*` |
| `monitoring` | System monitoring | `/api/monitoring/*` |

---

## Plugins (`src/plugins/`)

| Plugin | Description |
|--------|-------------|
| `knex.plugin.ts` | Database connection (PostgreSQL) |
| `jwt-auth.plugin.ts` | JWT authentication |
| `redis.plugin.ts` | Redis connection |
| `swagger.plugin.ts` | OpenAPI documentation |
| `response-handler.plugin.ts` | Standardized responses |
| `health-check.plugin.ts` | Health endpoints |
| `logging.plugin.ts` | Request logging |
| `multipart.plugin.ts` | File upload handling |
| `static-files.plugin.ts` | Static file serving |
| `schemas.plugin.ts` | Schema registration |
| `schema-enforcement.plugin.ts` | Schema validation |
| `activity-logging/` | Activity audit logging |

---

## Module Structure

Each module follows this pattern:

```
module-name/
├── module-name.plugin.ts     # Fastify plugin entry
├── module-name.routes.ts     # Route definitions
├── module-name.controller.ts # Request handlers
├── module-name.service.ts    # Business logic
├── module-name.repository.ts # Database queries
├── module-name.schemas.ts    # TypeBox schemas
├── module-name.types.ts      # TypeScript types
├── module-name.events.ts     # WebSocket events (optional)
└── __tests__/                # Unit tests
```

---

## Authentication Flow

### JWT Tokens
- Access token: Short-lived (15 min default)
- Refresh token: Long-lived (7 days default)
- Stored in HTTP-only cookies

### Auth Middleware
```typescript
// Available decorators on FastifyRequest
request.user         // Authenticated user
request.authenticate // Manual auth trigger
```

### Auth Strategies
Located in `src/core/auth/strategies/`:
- `verifyJWT` - Verify JWT token
- `verifyRole` - Check user role
- `verifyPermission` - Check specific permission
- `verifyOwnership` - Check resource ownership

---

## RBAC System

### Permission Format
```
resource.action
```

Examples:
- `users.read` - Read users
- `users.write` - Create/update users
- `users.delete` - Delete users
- `admin.*` - All admin permissions

### Role Structure
```typescript
interface Role {
  id: string;
  name: string;
  permissions: string[];
  isSystem: boolean;
}
```

### Permission Check
```typescript
// In route preHandler
{
  preHandler: [
    fastify.auth([fastify.verifyJWT]),
    fastify.verifyPermission(['users.read']),
  ],
}
```

---

## Database

### Knex.js Configuration
- PostgreSQL connection
- Migrations in `src/database/migrations/`
- Seeds in `src/database/seeds/`

### Base Repository Pattern
```typescript
import { BaseRepository } from '@shared/repository';

class UsersRepository extends BaseRepository<User> {
  constructor(knex: Knex) {
    super(knex, 'users', ['name', 'email']);
  }
}
```

### Repository Methods
- `findAll(options)` - List with pagination/filtering
- `findById(id)` - Get by ID
- `findOne(where)` - Get single record
- `create(data)` - Create record
- `update(id, data)` - Update record
- `delete(id)` - Delete record (soft delete)
- `hardDelete(id)` - Permanent delete

---

## WebSocket Events

### Event Bus
Located in `src/shared/websocket/`:

```typescript
import { eventBus } from '@shared/websocket';

// Emit event
eventBus.emit('user:created', { userId: '...' });

// Subscribe
eventBus.on('user:created', handler);
```

### CRUD Event Helper
```typescript
import { CrudEventHelper } from '@shared/websocket';

const helper = new CrudEventHelper('users');
helper.emitCreated(user);
helper.emitUpdated(user);
helper.emitDeleted(userId);
```

---

## Schemas (TypeBox)

### Base Schemas
Located in `src/schemas/`:

```typescript
import { Type } from '@sinclair/typebox';

// Common patterns
export const IdParamSchema = Type.Object({
  id: Type.String({ format: 'uuid' }),
});

export const PaginationSchema = Type.Object({
  page: Type.Optional(Type.Number({ minimum: 1 })),
  limit: Type.Optional(Type.Number({ minimum: 1, maximum: 100 })),
});
```

### Route Schema Registration
```typescript
{
  schema: {
    params: IdParamSchema,
    querystring: PaginationSchema,
    body: CreateUserSchema,
    response: {
      200: UserResponseSchema,
    },
  },
}
```

---

## Services

### Export Service
```typescript
import { ExportService } from '@services/export.service';

const exportService = new ExportService();
await exportService.exportToExcel(data, columns, filename);
await exportService.exportToPdf(data, template);
await exportService.exportToCsv(data, columns);
```

### PDF Service
```typescript
import { PdfMakeService } from '@services/pdfmake.service';

const pdfService = new PdfMakeService();
const buffer = await pdfService.generatePdf(docDefinition);
```

### Redis Cache
```typescript
import { RedisCacheService } from '@services/redis-cache.service';

const cache = new RedisCacheService();
await cache.set('key', value, ttl);
const value = await cache.get('key');
```

---

## Configuration

### Environment Variables
```bash
# Server
PORT=3333
HOST=0.0.0.0
NODE_ENV=development

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/db
# Or individual:
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=password
DB_NAME=aegisx

# JWT
JWT_SECRET=your-secret
JWT_ACCESS_EXPIRY=15m
JWT_REFRESH_EXPIRY=7d

# Redis
REDIS_URL=redis://localhost:6379

# File Storage
STORAGE_PATH=./uploads
MAX_FILE_SIZE=10485760
```

### Config Files
- `src/config/app.config.ts` - Application config
- `src/config/database.config.ts` - Database config
- `src/config/security.config.ts` - Security settings

---

## Error Handling

### AppError Class
```typescript
import { AppError } from '@core/errors';

throw new AppError('User not found', 404, 'USER_NOT_FOUND');
```

### Error Response Format
```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User not found",
    "statusCode": 404
  }
}
```

---

## API Response Format

### Success Response
```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

### Error Response
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input",
    "details": [...]
  }
}
```

---

## Testing

### Test Setup
```typescript
import { createTestApp } from '@shared/test/test-app-helper';

const app = await createTestApp();
```

### Integration Tests
Located in `src/__tests__/integration/`:
- Use `request-helper.ts` for API calls
- Use `factories.ts` for test data
- Use `db-helper.ts` for database setup

---

## Swagger Documentation

Available at: `http://localhost:{PORT}/docs`

Features:
- Interactive API explorer
- Request/Response schemas
- Authentication support
- Try-it-out functionality

---

## File Structure Reference

```
apps/api/src/
├── main.ts
├── bootstrap/
│   ├── index.ts
│   └── server.factory.ts
├── config/
│   ├── app.config.ts
│   ├── database.config.ts
│   ├── security.config.ts
│   └── environment.validator.ts
├── core/
│   ├── auth/
│   ├── users/
│   ├── rbac/
│   ├── user-profile/
│   ├── settings/
│   ├── navigation/
│   ├── api-keys/
│   ├── file-upload/
│   ├── attachments/
│   ├── email/
│   ├── pdf-templates/
│   ├── pdf-export/
│   ├── audit-system/
│   ├── error-logs/
│   └── monitoring/
├── modules/
│   └── (generated CRUD modules)
├── plugins/
├── shared/
│   ├── test/
│   ├── utils/
│   └── websocket/
├── services/
├── schemas/
├── database/
│   ├── migrations/
│   └── seeds/
└── types/
```
