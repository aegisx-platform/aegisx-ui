import { Type, Static } from '@sinclair/typebox';
import { 
  UuidParamSchema, 
  PaginationQuerySchema, 
  ApiErrorResponseSchema,
  ApiSuccessResponseSchema,
  PaginatedResponseSchema,
  {{#if (or (eq package 'enterprise') (eq package 'full'))}}
  DropdownQuerySchema,
  DropdownResponseSchema,
  BulkResponseSchema,
  StatisticsResponseSchema,
  {{/if}}
  {{#if (eq package 'full')}}
  ValidationResponseSchema,
  UniquenessResponseSchema,
  {{/if}}
  {{#if hasStatusField}}
  StatusUpdateResponseSchema,
  {{/if}}
  SchemaRefs
} from '../../schemas/base.schemas';

// Base {{ModuleName}} Schema
export const {{ModuleName}}Schema = Type.Object({
  {{#each columns}}
  {{name}}: {{{raw typeboxType}}}{{#unless @last}},{{/unless}}
  {{/each}}
});

// Create Schema (without auto-generated fields)
export const Create{{ModuleName}}Schema = Type.Object({
{{#each columns}}
{{#unless isPrimaryKey}}
{{#unless (eq name 'created_at')}}
{{#unless (eq name 'updated_at')}}
  {{name}}: {{{raw typeboxType}}},
{{/unless}}
{{/unless}}
{{/unless}}
{{/each}}
});

// Update Schema (partial, without auto-generated fields)
export const Update{{ModuleName}}Schema = Type.Partial(
  Type.Object({
{{#each columns}}
{{#unless isPrimaryKey}}
{{#unless (eq name 'created_at')}}
{{#unless (eq name 'updated_at')}}
    {{name}}: {{{raw typeboxType}}},
{{/unless}}
{{/unless}}
{{/unless}}
{{/each}}
  })
);

// ID Parameter Schema
export const {{ModuleName}}IdParamSchema = Type.Object({
  id: Type.Union([Type.String(), Type.Number()])
});

// Query Schemas
export const Get{{ModuleName}}QuerySchema = Type.Object({
  include: Type.Optional(Type.Union([
    Type.String(),
    Type.Array(Type.String())
  ]))
});

export const List{{ModuleName}}QuerySchema = Type.Object({
  // Pagination parameters
  page: Type.Optional(Type.Number({ minimum: 1, default: 1 })),
  limit: Type.Optional(Type.Number({ minimum: 1, maximum: 1000, default: 20 })),
  sortBy: Type.Optional(Type.String()),
  sortOrder: Type.Optional(Type.Union([
    Type.Literal('asc'), 
    Type.Literal('desc')
  ], { default: 'desc' })),
  
  // Search and filtering
  search: Type.Optional(Type.String({ minLength: 1, maxLength: 100 })),
  
  // Include related data (only if table has foreign keys)
  {{#if (hasForeignKeys schema)}}
  include: Type.Optional(Type.Union([
    Type.String(),
    Type.Array(Type.String())
  ])),
  {{/if}}
  
  // Smart field-based filters
  {{#each columns}}
  {{#unless (or isPrimaryKey (eq name 'created_at') (eq name 'updated_at'))}}
  {{#if (isExactMatchField this)}}
  {{name}}: Type.Optional({{#if (eq tsType 'boolean')}}Type.Boolean(){{else if (eq tsType 'string')}}Type.String({{{getFieldConstraints this}}}){{else if (eq tsType 'number')}}Type.Number({{{getFieldConstraints this}}}){{/if}}),
  {{/if}}
  {{#if (isRangeField this)}}
  {{name}}_min: Type.Optional({{#if (eq tsType 'number')}}Type.Number({{{getFieldConstraints this}}}){{else if (eq tsType 'Date')}}Type.String({ format: 'date-time' }){{/if}}),
  {{name}}_max: Type.Optional({{#if (eq tsType 'number')}}Type.Number({{{getFieldConstraints this}}}){{else if (eq tsType 'Date')}}Type.String({ format: 'date-time' }){{/if}}),
  {{/if}}
  {{/unless}}
  {{/each}}
});

// Response Schemas using base wrappers
export const {{ModuleName}}ResponseSchema = ApiSuccessResponseSchema({{ModuleName}}Schema);
export const {{ModuleName}}ListResponseSchema = PaginatedResponseSchema({{ModuleName}}Schema);

// Export types
export type {{ModuleName}} = Static<typeof {{ModuleName}}Schema>;
export type Create{{ModuleName}} = Static<typeof Create{{ModuleName}}Schema>;
export type Update{{ModuleName}} = Static<typeof Update{{ModuleName}}Schema>;
export type {{ModuleName}}IdParam = Static<typeof {{ModuleName}}IdParamSchema>;
export type Get{{ModuleName}}Query = Static<typeof Get{{ModuleName}}QuerySchema>;
export type List{{ModuleName}}Query = Static<typeof List{{ModuleName}}QuerySchema>;

{{#if withEvents}}
// WebSocket Event Schemas
export const {{ModuleName}}CreatedEventSchema = Type.Object({
  type: Type.Literal('{{moduleName}}.created'),
  data: {{ModuleName}}Schema
});

export const {{ModuleName}}UpdatedEventSchema = Type.Object({
  type: Type.Literal('{{moduleName}}.updated'),
  data: {{ModuleName}}Schema
});

export const {{ModuleName}}DeletedEventSchema = Type.Object({
  type: Type.Literal('{{moduleName}}.deleted'),
  data: Type.Object({
    id: Type.Union([Type.String(), Type.Number()])
  })
});

export type {{ModuleName}}CreatedEvent = Static<typeof {{ModuleName}}CreatedEventSchema>;
export type {{ModuleName}}UpdatedEvent = Static<typeof {{ModuleName}}UpdatedEventSchema>;
export type {{ModuleName}}DeletedEvent = Static<typeof {{ModuleName}}DeletedEventSchema>;
{{/if}}