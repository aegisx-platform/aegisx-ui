version: '3.8'

# AegisX Production Docker Compose with SSL/TLS Support
# This file extends the base docker-compose.yml for production deployment

services:
  # Nginx reverse proxy with SSL termination
  nginx:
    image: nginx:alpine
    container_name: aegisx_nginx_prod
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx:/etc/nginx/conf.d:ro
      - ./ssl:/etc/ssl/aegisx:ro
      - ./ssl/dhparam.pem:/etc/ssl/certs/dhparam.pem:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
      - /var/www/html:/var/www/html # For Let's Encrypt challenges
    networks:
      - aegisx_network
    depends_on:
      - api
      - web
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - 'com.aegisx.service=nginx'
      - 'com.aegisx.environment=production'

  # API service with production configuration
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.prod
      target: production
    container_name: aegisx_api_prod
    restart: unless-stopped
    env_file:
      - .env.production
    environment:
      - NODE_ENV=production
      - DATABASE_HOST=postgres
      - REDIS_HOST=redis
    volumes:
      - api_uploads:/app/uploads
      - api_logs:/app/logs
    networks:
      - aegisx_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3333/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      replicas: 2
    labels:
      - 'com.aegisx.service=api'
      - 'com.aegisx.environment=production'

  # Web application service
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.prod
      target: production
    container_name: aegisx_web_prod
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    volumes:
      - web_assets:/usr/share/nginx/html/assets
    networks:
      - aegisx_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost']
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      replicas: 2
    labels:
      - 'com.aegisx.service=web'
      - 'com.aegisx.environment=production'

  # PostgreSQL database with production optimizations
  postgres:
    image: postgres:15-alpine
    container_name: aegisx_postgres_prod
    restart: unless-stopped
    env_file:
      - .env.production
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backups:/backups
      - ./scripts/postgres-init:/docker-entrypoint-initdb.d:ro
    networks:
      - aegisx_network
    ports:
      # Only expose to localhost for maintenance
      - '127.0.0.1:5432:5432'
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_connections=100
      -c logging_collector=on
      -c log_directory='/var/log/postgresql'
      -c log_filename='postgresql-%Y-%m-%d_%H%M%S.log'
      -c log_statement='all'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - 'com.aegisx.service=postgres'
      - 'com.aegisx.environment=production'

  # Redis cache with persistence
  redis:
    image: redis:7-alpine
    container_name: aegisx_redis_prod
    restart: unless-stopped
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - aegisx_network
    ports:
      # Only expose to localhost for maintenance
      - '127.0.0.1:6379:6379'
    healthcheck:
      test:
        [
          'CMD',
          'redis-cli',
          '--no-auth-warning',
          '-a',
          '${REDIS_PASSWORD}',
          'ping',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - 'com.aegisx.service=redis'
      - 'com.aegisx.environment=production'

  # Monitoring with Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: aegisx_prometheus_prod
    restart: unless-stopped
    ports:
      - '127.0.0.1:9090:9090'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - aegisx_network
    labels:
      - 'com.aegisx.service=prometheus'
      - 'com.aegisx.environment=production'

  # Grafana for metrics visualization
  grafana:
    image: grafana/grafana:latest
    container_name: aegisx_grafana_prod
    restart: unless-stopped
    ports:
      - '127.0.0.1:3000:3000'
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SECURITY_DISABLE_GRAVATAR=true
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/dashboards:ro
    networks:
      - aegisx_network
    depends_on:
      - prometheus
    labels:
      - 'com.aegisx.service=grafana'
      - 'com.aegisx.environment=production'

  # Log aggregation with Loki
  loki:
    image: grafana/loki:latest
    container_name: aegisx_loki_prod
    restart: unless-stopped
    ports:
      - '127.0.0.1:3100:3100'
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    networks:
      - aegisx_network
    labels:
      - 'com.aegisx.service=loki'
      - 'com.aegisx.environment=production'

  # Log shipping with Promtail
  promtail:
    image: grafana/promtail:latest
    container_name: aegisx_promtail_prod
    restart: unless-stopped
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./monitoring/promtail.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - api_logs:/var/log/aegisx:ro
      - nginx_logs:/var/log/nginx:ro
    networks:
      - aegisx_network
    depends_on:
      - loki
    labels:
      - 'com.aegisx.service=promtail'
      - 'com.aegisx.environment=production'

  # Database backup service
  db-backup:
    image: postgres:15-alpine
    container_name: aegisx_db_backup_prod
    restart: 'no'
    env_file:
      - .env.production
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - BACKUP_SCHEDULE="0 2 * * *" # Daily at 2 AM
      - BACKUP_RETENTION=30
    volumes:
      - postgres_backups:/backups
      - ./scripts/db-backup.sh:/usr/local/bin/db-backup.sh:ro
    networks:
      - aegisx_network
    depends_on:
      postgres:
        condition: service_healthy
    command: /bin/sh -c "crond -f"
    labels:
      - 'com.aegisx.service=db-backup'
      - 'com.aegisx.environment=production'

# Networks
networks:
  aegisx_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Persistent volumes
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/postgres

  postgres_backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/backups/postgres

  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/redis

  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/prometheus

  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/grafana

  loki_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/loki

  api_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/uploads

  api_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/aegisx/api

  web_assets:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/aegisx/web/assets

  nginx_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/cache/aegisx/nginx

  nginx_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/aegisx/nginx
