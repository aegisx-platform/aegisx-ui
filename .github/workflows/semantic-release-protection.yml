name: Semantic Release Protection

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  protect-versioning:
    runs-on: self-hosted
    name: ðŸ›¡ï¸ Version Protection Check

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for forbidden BREAKING patterns
        run: |
          echo "ðŸ” Checking for forbidden BREAKING CHANGE patterns..."

          # Get commits to check (if PR, check PR commits; if push, check new commits)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMIT_RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          else
            # For push events, check commits since last tag or last 10 commits
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
              COMMIT_RANGE="${LAST_TAG}..HEAD"
            else
              COMMIT_RANGE="HEAD~10..HEAD"
            fi
          fi

          echo "Checking commit range: $COMMIT_RANGE"

          # Check for forbidden patterns in commit messages
          FORBIDDEN_COMMITS=$(git log --grep="BREAKING CHANGE" --grep="BREAKING CHANGES" --grep="BREAKING:" --oneline $COMMIT_RANGE || true)

          if [ -n "$FORBIDDEN_COMMITS" ]; then
            echo "ðŸš¨ ERROR: Forbidden BREAKING CHANGE pattern detected!"
            echo "These commits contain forbidden patterns that will trigger v2.x.x releases:"
            echo "$FORBIDDEN_COMMITS"
            echo ""
            echo "AegisX Platform policy: v2.x.x releases are FORBIDDEN"
            echo "Use these safe alternatives instead:"
            echo "  IMPORTANT: for significant changes"
            echo "  MAJOR UPDATE: for substantial features"
            echo "  SIGNIFICANT: for notable modifications"
            echo "  API CHANGE: for API modifications"
            echo "  MIGRATION: for schema/config changes"
            echo "  DEPRECATED: for deprecation notices"
            exit 1
          fi

          echo "âœ… No forbidden BREAKING patterns found"

      - name: ðŸ“‹ Setup pnpm
        if: github.ref == 'refs/heads/main'
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.0

      - name: ðŸ“‹ Setup Node.js
        if: github.ref == 'refs/heads/main'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“¦ Install dependencies
        if: github.ref == 'refs/heads/main'
        run: pnpm install --frozen-lockfile

      - name: ðŸŽ¯ Verify semantic-release version prediction
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸŽ¯ Checking what version semantic-release would create..."

          # Run semantic-release in dry-run mode
          SEMANTIC_OUTPUT=$(pnpm exec semantic-release --dry-run 2>&1 || true)
          echo "Semantic-release output:"
          echo "$SEMANTIC_OUTPUT"

          # Extract the next version
          NEXT_VERSION=$(echo "$SEMANTIC_OUTPUT" | grep -o "The next release version is [0-9]\+\.[0-9]\+\.[0-9]\+" | cut -d' ' -f6 || echo "none")

          if [ "$NEXT_VERSION" = "none" ]; then
            echo "â„¹ï¸  No release would be created (no relevant changes)"
            exit 0
          fi

          echo "Next version would be: $NEXT_VERSION"

          # Check if it would create a v2.x.x release
          if echo "$NEXT_VERSION" | grep -q "^2\."; then
            echo "ðŸš¨ ERROR: Semantic-release would create v2.x.x release!"
            echo "Expected: v1.x.x"
            echo "Got: $NEXT_VERSION"
            echo ""
            echo "This indicates BREAKING CHANGE patterns in recent commits."
            echo "Check recent commits for forbidden patterns:"
            git log --oneline -10
            exit 1
          fi

          echo "âœ… Safe version prediction: $NEXT_VERSION"

      - name: ðŸ“Š Version consistency check
        run: |
          echo "ðŸ“Š Checking version consistency..."

          # Check package.json version
          PKG_VERSION=$(cat package.json | grep '"version"' | cut -d'"' -f4)
          echo "package.json version: $PKG_VERSION"

          # Check latest git tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Latest git tag: $LATEST_TAG"

          # Verify no v2.x.x tags exist
          V2_TAGS=$(git tag --list | grep "^v2\." | wc -l)
          if [ $V2_TAGS -gt 0 ]; then
            echo "ðŸš¨ WARNING: Found v2.x.x tags in repository!"
            echo "v2.x.x tags found:"
            git tag --list | grep "^v2\."
            echo "These should be cleaned up following the recovery guide."
          fi

          echo "âœ… Version consistency check complete"

      - name: ðŸ“ Summary
        run: |
          echo "## ðŸ›¡ï¸ Semantic Release Protection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No forbidden BREAKING CHANGE patterns detected" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "- âœ… Semantic-release version prediction verified" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- âœ… Version consistency check passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Project maintains strict v1.x.x versioning policy." >> $GITHUB_STEP_SUMMARY
