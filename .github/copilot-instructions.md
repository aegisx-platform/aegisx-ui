# AegisX Starter – Copilot Guide

- **Workspace shape**: Nx 21.4 monorepo using pnpm 10+. Key apps live under `apps/` (`api` Fastify backend, `web` Angular 20 web, `admin` Angular admin); shared UI sits in `libs/aegisx-ui`.
- **Bootstrap stack**: `apps/api/src/bootstrap` wires Fastify plugins, schema validation, Redis, and Knex. Angular apps lean on standalone components, Angular Material, and Tailwind with Signals-first state.
- **Environment setup**: Always run `pnpm setup` (or `./scripts/setup-env.sh`) before serving. It generates `.env.local`, `docker-compose.instance.yml`, applies migrations, and seeds data with per-folder port hashing—never edit those generated files manually.
- **Serving locally**: Use the wrapper scripts so ports come from `.env.local`: `pnpm dev:api`, `pnpm dev:web`, or `pnpm dev` (api+web). For full admin include `pnpm dev:all`. Behind the scenes `scripts/load-env.sh` exports the right ENV before `nx serve`.
- **Database tooling**: `pnpm db:migrate`, `pnpm db:seed`, and `pnpm db:reset` call Knex via ts-node. Migrations live in `apps/api/src/database/migrations`, seeds in `apps/api/src/database/seeds` with strict TypeBox schemas backing every route.
- **Testing gates**: `pnpm test` (Nx unit tests), `pnpm test:integration` (Fastify integration via Jest), and `pnpm test:e2e` (Playwright). Lint with `pnpm lint` or `pnpm lint:fix`. CI expects all three plus the QA checklist in `docs/guides/development/qa-checklist.md`.
- **Backend patterns**: Routes sit in `apps/api/src/modules/*/routes`. Every handler uses TypeBox schemas from `apps/api/src/schemas`, then delegates to services under `apps/api/src/services` / repositories under `apps/api/src/modules/**/repositories`. BaseRepository in `shared/repositories` handles pagination, smart UUID validation, and dynamic filtering.
- **Auth & middleware**: Fastify plugins load from `apps/api/src/plugins`; `bootstrap/plugin.loader.ts` registers auth, rate limiting, CORS, and swagger. Be mindful of `file-upload` plugin, which exposes `fileUploadService` injected into PDF services.
- **Frontend patterns**: Angular features live in `apps/web/src/app/features/<domain>`. Components are standalone + Signals, often bundling `FormBuilder` with strongly typed forms. Shared services stay under `apps/web/src/app/shared` (HTTP clients, upload widgets, Monaco editor wrapper).
- **State & HTTP**: Feature services expose Angular signals (see `PdfTemplateService`) and always return typed `ApiResponse`. Use `HttpParams` builders for filters; avoid mutating `signal` stores directly—call `set`/`update`.
- **PDF template domain**: UI lives in `features/pdf-templates`, combining `PdfTemplateFormComponent`, `TemplateInsertToolbar`, and `LogoUploadComponent`. Uploads go through `FileUploadService` (image validation, preview, allowDuplicates flag) before persisting `logo_file_id` on the form.
- **Backend PDF flow**: `PdfTemplateService` in `apps/api/src/services` validates Handlebars templates, creates versions, and during render injects `logo_file_id` and resolves it via `FileUploadService.generateSignedUrls`. Template data is stored as TEXT (see migration `20251013030000_change_template_data_to_text`), so don’t assume JSON.
- **Preview vs render**: Preview requests (`renderType: preview`) save temp PDFs under `temp/pdf-renders` and return `previewUrl`; normal renders can stream buffers or persist files when `saveFile` is true. Starters (`is_template_starter`) are blocked from non-preview renders.
- **Docs to trust**: `CLAUDE.md` for repo-wide rules, `docs/getting-started/getting-started.md` for workflow, and `docs/features/pdf-templates/PDF_TEMPLATES_GUIDE.md` for template syntax + helpers. Respect the documentation hierarchy when adding new material.
- **Common pitfalls**: Don’t hardcode ports or JWT secrets; always read from `.env.local` via the load-env wrapper. Template validation runs before save—use the validation service in tests (`PdfTemplateValidationService`). When touching repositories, keep UUID guards aligned with BaseRepository to avoid Postgres cast errors.
- **Debug helpers**: API logging is wired with Winston; check `logs/` or enable verbose by toggling config in `apps/api/src/config`. For PDF debugging, inspect cached renders and Handlebars helpers in `apps/api/src/services/handlebars-template.service.ts`.
- **Contribution flow**: Feature branches off `develop`, conventional commits, no direct pushes to `main`. Run pre-push script (`scripts/pre-push-check.sh`) or set `SKIP_HOOKS=1` intentionally if CI already covers it.
- **Nx tooling**: Prefer `nx graph`/`nx affected` for impact analysis. When generating code, use `tools/crud-generator` CLI; it scaffolds schemas, repositories, routes, and keeps TypeBox + Handlebars conventions aligned.

> After updates, confirm whether sections on PDF templates, environment bootstrap, or testing need deeper examples for your workflow. Let me know what feels unclear so we can refine this guide.
